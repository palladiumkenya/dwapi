Id|Display|DocketId|EmrSystemId|ExtractSql|Destination|IsPriority|Name|Rank|DatabaseProtocolId
a6222210-0e85-11e8-ba89-0ed5f89f718b|Smart Card|PSMART|a62216ee-0e85-11e8-ba89-0ed5f89f718b|"select [Id],[shr],[date_created],[status],[status_date],[uuid] FROM [psmart_store] WHERE UPPER(Status) = 'PENDING'"|PSmartStage|1|pSmart|1|a6221982-0e85-11e8-ba89-0ed5f89f718b
a6226eb4-0e85-11e8-ba89-0ed5f89f718b|Smart Card|PSMART|a6221856-0e85-11e8-ba89-0ed5f89f718b|"select id,shr,date_created,status,status_date,uuid FROM psmart_store where upper(status) = 'PENDING'"|PSmartStage|1|pSmart|1|a6221aa4-0e85-11e8-ba89-0ed5f89f718b
329bfbf4-d404-4dfd-88eb-6fb398c64249|All Patients|NDWH|a62216ee-0e85-11e8-ba89-0ed5f89f718b|"SELECT
 PatientID, PatientPK, FacilityID, SiteCode, FacilityName, SatelliteName,
 Gender, DOB, RegistrationDate, RegistrationAtCCC, RegistrationAtPMTCT,
 RegistrationAtTBClinic, PatientSource, Region, District, Village, ContactRelation, LastVisit,
 MaritalStatus, EducationLevel, DateConfirmedHIVPositive, PreviousARTExposure,
 PreviousARTStartDate, StatusAtCCC, StatusAtPMTCT, StatusAtTBClinic, 'IQCare' AS EMR, 'Kenya HMIS II' AS Project,
 PatientType,
	PopulationCategory as PopulationType,
	'' AS KeyPopulationType,
	Orphan, InSchool,
	County AS PatientResidentCounty ,
	SubCounty AS PatientResidentSubCounty,
	Ward AS PatientResidentLocation ,
	'' AS PatientResidentSubLocation,
	Ward AS PatientResidentWard ,
	Village AS PatientResidentVillage,
	ARTTransferInDate as TransferInDate,
	CAST(GETDATE() AS DATE) AS DateExtracted,
	newid() as ID
  FROM  	tmp_PatientMaster AS a WHERE a.RegistrationAtCCC IS NOT NULL"|dwhstage|1|PatientExtract|1|a6221983-0e85-11e8-ba89-0ed5f89f718b
41742eb0-5856-e811-8e16-9cb6d0da773c|ART Patients|NDWH|a62216ee-0e85-11e8-ba89-0ed5f89f718b|"SELECT

 a.PatientPK, a.PatientID, c.FacilityID, c.SiteCode,
 a.FacilityName, a.DOB, a.AgeEnrollment, a.AgeARTStart,
 a.AgeLastVisit, a.RegistrationDate, a.PatientSource, a.Gender, a.StartARTDate, a.PreviousARTStartDate,
  REPLACE(REPLACE(REPLACE (a.PreviousARTRegimen,'/', '+'),'LPV+r','LPV/r'), 'ATV+r','ATV/r') AS PreviousARTRegimen,
  a.StartARTAtThisFacility,
 REPLACE(REPLACE(REPLACE (a.StartRegimen,'/', '+'),'LPV+r','LPV/r'), 'ATV+r','ATV/r') AS StartRegimen,
  a.StartRegimenLine, a.LastARTDate,
  REPLACE(REPLACE(REPLACE (a.LastRegimen,'/', '+'),'LPV+r','LPV/r'), 'ATV+r','ATV/r') AS LastRegimen,
   a.LastRegimenLine, a.Duration, a.ExpectedReturn, a.Provider, a.LastVisit, a.ExitReason,

 a.ExitDate, CAST(GETDATE() AS DATE) AS DateExtracted
 , 'IQCare' AS EMR, 'Kenya HMIS II' AS Project

FROM
 tmp_ARTPatients AS a
 INNER JOIN
 tmp_PatientMaster AS c ON a.PatientPK = c.PatientPK where c.RegistrationAtCCC is not null"|dwhStage|0|PatientArtExtract|2|a6221983-0e85-11e8-ba89-0ed5f89f718b
42742eb0-5856-e811-8e16-9cb6d0da773c|Patient Baselines|NDWH|a62216ee-0e85-11e8-ba89-0ed5f89f718b|"SELECT

 tmp_PatientMaster.PatientPK, tmp_PatientMaster.PatientID, tmp_PatientMaster.FacilityID, tmp_PatientMaster.SiteCode, IQC_bCD4.bCD4, IQC_bCD4.bCD4Date, IQC_bWAB.bWAB, IQC_bWAB.bWABDate,

 IQC_bWHO.bWHO, IQC_bWHO.bWHODate, IQC_eWAB.eWAB, IQC_eWAB.eWABDate, IQC_eCD4.eCD4, IQC_eCD4.eCD4Date, IQC_eWHO.eWHO, IQC_eWHO.eWHODate, IQC_lastWHO.lastWHO,

 IQC_lastWHO.lastWHODate, IQC_lastWAB.lastWAB, IQC_lastWAB.lastWABDate, IQC_lastCD4.lastCD4, IQC_lastCD4.lastCD4Date, IQC_m12CD4.m12CD4, IQC_m12CD4.m12CD4Date, IQC_m6CD4.m6CD4,

 IQC_m6CD4.m6CD4Date, CAST(GETDATE() AS DATE) AS DateExtracted
 , 'IQCare' AS EMR, 'Kenya HMIS II' AS Project

FROM

 tmp_PatientMaster LEFT OUTER JOIN
    IQC_bCD4 ON tmp_PatientMaster.PatientPK = IQC_bCD4.PatientPK LEFT OUTER JOIN
    IQC_bWAB ON tmp_PatientMaster.PatientPK = IQC_bWAB.PatientPK LEFT OUTER JOIN
    IQC_bWHO ON tmp_PatientMaster.PatientPK = IQC_bWHO.PatientPK LEFT OUTER JOIN
    IQC_lastCD4 ON tmp_PatientMaster.PatientPK = IQC_lastCD4.PatientPK LEFT OUTER JOIN
    IQC_eWAB ON tmp_PatientMaster.PatientPK = IQC_eWAB.PatientPK LEFT OUTER JOIN
    IQC_eWHO ON tmp_PatientMaster.PatientPK = IQC_eWHO.PatientPK LEFT OUTER JOIN
    IQC_lastWAB ON tmp_PatientMaster.PatientPK = IQC_lastWAB.PatientPK LEFT OUTER JOIN
    IQC_eCD4 ON tmp_PatientMaster.PatientPK = IQC_eCD4.PatientPK LEFT OUTER JOIN
    IQC_lastWHO ON tmp_PatientMaster.PatientPK = IQC_lastWHO.PatientPK LEFT OUTER JOIN
    IQC_m12CD4 ON tmp_PatientMaster.PatientPK = IQC_m12CD4.PatientPK LEFT OUTER JOIN
    IQC_m6CD4 ON tmp_PatientMaster.PatientPK = IQC_m6CD4.PatientPK where tmp_PatientMaster.RegistrationAtCCC is not null"|dwhStage|0|PatientBaselineExtract|3|a6221983-0e85-11e8-ba89-0ed5f89f718b
43742eb0-5856-e811-8e16-9cb6d0da773c|Patient Status|NDWH|a62216ee-0e85-11e8-ba89-0ed5f89f718b|"SELECT
 pm.PatientID, ls.PatientPK, pm.SiteCode,
 pm.FacilityName, pm.FacilityID as FacilityId,
 '' AS ExitDescription,
 MAX(ls.ExitDate) AS ExitDate,
 (SELECT TOP 1 ExitReason from tmp_LastStatus S
	WHERE S.PatientPK=ls.PatientPK AND ExitDate= MAX(ls.ExitDate)) AS ExitReason,
 CAST(GETDATE() AS DATE) AS DateExtracted, 'IQCare' AS EMR, 'Kenya HMIS II' AS Project
FROM
 tmp_LastStatus ls
 INNER JOIN
 tmp_PatientMaster pm ON ls.PatientPK = pm.PatientPK
 where pm.RegistrationAtCCC is not null
 GROUP BY  pm.PatientID, ls.PatientPK, pm.SiteCode, pm.FacilityName, pm.FacilityID
 order by PatientPK"|dwhStage|0|PatientStatusExtract|4|a6221983-0e85-11e8-ba89-0ed5f89f718b
44742eb0-5856-e811-8e16-9cb6d0da773c|Patient Labs|NDWH|a62216ee-0e85-11e8-ba89-0ed5f89f718b|"SELECT
 tmp_PatientMaster.PatientID, tmp_Labs.PatientPK, tmp_PatientMaster.FacilityID, tmp_PatientMaster.SiteCode, tmp_PatientMaster.FacilityName, tmp_PatientMaster.SatelliteName, tmp_Labs.VisitID,
 tmp_Labs.OrderedbyDate, tmp_Labs.ReportedbyDate, tmp_Labs.TestName, tmp_Labs.EnrollmentTest, tmp_Labs.TestResult, tmp_Labs.Reasons as Reason,CAST(GETDATE() AS DATE) AS DateExtracted,
   'IQCare' AS EMR, 'Kenya HMIS II' AS Project
FROM
 tmp_Labs INNER JOIN
 tmp_PatientMaster ON tmp_Labs.PatientPK = tmp_PatientMaster.PatientPK where tmp_PatientMaster.RegistrationAtCCC is not null"|dwhstage|0|PatientLabExtract|5|a6221983-0e85-11e8-ba89-0ed5f89f718b
46742eb0-5856-e811-8e16-9cb6d0da773c|Patient Pharmacy|NDWH|a62216ee-0e85-11e8-ba89-0ed5f89f718b|"SELECT
 pm.PatientID, pm.FacilityID, pm.SiteCode,
 ph.PatientPK, ph.VisitID,
  CASE WHEN ph.TreatmentType='ART'
 THEN  REPLACE(REPLACE(REPLACE ( ph.Drug,'/', '+'),'LPV+r','LPV/r'), 'ATV+r','ATV/r')
 ELSE ph.Drug END as drug, ph.Provider,
 ph.DispenseDate, ph.Duration, ph.ExpectedReturn, ph.TreatmentType, ph.RegimenLine, ph.PeriodTaken,
  ph.ProphylaxisType, CAST(GETDATE() AS DATE) AS DateExtracted
 , 'IQCare' AS EMR, 'Kenya HMIS II' AS Project
FROM
 tmp_Pharmacy Ph
 INNER JOIN
    tmp_PatientMaster pm ON ph.PatientPK = pm.PatientPK where pm.RegistrationAtCCC is not null"|dwhstage|0|PatientPharmacyExtract|6|a6221983-0e85-11e8-ba89-0ed5f89f718b
47742eb0-5856-e811-8e16-9cb6d0da773c|Patient Visits|NDWH|a62216ee-0e85-11e8-ba89-0ed5f89f718b|"SELECT
 REPLACE(tmp_PatientMaster.PatientID, ' ', '') AS PatientID, tmp_PatientMaster.FacilityName, tmp_PatientMaster.FacilityID as FacilityId, tmp_PatientMaster.SiteCode, tmp_ClinicalEncounters.PatientPK, tmp_ClinicalEncounters.VisitID,
 tmp_ClinicalEncounters.VisitDate, tmp_ClinicalEncounters.Service, tmp_ClinicalEncounters.VisitType, tmp_ClinicalEncounters.WHOStage, tmp_ClinicalEncounters.WABStage, tmp_ClinicalEncounters.Pregnant,
 tmp_ClinicalEncounters.LMP, tmp_ClinicalEncounters.EDD, tmp_ClinicalEncounters.Height, tmp_ClinicalEncounters.Weight, tmp_ClinicalEncounters.BP, tmp_ClinicalEncounters.OI,
 tmp_ClinicalEncounters.OIDate, tmp_ClinicalEncounters.Adherence, tmp_ClinicalEncounters.AdherenceCategory, NULL AS SubstitutionFirstlineRegimenDate, NULL AS SubstitutionFirstlineRegimenReason, NULL
 AS SubstitutionSecondlineRegimenDate, NULL AS SubstitutionSecondlineRegimenReason, NULL AS SecondlineRegimenChangeDate, NULL AS SecondlineRegimenChangeReason,
 tmp_ClinicalEncounters.FamilyPlanningMethod, tmp_ClinicalEncounters.PwP, tmp_ClinicalEncounters.GestationAge, tmp_ClinicalEncounters.NextAppointmentDate, CAST(GETDATE() AS DATE)
 AS DateExtracted
 , 'IQCare' AS EMR, 'Kenya HMIS II' AS Project,
 PopulationCategory as PopulationType,
	NULL AS KeyPopulationType,
	StabilityAssessment AS StabilityAssessment,
	DifferentiatedCare AS DifferentiatedCare
FROM
 tmp_ClinicalEncounters INNER JOIN
 tmp_PatientMaster ON tmp_PatientMaster.PatientPK = tmp_ClinicalEncounters.PatientPK where tmp_PatientMaster.RegistrationAtCCC is not null"|dwhstage|0|PatientVisitExtract|7|a6221983-0e85-11e8-ba89-0ed5f89f718b
3A742EB0-5856-E811-8E16-9CB6D0DA773C|All Patients|NDWH|a6221856-0e85-11e8-ba89-0ed5f89f718b|"select
                            CASE WHEN prg.program='TB' THEN prg.status  ELSE null end  AS StatusAtTBClinic,
                            CASE WHEN prg.program='MCH-Mother Services' THEN prg.status  ELSE null end  AS  StatusAtPMTCT,
                            CASE WHEN prg.program='HIV' THEN prg.status  ELSE null end  AS   StatusATCCC,
             
                            '' AS SatelliteName,
                            0 AS FacilityId,d.unique_patient_no as PatientID,
                            d.patient_id as PatientPK,
                            d.uuid  as RecordUUID,
                            d.national_unique_patient_identifier as NUPI,
                            pkv.PKV as Pkv,
                            i.siteCode as SiteCode,
                             i.facilityName as FacilityName,
                            case d.gender when 'M' then 'Male' when 'F' then 'Female' end  as Gender,
                            d.dob as DOB,
                            CAST(min(hiv.visit_date) as Date) as RegistrationDate,
                            CAST(coalesce(date_first_enrolled_in_care,min(hiv.visit_date)) as Date) as RegistrationAtCCC,
                            CAST(min(mch.visit_date)as Date) as RegistrationATPMTCT,
                            CAST(min(tb.visit_date)as Date) as RegistrationAtTBClinic,
                            case  max(hiv.entry_point)
                                    when 160542 then 'OPD'
                                    when 160563 then 'Other'
                                    when 160539 then 'VCT'
                                    when 160538 then 'PMTCT'
                                    when 160541 then 'TB'
                                    when 160536 then 'IPD - Adult'
                                            /*else cn.name*/
                                            end as PatientSource,
             
                            (select state_province from location
                                where location_id in (select property_value
                                                                                                                        from global_property
                                                                                                                        where property='kenyaemr.defaultLocation')) as Region,
                            (select county_district from location
                                where location_id in (select property_value
                                                                                                                        from global_property
                                                                                                                        where property='kenyaemr.defaultLocation'))as District,
                            (select address6 from location
                                where location_id in (select property_value
                                                                                                                        from global_property
                                                                                                                        where property='kenyaemr.defaultLocation')) as Village,
                            UPPER(ts.name) as ContactRelation,
                            CAST(GREATEST(coalesce(max(hiv.visit_date),date('1000-01-01')),coalesce(max(de.visit_date),date('1000-01-01')), coalesce(max(enr.visit_date),date('1000-01-01'))) as Date) as LastVisit,
                            UPPER(d.marital_status) as MaritalStatus,
                            UPPER(d.education_level) as EducationLevel,
             
                            CAST(min(hiv.date_confirmed_hiv_positive) as Date) as DateConfirmedHIVPositive,
                            max(hiv.arv_status) as PreviousARTExposure,
                            NULL as PreviousARTStartDate,
                            'KenyaEMR' as Emr,
                            'Kenya HMIS II' as Project,
                            CASE hiv.patient_type
                                    WHEN 160563 THEN 'Transfer in'
                                    WHEN 164144	THEN 'New client'
                                    WHEN 159833	THEN 'Re-enroll'
                                    WHEN 164931 THEN 'Transit'
                                    ELSE hiv.patient_type
                                            END AS PatientType,
                            if (c.client_id is not null,'Key population', (select CASE
                                                            WHEN mid(max(concat(f.visit_date,f.population_type)),11)=164929
                                                                                            THEN 'Key population'
                                                            WHEN mid(max(concat(f.visit_date,f.population_type)),11)=164928 THEN 'General Population'
                                                                    END  from  kenyaemr_etl.etl_patient_hiv_followup f
                        WHERE f.encounter_id=max(enr.encounter_id) group by f.patient_id)) AS PopulationType,
                            COALESCE(c.key_population_type,(select
                                                    case mid(max(concat(f.visit_date,f.key_population_type)),11)
                                                            WHEN 105 THEN 'PWID'
                                                            WHEN 160578 THEN 'MSM'
                                                            WHEN 160579  THEN 'FSW'
                                                            WHEN 1175 THEN 'N/A'
                                                            ELSE null END
                        from  kenyaemr_etl.etl_patient_hiv_followup f
                        WHERE f.encounter_id=max(enr.encounter_id) group by f.patient_id)) AS KeyPopulationType,
                            case hiv.orphan when 1 THEN 'Yes' when 2 THEN 'No' ELSE null END as  'Orphan',
                            case hiv.in_school when 1 THEN 'Yes' when 2 THEN 'No' ELSE null END as 'InSchool',
                            patAd.county_district AS  PatientResidentCounty,
                            patAd.state_province AS PatientResidentSubCounty,
                            patAd.address6 AS PatientResidentLocation,
                            patAd.address5 AS PatientResidentSubLocation,
                            patAd.address4 AS PatientResidentWard,
                            patAd.city_village AS PatientResidentVillage,
                            cast(min(hiv.transfer_in_date) as Date) as TransferInDate,
                            hiv.date_created as Date_Created,
                            GREATEST(
                                    COALESCE(d.date_last_modified, hiv.date_last_modified, prg.date_last_modified),
                                    COALESCE(hiv.date_last_modified, prg.date_last_modified, d.date_last_modified),
                                    COALESCE(prg.date_last_modified, d.date_last_modified, hiv.date_last_modified)
                                            ) as Date_Last_Modified,d.occupation as Occupation,	
             d.voided                                                                    as Voided	
             from dwapi_etl.etl_hiv_enrollment hiv	
             inner join dwapi_etl.etl_patient_demographics d on hiv.patient_id = d.patient_id	
             left outer join dwapi_etl.etl_mch_enrollment mch on mch.patient_id = d.patient_id	
             left outer join dwapi_etl.etl_patient_hiv_followup enr on enr.patient_id = d.patient_id	
             left outer join dwapi_etl.etl_tb_enrollment tb on tb.patient_id = d.patient_id	
             left outer join dwapi_etl.etl_drug_event de on de.patient_id = d.patient_id	
             left join concept_name ts on ts.concept_id = hiv.relationship_of_treatment_supporter and	
             ts.concept_name_type = 'FULLY_SPECIFIED' and ts.locale = 'en'	
             left join person_address patAd ON patAd.person_id = d.patient_id and patAd.voided = 0	
             inner join (select x.patient_id as patient_id,	
             x.sxFirstName,	
             x.sxLastname,	
             x.sxMiddleName,	
             x.dmFirstName,	
             x.dmLastName,	
             x.dmMiddleName,
             x.Gender,	
             x.DOB,	
             CASE	
             WHEN locate(';', dmLastName) > 0 THEN	
             CONCAT(	
             CAST(LEFT(Gender, 1) AS CHAR CHARACTER SET utf8)	
             , CAST(sxFirstName AS CHAR CHARACTER SET utf8)	
             , CAST(SUBSTRING(dmLastName, locate(';', dmLastName) + 1,	
             LENGTH(dmLastName)) AS CHAR CHARACTER SET utf8)	
             , CAST(LTRIM(RTRIM(DATE_FORMAT(DOB, '%Y'))) AS CHAR CHARACTER SET utf8)	
             )	
             ELSE	
             CONCAT(	
             CAST(LEFT(Gender, 1) AS CHAR CHARACTER SET utf8)	
             , CAST(sxFirstName AS CHAR CHARACTER SET utf8),	
             CAST(dmLastName AS CHAR CHARACTER SET utf8),	
             CAST(LTRIM(RTRIM(DATE_FORMAT(DOB, '%Y'))) AS CHAR CHARACTER SET utf8)	
             )	
             END      AS PKV	
             from (SELECT patient_id,	
             SOUNDEX(UPPER(REPLACE(given_name, '0', 'O')))                           AS sxFirstName,	
             SOUNDEX(UPPER(REPLACE(family_name, '0', 'O')))                          AS sxLastName,
             SOUNDEX(UPPER(REPLACE(middle_name, '0', 'O')))                          AS sxMiddleName,	
             fn_getPatientNameDoubleMetaphone(UPPER(REPLACE(given_name, '0', 'O')))  AS dmFirstName,	
             fn_getPatientNameDoubleMetaphone(UPPER(REPLACE(family_name, '0', 'O'))) AS dmLastName,	
             fn_getPatientNameDoubleMetaphone(UPPER(REPLACE(middle_name, '0', 'O'))) AS dmMiddleName,	
             Gender,	
             DOB	
             FROM dwapi_etl.etl_patient_demographics) x) pkv on pkv.patient_id = d.patient_id	
             left join	
             (select Patient_Id,	
             program,	
             if(mid(max(concat(date_enrolled, date_completed)), 20) is null, 'Active', 'Inactive') as status,	
             date_created,	
             date_last_modified	
             from dwapi_etl.etl_patient_program	
             group by Patient_Id, program) as prg on prg.patient_id = d.patient_id	
             left join dwapi_etl.etl_contact c	
             on c.client_id = d.patient_id and prg.status = 'Active' and prg.program = 'KP'
             join kenyaemr_etl.etl_default_facility_info i	
             where unique_patient_no is not null	
             group by d.patient_id	
             order by d.patient_id"|dwhstage|1|PatientExtract|1|a6221aa4-0e85-11e8-ba89-0ed5f89f718b
39742EB0-5856-E811-8E16-9CB6D0DA773C|ART Patients|NDWH|a6221856-0e85-11e8-ba89-0ed5f89f718b|"select ''                                                                                  AS SatelliteName,
                                 reg.uuid                                                                        as RecordUUID,
                                 0                                                                                   AS FacilityId,
                                 d.DOB,
                                 d.Gender,
                                 'Government'                                                                        AS Provider,
                                 d.unique_patient_no                                                                 as PatientID,
                                 d.patient_id                                                                        as PatientPK,
                                 timestampdiff(year, d.DOB, hiv.visit_date)                                          as AgeEnrollment,
                                 timestampdiff(year, d.DOB, reg.art_start_date)                                      as AgeARTStart,
                                 timestampdiff(year, d.DOB, reg.latest_vis_date)                                     as AgeLastVisit,
                                 i.siteCode                                                                          as SiteCode,
                                 i.FacilityName                                                                      as FacilityName,
                                 CAST(coalesce(date_first_enrolled_in_care, min(hiv.visit_date)) as Date)            as RegistrationDate,
                                 case max(hiv.entry_point)
                                     when 160542 then 'OPD'
                                     when 160563 then 'Other'
                                     when 160539 then 'VCT'
                                     when 160538 then 'PMTCT'
                                     when 160541 then 'TB'
                                     when 160536 then 'IPD - Adult'
                                     else ''
                                     end                                                                             as PatientSource,
                                 mid(min(concat(hiv.visit_date, hiv.date_started_art_at_transferring_facility)), 11) as PreviousARTStartDate,
                                 reg.date_started_art_this_facility                                                  as StartARTAtThisFAcility,
                                 least(ifnull(mid(min(concat(hiv.visit_date, hiv.date_started_art_at_transferring_facility)), 11),
                                              reg.date_started + interval rand()*1000 year), reg.date_started)       as StartARTDate,
                                 reg.PreviousARTUse                                                                  as PreviousARTUse,
                                 reg.PreviousARTPurpose                                                              as PreviousARTPurpose,
                                 reg.PreviousARTRegimen                                                              as PreviousARTRegimen,
                                 reg.DateLastUsed                                                                    as DateLastUsed,
                                 reg.regimen                                                                         as StartRegimen,
                                 reg.regimen_line                                                                    as StartRegimenLine,
                                 case
                                     when reg.latest_vis_date is not null then reg.latest_vis_date
                                     else reg.last_art_date end                                                        as LastARTDate,
                                 reg.last_regimen                                                                    as LastRegimen,
                                 reg.last_regimen_line                                                               as LastRegimenLine,
                                 reg.latest_tca                                                                      as ExpectedReturn,
                                 reg.latest_vis_date                                                                 as LastVisit,
                                 timestampdiff(month, reg.art_start_date, reg.latest_vis_date)                       as Duration,
                                 disc.ExitDate                                                                       as ExitDate,
                                 disc.ExitReason                                                                     as ExitReason,
                                 'KenyaEMR'                                                                          as Emr,
                                 'Kenya HMIS II'                                                                     as Project,
                                 hiv.date_created                                                                    as Date_Created,
                                 GREATEST(
                                         COALESCE(hiv.date_last_modified, disc.date_last_modified, reg.date_last_modified),
                                         COALESCE(disc.date_last_modified, reg.date_last_modified, hiv.date_last_modified),
                                         COALESCE(reg.date_last_modified, hiv.date_last_modified, disc.date_last_modified)
                                     )                                                                               as Date_Last_Modified,
                                        hiv.voided                                                                      as Voided
                          from dwapi_etl.etl_hiv_enrollment hiv
                                  join dwapi_etl.etl_patient_demographics d on d.patient_id = hiv.patient_id
                                  left outer join (select d.patient_id,
                                                          coalesce(max(date(d.effective_discontinuation_date)),
                                                                   max(date(d.visit_date))) as ExitDate,
                                                          (case d.discontinuation_reason
                                                               when 159492 then 'Transfer Out'
                                                               when 160034 then 'Died'
                                                               when 5240 then 'LTFU'
                                                               when 819 then 'Stopped Treatment'
                                                               else '' end)                 as ExitReason,
                                                          max(d.date_last_modified)         as date_last_modified
                                                   from dwapi_etl.etl_patient_program_discontinuation d
                                                   where d.program_name = 'HIV'
                                                   group by d.patient_id) disc on disc.patient_id = hiv.patient_id
                                  left outer join (select e.patient_id,
                                                          e.uuid                                                               as uuid,
                                                          min(e.date_started)                                                  as art_start_date,
                                                          min(e.date_started)                                                  as date_started_art_this_facility,
                                                          e.date_started,
                                                          e.gender,
                                                          e.dob,
                                                          d.ExitDate                                                           as dis_date,
                                                          if(d.ExitDate is not null, 1, 0)                                     as TOut,
                                                          e.regimen,
                                                          e.regimen_line,
                                                          e.alternative_regimen,
                                                          max(fup.next_appointment_date)                                       as latest_tca,
                                                          last_art_date,
                                                          last_regimen,
                                                          last_regimen_line,
                                                          if(enr.transfer_in_date is not null, 1, 0)                           as TIn,
                                                          if(enr.transfer_in_date is not null, enr.previous_art_use, NULL)     as PreviousARTUse,
                                                          if(enr.transfer_in_date is not null, enr.previous_art_purpose, NULL) as PreviousARTPurpose,
                                                          if(enr.transfer_in_date is not null, enr.previous_art_regimen, NULL) as PreviousARTRegimen,
                                                          if(enr.transfer_in_date is not null,
                                                             enr.transfer_in_date,
                                                             NULL)                                                             as DateLastUsed,
                                                          max(fup.visit_date)                                                  as latest_vis_date,
                                                          e.date_created,
                                                          e.date_last_modified
                                                   from (select e.patient_id,
                                                                e.uuid,
                                                                p.dob,
                                                                p.Gender,
                                                                min(e.date_started)                                             as date_started,
                                                                max(e.date_started)                                             as last_art_date,
                                                                mid(min(concat(e.date_started, e.regimen_name)), 11)            as regimen,
                                                                mid(min(concat(e.date_started, e.regimen_line)), 11)            as regimen_line,
                                                                mid(max(concat(e.date_started, e.regimen_name)), 11)            as last_regimen,
                                                                mid(max(concat(e.date_started, e.regimen_line)), 11)            as last_regimen_line,
                                                                max(if(discontinued, 1, 0))                                     as alternative_regimen,
                                                                GREATEST(COALESCE(p.date_created, ph.date_created),
                                                                         COALESCE(ph.date_created, p.date_created))             as date_created,
                                                                GREATEST(COALESCE(p.date_last_modified, ph.date_last_modified),
                                                                         COALESCE(ph.date_last_modified, p.date_last_modified)) as date_last_modified,
                                                                e.provider                                                      as provider
                                                         from dwapi_etl.etl_drug_event e
                                                                  join dwapi_etl.etl_patient_demographics p on p.patient_id = e.patient_id
                                                                  left join dwapi_etl.etl_pharmacy_extract ph
                                                                            on ph.patient_id = e.patient_id and is_arv = 1
                                                         where e.program = 'HIV'
                                                         group by e.patient_id) e
                                                            left outer join (select d.patient_id,
                                                                                    coalesce(max(date(d.effective_discontinuation_date)),
                                                                                             max(date(d.visit_date))) ExitDate
                                                                             from dwapi_etl.etl_patient_program_discontinuation d
                                                                             where d.program_name = 'HIV'
                                                                             group by d.patient_id) d on d.patient_id = e.patient_id
                                                            inner join (select e.patient_id                                           as patient_id,
                                                                               mid(max(concat(e.visit_date, e.transfer_in_date)), 11) as transfer_in_date,
                                                                               case mid(max(concat(e.visit_date, e.arv_status)), 11)
                                                                                   when 1 then 'Yes'
                                                                                   when 0
                                                                                       then 'No' end                                  as previous_art_use,
                                                                               concat_ws('|', NULLIF(
                                                                                       case mid(max(concat(pre.visit_date, pre.PMTCT)), 11)
                                                                                           when 1065 then 'PMTCT' end, ''),
                                                                                         NULLIF(
                                                                                                 case mid(max(concat(pre.visit_date, pre.PEP)), 11)
                                                                                                     when 1 then 'PEP' end, ''),
                                                                                         NULLIF(
                                                                                                 case mid(max(concat(pre.visit_date, pre.PrEP)), 11)
                                                                                                     when 1065 then 'PrEP' end, ''),
                                                                                         NULLIF(
                                                                                                 case mid(max(concat(pre.visit_date, pre.HAART)), 11)
                                                                                                     when 1185 then 'HAART' end, '')
                                                                                   )                                                  as previous_art_purpose,
                                                                               concat_ws('|', NULLIF(
                                                                                       case mid(max(concat(pre.visit_date, pre.PMTCT_regimen)), 11)
                                                                                           when 164968 then 'AZT+3TC+DTG'
                                                                                           when 164969 then 'TDF+3TC+DTG'
                                                                                           when 164970 then 'ABC+3TC+DTG'
                                                                                           when 164505 then 'TDF+3TC+EFV'
                                                                                           when 792 then 'D4T+3TC+NVP'
                                                                                           when 160124 then 'AZT+3TC+EFV'
                                                                                           when 160104 then 'D4T+3TC+EFV'
                                                                                           when 161361 then 'EDF+3TC+EFV'
                                                                                           when 104565 then 'EFV+FTC+TDF'
                                                                                           when 162201 then '3TC+LPV+TDF+r'
                                                                                           when 817 then 'ABC+3TC+AZT'
                                                                                           when 162199 then 'ABC+NVP+3TC'
                                                                                           when 162200 then '3TC+ABC+LPV+r'
                                                                                           when 162565 then '3TC+NVP+TDF'
                                                                                           when 1652 then '3TC+NVP+AZT'
                                                                                           when 162561 then '3TC+AZT+LPV+r'
                                                                                           when 164511 then 'AZT-3TC-ATV+r'
                                                                                           when 164512 then 'TDF-3TC-ATV+r'
                                                                                           when 162560 then '3TC+D4T+LPV+r'
                                                                                           when 162563 then '3TC+ABC+EFV'
                                                                                           when 162562 then 'ABC+LPV+R+TDF'
                                                                                           when 162559 then 'ABC+DDI+LPV+r' end, ''),
                                                                                         NULLIF(
                                                                                                 case mid(max(concat(pre.visit_date, pre.PEP_regimen)), 11)
                                                                                                     when 164968 then 'AZT+3TC+DTG'
                                                                                                     when 164969 then 'TDF+3TC+DTG'
                                                                                                     when 164970 then 'ABC+3TC+DTG'
                                                                                                     when 164505 then 'TDF+3TC+EFV'
                                                                                                     when 792 then 'D4T+3TC+NVP'
                                                                                                     when 160124 then 'AZT+3TC+EFV'
                                                                                                     when 160104 then 'D4T+3TC+EFV'
                                                                                                     when 1652 then '3TC+NVP+AZT'
                                                                                                     when 161361 then 'EDF+3TC+EFV'
                                                                                                     when 104565 then 'EFV+FTC+TDF'
                                                                                                     when 162201 then '3TC+LPV+TDF+r'
                                                                                                     when 817 then 'ABC+3TC+AZT'
                                                                                                     when 162199 then 'ABC+NVP+3TC'
                                                                                                     when 162200 then '3TC+ABC+LPV+r'
                                                                                                     when 162565 then '3TC+NVP+TDF'
                                                                                                     when 162561 then '3TC+AZT+LPV+r'
                                                                                                     when 164511 then 'AZT+3TC+ATV+r'
                                                                                                     when 164512 then 'TDF+3TC+ATV+r'
                                                                                                     when 162560 then '3TC+D4T+LPV+r'
                                                                                                     when 162563 then '3TC+ABC+EFV'
                                                                                                     when 162562 then 'ABC+LPV/R+TDF'
                                                                                                     when 162559 then 'ABC+DDI+LPV+r' end, ''),
                                                                                         NULLIF(
                                                                                                 case mid(max(concat(pre.visit_date, pre.PrEP_regimen)), 11)
                                                                                                     when 164968 then 'AZT+3TC+DTG'
                                                                                                     when 164969 then 'TDF+3TC+DTG'
                                                                                                     when 164970 then 'ABC+3TC+DTG'
                                                                                                     when 164505 then 'TDF+3TC+EFV'
                                                                                                     when 792 then 'D4T+3TC+NVP'
                                                                                                     when 160124 then 'AZT+3TC+EFV'
                                                                                                     when 160104 then 'D4T+3TC+EFV'
                                                                                                     when 161361 then 'EDF+3TC+EFV'
                                                                                                     when 104565 then 'EFV+FTC+TDF'
                                                                                                     when 162201 then '3TC+LPV+TDF+r'
                                                                                                     when 817 then 'ABC+3TC+AZT'
                                                                                                     when 162199 then 'ABC+NVP+3TC'
                                                                                                     when 162200 then '3TC+ABC+LPV+r'
                                                                                                     when 162565 then '3TC+NVP+TDF'
                                                                                                     when 1652 then '3TC+NVP+AZT'
                                                                                                     when 162561 then '3TC+AZT+LPV+r'
                                                                                                     when 164511 then 'AZT+3TC+ATV+r'
                                                                                                     when 164512 then 'TDF+3TC+ATV+r'
                                                                                                     when 162560 then '3TC+D4T+LPV+r'
                                                                                                     when 162563 then '3TC+ABC+EFV'
                                                                                                     when 162562 then 'ABC+LPV+R+TDF'
                                                                                                     when 162559 then 'ABC+DDI+LPV+r' end, ''),
                                                                                         NULLIF(
                                                                                                 case mid(max(concat(pre.visit_date, pre.HAART_regimen)), 11)
                                                                                                     when 164968 then 'AZT+3TC+DTG'
                                                                                                     when 164969 then 'TDF+3TC+DTG'
                                                                                                     when 164970 then 'ABC+3TC+DTG'
                                                                                                     when 164505 then 'TDF+3TC+EFV'
                                                                                                     when 792 then 'D4T+3TC+NVP'
                                                                                                     when 160124 then 'AZT+3TC+EFV'
                                                                                                     when 160104 then 'D4T+3TC+EFV'
                                                                                                     when 161361 then 'EDF+3TC+EFV'
                                                                                                     when 104565 then 'EFV+FTC+TDF'
                                                                                                     when 162201 then '3TC+LPV+TDF+r'
                                                                                                     when 817 then 'ABC+3TC+AZT'
                                                                                                     when 162199 then 'ABC+NVP+3TC'
                                                                                                     when 162200 then '3TC+ABC+LPV+r'
                                                                                                     when 162565 then '3TC+NVP+TDF'
                                                                                                     when 1652 then '3TC+NVP+AZT'
                                                                                                     when 162561 then '3TC+AZT+LPV+r'
                                                                                                     when 164511 then 'AZT+3TC+ATV+r'
                                                                                                     when 164512 then 'TDF+3TC+ATV+r'
                                                                                                     when 162560 then '3TC+D4T+LPV+r'
                                                                                                     when 162563 then '3TC+ABC+EFV'
                                                                                                     when 162562 then 'ABC+LPV+R+TDF'
                                                                                                     when 162559 then 'ABC+DDI+LPV+r' end, '')
                                                                                   )                                                  as previous_art_regimen
                                                                        from dwapi_etl.etl_hiv_enrollment e
                                                                                 left join dwapi_etl.etl_pre_hiv_enrollment_art pre
                                                                                           on e.encounter_id = pre.encounter_id and e.patient_id = pre.patient_id
                                                                        group by e.patient_id) enr on enr.patient_id = e.patient_id
                                                            left outer join dwapi_etl.etl_patient_hiv_followup fup
                                                                            on fup.patient_id = e.patient_id
                                                   group by e.patient_id) reg on reg.patient_id = hiv.patient_id
                                  join kenyaemr_etl.etl_default_facility_info i
                         where d.unique_patient_no is not null
                         group by d.patient_id
                         having min(hiv.visit_date) is not null
                            and StartARTDate is not null"|dwhstage|0|PatientArtExtract|2|a6221aa4-0e85-11e8-ba89-0ed5f89f718b
3C742EB0-5856-E811-8E16-9CB6D0DA773C|Patient Baselines|NDWH|a6221856-0e85-11e8-ba89-0ed5f89f718b|"select '' AS SatelliteName, 0 AS FacilityId, d.unique_patient_no as PatientID,
                                     d.patient_id as PatientPK,
                                        p_dates.uuid  as RecordUUID,
                                     (select siteCode from kenyaemr_etl.etl_default_facility_info) as SiteCode,
                                      mid(max(if(l.visit_date<=p_dates.enrollment_date,concat(l.visit_date,test_result),null)),11) as eCd4,
                                      DATE(left(max(if(l.visit_date <= p_dates.enrollment_date, concat(l.visit_date, test_result), null)),	
                                      10)) as eCd4Date,
                                        case coalesce(p_dates.ewho, mid(min(concat(date(fup.visit_date), fup.who_stage)), 11))	
                                      when 1220 then 1	
                                      when 1221 then 2	
                                      when 1222 then 3	
                                      when 1223 then 4	
                                      when 1204 then 1	
                                      when 1205 then 2	
                                      when 1206 then 3	
                                      when 1207 then 4	
                                      end as ewho,
                                        coalesce(p_dates.ewho_date, left(min(concat(date(fup.visit_date), fup.who_stage)), 10))    as eWHODate,
                                     '' as bCD4,
                                     NULL as bCD4Date,
                                     '' as bWHO,
                                     NULL as bWHODate,
                                        case mid(max(concat(fup.visit_date, fup.who_stage)), 11)	
                                      when 1220 then 1	
                                      when 1221 then 2	
                                      when 1222 then 3	
                                      when 1223 then 4	
                                      when 1204 then 1	
                                      when 1205 then 2	
                                      when 1206 then 3	
                                      when 1207 then 4 end  as lastwho,
                                       DATE(left(max(concat(fup.visit_date, fup.who_stage)), 10)) as lastwhodate,
                                            mid(max(concat(l.visit_date, l.test_result)), 11)             as lastcd4,
                                            DATE(left(max(concat(l.visit_date, l.test_result)), 10))      as lastcd4date,
                                            mid(max(if(l.visit_date > p_dates.six_month_date and l.visit_date < p_dates.twelve_month_date,
                                                       concat(l.visit_date, test_result), null)),
                                                11)                                                       as m6Cd4,
                                            DATE(left(max(if(l.visit_date >= p_dates.six_month_date and l.visit_date < p_dates.twelve_month_date,
                                                             concat(l.visit_date, test_result), null)),
                                                      10))                                                as m6Cd4Date,
                                            mid(max(if(l.visit_date >= p_dates.twelve_month_date, concat(l.visit_date, test_result), null)),
                                                11)                                                       as m12Cd4,
                                            DATE(left(max(if(l.visit_date > p_dates.twelve_month_date, concat(l.visit_date, test_result), null)),
                                                      10))                                                as m12Cd4Date,
                                      '' as eWAB, NULL as eWABDate,'' as bWAB, NULL as bWABDAte,
                                      'KenyaEMR' as Emr,
                                      'Kenya HMIS II' as Project,
                                      '' AS LastWaB,NULL AS LastWABDate, 
                                     fup.date_created as date_created,	
                                     fup.date_last_modified as date_last_modified,
                                   fup.voided                                                                              as Voided
                                     from dwapi_etl.etl_patient_hiv_followup fup
           join dwapi_etl.etl_patient_demographics d on d.patient_id = fup.patient_id
           join (select e.patient_id,
                        e.uuid,
                        date_add(date_add(min(e.visit_date), interval 3 month), interval 1 day)  as enrollment_date,
                        date_add(date_add(min(e.visit_date), interval 6 month), interval 1 day)  as six_month_date,
                        date_add(date_add(min(e.visit_date), interval 12 month), interval 1 day) as twelve_month_date,
                        mid(min(concat(e.visit_date, e.who_stage)), 11)                          as ewho,
                        left(min(concat(date(e.visit_date), e.who_stage)), 10)                   as ewho_date,
                        e.date_created,
                        e.date_last_modified
                 from dwapi_etl.etl_hiv_enrollment e
                 group by e.patient_id) p_dates on p_dates.patient_id = fup.patient_id
           left outer join dwapi_etl.etl_laboratory_extract l
                           on l.patient_id = fup.patient_id and l.lab_test in (5497, 730)
  where d.unique_patient_no is not null
  group by fup.patient_id
  order by m6cd4date desc"|dwhstage|0|PatientBaselineExtract|3|a6221aa4-0e85-11e8-ba89-0ed5f89f718b
38742EB0-5856-E811-8E16-9CB6D0DA773C|Patient Status|NDWH|a6221856-0e85-11e8-ba89-0ed5f89f718b|"select '' AS SatelliteName,
                                    0                                                                           AS FacilityId,
                                    d.unique_patient_no                                                         as PatientID,
                                    d.patient_id                                                                as PatientPK,
                                        disc.uuid                                                                   as RecordUUID,
                                    i.siteCode                                                                  as SiteCode,
                                    i.FacilityName                                                              as FacilityName,
                                    ''                                                                          as ExitDescription,
                                    'KenyaEMR'                                                                  as Emr,
                                    'Kenya HMIS II'                                                             as Project,
                                    max(date(disc.visit_date))                                                  AS ExitDate,
                                    max(date(disc.effective_discontinuation_date))                              AS EffectiveDiscontinuationDate,
                                    mid(max(concat(visit_date, (case discontinuation_reason
                                            when 159492 then 'Transfer Out'
                                            when 160034 then 'Died'
                                            when 5240 then 'LTFU'
                                            when 819 then 'Stopped Treatment'
                                            else '' end), '')), 20)                       as ExitReason,
                                    if(e.latest_enrolment_date > greatest(coalesce(max(date(disc.effective_discontinuation_date)), '0000-00-00'),
                                                coalesce(max(date(disc.visit_date)), '0000-00-00')), e.latest_enrolment_date,
                                                null)                                                                    as ReEnrollmentDate,
                                    (case mid(max(concat(date(disc.visit_date), disc.death_reason)), 11)
                                                when 163324 then 'HIV disease resulting in TB'
                                                when 116030 then 'HIV disease resulting in cancer'
                                                when 160159 then 'HIV disease resulting in other infectious and parasitic diseases'
                                                when 160158 then 'Other HIV disease resulting in other diseases or conditions leading to death'
                                                when 133478 then 'Other natural causes not directly related to HIV'
                                                when 145439 then 'Non-communicable diseases such as Diabetes and hypertension'
                                                when 123812 then 'Non-natural causes'
                                                when 42917 then 'Unknown cause'
                                                else '' end)                                                             as ReasonForDeath,
                                    (case mid(max(concat(date(disc.visit_date), disc.specific_death_cause)), 11)
                                                when 156673 then 'HIV disease resulting in mycobacterial infection'
                                                when 155010 then 'HIV disease resulting in Kaposis sarcoma'
                                                when 156667 then 'HIV disease resulting in Burkitts lymphoma'
                                                when 115195 then 'HIV disease resulting in other types of non-Hodgkin lymphoma'
                                                when 157593
                                                                                then 'HIV disease resulting in other malignant neoplasms of lymphoid and haematopoietic and related tissue'
                                                when 156672 then 'HIV disease resulting in multiple malignant neoplasms'
                                                when 159988 then 'HIV disease resulting in other malignant neoplasms'
                                                when 5333 then 'HIV disease resulting in other bacterial infections'
                                                when 116031 then 'HIV disease resulting in unspecified malignant neoplasms'
                                                when 123122 then 'HIV disease resulting in other viral infections'
                                                when 156669 then 'HIV disease resulting in cytomegaloviral disease'
                                                when 156668 then 'HIV disease resulting in candidiasis'
                                                when 5350 then 'HIV disease resulting in other mycoses'
                                                when 882
                                                                                then 'HIV disease resulting in Pneumocystis jirovecii pneumonia - HIV disease resulting in Pneumocystis carinii pneumonia'
                                                when 156671 then 'HIV disease resulting in multiple infections'
                                                when 160159 then 'HIV disease resulting in other infectious and parasitic diseases'
                                                when 171
                                                                                then 'HIV disease resulting in unspecified infectious or parasitic disease - HIV disease resulting in infection NOS'
                                                when 156670
                                                                                then 'HIV disease resulting in other specified diseases including encephalopathy or lymphoid interstitial pneumonitis or wasting syndrome and others'
                                                when 160160
                                                                                then 'HIV disease resulting in other conditions including acute HIV infection syndrome or persistent generalized lymphadenopathy or hematological and immunological abnormalities and others'
                                                when 161548 then 'HIV disease resulting in Unspecified HIV disease'
                                                    end)                                                                    as SpecificDeathReason,
                                    (case mid(max(concat(date(disc.visit_date), disc.trf_out_verified)), 11)
                                                when 1065 then 'Yes'
                                                when 1066 then 'No' end)                                                 as TOVerified,
                                    mid(max(concat(date(disc.visit_date), disc.trf_out_verification_date)), 11) as TOVerifiedDate,
                                    mid(max(concat(disc.visit_date, disc.date_died)), 11)                       as DeathDate,
                                    disc.date_created                                                           as Date_Created,
                                    disc.date_last_modified                                                     as Date_Last_Modified,
                                                        null as Voided
                               from dwapi_etl.etl_patient_program_discontinuation disc
                                        left join (select e.patient_id                                       as patient_id,
                                                          max(e.visit_date)                                  as latest_enrolment_date,
                                                          mid(max(concat(e.visit_date, e.patient_type)), 11) as patient_type
                                                   from dwapi_etl.etl_hiv_enrollment e
                                                   group by e.patient_id) e on e.patient_id = disc.patient_id
                                        join dwapi_etl.etl_patient_demographics d on d.patient_id = disc.patient_id
                                        join kenyaemr_etl.etl_default_facility_info i
                               where d.unique_patient_no is not null
                                 and disc.program_name = 'HIV'
                               group by PatientID
                               order by disc.visit_date ASC"|dwhstage|0|PatientStatusExtract|4|a6221aa4-0e85-11e8-ba89-0ed5f89f718b
3D742EB0-5856-E811-8E16-9CB6D0DA773C|Patient Labs|NDWH|a6221856-0e85-11e8-ba89-0ed5f89f718b|"select '' AS SatelliteName, 0 AS FacilityId,
                                       d.unique_patient_no as PatientID, 
                                      l.uuid   as RecordUUID, 
                                      d.patient_id as PatientPK, 
                                      l.encounter_id as VisitId,
                                       coalesce(DATE(l.date_test_requested), DATE(l.visit_date)) as OrderedByDate,
                                       DATE(l.date_test_result_received) as ReportedByDate,
                                       i.siteCode as SiteCode,
                                       i.facilityName as FacilityName,
                                       (case lab_test
                                       when 5497 then 'CD4 Count'
                                       when 730 then 'CD4 Percent'
                                       when 654 then 'ALT'
                                       when 790 then 'Serum creatinine (umol/L)'
                                       when 167452 then 'Serum Cryptococcal Ag'
                                       when 167459 then 'TB LAM'
                                       when 856 then 'HIV Viral Load'
                                       when 1305 then 'HIV Viral Load'
                                       when 21 then 'Hemoglobin (HGB)'
                                       when 1029 then 'VDRL Titre'
                                       when 1031 then 'Treponema Pallidum Hemagglutination Assay'
                                       when 1619 then 'Rapid Plasma Reagin'
                                       when 1032 then 'Treponema Pallidum Hemagglutination Assay, Qualitative'
                                       else '' end)                                                                as TestName,
                                       date(l.visit_date)                                                               as DateSampleTaken,
                                       (case l.order_reason
                                       when 843 then 'Confirmation of treatment failure (repeat VL)'
                                       when 1434 then 'Pregnancy'
                                       when 162080 then 'Baseline VL (for infants diagnosed through EID)'
                                       when 1259 then 'Single Drug Substitution'
                                       when 159882 then 'Breastfeeding'
                                       when 163523 then 'Clinical failure'
                                       when 161236 then 'Routine'
                                       when 160032 then 'Confirmation of persistent low level Viremia (PLLV)' end) as Reason,
                                       if(lab_test = 299, (case test_result
                                       when 1228 then 'REACTIVE'
                                       when 1229 then 'NON-REACTIVE'
                                       when 1304 then 'POOR SAMPLE QUALITY' end),
                                       if(lab_test = 1030, (case test_result
                                       when 1138 then 'INDETERMINATE'
                                       when 664 then 'NEGATIVE'
                                       when 703 then 'POSITIVE'
                                       when 1304 then 'POOR SAMPLE QUALITY' end),
                                       if(lab_test = 302, (case test_result
                                       when 1115 then 'Normal'
                                       when 1116 then 'Abnormal'
                                       when 1067 then 'Unknown' end),
                                       if(lab_test = 32, (case test_result
                                       when 664 then 'NEGATIVE'
                                       when 703 then 'POSITIVE'
                                       when 1138 then 'INDETERMINATE' end),
                                       if(lab_test = 1305, (case test_result
                                       when 1306 then 'BEYOND DETECTABLE LIMIT'
                                       when 1301 then 'DETECTED'
                                       when 1302 then 'LDL'
                                       when 1304 then 'POOR SAMPLE QUALITY' end),
                                       if(lab_test = 1029,
                                       (case test_result when 664 then 'Negative' when 703 then 'Positive' end),
                                       if(lab_test = 1031, (case test_result
                                       when 1311 then '<1:2'
                                       when 1312 then '01:02'
                                       when 1313 then '1:4'
                                       when 1314 then '01:08'
                                       when 1315 then '01:16'
                                       when 1316 then '01:32'
                                       when 1317 then '>1:32'
                                       when 1304 then 'Poor Sample Quality'
                                       when 163621 then '1:64'
                                       when 163622 then '1:128'
                                       when 163623 then '1:256'
                                       when 163624 then '>1:572' end),
                                       if(lab_test = 1032, (case test_result
                                       when 703 then 'Positive'
                                       when 664 then 'Negative'
                                       when 1300 then 'Equivocal'
                                       when 1304 then 'Poor Sample Quality' end),
                                       if(lab_test in (1619, 167452), (case test_result
                                       when 703 then 'Positive'
                                       when 664 then 'Negative'
                                       when 1067 then 'Unknown' end),
                                       if(lab_test = 167459, (case test_result
                                       when 163747 then 'Absent'
                                       when 163748 then 'Present' end),
                                       if(lab_test = 307, (case test_result
                                       when 1364 then 'Three Plus'
                                       when 1362 then 'One Plus'
                                       when 1363 then 'Two Plus'
                                       when 664 then 'Negative'
                                       when 159985 then 'Scanty'
                                       when 703 then 'Positive'
                                       when 160008 then 'Contaminated specimen'
                                       when 164369 then 'Results not available'
                                       when 1118 then 'Not done' end),
                                       if(lab_test = 162202, (case test_result
                                       when 664 then 'NEGATIVE'
                                       when 162203
                                       then 'Mycobacterium tuberculosis detected with rifampin resistance'
                                       when 162204
                                       then 'Mycobacterium tuberculosis detected without rifampin resistance'
                                       when 164104
                                       then 'Mycobacterium tuberculosis detected with indeterminate rifampin resistance'
                                       when 163611 then 'Invalid'
                                       when 1138 then 'INDETERMINATE' end),
                                       test_result))))))))))))                                  as TestResult,
                                       NULL                                                                             as EnrollmentTest,
                                       o.sample_type                                                                    as SampleType,
                                       'KenyaEMR'                                                                       as Emr,
                                       'Kenya HMIS II'                                                                  as Project,
                                       l.date_created                                                                   as Date_Created,
                                       l.date_last_modified                                                             as Date_Last_Modified,	
         l.voided                                                                         as Voided	
         from dwapi_etl.etl_laboratory_extract l	
         left join openmrs.kenyaemr_order_entry_lab_manifest_order o on l.order_id = o.order_id	
         join dwapi_etl.etl_patient_demographics d on d.patient_id = l.patient_id	
         join kenyaemr_etl.etl_default_facility_info i	
         where d.unique_patient_no is not null"|dwhstage|0|PatientLabExtract|5|a6221aa4-0e85-11e8-ba89-0ed5f89f718b
3F742EB0-5856-E811-8E16-9CB6D0DA773C|Patient Pharmacy|NDWH|a6221856-0e85-11e8-ba89-0ed5f89f718b|"select 'Government'                                                 AS Provider,
                                  ''                                                           AS SatelliteName,
                                  0                                                            as FacilityId,
                                  d.unique_patient_no                                          as PatientID,
                                  d.patient_id                                                 as PatientPK,
                                    ph.uuid                                                    as RecordUUID,
                                  i.Facilityname                                               as FacilityName,
                                  i.sitecode                                                   as siteCode,
                                  ph.visit_id                                                  as VisitID,
                                  Drug,
                                  ph.visit_date                                                as DispenseDate,
                                  ph.duration                                                  AS duration,
                                  ph.duration                                                  AS PeriodTaken,
                                  DATE_ADD(ph.visit_date, INTERVAL ph.duration DAY)            as ExpectedReturn,
                                  'KenyaEMR'                                                   as Emr,
                                  'Kenya HMIS II'                                              as Project,
                                  CASE
                                      WHEN is_arv = 1 THEN 'ARV'
                                      WHEN is_ctx = 1 OR is_dapsone = 1 THEN 'Prophylaxis' END AS TreatmentType,
                                  ph.RegimenLine,
                                  CASE
                                      WHEN is_ctx = 1 THEN 'CTX'
                                      WHEN is_dapsone = 1 THEN 'DAPSONE' END                   AS ProphylaxisType,
                                  CAST(now() as Date)                                          AS DateExtracted,
                                  ph.RegimenChangedSwitched                                    as RegimenChangedSwitched,
                                  ph.RegimenChangeSwitchReason                                 as RegimenChangeSwitchReason,
                                  ph.StopRegimenReason                                         as StopRegimenReason,
                                  ph.StopRegimenDate                                           as StopRegimenDate,
                                  ph.date_created,
                                  ph.date_last_modified,
                ph.voided                                                    as Voided
         from (SELECT *
               FROM ((select patient_id,
                             uuid,
                             visit_id,
                             visit_date,
                             encounter_id,
                             (case drug when 105281 then 'CTX' when 74250 then 'DAPSONE' end) as drug,
                             is_arv,
                             is_ctx,
                             is_dapsone,
                             drug_name                                                        as drugreg,
                             frequency,
                             visit_date                                                       as DispenseDate,
                             duration_in_days                                                 as duration,
                             duration_in_days                                                 as PeriodTaken,
                             DATE_ADD(visit_date, INTERVAL duration_in_days DAY)              as ExpectedReturn,
                             CASE WHEN is_ctx = 1 OR is_dapsone = 1 THEN 'Prophylaxis' END    AS TreatmentType,
                             ''                                                               as RegimenLine,
                             ''                                                               as regimen,
                             CASE
                                 WHEN is_ctx = 1 THEN 'CTX'
                                 WHEN is_dapsone = 1 THEN 'DAPSONE' END                       AS ProphylaxisType,
                             ''                                                               as previousRegimen,
                             ''                                                               as RegimenChangedSwitched,
                             ''                                                               as RegimenChangeSwitchReason,
                             ''                                                               as StopRegimenReason,
                             ''                                                               as StopRegimenDate,
                             ''                                                               as prev_Regimen,
                             ph.date_created,
                             ph.date_last_modified,
                             ph.voided                                                        as Voided
                      from dwapi_etl.etl_pharmacy_extract ph
                      where is_arv = 1
                      group by ph.encounter_id
                      order by patient_id, DispenseDate)
                     UNION ALL
                     (SELECT e.patient_id                                                                        as patient_id,
                             e.uuid                                                                              as uuid,
                             ''                                                                                  as visit_id,
                             e.visit_date,
                             e.encounter_id,
                             regimen                                                                                drug,
                             1                                                                                   as is_arv,
                             0                                                                                   as is_ctx,
                             0                                                                                   as is_dapsone,
                             regimen_name                                                                        as drugreg,
                             ''                                                                                     frequency,
                             date_started                                                                        as DispenseDate,
                             null                                                                                as duration,
                             null                                                                                as PeriodTaken,
                             null                                                                                as ExpectedReturn,
                             'ARV'                                                                               AS TreatmentType,
                             e.regimen_line                                                                      as regimen_line,
                             e.regimen                                                                           as regimen,
                             ''                                                                                  as ProphylaxisType,
                             @prev_regimen                                                                          previousRegimen,
                             coalesce(@s := (if(ifnull(@prev_regimen_line, '') <> regimen_line and discontinued = 1, 'Switch',
                                                NULL)),
                                      (if(@prev_regimen <> regimen and discontinued = 1, 'Substitution', NULL))) as RegimenChangedSwitched,
                             (case reason_discontinued
                                  when 160559 then 'Risk of pregnancy'
                                  when 160561 then 'New drug available'
                                  when 160567 then 'New diagnosis of Tuberculosis'
                                  when 160569 then 'Virological failure'
                                  when 159598 then 'Non-compliance with treatment or therapy'
                                  when 1754 then 'Drugs out of stock'
                                  when 1434 then 'Pregnancy'
                                  when 1253 then 'Completed PMTCT'
                                  when 843 then 'Clinical treatment failure'
                                  when 160566 then 'Immunological failure'
                                  when 102 then 'Drug toxicity'
                                  when 5622 then 'Other'
                                  else '' end)                                                                   as RegimenChangeSwitchReason,
                             (case reason_discontinued
                                  when 102 then 'Drug toxicity'
                                  when 160567 then 'New diagnosis of Tuberculosis'
                                  when 160569 then 'Virologic failure'
                                  when 159598 then 'Non-compliance with treatment or therapy'
                                  when 1754 then 'Medications unavailable'
                                  when 160016 then 'Planned Treatment interruption'
                                  when 1434 then 'Currently pregnant'
                                  when 1253 then 'Completed PMTCT'
                                  when 843 then 'Regimen failure'
                                  when 5622 then 'Other'
                                  when 160559 then 'Risk of pregnancy'
                                  when 160561 then 'New drug available'
                                  else '' end)                                                                   as StopRegimenReason,
                             if(discontinued = 1, date_discontinued, NULL)                                       as StopRegimenDate,
                             @prev_regimen := e.regimen                                                             prev_regimen,
                             e.date_created                                                                      as date_created,
                             e.date_last_modified                                                                as date_last_modified,
                             e.voided                                                                            as Voided
                      FROM dwapi_etl.etl_drug_event e,
                           (SELECT @s := 0, @prev_regimen := -1, @x := 0, @prev_regimen_line := -1) s
                      where e.program = 'HIV'
                      group by e.encounter_id
                      ORDER BY e.patient_id, e.date_started)
                     UNION ALL
                     (select patient_id,
                             uuid,
                             visit_id,
                             visit_date,
                             encounter_id,
                             CASE
                              WHEN do.drug_concept_id = '84797' THEN 'TDF'
                              WHEN do.drug_concept_id LIKE '84797|%' THEN CONCAT('TDF+', do.drug_short_name)
                              WHEN do.drug_concept_id LIKE '%|84797|%' THEN INSERT(do.drug_short_name,
                              LOCATE('+', do.drug_short_name) + 1, 0,
                              'TDF+')
                              WHEN do.drug_concept_id LIKE '%|84797' THEN CONCAT(do.drug_short_name, '+TDF')
                              WHEN do.drug_concept_id LIKE '70057|%' THEN CONCAT('ABC+', do.drug_short_name)
                              WHEN do.drug_concept_id LIKE '%|70057|%' THEN INSERT(do.drug_short_name,
                              LOCATE('+', do.drug_short_name) + 1, 0,
                              'ABC+')
                              WHEN do.drug_concept_id LIKE '%|70057' THEN CONCAT(do.drug_short_name, '+ABC')
                              WHEN do.drug_concept_id = '70057' THEN 'ABC'
                              WHEN do.drug_concept_id = '105281' THEN 'CTX'
                              WHEN do.drug_concept_id = '71648' THEN 'ATV/r'
                              WHEN do.drug_concept_id = '70246' THEN 'ACYCLOVIR SODIUM'
                              ELSE do.drug_short_name
                              END                                                              as drug,
                             1                                                                           as is_arv,
                             ''                                                                          as is_ctx,
                             ''                                                                          as is_dapsone,
                             drug_name                                                                   as drugreg,
                             frequency,
                             visit_date                                                                  as DispenseDate,
                             (case duration_units
                                  when 'DAYS' then duration
                                  when 'MONTHS' then duration * 30
                                  when 'WEEKS' then duration * 7 end)                                    as duration,
                             (case duration_units
                                  when 'DAYS' then duration
                                  when 'MONTHS' then duration * 30
                                  when 'WEEKS' then duration * 7 end)                                    as PeriodTaken,
                             DATE_ADD(visit_date, INTERVAL (case duration_units
                                                                when 'DAYS' then duration
                                                                when 'MONTHS' then duration * 30
                                                                when 'WEEKS' then duration * 7 end) DAY) as ExpectedReturn,
                             ''                                                                          AS TreatmentType,
                             ''                                                                          as RegimenLine,
                             drug_name                                                                   as regimen,
                             ''                                                                          AS ProphylaxisType,
                             ''                                                                          as previousRegimen,
                             ''                                                                          as RegimenChangedSwitched,
                             ''                                                                          as RegimenChangeSwitchReason,
                             ''                                                                          as StopRegimenReason,
                             ''                                                                          as StopRegimenDate,
                             ''                                                                          as prev_Regimen,
                             do.date_created,
                             do.date_last_modified,
                             do.voided                                                                   as Voided
                      from dwapi_etl.etl_drug_order do
                      group by do.order_group_id, do.patient_id, do.encounter_id
                      order by do.patient_id, DispenseDate)) A
               order by A.DispenseDate, A.patient_id) ph
                  join dwapi_etl.etl_patient_demographics d on d.patient_id = ph.patient_id
                  left outer join concept_name cn on cn.concept_id = ph.drug and cn.concept_name_type = 'FULLY_SPECIFIED'
             and cn.locale = 'en'
                  left outer join concept_name cn2 on cn2.concept_id = ph.drug and cn2.concept_name_type = 'SHORT'
             and cn.locale = 'en'
                  left outer join dwapi_etl.etl_patient_hiv_followup fup on fup.encounter_id = ph.encounter_id
             and fup.patient_id = ph.patient_id
                  join kenyaemr_etl.etl_default_facility_info i
         where unique_patient_no is not null
           and drugreg is not null
         order by ph.patient_id, ph.DispenseDate"|dwhstage|0|PatientPharmacyExtract|6|a6221aa4-0e85-11e8-ba89-0ed5f89f718b
40742EB0-5856-E811-8E16-9CB6D0DA773C|Patient Visit|NDWH|a6221856-0e85-11e8-ba89-0ed5f89f718b|"select ''                                                                     AS SatelliteName,
                                                0                                                                      AS FacilityId,
                                                d.unique_patient_no                                                    as PatientID,
                                                d.patient_id                                                           as PatientPK,
                                                fup.uuid                                                             as RecordUUID,
                                                i.facilityName                                                         as FacilityName,
                                                i.siteCode                                                             as SiteCode,
                                                fup.visit_id                                                           as VisitId,
                                                case
                                                    when fup.visit_date < '1990-01-01' then null
                                                    else CAST(fup.visit_date AS DATE) end                                AS VisitDate,
                                                'Out Patient'                                                          as Service,
                                                (case fup.visit_scheduled
                                                     when 1 then 'Scheduled'
                                                     when 2 then 'Unscheduled'
                                                     else '' end)                                                        as VisitType,
                                                (case fup.person_present
                                                     when 978 then 'Self'
                                                     when 161642 then 'Treatment supporter'
                                                     when 159802 then 'Refill visit documentation'
                                                     when 5622 then 'Other' end)                                         as VisitBy,
                                                case fup.who_stage
                                                    when 1220 then 1
                                                   when 1221 then 2
                                                   when 1222 then 3
                                                   when 1223 then 4
                                                   when 1204 then 1
                                                   when 1205 then 2
                                                   when 1206 then 3
                                                   when 1207 then 4
                                                    else ''
                                                    end                                                                as WHOStage,
                                               fup.who_stage_associated_oi                                              as WHOStagingOI,
                                                null                                                                   as WABStage,
                                                case fup.pregnancy_status
                                                    when 1065 then 'Yes'
                                                    when 1066 then 'No'
                                                    end                                                                as Pregnant,
                                                CAST(fup.last_menstrual_period AS DATE)                                as LMP,
                                                CAST(fup.expected_delivery_date AS DATE)                               as EDD,
                                                t.height                                                               as Height,
                                                t.weight                                                               as Weight,
                                                concat(t.systolic_pressure, '/', t.diastolic_pressure)                 as BP,
                                                t.temperature                                                          as Temp,
                                                t.z_score                                                              as ZScoreAbsolute,
                                                case t.z_score
                                                           when 1115 then 'Normal (Median)'
                                                           when 123814 then 'Mild (-1 SD)'
                                                           when 123815 then 'Moderate (-2 SD)'
                                                           when 164131 then 'Severe (-3 SD and -4 SD)' end             as ZScore,
                                                t.pulse_rate                                                         as PulseRate,
                                                t.respiratory_rate                                                   as RespiratoryRate,
                                                t.oxygen_saturation                                                  as OxygenSaturation,
                                                t.muac                                                               as Muac,
                                                (case t.nutritional_status
                                                     when 1115 then 'Normal'
                                                     when 163302 then 'Severe acute malnutrition'
                                                     when 163303 then 'Moderate acute malnutrition'
                                                     when 114413 then 'Overweight/Obese'
                                                     else '' end)                                                        as NutritionalStatus,
                                                (case fup.ever_had_menses
                                                     when 1065 then 'Yes'
                                                     when 1066 then 'No'
                                                     when 1175 then 'N/A' end)                                           as EverHadMenses,
                                                if(d.gender = 'F',(case fup.breastfeeding when 1065 then 'Yes' when 1066 then 'No' end),'N/A')  as Breastfeeding,
                                                (case menopausal when 113928 then 'Yes' end)                           as Menopausal,
                                                (case prophylaxis_given
                                                     when 105281 then 'Cotrimoxazole'
                                                     when 74250 then 'Dapsone'
                                                     when 1107 then 'None' end)                                          as ProphylaxisUsed,
                                                (case fup.ctx_adherence
                                                     when 159405 then 'Good'
                                                     when 163794 then 'Fair'
                                                     when 159407 then 'Bad'
                                                     else '' end)                                                        as CTXAdherence,
                                                de.regimen                                                             as CurrentRegimen,
                                                (case fup.reason_not_using_family_planning
                                                     when 160572 then 'Thinks cant get pregnant'
                                                     when 160573 then 'Not sexually active now'
                                                     when 5622 then 'Other'
                                                     else '' end)                                                        as NoFPReason,
                                                'ART|CTX'                                                              as AdherenceCategory,
                                                concat(
                                                        IF(fup.arv_adherence = 159405, 'Good',
                                                           IF(fup.arv_adherence = 159406, 'Fair', IF(fup.arv_adherence = 159407, 'Poor', ''))),
                                                        IF(fup.arv_adherence in (159405, 159406, 159407), '|', ''),
                                                        IF(fup.ctx_adherence = 159405, 'Good',
                                                           IF(fup.ctx_adherence = 159406, 'Fair', IF(fup.ctx_adherence = 159407, 'Poor', '')))
                                                    )                                                                  AS Adherence,
                                                (case next_appointment_reason
                                                     when 160523 then 'Follow up'
                                                     when 1283 then 'Lab tests'
                                                     when 159382 then 'Counseling'
                                                     when 160521 then 'Pharmacy Refill'
                                                     when 5622 then 'Other'
                                                     else '' end)                                                        as TCAReason,
                                                fup.clinical_notes                                                     as ClinicalNotes,
                                                ''                                                                     as OI,
                                                NULL                                                                   as OIDate,
                                                fup.general_examination                                                as GeneralExamination,
                                                (case fup.system_examination
                                                     when 1115 then 'Normal'
                                                     when 1116 then 'Abnormal' end)                                      as SystemExamination,
                                                (case fup.skin_findings
                                                     when 150555 then 'Abscess'
                                                     when 125201 then 'Swelling/Growth'
                                                     when 135591 then 'Hair Loss'
                                                     when 136455 then 'Itching'
                                                     when 507 then 'Kaposi Sarcoma'
                                                     when 1249 then 'Skin eruptions/Rashes'
                                                     when 5244 then 'Oral sores' end)                                    as Skin,
                                                (case fup.eyes_findings
                                                     when 123074 then 'Visual Disturbance'
                                                     when 140940 then 'Excessive tearing'
                                                     when 131040 then 'Eye pain'
                                                     when 127777 then 'Eye redness'
                                                     when 140827 then 'Light sensitive'
                                                     when 139100 then 'Itchy eyes' end)                                  as Eyes,
                                                (case fup.ent_findings
                                                     when 148517 then 'Apnea'
                                                     when 139075 then 'Hearing disorder'
                                                     when 119558 then 'Dental caries'
                                                     when 118536 then 'Erythema'
                                                     when 106 then 'Frequent colds'
                                                     when 147230 then 'Gingival bleeding'
                                                     when 135841 then 'Hairy cell leukoplakia'
                                                     when 117698
                                                         then 'Hearing loss'
                                                     when 138554 then 'Hoarseness'
                                                     when 507 then 'Kaposi Sarcoma'
                                                     when 152228 then 'Masses'
                                                     when 128055 then 'Nasal discharge'
                                                     when 133499 then 'Nosebleed'
                                                     when 160285 then 'Pain'
                                                     when 110099 then 'Post nasal discharge'
                                                     when 126423 then 'Sinus problems'
                                                     when 126318 then 'Snoring'
                                                     when 158843 then 'Sore throat'
                                                     when 5244 then 'Oral sores'
                                                     when 5334 then 'Thrush'
                                                     when 123588 then 'Tinnitus'
                                                     when 124601 then 'Toothache'
                                                     when 123919 then 'Ulcers'
                                                     when 111525 then 'Vertigo' end)                                     as ENT,
                                                (case fup.chest_findings
                                                     when 146893 then 'Bronchial breathing'
                                                     when 127640 then 'Crackles'
                                                     when 145712 then 'Dullness'
                                                     when 164440 then 'Reduced breathing'
                                                     when 127639 then 'Respiratory distress'
                                                     when 5209 then 'Wheezing' end)                                      as Chest,
                                                (case fup.cvs_findings
                                                     when 140147 then 'Elevated blood pressure'
                                                     when 136522 then 'Irregular heartbeat'
                                                     when 562 then 'Cardiac murmur'
                                                     when 130560 then 'Cardiac rub' end)                                 as CVS,
                                                (case fup.abdomen_findings
                                                     when 150915 then 'Abdominal distension'
                                                     when 5008 then 'Hepatomegaly'
                                                     when 5103 then 'Abdominal mass'
                                                     when 5009 then 'Splenomegaly'
                                                     when 5105 then 'Abdominal tenderness' end)                          as Abdomen,
                                                (case fup.cns_findings
                                                     when 118872 then 'Altered sensations'
                                                     when 1836 then 'Bulging fontenelle'
                                                     when 150817 then 'Abnormal reflexes'
                                                     when 120345 then 'Confusion'
                                                     when 157498 then 'Limb weakness'
                                                     when 112721 then 'Stiff neck'
                                                     when 136282 then 'Kernicterus' end)                                 as CNS,
                                                (case fup.genitourinary_findings
                                                     when 147241 then 'Bleeding'
                                                     when 154311 then 'Rectal discharge'
                                                     when 123529 then 'Urethral discharge'
                                                     when 123396 then 'Vaginal discharge'
                                                     when 124087 then 'Ulceration' end)                                  as Genitourinary,
                                                case ifnull(fup.family_planning_status, '')
                                                    when 695 then 'Currently using FP'
                                                    when 160652 then 'Not using FP'
                                                    when 1360 then 'Wants FP'
                                                    else ''
                                                    end                                                                as FamilyPlanningMethod,
                                                concat_ws('|',
                                                          nullif(case fup.substance_abuse_screening
                                                                     when 1065 then 'Screened for substance abuse'
                                                                     else ''
                                                                     end, ''),
                                                          nullif(case fup.condom_provided
                                                                     when 1065 then 'Condoms'
                                                                     else ''
                                                                     end, ''),
                                                          nullif(case fup.pwp_disclosure
                                                                     when 1065 then 'Disclosure'
                                                                     else ''
                                                                     end, ''),
                                                          nullif(case fup.pwp_partner_tested
                                                                     when 1065 then 'Partner Testing'
                                                                     else ''
                                                                     end, ''),
                                                          nullif(case fup.screened_for_sti
                                                                     when 1065 then 'Screened for STI'
                                                                     else ''
                                                                     end, ''),
                                               nullif(case fup.cacx_screening
                                               when 703 then 'Screened for CaCx'
                                               when 664 then 'Screened for CaCx'
                                               end, '')) as                                          PwP,
                                                case fup.pwp_pead_disclosure when 1066 then 'No disclosure' when 162979 then 'Partial disclosure' when 166982 then 'Full disclosure' end as PaedsDisclosure,
                                                if(fup.last_menstrual_period is not null,
                                                   timestampdiff(week, fup.last_menstrual_period, fup.visit_date), '') as GestationAge,
                                                case
                                                    when fup.next_appointment_date < '1990-01-01' then null
                                                    else CAST(fup.next_appointment_date AS DATE) end                     AS NextAppointmentDate,
                                                case when fup.refill_date < '1990-01-01' then null
                                                                      else CAST(fup.refill_date AS DATE) end                   AS RefillDate,
                                                'KenyaEMR'                                                             as Emr,
                                                'Kenya HMIS II'                                                        as Project,
                                                CAST(fup.substitution_first_line_regimen_date AS DATE)                 AS SubstitutionFirstlineRegimenDate,
                                                fup.substitution_first_line_regimen_reason                             AS SubstitutionFirstlineRegimenReason,
                                                CAST(fup.substitution_second_line_regimen_date AS DATE)                AS SubstitutionSecondlineRegimenDate,
                                                fup.substitution_second_line_regimen_reason                            AS SubstitutionSecondlineRegimenReason,
                                                CAST(fup.second_line_regimen_change_date AS DATE)                      AS SecondlineRegimenChangeDate,
                                                fup.second_line_regimen_change_reason                                  AS SecondlineRegimenChangeReason,
                                                CASE fup.stability
                                                    WHEN 1 THEN 'Stable'
                                                    WHEN 2 THEN 'Not Stable' END                                         as StabilityAssessment,
                                                (case fup.differentiated_care
                                                     when 164942 then 'Standard Care'
                                                     when 164943 then 'Fast Track'
                                                     when 164944 then 'Community ART Distribution - HCW Led'
                                                     when 164945 then 'Community ART Distribution - Peer Led'
                                                     when 164946 then 'Facility ART Distribution Group'
                                                     else '' end)                                                        as DifferentiatedCare,
                                                (case population_type
                                                     when 164928 then 'General Population'
                                                     when 164929 then 'Key Population'
                                                     else '' end)                                                        as PopulationType,
                                                case fup.key_population_type
                                                    WHEN 105 THEN 'PWID'
                                                    WHEN 160578 THEN 'MSM'
                                                    WHEN 160579 THEN 'FSW'
                                                    when 165084 then 'MSW'
                                                    when 165085 then 'PWUD'
                                                    when 165100 then 'Transgender'
                                                    WHEN 1175 THEN 'N/A' END                                                        as KeyPopulationType,
                                                ''                                                                     as HCWConcern,
                                                fup.date_created                                                       as Date_Created,
                                                fup.date_last_modified                                                 as Date_Last_Modified,
                                     fup.voided                                                             as Voided
                              from dwapi_etl.etl_patient_demographics d
                                       join dwapi_etl.etl_patient_hiv_followup fup on fup.patient_id = d.patient_id
                                       join kenyaemr_etl.etl_default_facility_info i
                                       left join (select t.patient_id,
                                                         t.visit_date,
                                                         t.weight,
                                                         t.height,
                                                         t.systolic_pressure,
                                                         t.diastolic_pressure,
                                                         t.temperature,
                                                         t.z_score_absolute,
                                                         t.z_score,
                                                         t.pulse_rate,
                                                         t.respiratory_rate,
                                                         t.oxygen_saturation,
                                                         t.muac,
                                                         t.nutritional_status
                                                  from dwapi_etl.etl_patient_triage t) t
                                                 on fup.patient_id = t.patient_id and date(fup.visit_date) = date(t.visit_date)
                                       left join (select de.patient_id, mid(max(concat(de.visit_date, de.regimen)), 11) as regimen
                                                  from dwapi_etl.etl_drug_event de
                                                  where de.discontinued is null
                                                  group by de.patient_id) de on fup.patient_id = de.patient_id
                              where d.unique_patient_no is not null
                                and fup.visit_date > '1990-01-01'
                                and fup.next_appointment_date is not null
                                and fup.visit_id is not null"|dwhstage|0|PatientVisitExtract|7|a6221aa4-0e85-11e8-ba89-0ed5f89f718b
48742EB0-5856-E811-8E16-9CB6D0DA773C|Master Patient Index|CBS|a62216ee-0e85-11e8-ba89-0ed5f89f718b|"SELECT DISTINCT	*,
						LEFT([Gender],1)+[sxFirstName]+[sxLastName]+LTRIM(RTRIM(STR(YEAR(X.DOB)))) AS [sxPKValue],
						LEFT([Gender],1)+
										CASE
										WHEN CHARINDEX(';',[dmFirstName])>0 THEN
													SUBSTRING([dmFirstName],CHARINDEX(';',[dmFirstName])+1,LEN([dmFirstName]))
										ELSE
											[dmFirstName]
										END +
										CASE
										WHEN CHARINDEX(';',[dmLastName])>0 THEN
													SUBSTRING([dmLastName],CHARINDEX(';',[dmLastName])+1,LEN([dmLastName]))
										ELSE
											[dmLastName]
										END +LTRIM(RTRIM(STR(YEAR(DOB)))) AS [dmPKValue],
						CASE WHEN CHARINDEX(';',[dmLastName])>0 THEN
											LEFT([Gender],1)+ [sxFirstName]+ SUBSTRING([dmLastName],CHARINDEX(';',[dmLastName])+1,LEN([dmLastName]))+LTRIM(RTRIM(STR(YEAR(DOB))))
										ELSE
											LEFT([Gender],1)+ [sxFirstName]+[dmLastName]+LTRIM(RTRIM(STR(YEAR(DOB))))
										END AS [sxdmPKValue],
						LEFT([Gender],1)+[sxFirstName]+[sxLastName]+LTRIM(RTRIM(STR(CONVERT(VARCHAR(20),DOB,112)))) AS [sxPKValueDoB],
						LEFT([Gender],1)+
										CASE
										WHEN CHARINDEX(';',[dmFirstName])>0 THEN
													SUBSTRING([dmFirstName],CHARINDEX(';',[dmFirstName])+1,LEN([dmFirstName]))
										ELSE
											[dmFirstName]
										END +
										CASE
										WHEN CHARINDEX(';',[dmLastName])>0 THEN
													SUBSTRING([dmLastName],CHARINDEX(';',[dmLastName])+1,LEN([dmLastName]))
										ELSE
											[dmLastName]
										END +LTRIM(RTRIM(STR(CONVERT(VARCHAR(20),DOB,112)))) AS [dmPKValueDoB],
						CASE WHEN CHARINDEX(';',[dmLastName])>0 THEN
											LEFT([Gender],1)+ [sxFirstName]+ SUBSTRING([dmLastName],CHARINDEX(';',[dmLastName])+1,LEN([dmLastName]))+LTRIM(RTRIM(STR(CONVERT(VARCHAR(20),DOB,112))))
										ELSE
											LEFT([Gender],1)+ [sxFirstName]+[dmLastName]+LTRIM(RTRIM(STR(CONVERT(VARCHAR(20),DOB,112))))
										END AS [sxdmPKValueDoB]
						
						FROM
						(
						SELECT
									-------Demographics
									Ptn_Pk,a.PatientPK,a.SiteCode,a.FacilityName,
										case when a.HTSID is null then a.PatientID else a.HTSID end as Serial
						
												,UPPER([dFirstName]) FirstName
									,UPPER([dMiddleName]) MiddleName
												,UPPER([dLastName]) LastName
									,dbo.[fnReplaceInvalidChars](UPPER(REPLACE([dFirstName],'0','O'))) AS [FirstName_Normalized]
												,dbo.[fnReplaceInvalidChars](UPPER(REPLACE([dMiddleName],'0','O'))) AS [MiddleName_Normalized]
												,dbo.[fnReplaceInvalidChars](UPPER(REPLACE([dLastName],'0','O'))) AS [LastName_Normalized]
											,SOUNDEX(dbo.[fnReplaceInvalidChars](UPPER(REPLACE([dFirstName],'0','O')))) AS  [sxFirstName]
									,SOUNDEX(dbo.[fnReplaceInvalidChars](UPPER(REPLACE([dLastName],'0','O')))) AS [sxLastName]
									,SOUNDEX(dbo.[fnReplaceInvalidChars](UPPER(REPLACE([dMiddleName],'0','O')))) AS sxMiddleName
								,[dmFirstName]= dbo.fn_getPatientNameDoubleMetaphone(dbo.[fnReplaceInvalidChars](UPPER(REPLACE([dFirstName],'0','O'))))
								,[dmLastName] = dbo.fn_getPatientNameDoubleMetaphone(dbo.[fnReplaceInvalidChars](UPPER(REPLACE([dLastName],'0','O'))))
								,dmMiddleName = dbo.fn_getPatientNameDoubleMetaphone(dbo.[fnReplaceInvalidChars](UPPER(REPLACE([dMiddleName],'0','O'))))
								,a.[PhoneNumber]PatientPhoneNumber
									,NULL PatientAlternatePhoneNumber
												,a.[Gender]
												,a.[DOB]
									,a.[MaritalStatus]
									-------Patient Address
									,a.[PatientSource]
												,[Region]PatientCounty
												,[District]PatientSubCounty
												,[Village]PatientVillage
									-------Patient-Identifiers
									,mst.[PatientClinicID]PatientID
									,[NationalId][National_ID]
									,NULL as [NHIF_Number]
									,NULL as [Birth_Certificate]
									,b.[PatientID][CCC_Number]
									,ltrim(rtrim(DistrictRegistrationNr))[TB_Number]
												-------Next Of Kin
						
												,LTRIM(RTRIM(ContactName)) AS ContactName
												,[ContactRelation] AS  ContactRelation
												,[ContactPhoneNumber] as ContactPhoneNumber
												,[ContactAddress] as ContactAddress
									, NULL AS  NokNationalId
									-------Additional Variables
												,[DateConfirmedHIVPositive]
									,b.[StartARTDate]
									,[StartRegimen]StartARTRegimenCode
									,[StartRegimenLine]StartARTRegimenDesc
						
								FROM [dbo].[tmp_PatientMaster] a
								inner join [dbo].[mst_patient_decoded]mst on a.patientpk=mst.ptn_pk
								left  join (SELECT DISTINCT a.PatientPK, a.PatientID, a.RegistrationAtCCC, b.StartARTDate, b.StartRegimen, b.StartRegimenLine
								FROM
								tmp_PatientMaster AS a LEFT OUTER JOIN dbo.tmp_ARTPatients AS b ON a.PatientPK = b.PatientPK
								WHERE  (a.RegistrationAtCCC IS NOT NULL)) b on a.patientpk=b.patientpk
								Where len(a.htsid) > 0 or len(a.PatientID) > 0
							--ORDER BY PKV_2,Ptn_Pk  ASC
						) X
						INNER JOIN
						(
						SELECT
								Ptn_Pk,
										case when a.HTSID is null then a.PatientID else a.HTSID end as Serial
						FROM [dbo].[tmp_PatientMaster] a
								inner join [dbo].[mst_patient_decoded]mst on a.patientpk=mst.ptn_pk
								left  join (SELECT DISTINCT a.PatientPK, a.PatientID, a.RegistrationAtCCC, b.StartARTDate, b.StartRegimen, b.StartRegimenLine
								FROM dbo.tmp_PatientMaster AS a LEFT OUTER JOIN dbo.tmp_ARTPatients AS b ON a.PatientPK = b.PatientPK
								WHERE  (a.RegistrationAtCCC IS NOT NULL)) b on a.patientpk=b.patientpk
								Where len(a.htsid) > 0 or len(a.PatientID) > 0
						
						)Y
						ON
						Y.Ptn_Pk = X.Ptn_Pk AND Y.Serial= X.Serial"|MPI|1|MasterPatientIndex|1|a6221983-0e85-11e8-ba89-0ed5f89f718b
48742EB0-6656-E811-8E16-9CB6D0DA773C|Master Patient Index|CBS|a6221856-0e85-11e8-ba89-0ed5f89f718b|"
SELECT DISTINCT
-- -----Demographics
X.Ptn_Pk,
X.PatientPK,
siteCode,
FacilityName,
-- a.patient_clinic_number AS Serial
-- X.Ptn_Pk AS Serial
X.Serial
,FirstName
, MiddleName
,LastName
, FirstName_Normalized
, MiddleName_Normalized
,LastName_Normalized
,sxFirstName
,sxLastName
,sxMiddleName
,dmFirstName
, dmLastName
, dmMiddleName
, PatientPhoneNumber
, PatientAlternatePhoneNumber
,Gender
,DOB
,MaritalStatus
-- -----Patient Address
, PatientSource
, PatientCounty
, PatientSubCounty
, PatientVillage
-- -----Patient-Identifiers
,PatientID
,National_ID
,NHIF_Number
,Birth_Certificate
,CCC_Number
,TB_Number
-- -----Next Of Kin
,ContactName
,ContactRelation
, ContactPhoneNumber
,ContactAddress
, NokNationalId
-- -----Additional Variables
, DateConfirmedHIVPositive
,StartARTDate
,StartARTRegimenCode
, StartARTRegimenDesc,
CONCAT(LEFT(Gender ,1), sxFirstName ,sxLastName ,LTRIM(RTRIM(DATE_FORMAT(DOB, '%Y')))) AS sxPKValue,
CONCAT( CAST(LEFT(Gender ,1) AS CHAR CHARACTER SET utf8),
CAST(CASE
WHEN locate(';',dmFirstName )>0 THEN
SUBSTRING(dmFirstName , locate(';',dmFirstName )+1,LENGTH(dmFirstName ))
ELSE
dmFirstName
END AS CHAR CHARACTER SET utf8),
CAST(CASE
WHEN locate(';',dmLastName )>0 THEN
SUBSTRING(dmLastName , locate(';',dmLastName )+1,LENGTH(dmLastName ))
ELSE
dmLastName
END AS CHAR CHARACTER SET utf8),
CAST(LTRIM(RTRIM(DATE_FORMAT(DOB, '%Y')))AS CHAR CHARACTER SET utf8)

) AS dmPKValue ,

CASE WHEN locate(';',dmLastName )>0
THEN
CONCAT(
CAST(LEFT(Gender ,1) AS CHAR CHARACTER SET utf8)
, CAST(sxFirstName AS CHAR CHARACTER SET utf8)
, CAST(SUBSTRING(dmLastName , locate(';',dmLastName )+1,LENGTH(dmLastName )) AS CHAR CHARACTER SET utf8)
, CAST(LTRIM(RTRIM(DATE_FORMAT(DOB, '%Y')))AS CHAR CHARACTER SET utf8)
)
ELSE
CONCAT(
CAST(LEFT(Gender ,1)AS CHAR CHARACTER SET utf8)
, CAST(sxFirstName AS CHAR CHARACTER SET utf8)
, CAST(dmLastName AS CHAR CHARACTER SET utf8)
, CAST(LTRIM(RTRIM(DATE_FORMAT(DOB, '%Y'))) AS CHAR CHARACTER SET utf8)
)
END AS sxdmPKValue ,
CONCAT(
CAST(LEFT(Gender ,1) AS CHAR CHARACTER SET utf8)
,CAST(sxFirstName AS CHAR CHARACTER SET utf8)
,CAST(sxLastName AS CHAR CHARACTER SET utf8)
,CAST(LTRIM(RTRIM(DATE_FORMAT(DOB, '%Y%m%d')))AS CHAR CHARACTER SET utf8)
) AS sxPKValueDoB ,

CONCAT(

CAST(LEFT(Gender ,1) AS CHAR CHARACTER SET utf8),
CASE
WHEN locate(';',dmFirstName )>0 THEN
CAST(SUBSTRING(dmFirstName , locate(';',dmFirstName )+1,LENGTH(dmFirstName )) AS CHAR CHARACTER SET utf8)
ELSE
CAST(dmFirstName AS CHAR CHARACTER SET utf8)
END ,
CASE
WHEN locate(';',dmLastName )>0 THEN
CAST( SUBSTRING(dmLastName , locate(';',dmLastName )+1,LENGTH(dmLastName )) AS CHAR CHARACTER SET utf8)
ELSE
CAST( dmLastName AS CHAR CHARACTER SET utf8)
END ,

CAST( LTRIM(RTRIM(DATE_FORMAT(DOB, '%Y%m%d'))) AS CHAR CHARACTER SET utf8)
) AS dmPKValueDoB ,

CASE WHEN locate(';',dmLastName )>0 THEN
CONCAT(
CAST( LEFT(Gender ,1) AS CHAR CHARACTER SET utf8)
,CAST( sxFirstName AS CHAR CHARACTER SET utf8)
, CAST( SUBSTRING(dmLastName ,locate(';',dmLastName )+1,LENGTH(dmLastName )) AS CHAR CHARACTER SET utf8)
,CAST( LTRIM(RTRIM(DATE_FORMAT(DOB, '%Y%m%d'))) AS CHAR CHARACTER SET utf8)
)
ELSE
CONCAT(
CAST( LEFT(Gender ,1)AS CHAR CHARACTER SET utf8)
, CAST( sxFirstName AS CHAR CHARACTER SET utf8),
CAST( dmLastName AS CHAR CHARACTER SET utf8),
CAST( LTRIM(RTRIM(DATE_FORMAT(DOB, '%Y%m%d'))) AS CHAR CHARACTER SET utf8)
)
END AS sxdmPKValueDoB
FROM
(
SELECT
-- -----Demographics
a.patient_id as Ptn_Pk,
a.patient_id as PatientPK,
(select value_reference from location_attribute
where location_id in (select property_value
from global_property
where property='kenyaemr.defaultLocation') and attribute_type_id=1) as siteCode,

(select name from location
where location_id in (select property_value
from global_property
where property='kenyaemr.defaultLocation')) as FacilityName,
id.identifier AS Serial
-- a.patient_clinic_number AS Serial

,UPPER(a.given_name ) as FirstName
,UPPER(a.middle_name ) as MiddleName
,UPPER(family_name) as LastName
,UPPER(REPLACE(given_name ,'0','O')) AS FirstName_Normalized
,UPPER(REPLACE(middle_name ,'0','O')) AS MiddleName_Normalized
,UPPER(REPLACE(family_name ,'0','O')) AS LastName_Normalized
,SOUNDEX(UPPER(REPLACE(given_name ,'0','O'))) AS sxFirstName
,SOUNDEX(UPPER(REPLACE(family_name ,'0','O'))) AS sxLastName
,SOUNDEX(UPPER(REPLACE(middle_name ,'0','O'))) AS sxMiddleName
, fn_getPatientNameDoubleMetaphone(UPPER(REPLACE(given_name ,'0','O'))) AS dmFirstName
, fn_getPatientNameDoubleMetaphone(UPPER(REPLACE(family_name ,'0','O'))) AS dmLastName
, fn_getPatientNameDoubleMetaphone(UPPER(REPLACE(middle_name ,'0','O'))) AS dmMiddleName
,a.phone_number AS PatientPhoneNumber
,en.treatment_supporter_telephone AS PatientAlternatePhoneNumber
,a.Gender
,a.DOB
,a.marital_status AS MaritalStatus
-- -----Patient Address
, en.entry_point AS PatientSource
,NULL PatientCounty
,NULL PatientSubCounty
,NULL PatientVillage
-- -----Patient-Identifiers
,patient_clinic_number AS PatientID
,national_id_no AS National_ID
,NULL as NHIF_Number
,NULL as Birth_Certificate
,a.patient_clinic_number AS CCC_Number
,ltrim(rtrim(a.district_reg_no))TB_Number
-- -----Next Of Kin
,LTRIM(RTRIM(next_of_kin)) AS ContactName
,next_of_kin_relationship AS ContactRelation
,treatment_supporter_telephone as ContactPhoneNumber
,treatment_supporter_address as ContactAddress
,NULL AS NokNationalId
-- -----Additional Variables
,date_confirmed_hiv_positive AS DateConfirmedHIVPositive
,X.date_started AS StartARTDate
,X.regimen_name AS StartARTRegimenCode
,X.regimen_line StartARTRegimenDesc

FROM kenyaemr_datatools.patient_demographics a
INNER JOIN patient_identifier id ON a.patient_id = id.patient_id AND id.identifier_type = (SELECT patient_identifier_type_id FROM openmrs.patient_identifier_type
where name ='OpenMRS ID')
left join (
SELECT  c.patient_id,
c.encounter_id, treatment_supporter_telephone, entry_point , treatment_supporter_address, date_confirmed_hiv_positive
from kenyaemr_datatools.hiv_enrollment  c
left JOIN
    (
        SELECT patient_id, MAX(encounter_id) max_encounter_id
        FROM kenyaemr_datatools.hiv_enrollment
        GROUP BY patient_id
    ) b ON c.patient_id = b.patient_id AND
            c.encounter_id = b.max_encounter_id

  order by patient_id,date_created asc


 ) en
on a.Patient_Id=en.patient_id
LEFT JOIN
(
SELECT patient_id, MIN(date_started) AS date_started ,MIN(regimen_name) AS regimen_name, MIN(regimen_line) AS regimen_line
FROM kenyaemr_datatools.drug_event GROUP BY patient_id
) X ON X.patient_id = a.Patient_id
) X
INNER JOIN
(
SELECT
a.patient_id as Ptn_Pk,
id.identifier AS Serial
FROM kenyaemr_datatools.patient_demographics a
INNER JOIN patient_identifier id ON a.patient_id = id.patient_id AND id.identifier_type = (SELECT patient_identifier_type_id FROM openmrs.patient_identifier_type
where name ='OpenMRS ID')

)Y
ON
Y.Ptn_Pk = X.Ptn_Pk AND Y.Serial= X.Serial
"|MPI|1|MasterPatientIndex|1|a6221aa4-0e85-11e8-ba89-0ed5f89f718b
329bfbf4-d404-4dfd-88eb-6fb398c5f449|Patient Adverse Events|NDWH|a62216ee-0e85-11e8-ba89-0ed5f89f718b|"SELECT adv.PatientID,
       adv.PatientPK,
       adv.SiteCode,
	   p.FacilityID,
       'IQCare' AS EMR,
       'Kenya HMIS II' AS Project,
       adv.VisitDate,
       adv.Regimen AS AdverseEventRegimen,
       adv.AdverseEvent,
       adv.AdverseEventCause,
       adv.Severity,
       adv.ActionTaken AS AdverseEventActionTaken,
       adv.ClinicalOutcome AS AdverseEventClinicalOutcome,
	   adv.VisitDate AS AdverseEventStartDate,
       adv.AdverseEventEndDate,
       adv.Pregnancy AS AdverseEventIsPregnant
FROM IQC_AdverseEvents adv
     INNER JOIN tmp_PatientMaster p ON adv.PatientPK = p.PatientPK where p.RegistrationAtCCC is not null"|dwhstage|0|PatientAdverseEventExtract|8|a6221983-0e85-11e8-ba89-0ed5f89f718b
a6226eb4-0e85-11e8-ba89-6fb398c5f449|Patient Adverse Events|NDWH|a6221856-0e85-11e8-ba89-0ed5f89f718b|"select v.patient_id as PatientPK,
                                   a.uuid   as RecordUUID,
                                   s.siteCode as SiteCode,
                                   de.unique_patient_no as PatientID,
                                   0 AS FacilityId,'KenyaEMR' as Emr,'Kenya HMIS II' as Project,
                                   s.FacilityName as FacilityName,
                                   v.visit_date as VisitDate,
                                   group_concat(case a.cause when 70056 then 'Abicavir' when 162298 then 'ACE inhibitors' when 70878 then 'Allopurinol' when 155060 then 'Aminoglycosides' when 162299 then 'ARBs (angiotensin II receptor blockers)' when 103727 then 'Aspirin' when 71647 then 'Atazanavir' when 72822 then 'Carbamazepine' when 162301 then 'Cephalosporins' when 73300 then 'Chloroquine'  when 73667 then 'Codeine' when 74807 then 'Didanosine' when 75523 then 'Efavirenz' when 162302 then 'Erythromycins' when
                                                    75948 then 'Ethambutol' when 77164 then 'Griseofulvin' when 162305 then 'Heparins' when 77675 then 'Hydralazine' when 78280 then 'Isoniazid' when 794 then 'Lopinavir/ritonavir' when 80106 then 'Morphine' when 80586 then 'Nevirapine' when 80696 then 'Nitrofurans' when 162306 then 'Non-steroidal anti-inflammatory drugs' when 81723 then 'Penicillamine' when 81724 then 'Penicillin' when 81959 then 'Phenolphthaleins' when 82023 then 'Phenytoin' when
                                                    82559 then 'Procainamide' when 82900 then 'Pyrazinamide' when 83018 then 'Quinidine' when 767 then 'Rifampin' when 162307 then 'Statins' when 84309 then 'Stavudine'
                                                             when 162170 then 'Sulfonamides' when 84795 then 'Tenofovir' when 84893 then 'Tetracycline' when 86663 then 'Zidovudine' when 5622 then 'Other' end SEPARATOR '|') as AdverseEventCause,
                                   group_concat(case a.adverse_event when 1067 then 'Unknown' when  121629  then 'Anaemia' when 148888 then 'Anaphylaxis' when 148787 then 'Angioedema' when 120148 then 'Arrhythmia' when 108 then 'Bronchospasm' when 143264 then 'Cough' when 142412 then 'Diarrhea' when 118773 then 'Dystonia' when 140238 then 'Fever'
                                                                     when 140039 then 'Flushing' when 139581 then 'GI upset' when 139084 then 'Headache' when 159098 then 'Hepatotoxicity' when 111061 then 'Hives' when 117399 then 'Hypertension' when 879 then 'Itching' when 121677 then 'Mental status change' when 159347 then 'Musculoskeletal pain'
                                                                     when 121 then 'Myalgia' when 512 then 'Rash' when 5622 then 'Other' end  SEPARATOR '|') as AdverseEvent,
                                   group_concat(case a.severity when 1498 then 'Mild' when 1499 then 'Moderate' when 1500 then 'Severe' when 162819 then 'Fatal' when 1067 then 'Unknown' end SEPARATOR '|') as Severity,
                                   group_concat(a.start_date SEPARATOR '|') as AdverseEventStartDate,'' as AdverseEventEndDate,
                                   group_concat(case a.action_taken when 1257 then 'CONTINUE REGIMEN' when 1259 then 'SWITCHED REGIMEN'  when 981 then 'CHANGED DOSE'  when 1258 then 'SUBSTITUTED DRUG' when 1107 then 'NONE' when 1260 then 'STOP' when 5622 then 'Other' end SEPARATOR '|') as AdverseEventActionTaken,
                                   '' as AdverseEventClinicalOutcome, '' as AdverseEventIsPregnant, '' as AdverseEventRegimen,
                                   a.date_created as Date_Created, a.date_last_modified as Date_Last_Modified,
                                  a.voided as Voided
                           from dwapi_etl.etl_adverse_events a
                                    inner join (select e.patient_id, max(e.visit_date) as latest_enrolment_date
                                                from dwapi_etl.etl_hiv_enrollment e
                                                group by e.patient_id) e on a.patient_id = e.patient_id
                                    left join dwapi_etl.etl_patient_hiv_followup v on a.encounter_id = v.encounter_id
                                    left join (select d.patient_id as                                                           hiv_disc_patient,
                                                      coalesce(max(date(d.effective_discontinuation_date)), date(d.visit_date)) hiv_outcome_date
                                               from dwapi_etl.etl_patient_program_discontinuation d
                                               where program_name = 'HIV'
                                               group by d.patient_id) d on d.hiv_disc_patient = a.patient_id
                                    inner join dwapi_etl.etl_patient_demographics de on a.patient_id = de.patient_id
                                    join kenyaemr_etl.etl_default_facility_info s
                           where a.form = 'greencard'
                             and ((d.hiv_disc_patient is null or d.hiv_outcome_date < e.latest_enrolment_date))
                           group by a.patient_id, a.visit_date"|dwhstage|0|PatientAdverseEventExtract|8|a6221aa4-0e85-11e8-ba89-0ed5f89f718b
953cd910-23bb-11e9-ab14-d663bd873d93|Patient Status|NDWH|a6221857-0e85-11e8-ba89-0ed5f89f718b|"SELECT patientid,
       patientpk,
       sitecode,
       facilityname,
       exitdescription,
       exitreason,
       if(exitdate,exitdate,null) as exitdate,
       emr,
       project,
       ident,
       null as dateimported,
       facilityid
FROM   ndwr_patient_status"|dwhstage|0|PatientStatusExtract|4|a6221aa5-0e85-11e8-ba89-0ed5f89f718b
953cdb90-23bb-11e9-ab14-d663bd873d93|ART Patients|NDWH|a6221857-0e85-11e8-ba89-0ed5f89f718b|"SELECT patientid,
       patientpk,
       if(dob,dob,null) as dob,
       arv_first_regimen_start_date,
       ageenrollment,
       ageartstart,
       agelastvisit,
       sitecode,
       facilityname,
       if(registrationdate,registrationdate,null) as registrationdate,
       patientsource,
       gender,
       if(startartdate,startartdate,null) as startartdate,
       if(previousartstartdate,previousartstartdate,NULL) as previousartstartdate,
       previousartregimen,
       if(startartatthisfacility,startartatthisfacility,null) AS startartatthisfacility,
       startregimen,
       startregimenline,
       if(lastartdate,lastartdate,null) AS lastartdate,
       lastregimen,
       lastregimenline,
       duration,
       IF(expectedreturn,expectedreturn,NULL) AS expectedreturn,
       provider,
       IF(lastvisit,lastvisiT,NULL) AS lastvisit,
       encounter_type,
       status,
       exitreason,
       if(exitdate,exitdate,null) as exitdate,
       emr,
       project,
       ident,
       previousartregimen_orig,
       startregimen_orig,
       lastregimen_orig,
       null as dateimported,
       facilityid
FROM   ndwr_art_patients"|dwhstage|0|PatientArtExtract|2|a6221aa5-0e85-11e8-ba89-0ed5f89f718b
953cdce4-23bb-11e9-ab14-d663bd873d93|All Patients|NDWH|a6221857-0e85-11e8-ba89-0ed5f89f718b|"SELECT patientid,
       patientpk,
       sitecode,
       facilityname,
       gender,
       IF(dob, dob, NULL) AS DOB,
       IF(registrationdate, registrationdate, NULL) as registrationdate,
       if(registrationatccc,registrationatccc,null) as registrationatccc,
       if(registrationatpmtct,registrationatpmtct,null) AS registrationatpmtct,
       IF(registrationattbclinic,registrationattbclinic,NULL) AS registrationattbclinic,
       patientsource,
       region,
       district,
       village,
       contactrelation,
       lastvisit,
       maritalstatus,
       educationlevel,
       IF(dateconfirmedhivpositive,dateconfirmedhivpositive,NULL) AS dateconfirmedhivpositive,
       IF(previousartexposure,previousartexposure,NULL) as previousartexposure,
       if(previousartstartdate,previousartstartdate,null) as previousartstartdate,
       emr,
       project,
       facilityid,
       satellitename,
       StatusAtCCC,StatusAtPMTCT,StatusAtTBClinic
FROM   ndwr_all_patients"|dwhstage|1|PatientExtract|1|a6221aa5-0e85-11e8-ba89-0ed5f89f718b
953cde1a-23bb-11e9-ab14-d663bd873d93|Patient Baselines|NDWH|a6221857-0e85-11e8-ba89-0ed5f89f718b|"SELECT patientpk,
       patientid,
       facilityname,
       sitecode,
       locationid,
       facilityid,
       bcd4,
       if(bcd4date,bcd4date,null) as bcd4date,
       bwho,
       if(bwhodate,bwhodate,null) as bwhodate,
       ecd4,
       if(ecd4date,ecd4date,null) as ecd4date,
       ewho,
       if(ewhodate,ewhodate,null) as ewhodate,
       lastwho,
       if(lastwhodate,lastwhodate,null) as lastwhodate,
       lastcd4,
       if(lastcd4date,lastcd4date,null) as lastcd4date,
       m12cd4,
       if(m12cd4date,m12cd4date,null) as m12cd4date,
       m6cd4,
       if(m6cd4date,m6cd4date,null) as m6cd4date,
       cd4atenrollment,
       if(cd4atenrollment_date,cd4atenrollment_date,null) as cd4atenrollment_date,
       cd4beforeartstart,
       if(cd4beforeartstart_date,cd4beforeartstart_date,null) as cd4beforeartstart_date,
       lastcd4afterartstart,
       if(lastcd4afterartstart_date,lastcd4afterartstart_date,null) as lastcd4afterartstart_date,
       cd4atenrollmentpercent,
       if( cd4atenrollmentpercent_date,cd4atenrollmentpercent_date,null) as  cd4atenrollmentpercent_date,
       cd4beforeartstartpercent,
       if(cd4beforeartstartpercent_date,cd4beforeartstartpercent_date,null) as cd4beforeartstartpercent_date,
       lastcd4afterartstartpercent,
       if(lastcd4afterartstartpercent_date,lastcd4afterartstartpercent_date,null) as lastcd4afterartstartpercent_date,
       6monthcd4,
       if(6monthcd4_date,6monthcd4_date,null) as 6monthcd4_date,
       12monthcd4,
       if(12monthcd4_date,12monthcd4_date,null) as 12monthcd4_date,
       6monthcd4percent,
       if(6monthcd4percent_date,6monthcd4percent_date,null) as 6monthcd4percent_date,
       firstcd4afterartstart,
       if(firstcd4afterartstart_date,firstcd4afterartstart_date,null) as firstcd4afterartstart_date,
       firtscd4afterartstartpercent,
       if(firtscd4afterartstartpercent_date,firtscd4afterartstartpercent_date,null) as firtscd4afterartstartpercent_date,
       null as dateimported,
       6monthvl,
       if(6monthvldate,6monthvldate,null) as 6monthvldate,
       12monthvl,
       if(12monthvldate,12monthvldate,null) as 12monthvldate,
       'AMRS' as emr,
       'AMPATHPLUS' as project,
       null as ident,
	   null as bWAB,
	   null as bWABDate,
	   null as eWAB,
	   null as eWABDate,
	   null as lastWAB,
	   null as lastWABDate

FROM   ndw_base_line"|dwhstage|0|PatientBaselineExtract|3|a6221aa5-0e85-11e8-ba89-0ed5f89f718b
953cdf46-23bb-11e9-ab14-d663bd873d93|Patient Labs|NDWH|a6221857-0e85-11e8-ba89-0ed5f89f718b|"SELECT patientid,
       patientpk,
       facilityid,
       sitecode,
       facilityname,
       satellitename,
       if(orderedbydate,orderedbydate,null) as orderedbydate,
       if(reportedbydate,reportedbydate,null) as reportedbydate,
       visitid,
       testname,
       testresult,
       baselinetest,
       enrollmenttest,
       emr,
       project,
       ident,
       null as dateimported
FROM   ndwr_patient_labs"|dwhstage|0|PatientLabExtract|5|a6221aa5-0e85-11e8-ba89-0ed5f89f718b
953ce2b6-23bb-11e9-ab14-d663bd873d93|Patient Pharmacy|NDWH|a6221857-0e85-11e8-ba89-0ed5f89f718b|"SELECT patientid,
       patientpk,
       facilityname,
       sitecode,
       visitid,
       drug,
       if(dispensedate,dispensedate,null) as dispensedate,
       treatmenttype,
       prophylaxistype,
       if(expectedreturn,expectedreturn,null) as expectedreturn,
       duration,
       periodtaken,
       emr,
       project,
       null as dateimported,
       ident,
       facilityid,
	   null as Provider,
	   null as RegimenLine
FROM   ndwr_patient_pharmacy"|dwhstage|0|PatientPharmacyExtract|6|a6221aa5-0e85-11e8-ba89-0ed5f89f718b
953ce400-23bb-11e9-ab14-d663bd873d93|Patient Visit|NDWH|a6221857-0e85-11e8-ba89-0ed5f89f718b|"SELECT patientid,
       patientpk,
       facilityname,
       sitecode,
       visitid,
       if(visitdate,visitdate,null) as visitdate,
       service,
       visittype,
       whostage,
       wabstage,
       pregnant,
       if(lmp,lmp,null) as lmp,
       if(edd,edd,null) as edd,
       height,
       bp,
       oi,
       if(oidate,oidate,null) as oidate,
       adherence,
       adherencecategory,
       familyplanningmethod,
       pwp,
       gestationage,
       if(nextappointmentdate,nextappointmentdate,null) as nextappointmentdate,
       substitutionfirstlinereg,
	   if(SecondlineRegimenChangeDate,SecondlineRegimenChangeDate,null) as SecondlineRegimenChangeDate,
	   if(SubstitutionSecondlineRegimenDate,SubstitutionSecondlineRegimenDate,null) as SubstitutionSecondlineRegimenDate,
	   if(SubstitutionFirstlineRegimenDate,SubstitutionFirstlineRegimenDate,null) as SubstitutionFirstlineRegimenDate,
       emr,
       project,
       null as dateimported,
       ident,
       facilityid,
	   null as weight,
	   null as SubstitutionFirstlineRegimenReason,
	   null as SubstitutionFirstLineRegmenReason,
	   null as SubstitutionSecondLineRegimen,
	   null as SubstitutionSecondLineRegimenReason,
	   null as SecondLineRegimenChange,
	   null as SubstitutionSecondlineRegimenReason,
	   null as SecondLineRegimenChangeReason  FROM   ndwr_all_patient_visits"|dwhstage|0|PatientVisitExtract|7|a6221aa5-0e85-11e8-ba89-0ed5f89f718b

96226eb4-0e85-11e8-ba89-6fb398c5f449|Patient Adverse Events|NDWH|a6221857-0e85-11e8-ba89-0ed5f89f718b|"SELECT '' AS PatientID,
       '' AS PatientPK,
       '' AS SiteCode,
	   '' AS FacilityID,
       'Kenya EMR' AS EMR,
       'Kenya HMIS II' AS Project,
       NOW() AS VisitDate,
       '' AS AdverseEventRegimen,
       '' AS AdverseEvent,
       '' AS AdverseEventCause,
       '' AS Severity,
       '' AS AdverseEventActionTaken,
       '' AS AdverseEventClinicalOutcome,
	   NOW() AS AdverseEventStartDate,
       NOW() AS AdverseEventEndDate,
       '' AS AdverseEventIsPregnant"|dwhstage|0|PatientAdverseEventExtract|8|a6221aa5-0e85-11e8-ba89-0ed5f89f718b

8578a9ae-c34b-11e9-9cb5-2a2ae2dbcce4|Hts Clients|HTS|A62216EE-0E85-11E8-BA89-0ED5F89F718B|"select distinct h.PatientPk,
SiteCode,
FacilityName,
'IQCare' as Emr,
'Kenya HMIS II' as Project,
HTSID as HtsNumber  ,
h.DOB as Dob,
h.Gender,
h.MaritalStatus,
case when ltrim(h.KeyPop) in ('SW','PWID','MSM','Other','MSW','FSW') then 'Key Population' else 'General Population' end as PopulationType,
ltrim(h.KeyPop)  as KeyPopulationType,
Disability as PatientDisabled,
County,
SubCounty,
Ward from  tmp_HTS_LAB_register h inner join tmp_PatientMaster p
on h.PatientPK=p.PatientPK
order by KeyPopulationType"|DWHStage|1|HtsClient|1|A6221983-0E85-11E8-BA89-0ED5F89F718B

8578ad00-c34b-11e9-9cb5-2a2ae2dbcce4|Hts Clients|HTS|A6221856-0E85-11E8-BA89-0ED5F89F718B|"SELECT d.patient_id                                                      as PatientPK,
                                                                                                  t.uuid                                                            as RecordUUID,
                                                                                                  d.national_unique_patient_identifier                              as NUPI,
                                                                                                  pkv.PKV                                                           as Pkv,
                                                                                                  (select FacilityName from kenyaemr_etl.etl_default_facility_info) as FacilityName,
                                                                                                  (select siteCode from kenyaemr_etl.etl_default_facility_info)     as SiteCode,
                                                                                                  'KenyaEMR'                                                        as Emr,
                                                                                                  'Kenya HMIS II'                                                   AS Project,
                                                                                                  d.openmrs_id                                                      AS HtsNumber,
                                                                                                  d.hts_recency_id                                                  as HTSRecencyId,
                                                                                                  d.DOB,
                                                                                                  case when d.Gender = 'M' then 'Male' else 'Female' end            as Gender,
                                                                                                  d.marital_status                                                  as MaritalStatus,
                                                                                                  d.occupation                                                      as Occupation,
                                                                                                  t.population_type                                                 as PopulationType,
                                                                                                  t.key_population_type                                             as KeyPopulationType,
                                                                                                  t.priority_population_type                                        as PriorityPopulationType,
                                                                                                  t.patient_disabled                                                as PatientDisabled,
                                                                                                  t.disability_type                                                 as DisabilityType,
                                                                                                  A.county_district                                                 as County,
                                                                                                  A.state_province                                                  as SubCounty,
                                                                                                  A.address4                                                        as Ward,
                                                                                                  t.date_created                                                    as Date_Created,
                                                                                                  t.date_last_modified                                              as Date_Last_Modified,
                                                                                                  t.voided                                                          as Voided
                                                                                           FROM dwapi_etl.etl_hts_test t
                                                                                                    inner join dwapi_etl.etl_patient_demographics d ON d.patient_id = t.patient_id
                                                                                                    inner join (select x.patient_id as patient_id,
                                                                                                                       x.sxFirstName,
                                                                                                                       x.sxLastname,
                                                                                                                       x.sxMiddleName,
                                                                                                                       x.dmFirstName,
                                                                                                                       x.dmLastName,
                                                                                                                       x.dmMiddleName,
                                                                                                                       x.Gender,
                                                                                                                       x.DOB,
                                                                                                                       CASE
                                                                                                                           WHEN locate(';', dmLastName) > 0 THEN CONCAT(
                                                                                                                                   CAST(LEFT(Gender, 1) AS CHAR CHARACTER SET utf8),
                                                                                                                                   CAST(sxFirstName AS CHAR CHARACTER SET utf8), CAST(
                                                                                                                                           SUBSTRING(dmLastName, locate(';', dmLastName) + 1, LENGTH(dmLastName))
                                                                                                                                       AS
                                                                                                                                       CHAR CHARACTER SET utf8),
                                                                                                                                   CAST(LTRIM(RTRIM(DATE_FORMAT(DOB, '%Y'))) AS CHAR CHARACTER SET utf8)
                                                                                                                               )
                                                                                                                           ELSE CONCAT(
                                                                                                                                   CAST(LEFT(Gender, 1) AS CHAR CHARACTER SET utf8),
                                                                                                                                   CAST(sxFirstName AS CHAR CHARACTER SET utf8),
                                                                                                                                   CAST(dmLastName AS CHAR CHARACTER SET utf8),
                                                                                                                                   CAST(LTRIM(RTRIM(DATE_FORMAT(DOB, '%Y'))) AS CHAR CHARACTER SET utf8)
                                                                                                                               )
                                                                                                                           END      AS PKV
                                                                                                                from (SELECT patient_id,
                                                                                                                             SOUNDEX(UPPER(REPLACE(given_name, '0', 'O')))                           AS sxFirstName,
                                                                                                                             SOUNDEX(UPPER(REPLACE(family_name, '0', 'O')))                          AS sxLastName,
                                                                                                                             SOUNDEX(UPPER(REPLACE(middle_name, '0', 'O')))                          AS sxMiddleName,
                                                                                                                             fn_getPatientNameDoubleMetaphone(UPPER(REPLACE(given_name, '0', 'O')))  AS dmFirstName,
                                                                                                                             fn_getPatientNameDoubleMetaphone(UPPER(REPLACE(family_name, '0', 'O'))) AS dmLastName,
                                                                                                                             fn_getPatientNameDoubleMetaphone(UPPER(REPLACE(middle_name, '0', 'O'))) AS dmMiddleName,
                                                                                                                             Gender,
                                                                                                                             DOB
                                                                                                                      FROM dwapi_etl.etl_patient_demographics) x) pkv on pkv.patient_id = d.patient_id
                                                                                                    LEFT JOIN location_attribute SC ON SC.location_id = t.encounter_location AND SC.attribute_type_id = 1
                                                                                                    LEFT JOIN location SN ON SN.location_id = t.encounter_location
                                                                                                    LEFT JOIN person_address A ON A.person_id = d.patient_id
                                                                                           group by t.patient_id
                                                                                           having min(t.date_created)"|DWHStage|1|HtsClient|1|A6221AA4-0E85-11E8-BA89-0ED5F89F718B

8578ae7c-c34b-11e9-9cb5-2a2ae2dbcce4|Hts Client Tests|HTS|A62216EE-0E85-11E8-BA89-0ED5F89F718B|"select distinct h.PatientPK,
SiteCode,
FacilityName,
'IQCare' as Emr,
'Kenya HMIS II' as Project,
p.HTSID as HtsNumber,
HTSEncounterId as EncounterId,
VisitDate as TestDate,
TestedBefore as EverTestedForHiv,
WhenLastTested as MonthsSinceLastTest,
ClientTestedAs,
TestEntryPoint as EntryPoint,
StrategyHTS as TestStrategy,
FinalTestOneResult as TestResult1,
FinalResultTestTwo as TestResult2,
finalResultHTS as FinalTestResult,
FinalResultsGiven as PatientGivenResult,
TBScreeningHTS as TbScreening,
clientSelfTestesd as ClientSelfTested,
CoupleDiscordant,
TestType,
case when Consent='1' or Consent='Yes' then 'Yes' else 'No' end as Consent from  tmp_HTS_LAB_register h inner join tmp_PatientMaster p
on h.PatientPK=p.PatientPK"|DWHStage|1|HtsClientTests|2|A6221983-0E85-11E8-BA89-0ED5F89F718B

8578afbc-c34b-11e9-9cb5-2a2ae2dbcce4|Hts Client Tests|HTS|A6221856-0E85-11E8-BA89-0ED5F89F718B|"SELECT
                         t.patient_id as PatientPK, 
        t.uuid                                                                     RecordUUID,					 
                         (select FacilityName from kenyaemr_etl.etl_default_facility_info) as FacilityName,
                         (select siteCode from kenyaemr_etl.etl_default_facility_info) as SiteCode,
                         'KenyaEMR' as Emr,
                         'Kenya HMIS II' AS Project,
                         demographics.openmrs_id  AS HtsNumber,
                         t.encounter_id as EncounterId,
                         t.visit_date as TestDate,
                         t.ever_tested_for_hiv as EverTestedForHiv,
                         t.months_since_last_test as MonthsSinceLastTest,
                         t.client_tested_as as ClientTestedAs,
                         case t.hts_entry_point
                         when 5485 then 'In Patient Department(IPD)'
                         when 160542 then 'Out Patient Department(OPD)'
                         when 162181 then 'Peadiatric Clinic'
                         when 160552 then 'Nutrition Clinic'
                         when 160538 then 'PMTCT ANC'
                         when 160456 then 'PMTCT MAT'
                         when 1623 then 'PMTCT PNC'
                         when 160541 then 'TB'
                         when 162050 then 'CCC'
                         when 159940 then 'VCT'
                         when 159938 then 'Home Based Testing'
                         when 159939 then 'Mobile Outreach'
                         when 162223 then 'VMMC'
                         when 160546 then 'STI Clinic'
                         when 160522 then 'Emergency'
                         when 163096 then 'Community Testing'
                         when 5622 then 'Other' end                                    as EntryPoint,
                         case t.test_strategy
                         when 164163 then 'HP: Hospital Patient Testing'
                         when 164953 then 'NP: HTS for non-patients'
                         when 164954 then 'VI:Integrated VCT Center'
                         when 164955 then 'VS:Stand Alone VCT Center'
                         when 159938 then 'HB:Home Based Testing'
                         when 159939 then 'MO: Mobile Outreach HTS'
                         when 161557 then 'Index testing'
                         when 166606 then 'SNS - Social Networks'
                         when 5622 then 'O:Other'
                         end                                                           as TestStrategy,
                         t.test_1_result                                                   as TestResult1,
                         t.approach as Approach,
                         t.setting as Setting,
                         t.test_2_result                                                   as TestResult2,
                         t.final_test_result                                               as FinalTestResult,
                         t.patient_given_result                                            as PatientGivenResult,
                         t.tb_screening                                                    as TbScreening,
                         t.patient_had_hiv_self_test                                       as ClientSelfTested,
                         t.couple_discordant                                               as CoupleDiscordant,
                         CASE t.test_type
                         WHEN 1 THEN 'Initial'
                         WHEN 2 THEN 'Repeat'
                         END                                                           AS TestType,
                         t.patient_consented                                               as Consent,
                         t.hts_risk_category                                               as HtsRiskCategory,
                         CONCAT('',t.hts_risk_score, '' )                                          as HtsRiskScore,
                         if(coalesce(t.referral_for, t.neg_referral_for, t.neg_referral_specify) is not null and	
                         coalesce(t.referral_for, t.neg_referral_for) != '', 'Yes', 'No')        as ReferredForServices,	
                         concat_ws(',', NULLIF(t.referral_for, ''), NULLIF(t.neg_referral_for, '')) as ReferredServices,	
                         t.neg_referral_specify                                                     as OtherReferredServices,
                            t.date_created                                                             as Date_Created,	
                        t.date_last_modified                                                       as Date_Last_Modified,	
                        t.voided                                                                   as Voided
                         FROM dwapi_etl.etl_hts_test t
                         inner join dwapi_etl.etl_patient_demographics demographics on t.patient_id = demographics.patient_id"|DWHStage|1|HtsClientTests|2|A6221AA4-0E85-11E8-BA89-0ED5F89F718B

8578b0f2-c34b-11e9-9cb5-2a2ae2dbcce4|Hts Client Linkage|HTS|A62216EE-0E85-11E8-BA89-0ED5F89F718B|"SELECT distinct r.ptn_pk as PatientPK,SiteCode,
p.FacilityName,
'IQCare' as Emr,
'Kenya HMIS II' as Project,
p.HTSID as HtsNumber,
ref.referraldate as DatePrefferedToBeEnrolled,
case when ref.tofacility=99999 then 'Other Facility'else (
select name from FacilityList where MFLCode=ref.tofacility ) end as FacilityReferredTo,
HandedOverTo,
HandedOverToCadre,
r.FacilityEnrolled as EnrolledFacilityName,
ref.createdate as ReferralDate,
dateEnrolled as DateEnrolled,
r.CCCNumber as ReportedCCCNumber,
r.ArtStartDate as ReportedStartARTDate
  FROM tmp_Referral_Linkage_Register r
  inner join tmp_PatientMaster p on r.ptn_pk=p.PatientPK
  inner join tmp_HTS_LAB_register plab on r.ptn_pk=plab.PatientPK
  inner join patient pat on pat.ptn_pk=r.ptn_pk
  left join Referral ref on pat.personid=ref.personid"|DWHStage|1|HtsClientLinkage|3|A6221983-0E85-11E8-BA89-0ED5F89F718B

8578b21e-c34b-11e9-9cb5-2a2ae2dbcce4|Hts Client Linkage|HTS|A6221856-0E85-11E8-BA89-0ED5F89F718B|"select distinct a.patient_id as PatientPK,
                                                                                                  	a.uuid                 RecordUUID,
                                                                                                   (select FacilityName from kenyaemr_etl.etl_default_facility_info) as FacilityName,
                                                                                                   (select siteCode from kenyaemr_etl.etl_default_facility_info) as SiteCode,
                                                                                                   'KenyaEMR' as Emr,
                                                                                                   'Kenya HMIS II' AS Project,
                                                                                                   HtsNumber AS HtsNumber,
                                                                                                   ref.date_to_enrol as DatePrefferedToBeEnrolled,
                                                                                                   ref.facility_referred_to as FacilityReferredTo,
                                                                                                   a.provider_handed_to as HandedOverTo,
                                                                                                   NULL HandedOverToCadre,
                                                                                                   a.facility_linked_to as EnrolledFacilityName,
                                                                                                   ref.visit_date as ReferralDate,
                                                                                                   a.enrollment_date as DateEnrolled,
                                                                                                   a.ccc_number as ReportedCCCNumber,
                                                                                                   a.art_start_date as ReportedStartARTDate,
                                                                                                   	a.date_created         as Date_Created,	
                                                                                                  a.date_last_modified   as Date_Last_Modified,	
                                                                                                  a.voided               as Voided
                                                                                                   from (SELECT Distinct patient_id,	
                                                                                                  uuid,	
                                                                                                  encounter_id,	
                                                                                                  visit_date,	
                                                                                                  ccc_number,	
                                                                                                  HtsNumber,	
                                                                                                  enrollment_date,	
                                                                                                  art_start_date,	
                                                                                                  provider_handed_to,	
                                                                                                  HandedOverToCadre as HandedOverToCadre,	
                                                                                                  facility_linked_to,	
                                                                                                  facility_referred_to,	
                                                                                                  encounter_location,	
                                                                                                  date_created,	
                                                                                                  date_last_modified,	
                                                                                                  voided	
                                                                                                  FROM (SELECT DISTINCT htsrl.patient_id,	
                                                                                                  htsrl.uuid              as uuid,	
                                                                                                  encounter_id,	
                                                                                                  htsrl.visit_date,	
                                                                                                  ccc_number,	
                                                                                                  demo.openmrs_id            HtsNumber,	
                                                                                                  enrollment_date,	
                                                                                                  art_start_date,	
                                                                                                  provider_handed_to,	
                                                                                                  htsrl.cadre             as HandedOverToCadre,	
                                                                                                  facility_linked_to,	
                                                                                                  htsrl.referral_facility as facility_referred_to,	
                                                                                                  encounter_location,	
                                                                                                  htsrl.date_created,	
                                                                                                  htsrl.date_last_modified,	
                                                                                                  htsrl.voided            as Voided	
                                                                                                  FROM dwapi_etl.etl_hts_referral_and_linkage htsrl	
                                                                                                  inner join dwapi_etl.etl_patient_demographics demo	
                                                                                                  on demo.patient_id = htsrl.patient_id	
                                                                                                  UNION ALL	
                                                                                                  SELECT DISTINCT t.patient_id,	
                                                                                                  t.uuid                    as uuid,	
                                                                                                  t.encounter_id,	
                                                                                                  t.visit_date,	
                                                                                                  unique_patient_no            ccc_number,	
                                                                                                  pt.openmrs_id             as HtsNumber,	
                                                                                                  e.visit_date                 DateEnrolled,	
                                                                                                  ar.art_start_date,	
                                                                                                  l.provider_handed_to      as provider_handed_to,	
                                                                                                  l.cadre                   as HandedOverToCadre,	
                                                                                                  t.other_referral_facility as facility_referred_to,	
                                                                                                  l.facility_linked_to      as facility_linked_to,	
                                                                                                  t.encounter_location,	
                                                                                                  t.date_created,	
                                                                                                  t.date_last_modified,	
                                                                                                  t.voided                  as Voided	
                                                                                                  FROM dwapi_etl.etl_hts_test t	
                                                                                                  INNER JOIN dwapi_etl.etl_patient_demographics pt	
                                                                                                  ON pt.patient_id = t.patient_id	
                                                                                                  INNER JOIN dwapi_etl.etl_hiv_enrollment e ON e.patient_id = t.patient_id /*AND e.voided = 0*/	
                                                                                                  LEFT JOIN dwapi_etl.etl_hts_referral_and_linkage l ON l.patient_id = t.patient_id	
                                                                                                  LEFT JOIN (SELECT patient_id, min(date_started) as art_start_date	
                                                                                                  FROM dwapi_etl.etl_drug_event	
                                                                                                  group by patient_id) ar on ar.patient_id = t.patient_id	
                                                                                                  WHERE t.test_type = 2	
                                                                                                  AND t.final_test_result = 'Positive'	
                                                                                                  AND t.referral_facility is not null) a) a	
                                                                                                  join kenyaemr_etl.etl_default_facility_info i	
                                                                                                  left join dwapi_etl.etl_hts_referral ref on a.patient_id = ref.patient_id"|DWHStage|1|HtsClientLinkage|3|A6221AA4-0E85-11E8-BA89-0ED5F89F718B

8578b5a2-c34b-11e9-9cb5-2a2ae2dbcce4|Hts Test Kits|HTS|A62216EE-0E85-11E8-BA89-0ED5F89F718B|"select distinct p.PatientPK,
SiteCode,
p.FacilityName,
'IQCare' as Emr,
'Kenya HMIS II' as Project,
p.HTSID as HtsNumber,
HTSEncounterId as EncounterId,
TestKitName1,
TestKitLotNumber1,
TestKitExpiryDate1 as TestKitExpiry1,
TestResultsHTS1 as TestResult1,
TestKitName_2 as TestKitName2,
TestKitLotNumber_2 as TestKitLotNumber2,
TestKitExpiryDate_2 as TestKitExpiry2,
TestResultsHTS_2 as TestResult2
from tmp_HTS_LAB_register h inner join tmp_PatientMaster p
on h.PatientPK=p.PatientPK"|DWHStage|1|HtsTestKits|4|A6221983-0E85-11E8-BA89-0ED5F89F718B

8578b700-c34b-11e9-9cb5-2a2ae2dbcce4|Hts Test Kits|HTS|A6221856-0E85-11E8-BA89-0ED5F89F718B|"SELECT
                t.patient_id AS PatientPK,  
                t.uuid                                                            RecordUUID,	 
                (select FacilityName from kenyaemr_etl.etl_default_facility_info) as FacilityName,
                (select siteCode from kenyaemr_etl.etl_default_facility_info) as SiteCode,
                'KenyaEMR' as Emr,
                'Kenya HMIS II' AS Project,
                id.identifier AS HtsNumber,
                t.encounter_id AS EncounterId,
                t.test_1_kit_name AS TestKitName1,
                t.test_1_kit_lot_no AS TestKitLotNumber1,
                t.test_1_kit_expiry as TestKitExpiry1,
                t.test_1_result as TestResult1,
                t.test_2_kit_name as TestKitName2,
                t.test_2_kit_lot_no as TestKitLotNumber2,
                t.test_2_kit_expiry as TestKitExpiry2,
                t.test_2_result as TestResult2,
                t.syphillis_test_result as SyphilisResult,
                t.date_created as Date_Created,
                t.date_last_modified as Date_Last_Modified,
                t.voided                                                          as Voided
                FROM dwapi_etl.etl_hts_test t	
                inner join dwapi_etl.etl_patient_demographics demographics on t.patient_id = demographics.patient_id	
                LEFT JOIN location_attribute SC ON SC.location_id = t.encounter_location AND SC.attribute_type_id = 1	
                LEFT JOIN location SN ON SN.location_id = t.encounter_location	
                LEFT JOIN patient_identifier id ON id.patient_id = t.patient_id AND id.identifier_type =	
                (select patient_identifier_type_id	
                from patient_identifier_type	
                where name = 'OpenMRS ID')"|DWHStage|1|HtsTestKits|4|A6221AA4-0E85-11E8-BA89-0ED5F89F718B

8578b836-c34b-11e9-9cb5-2a2ae2dbcce4|Hts Client Tracing|HTS|A62216EE-0E85-11E8-BA89-0ED5F89F718B|"select distinct a.PatientPK, a.SiteCode, a. TracingType, a.TracingDate,
a.FacilityName,a.Emr,a.Project, a.HTSNumber AS HtsNumber, a.TracingOutcome from (select h.PatientPK,
tp.SiteCode,
TracingType = (Select TOP 1 ItemName From LookupItemView WHERE ItemId = tr.Mode),
DateTracingDone as TracingDate,
FacilityName,
'IQCare' as Emr,
'Kenya HMIS II' as Project,
tp.HTSID as HTSNumber,
Tpe = (Select TOP 1 ItemName From LookupItemView WHERE ItemId = tr.TracingType),
TracingOutcome = (Select Top 1 ItemName From LookupItemView WHERE ItemId = tr.Outcome)
from tmp_HTS_LAB_register h
inner join tmp_PatientMaster tp on tp.PatientPK =h.Patientpk
inner join patient pt on pt.ptn_pk=h.Patientpk
inner join Tracing tr on tr.personid=pt.id) a
where a.Tpe='Enrolment'"|DWHStage|1|HtsClientTracing|5|A6221983-0E85-11E8-BA89-0ED5F89F718B

8578b962-c34b-11e9-9cb5-2a2ae2dbcce4|Hts Client Tracing|HTS|A6221856-0E85-11E8-BA89-0ED5F89F718B|"SELECT
                            ht.patient_id as PatientPK,
                                htsrl.uuid                                                        RecordUUID,
                            (select FacilityName from kenyaemr_etl.etl_default_facility_info) as FacilityName,
                           (select siteCode from kenyaemr_etl.etl_default_facility_info) as SiteCode,
                            htsrl.tracing_type as TracingType,
                            htsrl.visit_date as TracingDate,
                            'KenyaEMR' as Emr,
                            'Kenya HMIS II' AS Project,
                                d.openmrs_id AS HtsNumber,
                            htsrl.tracing_status as TracingOutcome,
                                htsrl.date_created                                                as Date_Created,	
                          htsrl.date_last_modified                                          as Date_Last_Modified,
                          htsrl.voided                                                      as Voided	
                          FROM dwapi_etl.etl_hts_test ht	
                          INNER JOIN dwapi_etl.etl_patient_demographics d ON ht.patient_id = d.patient_id	
                          INNER JOIN dwapi_etl.etl_hts_referral_and_linkage htsrl ON ht.patient_id = htsrl.patient_id	
                          where ht.final_test_result = 'Positive'	
                          and ht.test_type = 2"|DWHStage|1|HtsClientTracing|5|A6221AA4-0E85-11E8-BA89-0ED5F89F718B

8578ba84-c34b-11e9-9cb5-2a2ae2dbcce4|Hts Partner Tracing|HTS|A62216EE-0E85-11E8-BA89-0ED5F89F718B|"select distinct a.IndexPatientPK as PatientPK, a.HtsNumber,
a.PartnerPersonId, a. TraceType,a.TraceDate, a.FacilityName,a.Emr,a.Project, a.SiteCode,a.TraceOutcome, a.BookingDate from (select pr.IndexPtn_pk as IndexPatientPK, tp.HTSID as HtsNumber,
pr.PersonId as PartnerPersonId,
TraceType = (Select TOP 1 ItemName From LookupItemView WHERE ItemId = tr.Mode),
DateTracingDone as TraceDate,
FacilityName,'IQCare' as Emr,'Kenya HMIS II' as Project,tp.SiteCode,
TraceOutcome = (Select Top 1 ItemName From LookupItemView WHERE ItemId = tr.Outcome),
Tpe = (Select TOP 1 ItemName From LookupItemView WHERE ItemId = tr.TracingType), tr.datebookedTesting as BookingDate
from (select pr.PersonId, pat.ptn_pk, ptIndex.ptn_pk as IndexPtn_pk
from PersonRelationship pr
left join patient ptIndex on ptIndex.id=pr.PatientId
left join patient pat on pat.PersonId=pr.PersonId
where pr.PatientId in (select PatientId
from PatientIdentifier pid
inner join Identifiers i on pid.IdentifierTypeId=i.id
where i.Name like '%hts%')) pr
inner join Tracing tr on tr.personid=pr.PersonId
inner join tmp_PatientMaster tp on tp.PatientPK =pr.IndexPtn_pk ) a
where a.Tpe='Partner'"|DWHStage|1|HtsPartnerTracing|6|A6221983-0E85-11E8-BA89-0ED5F89F718B

8578bbba-c34b-11e9-9cb5-2a2ae2dbcce4|Hts Partner Tracing|HTS|A6221856-0E85-11E8-BA89-0ED5F89F718B|"select distinct
                                                t.patient_id as PatientPK,
                                                    tc.uuid                      RecordUUID,
                                                id.identifier as HtsNumber,
                                                client_id as PartnerPersonId,
                                                contact_type as TraceType,
                                                encounter_date as TraceDate,
                                                (select FacilityName from kenyaemr_etl.etl_default_facility_info) as FacilityName,
                                                (select siteCode from kenyaemr_etl.etl_default_facility_info) as SiteCode,
                                                'KenyaEMR' as Emr,
                                                'Kenya HMIS II' AS Project,
                                                status as TraceOutcome,
                                                tc.appointment_date as BookingDate,
                                                    tc.date_created                                                   as DateCreated,	
                                               tc.date_changed                                                   as DateLastModified,	
                                               convert(tc.voided  , SIGNED)                                      as Voided
                                                from kenyaemr_hiv_testing_patient_contact pc	
                                               inner join dwapi_etl.etl_hts_test t on pc.patient_related_to = t.patient_id	
                                               inner join kenyaemr_hiv_testing_client_trace tc on pc.id = tc.client_id	
                                               LEFT JOIN patient_identifier id ON id.patient_id = t.patient_id AND id.identifier_type =	
                                               (select patient_identifier_type_id	
                                               from patient_identifier_type	
                                               where name = 'OpenMRS ID')	
                                               LEFT JOIN location_attribute SC ON SC.location_id = t.encounter_location AND SC.attribute_type_id = 1	
                                               LEFT JOIN location SN ON SN.location_id = t.encounter_location" |DWHStage|1|HtsPartnerTracing|6|A6221AA4-0E85-11E8-BA89-0ED5F89F718B

8578bce6-c34b-11e9-9cb5-2a2ae2dbcce4|Hts Partner Notification Services|HTS|A62216EE-0E85-11E8-BA89-0ED5F89F718B|"SELECT distinct pns.ptn_pk as PatientPK,a.SiteCode,a.FacilityName,
'IQCare' as Emr, 'Kenya HMIS II' as Project,HTS_Number as HtsNumber, pd.PatientPK as PartnerPatientPk,pns.personid as PartnerPersonID,
pns.AgeYears as Age, pns.PNSSex as Sex, RelationsipToIndexClient, ScreenedForIPV as ScreenedForIpv,
IPVScreeningOutcome as IpvScreeningOutcome, CurrentlyLivingWithIndexClient, KnowledgeOfHIVStatus as KnowledgeOfHivStatus,
PNSApproach as PnsApproach , PNSConsent as PnsConsent, Linked as LinkedToCare, b.dateEnrolled as LinkDateLinkedToCare,
b.CCCNumber as CccNumber, b.FacilityEnrolled as FacilityLinkedTo, pd.dateofbirth as Dob,
pns.Date as DateElicited,
pns.MaritalStatus
  FROM  tmp_PNS_Register pns
    INNER JOIN dbo.tmp_HTS_LAB_register AS c ON pns.Ptn_pk = c.PatientPK
	INNER JOIN tmp_PatientMaster AS a ON pns.Ptn_pk = a.PatientPK
	LEFT JOIN dbo.tmp_HTS_LAB_register AS pc ON pns.PersonID = pc.PersonID
    LEFT JOIN tmp_Referral_Linkage_Register b ON pc.PatientPK = b.ptn_pk

    LEFT JOIN tmp_PersonDetails pd ON pd.PersonID = pns.personid
  WHERE c.finalResultHTS = 'Positive' AND pns.personid IS NOT NULL"|DWHStage|1|HtsPartnerNotificationServices|7|A6221983-0E85-11E8-BA89-0ED5F89F718B


8578c042-c34b-11e9-9cb5-2a2ae2dbcce4|Hts Partner Notification Services|HTS|A6221856-0E85-11E8-BA89-0ED5F89F718B|"SELECT
                                                  DISTINCT
                                                                 t.patient_id AS PatientPK,
                                                                ohpc.uuid                                                         RecordUUID,
                                                                 (select FacilityName from kenyaemr_etl.etl_default_facility_info) as FacilityName,
                                                                 (select siteCode from kenyaemr_etl.etl_default_facility_info) as SiteCode,
                                                                 'KenyaEMR' as Emr,
                                                                 'Kenya HMIS II' AS Project,
                                                                 id.identifier AS HtsNumber,
                                                                 ohpc.patient_id AS PartnerPatientPk,
                                                                 ohpc.patient_related_to 		AS IndexPatientPk,
                                                                 ohpc.id AS PartnerPersonId,
                                                      YEAR(ohpc.date_created)-YEAR(ohpc.birth_date)  AS Age,
                                                                 ohpc.sex,
                                                                 CASE ohpc.relationship_type
                                                                                                WHEN 970          THEN  'parent (Mother)'
                                                                                                WHEN 971           THEN  'parent(Father)'
                                                                                                WHEN 972          THEN  'sibling'
                                                                                                WHEN 1528        THEN  'Child'
                                                                                                WHEN 5617          THEN  'spouse'
                                                              WHEN 163565  THEN  'partner'
                                                                                                WHEN 162221  THEN  'cowife'
                                                                 END     AS RelationsipToIndexClient,
                                                  
                                                      /*Screened for IPV? CASE?*/
                                                                 CASE WHEN ohpc.ipv_outcome IS NOT NUll THEN 'Yes' ELSE 'No' END AS  ScreenedForIpv,
                                                  
                                                                 ohpc.ipv_outcome AS IpvScreeningOutcome,
                                                                 CASE ohpc.living_with_patient
                                                                                 WHEN 1065 THEN 'Yes'
                                                                                 WHEN 1066 THEN 'No'
                                                                 END AS CurrentlyLivingWithIndexClient,
                                                      /*knowledgeof HIV Status*/
                                                      ohpc.baseline_hiv_status as KnowledgeOfHivStatus,
                                                  
                                                  pnsApprocah.name AS  PnsApproach,
                                                  ohpc.consented_contact_listing as  PnsConsent,
                                                  case when ctrace.status is null then 'N' else 'Y' end as LinkedToCare,
                                                  ctrace.encounter_date as  LinkDateLinkedToCare,
                                                  ctrace.unique_patient_no as CccNumber,
                                                  ctrace.facility_linked_to as FacilityLinkedTo,
                                                  ohpc.birth_date as DoB,
                                                  ohpc.date_created as DateElicited ,
                                                  marital.name as  MaritalStatus,
                                                    ohpc.date_created                                                 as DateCreated,	
                                                 ohpc.date_changed                                                 as DateLastModified,	
                                                 convert(ohpc.voided   , SIGNED)                                   as Voided                                                  
                                                  FROM dwapi_etl.etl_hts_test t	
                                                 INNER JOIN kenyaemr_hiv_testing_patient_contact ohpc ON ohpc.patient_related_to = t.patient_id	
                                                 LEFT JOIN location_attribute SC ON SC.location_id = t.encounter_location AND SC.attribute_type_id = 1	
                                                 LEFT JOIN location SN ON SN.location_id = t.encounter_location	
                                                 LEFT JOIN patient_identifier id ON id.patient_id = t.patient_id AND id.identifier_type =	
                                                 (select patient_identifier_type_id	
                                                 from patient_identifier_type	
                                                 where name = 'OpenMRS ID')	
                                                 left JOIN patient openmrs ON openmrs.patient_id = id.patient_id	
                                                 left JOIN kenyaemr_hiv_testing_client_trace ctrace	
                                                 ON ctrace.client_id = ohpc.id and ctrace.status = 'Contacted and Linked'	
                                                 left join concept_name marital ON marital.concept_id = ohpc.marital_status and marital.locale = 'en' and
                                                 marital.concept_name_type = 'FULLY_SPECIFIED'	
                                                 left join concept_name pnsApprocah	
                                                 ON pnsApprocah.concept_id = ohpc.pns_approach and pnsApprocah.locale = 'en' and	
                                                 pnsApprocah.concept_name_type = 'FULLY_SPECIFIED'"|DWHStage|1|HtsPartnerNotificationServices|7|A6221AA4-0E85-11E8-BA89-0ED5F89F718B



7bb8b081-c206-49ba-aac0-48bf14fdc84e|Hts Eligibility Screening|HTS|A6221856-0E85-11E8-BA89-0ED5F89F718B|"SELECT t.patient_id as PatientPK,
                                t.uuid                                                                      RecordUUID,
                                          (select siteCode from kenyaemr_etl.etl_default_facility_info)               as SiteCode,
                                          (select FacilityName from kenyaemr_etl.etl_default_facility_info)           as FacilityName,
                                          'KenyaEMR'                                                                  as Emr,
                                          'Kenya HMIS II'                                                             as Project,
                                          demographics.openmrs_id                                                     as HtsNumber,
                                          t.visit_id                                                                  as VisitID,
                                          t.encounter_id                                                              as EncounterId,
                                          t.visit_date                                                                as VisitDate, 
                                          '' as ForcedSex,                                                    
                                          case t.population_type
                                              when 164928 then 'General Population'
                                              when 164929 then 'Key Population'
                                              when 138643
                                                  then 'Priority Population' end                                      as PopulationType,
                                          t.key_population_type                                                       as KeyPopulation,
                                          t.priority_population_type                                                  as PriorityPopulation,
                                             t.patient_disabled                                                          as Disability,	
                                         t.disability_type                                                           as DisabilityType,	
                                         case t.test_strategy	
                                         when 164163 then 'HP: Hospital Patient Testing'	
                                         when 164953 then 'NP: HTS for non-patients'	
                                         when 164954 then 'VI:Integrated VCT Center'	
                                         when 164955 then 'VS:Stand Alone VCT Center'	
                                         when 159938 then 'HB:Home Based Testing'	
                                         when 159939 then 'MO: Mobile Outreach HTS'	
                                         when 161557 then 'Index testing'	
                                         when 166606 then 'SNS - Social Networks'	
                                         when 5622	
                                         then 'O:Other' end                                                  as HTSStrategy,	
                                         (case t.hts_entry_point	
                                         when 5485 then 'In Patient Department(IPD)'	
                                         when 160542 then 'Out Patient Department(OPD)'	
                                         when 162181 then 'Peadiatric Clinic'	
                                         when 160552 then 'Nutrition Clinic'	
                                         when 160538 then 'PMTCT ANC'	
                                         when 160456 then 'PMTCT MAT'	
                                         when 1623 then 'PMTCT PNC'	
                                         when 160541 then 'TB'	
                                         when 162050 then 'CCC'	
                                         when 159940 then 'VCT'	
                                         when 159938 then 'Home Based Testing'	
                                         when 159939 then 'Mobile Outreach'	
                                         when 162223 then 'VMMC'	
                                         when 160546 then 'STI Clinic'	
                                         when 160522 then 'Emergency'	
                                         when 163096 then 'Community Testing'	
                                         when 5622	
                                         then 'Other' end)                                                  as HTSEntryPoint,	
                                         t.hts_risk_category                                                         as HIVRiskCategory,
                                         CONCAT('',t.hts_risk_score, '' )                                           as HtsRiskScore,
                                          case t.department
                                              when 160542 then 'OPD:Out-patient department'
                                              when 5485 then 'IPD:In-patient department'
                                              when 160473 then 'Emergency'
                                              when 160538 then 'PMTCT'
                                              when 159940
                                                  then 'VCT' end                                                      as Department,
                                          case t.patient_type
                                              when 164163 then 'HP:Hospital Patient'
                                              when 164953
                                                  then 'NP:Non-Hospital Patient' end                                  as PatientType,
                                          case t.is_health_worker when 1065 then 'Yes' when 1066 then 'No' end        as IsHealthWorker,
                                          t.relationship_with_contact                                                 as RelationshipWithContact,
                                             case t.mother_hiv_status when 703 then 'Positive' when 664 then 'Negative' when 1067 then 'Unknown' end as MothersStatus,
                                          case t.tested_hiv_before when 1065 then 'Yes' when 1066 then 'No' end       as TestedHIVBefore,
                                          case t.who_performed_test
                                              when 5619 then 'HTS Provider'
                                              when 164952
                                                  then 'Self Tested' end                                              as WhoPerformedTest,
                                          (case t.test_results
                                               when 703 then 'Positive'
                                               when 664 then 'Negative'
                                               when 1067 then 'Unknown'
                                               else '' end)                                                           as ResultOfHIV,
                                          if(t.who_performed_test = 164952,t.date_tested,null)                             as DateTestedSelf,	
                                          if(t.who_performed_test = 164952,case t.test_results	
                                          when 703 then 'Positive'	
                                          when 664 then 'Negative'	
                                          when 1067 then 'Unknown'	
                                          else '' end,null)                                                           as ResultOfHIVSelf,	
                                          if(t.who_performed_test = 5619,t.date_tested, null)                             as DateTestedProvider,
                                          case t.started_on_art when 1065 then 'Yes' when 1066 then 'No' end          as StartedOnART,
                                          t.upn_number                                                                as CCCNumber,
                                          case t.ever_had_sex 		
                                             when 1 then 'Yes'	
                                             when 0 then 'No'	
                                             end                                                                     as EverHadSex,
                                          t.sexually_active 													        as SexuallyActive,
                                          t.new_partner 															    as NewPartner,
                                          t.partner_hiv_status														as PartnerHIVStatus,
                                          case t.couple_discordant when 1065 then 'Yes' when 1066 then 'No' end       as CoupleDiscordant,
                                          t.multiple_partners                                                   as MultiplePartners,
                                          t.number_partners                                                           as NumberOfPartners,
                                          case t.alcohol_sex
                                              when 1066 then 'Not at all'
                                              when 1385 then 'Sometimes'
                                              when 165027
                                                  then 'Always' end                                                   as AlcoholSex,
                                           t.money_sex                												as MoneySex,
                                           t.condom_burst            													as CondomBurst,
                                           t.unknown_status_partner   												as UnknownStatusPartner,
                                           t.known_status_partner  													as KnownStatusPartner,
                                           t.pregnant                													as Pregnant,
                                           t.breastfeeding_mother     												as BreastfeedingMother,
                                           t.experienced_gbv       													as ExperiencedGBV,
                                          t.type_of_gbv                                                               as TypeGBV,	
                                          t.service_received                                                          as ReceivedServices,
                                          t.currently_on_prep 												   		as CurrentlyOnPrEP,
                                         t.recently_on_pep 												            as CurrentlyOnPEP,
                                          t.recently_had_sti 												       		as CurrentlyHasSTI,
                                          t.tb_screened 																as  ScreenedTB,	
                                          case t.cough when 159799 then 'Yes' when 1066 then 'No' end as Cough,	
                                          case t.fever when 1494 then 'Yes' when 1066 then 'No' end as Fever,	
                                          case t.weight_loss when 832 then 'Yes' when 1066 then 'No' end as WeightLoss,	
                                          case t.night_sweats when 133027 then 'Yes' when 1066 then 'No' end as NightSweats,	
                                          case t.contact_with_tb_case when 124068 then 'Yes' when 1066 then 'No' end as ContactWithTBCase,	
                                          case t.lethargy when 116334 then 'Yes' when 1066 then 'No' end as Lethargy,	
                                          case t.tb_status when 1660 then 'No TB signs' when 142177 then 'Presumed TB' when 1662 then 'TB Confirmed' end as TBStatus,
                                          case t.shared_needle when 1065 then 'Yes' when 1066 then 'No' end           as SharedNeedle,
                                          case t.needle_stick_injuries when 153574 then 'Yes' when 1066 then 'No' end as NeedleStickInjuries,
                                          case t.traditional_procedures when 1065 then 'Yes' when 1066 then 'No' end  as TraditionalProcedures,
                                          t.child_reasons_for_ineligibility                                           as ChildReasonsForIneligibility,
                                             ''                                                                          as AssessmentOutcome,
                                          case t.eligible_for_test when 1065 then 'Yes' when 1066 then 'No' end       as EligibleForTest,
                                          case t.referred_for_testing when 1065 then 'Yes' when 1066 then 'No' end    as ReferredForTesting,	
                                         t.reason_to_test                                                            as ReasonRefferredForTesting,	
                                         t.reason_not_to_test                                                        as ReasonNotReffered,	
                                         t.reasons_for_ineligibility                                                 as ReasonsForIneligibility,
                                          t.specific_reason_for_ineligibility                                         as SpecificReasonForIneligibility,	
                                          t.date_created                                                              as DateCreated,
                                          t.date_last_modified                                                        as DateLastModified,
                                            t.voided                                                                    as Voided	
                                        FROM dwapi_etl.etl_hts_eligibility_screening t	
                                        inner join dwapi_etl.etl_patient_demographics demographics on t.patient_id = demographics.patient_id	
                                        LEFT JOIN openmrs.location_attribute SC ON SC.location_id = t.location_id AND SC.attribute_type_id = 1	
                                        LEFT JOIN openmrs.location SN ON SN.location_id = t.location_id	
                                        group by t.encounter_id"|DWHStage|1|HtsEligibilityExtract|8|A6221AA4-0E85-11E8-BA89-0ED5F89F718B


290bd21c-3089-11ea-978f-2e728ce88125|Master Patient Index|CBS|926f49b8-305d-11ea-978f-2e728ce88125|"SELECT
*
, LEFT([Gender],1)+[sxFirstName]+[sxLastName]+LTRIM(RTRIM(STR(YEAR(X.DOB)))) AS [sxPKValue]
, LEFT([Gender],1) + CASE
	WHEN CHARINDEX(';',[dmFirstName])>0 THEN
	SUBSTRING([dmFirstName],CHARINDEX(';',[dmFirstName])+1,LEN([dmFirstName]))
	ELSE [dmFirstName] END +
	CASE
	WHEN CHARINDEX(';',[dmLastName])>0 THEN
	SUBSTRING([dmLastName],CHARINDEX(';',[dmLastName])+1,LEN([dmLastName]))
	ELSE [dmLastName] END + LTRIM(RTRIM(STR(YEAR(DOB)))) AS [dmPKValue]
, CASE WHEN CHARINDEX(';',[dmLastName])>0 THEN
LEFT([Gender],1)+ [sxFirstName]+ SUBSTRING([dmLastName],CHARINDEX(';',[dmLastName])+1,LEN([dmLastName]))+LTRIM(RTRIM(STR(YEAR(DOB))))
ELSE
LEFT([Gender],1)+ [sxFirstName]+[dmLastName]+LTRIM(RTRIM(STR(YEAR(DOB))))
END AS [sxdmPKValue],
LEFT([Gender],1)+[sxFirstName]+[sxLastName]+LTRIM(RTRIM(STR(CONVERT(VARCHAR(20),DOB,112)))) AS [sxPKValueDoB],
LEFT([Gender],1)+
CASE
WHEN CHARINDEX(';',[dmFirstName])>0 THEN
SUBSTRING([dmFirstName],CHARINDEX(';',[dmFirstName])+1,LEN([dmFirstName]))
ELSE
[dmFirstName]
END +
CASE
WHEN CHARINDEX(';',[dmLastName])>0 THEN
SUBSTRING([dmLastName],CHARINDEX(';',[dmLastName])+1,LEN([dmLastName]))
ELSE
[dmLastName]
END +LTRIM(RTRIM(STR(CONVERT(VARCHAR(20),DOB,112)))) AS [dmPKValueDoB],
CASE WHEN CHARINDEX(';',[dmLastName])>0 THEN
LEFT([Gender],1)+ [sxFirstName]+ SUBSTRING([dmLastName],CHARINDEX(';',[dmLastName])+1,LEN([dmLastName]))+LTRIM(RTRIM(STR(CONVERT(VARCHAR(20),DOB,112))))
ELSE
LEFT([Gender],1)+ [sxFirstName]+[dmLastName]+LTRIM(RTRIM(STR(CONVERT(VARCHAR(20),DOB,112))))
END AS [sxdmPKValueDoB]

FROM
(
SELECT
-------Demographics
a.Ptn_Pk
,a.PatientPK
,a.SiteCode
,a.FacilityName
,a.[PatientID]Serial
,UPPER(c.FirstName) FirstName
,UPPER(C.MidName) MiddleName
,UPPER(c.LastName) LastName
,dbo.[fnReplaceInvalidChars](UPPER(REPLACE(c.FirstName,'0','O'))) AS [FirstName_Normalized]
,dbo.[fnReplaceInvalidChars](UPPER(REPLACE(c.MidName,'0','O'))) AS [MiddleName_Normalized]
,dbo.[fnReplaceInvalidChars](UPPER(REPLACE(c.LastName,'0','O'))) AS [LastName_Normalized]
,SOUNDEX(dbo.[fnReplaceInvalidChars](UPPER(REPLACE(c.FirstName,'0','O')))) AS  [sxFirstName]
,SOUNDEX(dbo.[fnReplaceInvalidChars](UPPER(REPLACE(c.LastName,'0','O')))) AS [sxLastName]
,SOUNDEX(dbo.[fnReplaceInvalidChars](UPPER(REPLACE(c.MidName,'0','O')))) AS sxMiddleName
,[dmFirstName]= dbo.fn_getPatientNameDoubleMetaphone(dbo.[fnReplaceInvalidChars](UPPER(REPLACE(c.FirstName,'0','O'))))
,[dmLastName] = dbo.fn_getPatientNameDoubleMetaphone(dbo.[fnReplaceInvalidChars](UPPER(REPLACE(c.MidName,'0','O'))))
,dmMiddleName = dbo.fn_getPatientNameDoubleMetaphone(dbo.[fnReplaceInvalidChars](UPPER(REPLACE(c.LastName,'0','O'))))
,a.[PhoneNumber]PatientPhoneNumber
,NULL PatientAlternatePhoneNumber
,a.[Gender]
,a.[DOB]
,a.[MaritalStatus]
-------Patient Address
,a.[PatientSource]
,(Select top 1 Region FROM IQC_SiteDetails) PatientCounty
,(Select top 1 District FROM IQC_SiteDetails)PatientSubCounty
,[Village]PatientVillage
-------Patient-Identifiers
, a.PatientID
,c.NationalId [NationalId]
,NULL as [NHIF_Number]
,NULL as [Birth_Certificate]
,a.[PatientID] [CCC_Number]
,NULL[TB_Number]
-------Next Of Kin

,LTRIM(RTRIM(ContactName)) AS ContactName
,[ContactRelation] AS  ContactRelation
,[ContactPhoneNumber] as ContactPhoneNumber
,[ContactAddress] as ContactAddress
, NULL AS  NokNationalId
-------Additional Variables
, HIVDiagnosisDate DateConfirmedHIVPositive
,b.[StartARTDate]
,[StartRegimen]StartARTRegimenCode
,[StartRegimenLine]StartARTRegimenDesc

FROM [dbo].[tmp_PatientMaster] a
inner join Patient bb on a.PatientPK = bb.Id
inner join Person_Decoded c ON bb.PersonId = c.PersonID
left  join

(SELECT DISTINCT a.PatientPK
, a.PatientID
, a.RegistrationAtCCC
, b.StartARTDate
, b.StartRegimen
, 'First Line' StartRegimenLine
FROM
tmp_PatientMaster AS a LEFT OUTER JOIN dbo.tmp_ARTPatients AS b ON a.PatientPK = b.PatientPK
WHERE  (a.RegistrationAtCCC IS NOT NULL)) b on a.patientpk=b.patientpk
) X
INNER JOIN
(
SELECT
a.PatientPK
,a.[PatientID] Serial
FROM [dbo].[tmp_PatientMaster] a
left  join (SELECT DISTINCT a.PatientPK, a.PatientID, a.RegistrationAtCCC, b.StartARTDate, b.StartRegimen, 'First Line' StartRegimenLine
FROM dbo.tmp_PatientMaster AS a LEFT OUTER JOIN dbo.tmp_ARTPatients AS b ON a.PatientPK = b.PatientPK
WHERE  (a.RegistrationAtCCC IS NOT NULL)) b on a.patientpk=b.patientpk

)Y
ON
Y.PatientPK = X.PatientPK AND Y.Serial= X.Serial
"|MPI|0|MasterPatientIndex|1|a6221988-0e85-11e8-ba89-0ed5f89f718b

290bd4b0-3089-11ea-978f-2e728ce88125|Hts Clients|HTS|926f49b8-305d-11ea-978f-2e728ce88125|"select distinct h.PatientPk,
SiteCode,
FacilityName,
'IQCare' as Emr,
'Kenya HMIS II' as Project,
HTSID as HtsNumber  ,
h.DOB as Dob,
h.Gender,
h.MaritalStatus,
case when LTRIM(h.KeyPop) in ('SW','PWID','MSM','Other','MSW','FSW') then 'Key Population' else 'General Population' end as PopulationType,
LTRIM(h.KeyPop)  as KeyPopulationType,
Disability as PatientDisabled,
County,
SubCounty,
Ward from  tmp_HTS_LAB_register h inner join tmp_PatientMaster p
on h.PatientPK=p.PatientPK
order by KeyPopulationType"|dwhstage|0|HtsClient|1|a6221988-0e85-11e8-ba89-0ed5f89f718b
290bd780-3089-11ea-978f-2e728ce88125|Hts Client Tests|HTS|926f49b8-305d-11ea-978f-2e728ce88125|"select distinct h.PatientPK,
SiteCode,
FacilityName,
'IQCare' as Emr,
'Kenya HMIS II' as Project,
p.HTSID as HtsNumber,
HTSEncounterId as EncounterId,
VisitDate as TestDate,
TestedBefore as EverTestedForHiv,
WhenLastTested as MonthsSinceLastTest,
ClientTestedAs,
TestEntryPoint as EntryPoint,
StrategyHTS as TestStrategy,
FinalTestOneResult as TestResult1,
FinalResultTestTwo as TestResult2,
finalResultHTS as FinalTestResult,
FinalResultsGiven as PatientGivenResult,
TBScreeningHTS as TbScreening,
clientSelfTestesd as ClientSelfTested,
CoupleDiscordant,
TestType,
case when Consent='1' or Consent='Yes' then 'Yes' else 'No' end as Consent from  tmp_HTS_LAB_register h inner join tmp_PatientMaster p
on h.PatientPK=p.PatientPK"|dwhstage|0|HtsClientTests|2|a6221988-0e85-11e8-ba89-0ed5f89f718b
290bd8e8-3089-11ea-978f-2e728ce88125|Hts Client Linkage|HTS|926f49b8-305d-11ea-978f-2e728ce88125|"SELECT distinct r.ptn_pk as PatientPK,SiteCode,
p.FacilityName,
'IQCare' as Emr,
'Kenya HMIS II' as Project,
p.HTSID as HtsNumber,
ref.referraldate as DatePrefferedToBeEnrolled,
case when ref.tofacility=99999 then 'Other Facility'else (
select name from FacilityList where MFLCode=ref.tofacility ) end as FacilityReferredTo,
HandedOverTo,
HandedOverToCadre,
r.FacilityEnrolled as EnrolledFacilityName,
ref.createdate as ReferralDate,
dateEnrolled as DateEnrolled,
r.CCCNumber as ReportedCCCNumber,
r.ArtStartDate as ReportedStartARTDate
  FROM tmp_Referral_Linkage_Register r
  inner join tmp_PatientMaster p on r.ptn_pk=p.PatientPK
  inner join tmp_HTS_LAB_register plab on r.ptn_pk=plab.PatientPK
  inner join patient pat on pat.ptn_pk=r.ptn_pk
  left join Referral ref on pat.personid=ref.personid"|dwhstage|0|HtsClientLinkage|3|a6221988-0e85-11e8-ba89-0ed5f89f718b
290bda28-3089-11ea-978f-2e728ce88125|Hts Test Kits|HTS|926f49b8-305d-11ea-978f-2e728ce88125|"select distinct p.PatientPK,
SiteCode,
p.FacilityName,
'IQCare' as Emr,
'Kenya HMIS II' as Project,
p.HTSID as HtsNumber,
HTSEncounterId as EncounterId,
TestKitName1,
TestKitLotNumber1,
TestKitExpiryDate1 as TestKitExpiry1,
TestResultsHTS1 as TestResult1,
TestKitName_2 as TestKitName2,
TestKitLotNumber_2 as TestKitLotNumber2,
TestKitExpiryDate_2 as TestKitExpiry2,
TestResultsHTS_2 as TestResult2
from tmp_HTS_LAB_register h inner join tmp_PatientMaster p
on h.PatientPK=p.PatientPK"|dwhstage|0|HtsTestKits|4|a6221988-0e85-11e8-ba89-0ed5f89f718b
290bdb54-3089-11ea-978f-2e728ce88125|Hts Client Tracing|HTS|926f49b8-305d-11ea-978f-2e728ce88125|"select distinct a.PatientPK, a.SiteCode, a. TracingType, a.TracingDate,
a.FacilityName,a.Emr,a.Project, a.HTSNumber AS HtsNumber, a.TracingOutcome from (select h.PatientPK,
tp.SiteCode,
TracingType = (Select TOP 1 ItemName From LookupItemView WHERE ItemId = tr.Mode),
DateTracingDone as TracingDate,
FacilityName,
'IQCare' as Emr,
'Kenya HMIS II' as Project,
tp.HTSID as HTSNumber,
Tpe = (Select TOP 1 ItemName From LookupItemView WHERE ItemId = tr.TracingType),
TracingOutcome = (Select Top 1 ItemName From LookupItemView WHERE ItemId = tr.Outcome)
from tmp_HTS_LAB_register h
inner join tmp_PatientMaster tp on tp.PatientPK =h.Patientpk
inner join patient pt on pt.ptn_pk=h.Patientpk
inner join Tracing tr on tr.personid=pt.id) a
where a.Tpe='Enrolment'"|dwhstage|0|HtsClientTracing|5|a6221988-0e85-11e8-ba89-0ed5f89f718b
290bdc8a-3089-11ea-978f-2e728ce88125|Hts Partner Tracing|HTS|926f49b8-305d-11ea-978f-2e728ce88125|"select a.IndexPatientPK as PatientPK, a.HtsNumber
,   a.PartnerPersonId, a. TraceType,a.TraceDate,   a.FacilityName,a.Emr,a.Project, a.SiteCode,a.TraceOutcome, a.BookingDate
from (select pr.IndexPtn_pk as IndexPatientPK
, tp.HTSID as HtsNumber
,   pr.PersonId as PartnerPersonId
,  TraceType = (Select TOP 1 ItemName From LookupItemView WHERE ItemId = tr.Mode)
,  DateTracingDone as TraceDate
,  FacilityName
,'IQCare' as Emr
,'Kenya HMIS II' as Project
,tp.SiteCode
,  TraceOutcome = (Select Top 1 ItemName From LookupItemView WHERE ItemId = tr.Outcome)
,  Tpe = (Select TOP 1 ItemName From LookupItemView WHERE ItemId = tr.TracingType), tr.datebookedTesting as BookingDate
from   (select pr.PersonId
	, pat.ptn_pk
	, ptIndex.ptn_pk as IndexPtn_pk
	from PersonRelationship pr
left join patient ptIndex on ptIndex.id=pr.PatientId
left join patient pat on pat.PersonId=pr.PersonId) pr

inner join Tracing tr on tr.personid=pr.PersonId
inner join tmp_PatientMaster tp on tp.Ptn_Pk =pr.IndexPtn_pk ) a  where a.Tpe='Partner'"|dwhstage|0|HtsPartnerTracing|6|a6221988-0e85-11e8-ba89-0ed5f89f718b
290bddb6-3089-11ea-978f-2e728ce88125|Hts Partner Notification Services|HTS|926f49b8-305d-11ea-978f-2e728ce88125|"SELECT distinct pns.ptn_pk as PatientPK
,a.SiteCode,a.FacilityName
,  'IQCare' as Emr, 'Kenya HMIS II' as Project
,HTS_Number as HtsNumber
, pd.Ptn_Pk as PartnerPatientPk
, pns.personid as PartnerPersonID
, pns.Age, pns.Gender as Sex
, RelationsipToIndexClient
, ScreenedForIPV as ScreenedForIpv
, IPVScreeningOutcome as IpvScreeningOutcome
, CurrentlyLivingWithIndexClient
, KnowledgeOfHIVStatus as KnowledgeOfHivStatus
, PNSApproach as PnsApproach
, PNSConsent as PnsConsent
, Linked as LinkedToCare
, b.dateEnrolled as LinkDateLinkedToCare
, b.CCCNumber as CccNumber
, b.FacilityEnrolled as FacilityLinkedTo
, DATEADD(yy,-pns.Age,pns.Date) as Dob
, pns.Date as DateElicited, pns.MaritalStatus
FROM  tmp_PNS_Register pns
	INNER JOIN dbo.tmp_HTS_LAB_register AS c ON pns.Ptn_pk = c.PatientPK
	INNER JOIN tmp_PatientMaster AS a ON pns.Ptn_pk = a.Ptn_Pk
	LEFT JOIN dbo.tmp_HTS_LAB_register AS pc ON pns.PersonID = pc.PersonID
	LEFT JOIN tmp_Referral_Linkage_Register b ON pc.PatientPK = b.ptn_pk
	LEFT JOIN Person pd ON pd.Id = pns.personid
WHERE c.finalResultHTS = 'Positive' AND pns.personid IS NOT NULL"|dwhstage|0|HtsPartnerNotificationServices|7|a6221988-0e85-11e8-ba89-0ed5f89f718b

b6299cbc-3055-11ea-978f-2e728ce88125|All Patients|NDWH|926f49b8-305d-11ea-978f-2e728ce88125|"WITH locator
     AS (SELECT Pat.id                  PatientPK,
                look.NAME               PatientType,
                pop.populationcategory  PopulationType,
                ''                      AS KeyPopulationType,
                CASE
                  WHEN ovc.orphan = 1 THEN 'Yes'
                  ELSE 'No'
                END                     AS Orphan,
                CASE
                  WHEN ovc.inschool = 1 THEN 'Yes'
                  ELSE 'No'
                END                     AS InSchool,
                county.countyname       AS PatientResidentCounty,
                subcounty.subcountyname AS PatientResidentSubCounty,
                loc.location            AS PatientResidentLocation,
                loc.sublocation         PatientResidentSubLocation,
                ward.wardname           AS PatientResidentWard,
                loc.village             AS PatientResidentVillage
         FROM   patient pat
                LEFT JOIN person per
                       ON per.id = pat.personid
                LEFT JOIN lookupitem look
                       ON look.id = pat.patienttype
                LEFT JOIN patientpopulationview pop
                       ON pop.patientpk = Pat.ptn_pk
                LEFT JOIN [patientovcstatus] ovc
                       ON ovc.personid = pat.personid
                LEFT JOIN personlocation loc
                       ON loc.personid = Pat.personid
                          AND loc.deleteflag = 0
                LEFT JOIN county
                       ON county.countyid = loc.county
                LEFT JOIN county subcounty
                       ON subcounty.subcountyid = loc.subcounty
                LEFT JOIN county ward
                       ON ward.wardid = loc.ward
         GROUP  BY Pat.id,
                   look.NAME,
                   patienttype,
                   loc.location,
                   loc.sublocation,
                   pop.populationcategory,
                   orphan,
                   inschool,
                   county.countyname,
                   subcounty.subcountyname,
                   loc.sublocation,
                   ward.wardname,
                   loc.village),
     transferin
     AS (SELECT a.id PatientPK,
                b.transferindate
         FROM   patient a
                LEFT JOIN patienttransferin b
                       ON a.id = b.patientid
                LEFT JOIN lookupitem c
                       ON b.currenttreatment = c.id
         WHERE  patienttype = 260)
SELECT patientid,
       a.patientpk,
       (SELECT TOP 1 facilityid
        FROM   iqc_sitedetails) FacilityID,
       sitecode,
       facilityname,
       satellitename,
       gender,
       dob,
       registrationdate,
       registrationatccc,
       registrationatpmtct,
       NULL                     RegistrationAtTBClinic,
       patientsource,
       (SELECT TOP 1 region
        FROM   iqc_sitedetails) Region,
       (SELECT TOP 1 district
        FROM   iqc_sitedetails) District,
       village,
       contactrelation,
       lastvisit,
       maritalstatus,
       NULL                     EducationLevel,
       hivdiagnosisdate         DateConfirmedHIVPositive,
       NULL                     PreviousARTExposure,
       NULL                     PreviousARTStartDate,
       CASE
         WHEN dbo.Fn_activeccc(Getdate(), a.patientpk) = 1 THEN 'Active'
         ELSE NULL
       END                      AS StatusAtCCC,
       NULL                     StatusAtPMTCT,
       NULL                     StatusAtTBClinic,
       'IQCare'                 AS EMR,
       'CHAP Uzima'             AS Project,
       b.patienttype,
       b.populationtype,
       ''                       KeyPopulationType,
       b.orphan,
       b.inschool,
       b.patientresidentcounty,
       b.patientresidentsubcounty,
       b.patientresidentlocation,
       b.patientresidentsublocation,
       b.patientresidentward,
       b.patientresidentvillage,
       c.transferindate,
       Cast(Getdate() AS DATE)  AS DateExtracted,
       Newid()                  AS ID
FROM   tmp_patientmaster AS a
       LEFT JOIN locator b
              ON a.patientpk = b.patientpk
       LEFT JOIN transferin c
              ON a.patientpk = c.patientpk
WHERE  a.registrationatccc IS NOT NULL
"|dwhstage|1|PatientExtract|1|a6221988-0e85-11e8-ba89-0ed5f89f718b
b629a1a8-3055-11ea-978f-2e728ce88125|ART Patients|NDWH|926f49b8-305d-11ea-978f-2e728ce88125|"with arvPharmacy as (select PatientPK
, MIN(DateDispensed) DateDispensed
from tmp_ARVPharmacy
GROUP BY PatientPK)

, lastDispense as (select a.PatientPK, max(Duration) Duration
from tmp_ARVPharmacy a inner join (
select PatientPK
, MAX(DateDispensed) DateDispensed
from tmp_ARVPharmacy
GROUP BY PatientPK) b on a.PatientPK = b.PatientPK and a.DateDispensed = b.DateDispensed
group by a.PatientPK)

SELECT

 a.PatientPK
 , a.PatientID
 , (SELECT TOP 1 FacilityID FROM IQC_SiteDetails) FacilityID
 , b.SiteCode
 , a.FacilityName
 , a.DOB
 , a.AgeEnrollment
 , a.AgeARTStart
 , a.AgeLastVisit
 , a.RegistrationDate
 , a.PatientSource
 , a.Gender
 , a.StartARTDate
 , case when c.DateDispensed < a.StartARTDate then c.DateDispensed else a.StartARTDate end PreviousARTStartDate
 , NULL PreviousARTRegimen
 , c.DateDispensed StartARTAtThisFacility
 , a.StartRegimen
 , 'First Line' StartRegimenLine
 , a.LastARTDate
 , a.LastRegimen
 , case a.LastRegimenLine when 1 then 'First Line' when 2 then 'Second Line' else null end as LastRegimenLine
 , d.Duration
 , a.ExpectedReturn
 , 'USG' [Provider]
 , a.LastVisit
 , a.ExitReason
 , a.ExitDate
 , CAST(GETDATE() AS DATE) AS DateExtracted
 , 'IQCare' AS EMR
 , 'CHAP Uzima' AS Project

FROM
tmp_ARTPatients AS a INNER JOIN tmp_PatientMaster AS b ON a.PatientPK = b.PatientPK
LEFT JOIN arvPharmacy c ON a.PatientPK = c.PatientPK
LEFT JOIN lastDispense d on a.PatientPK = d.PatientPK"|dwhstage|0|PatientArtExtract|2|a6221988-0e85-11e8-ba89-0ed5f89f718b
b629a32e-3055-11ea-978f-2e728ce88125|Patient Baselines|NDWH|926f49b8-305d-11ea-978f-2e728ce88125|"SELECT
a.PatientPK
, a.PatientID
 , (SELECT TOP 1 FacilityID FROM IQC_SiteDetails) FacilityID
 , a.SiteCode
 , IQC_bCD4.bCD4
 , IQC_bCD4.bCD4Date
 , NULL bWAB
 , NULL bWABDate
 , IQC_bWHO.bWHO
 , IQC_bWHO.bWHODate
 , NULL eWAB
 , NULL eWABDate
 , IQC_eCD4.eCD4
 , IQC_eCD4.eCD4Date
 , IQC_eWHO.eWHO
 , IQC_eWHO.eWHODate
 , IQC_lastWHO.lastWHO
 , IQC_lastWHO.lastWHODate
 , NULL lastWAB
 , NULL lastWABDate
 , IQC_lastCD4.lastCD4
 , IQC_lastCD4.lastCD4Date
 , IQC_m12CD4.m12CD4
 , IQC_m12CD4.m12CD4Date
 , IQC_m6CD4.m6CD4
 , IQC_m6CD4.m6CD4Date
 , CAST(GETDATE() AS DATE) AS DateExtracted
 , 'IQCare' AS EMR
 , 'CHAP Uzima' AS Project

FROM

 tmp_PatientMaster a LEFT OUTER JOIN
    IQC_bCD4 ON a.PatientPK = IQC_bCD4.PatientPK LEFT OUTER JOIN
    IQC_bWHO ON a.PatientPK = IQC_bWHO.PatientPK LEFT OUTER JOIN
    IQC_lastCD4 ON a.PatientPK = IQC_lastCD4.PatientPK LEFT OUTER JOIN
    IQC_eWHO ON a.PatientPK = IQC_eWHO.PatientPK LEFT OUTER JOIN
    IQC_eCD4 ON a.PatientPK = IQC_eCD4.PatientPK LEFT OUTER JOIN
    IQC_lastWHO ON a.PatientPK = IQC_lastWHO.PatientPK LEFT OUTER JOIN
    IQC_m12CD4 ON a.PatientPK = IQC_m12CD4.PatientPK LEFT OUTER JOIN
    IQC_m6CD4 ON a.PatientPK = IQC_m6CD4.PatientPK"|dwhstage|0|PatientBaselineExtract|3|a6221988-0e85-11e8-ba89-0ed5f89f718b
b629a46e-3055-11ea-978f-2e728ce88125|Patient Status|NDWH|926f49b8-305d-11ea-978f-2e728ce88125|"SELECT
 b.PatientID
 , a.PatientPK
 , b.SiteCode
 , b.FacilityName
 , (SELECT TOP 1 FacilityID FROM IQC_SiteDetails) FacilityId
 , a.ExitDescription
 , a.ExitDate
 , a.ExitReason
 , CAST(GETDATE() AS DATE) AS DateExtracted
 , 'IQCare' AS EMR
 , 'CHAP Uzima' AS Project
FROM
 tmp_LastStatus a INNER JOIN tmp_PatientMaster b ON a.PatientPK = b.PatientPK"|dwhstage|0|PatientStatusExtract|4|a6221988-0e85-11e8-ba89-0ed5f89f718b
b629a5a4-3055-11ea-978f-2e728ce88125|Patient Labs|NDWH|926f49b8-305d-11ea-978f-2e728ce88125|"SELECT
 b.PatientID
 , a.PatientPK
 , (SELECT TOP 1 FacilityID FROM IQC_SiteDetails) FacilityID
 , b.SiteCode
 , b.FacilityName
 , b.SatelliteName
 , a.VisitID
 , a.OrderedbyDate
 , a.ReportedbyDate
 , a.TestName
 , a.EnrollmentTest
 , a.TestResult
 ,a.Reasons AS Reason
 , CAST(GETDATE() AS DATE) AS DateExtracted
 , 'IQCare' AS EMR
 , 'CHAP Uzima' AS Project
FROM
 tmp_Labs a INNER JOIN
 tmp_PatientMaster b ON a.PatientPK = b.PatientPK"|dwhstage|0|PatientLabExtract|5|a6221988-0e85-11e8-ba89-0ed5f89f718b
b629a6da-3055-11ea-978f-2e728ce88125|Patient Pharmacy|NDWH|926f49b8-305d-11ea-978f-2e728ce88125|"SELECT
 b.PatientID
 , (SELECT TOP 1 FacilityID FROM IQC_SiteDetails) FacilityID
 , b.SiteCode
 , a.PatientPK
 , d.Id VisitID
 , a.Drug
 , 'USG' Provider
 , a.DateDispensed DispenseDate
 , a.Duration
 , DATEADD(dd,a.Duration,a.DateDispensed) ExpectedReturn
 , a.TreatmentType
 , case c.RegimenLine when 1 then 'First Line' when 2 then 'Second Line' else null end as RegimenLine
 , NULL PeriodTaken
 , a.ProphylaxisType
 , CAST(GETDATE() AS DATE) AS DateExtracted
 , 'IQCare' AS EMR
 , 'CHAP Uzima' AS Project

FROM

 tmp_Pharmacy a INNER JOIN
 tmp_PatientMaster b ON a.PatientPK = b.PatientPK
 LEFT JOIN tmp_ARVPharmacy c on a.PatientPK = c.PatientPK and a.DateDispensed = c.DateDispensed
 LEFT JOIN PatientMasterVisit d on a.PatientPK = d.PatientId and a.DateDispensed = cast(d.VisitDate as date)"|dwhstage|0|PatientPharmacyExtract|6|a6221988-0e85-11e8-ba89-0ed5f89f718b
b629a810-3055-11ea-978f-2e728ce88125|Patient Visits|NDWH|926f49b8-305d-11ea-978f-2e728ce88125|"with OIs as (select a.PatientId PatientPK
, b.[Name] OI
, a.PatientMasterVisitId
  from PatientOI a inner join LookupItem b on a.OIId = b.Id
where b.Name != 'Asymptomatic'
)

, Adherence as (select a.PatientId, a.PatientMasterVisitId
, case AdherenceType when 34 then 'ARV Adherence' when 35 then 'CTX Adherence'
end as AdherenceCategory
, c.[Name] Adherence
from AdherenceOutcome a
left join LookupItem c on a.Score = c.Id)

SELECT
 REPLACE(b.PatientID, ' ', '') AS PatientID
 , b.FacilityName
 , (SELECT TOP 1 FacilityID FROM IQC_SiteDetails) FacilityId
 , b.SiteCode
 , a.PatientPK
 , c.Id VisitID
 , a.VisitDate
 , a.Service
 , a.VisitType
 , a.WHOStage
 , NULL WABStage
 , a.Pregnant
 , a.LMP
 , a.EDD
 , a.Height
 , a.[Weight]
 , cast(a.BPS as varchar(3)) + '/' + cast(a.BPD as varchar(3)) BP
 , d.OI
 , case when d.OI is not null then a.VisitDate else null end OIDate
 , e.Adherence
 , e.AdherenceCategory
 , NULL AS SubstitutionFirstlineRegimenDate
 , NULL AS SubstitutionFirstlineRegimenReason
 , NULL AS SubstitutionSecondlineRegimenDate
 , NULL AS SubstitutionSecondlineRegimenReason
 , NULL AS SecondlineRegimenChangeDate
 , NULL AS SecondlineRegimenChangeReason

 , NULL FamilyPlanningMethod
 , NULL PwP
 , NULL GestationAge
 , a.NextAppointmentDate
 , CAST(GETDATE() AS DATE) AS DateExtracted
 , 'IQCare' AS EMR
 , 'CHAP Uzima' AS Project
 ,b.PopulationType AS PopulationType
 ,NULL AS KeyPopulationType
 ,a.StabilityAssessment AS StabilityAssessment
 ,NULL AS DifferentiatedCare
FROM
 tmp_ClinicalEncounters a INNER JOIN tmp_PatientMaster b ON a.PatientPK = b.PatientPK
 LEFT JOIN PatientMasterVisit c on a.PatientPK = c.PatientId and a.VisitDate = cast(c.VisitDate as date)
 LEFT JOIN OIs d on c.Id = d.PatientMasterVisitId
 LEFT JOIN Adherence e on c.Id = e.PatientMasterVisitId"|dwhstage|0|PatientVisitExtract|7|a6221988-0e85-11e8-ba89-0ed5f89f718b
b629ab26-3055-11ea-978f-2e728ce88125|Patient Adverse Events|NDWH|926f49b8-305d-11ea-978f-2e728ce88125|"with adv
as
(SELECT distinct p.PatientID,
       p.PatientPK,
       a.FacilityId AS SiteCode,
       c.VisitDate,
       r.Regimen,
       b.EventName AS AdverseEvent,
       b.EventCause AS AdverseEventCause,
       lk.ItemName AS Severity,
       b.Action AS ActionTaken,
       lk1.ItemName AS ClinicalOutcome,
       d.OutcomeDate AS AdverseEventEndDate,
       preg.PregnancyStatus AS Pregnancy
FROM dbo.Patient AS a
INNER JOIN dbo.tmp_PatientMaster AS p ON a.Id = p.PatientPK
INNER JOIN dbo.AdverseEvent AS b ON a.Id = b.PatientId
INNER JOIN dbo.PatientMasterVisit AS c ON b.PatientMasterVisitId = c.Id
LEFT OUTER JOIN dbo.PatientAdverseEventOutcome AS d ON a.Id = d.Id
LEFT OUTER JOIN dbo.LookupItemView AS lk ON b.Severity = lk.ItemId
LEFT OUTER JOIN dbo.LookupItemView AS lk1 ON d.OutComeId = lk1.ItemId
LEFT OUTER JOIN
  (SELECT DISTINCT a.PatientId,
                   a.PatientMasterVisitId,
                   c.VisitDate,
                   lk.DisplayName AS Regimen
   FROM dbo.ARVTreatmentTracker AS a
   INNER JOIN dbo.PatientMasterVisit AS c ON a.PatientMasterVisitId = c.Id
   LEFT OUTER JOIN dbo.LookupItemView AS lk ON a.RegimenId = lk.ItemId) AS r ON r.PatientId = a.Id
AND c.Id = r.PatientMasterVisitId
LEFT OUTER JOIN
  (SELECT dbo.PregnancyIndicator.PatientId,
          dbo.PregnancyIndicator.PatientMasterVisitId,
          lk.DisplayName AS PregnancyStatus,
          dbo.PregnancyIndicator.VisitDate
   FROM dbo.PregnancyIndicator
   INNER JOIN dbo.LookupItemView AS lk ON lk.ItemId = dbo.PregnancyIndicator.PregnancyStatusId) AS preg ON preg.PatientId = a.Id
AND c.Id = preg.PatientMasterVisitId)

SELECT adv.PatientID,
       adv.PatientPK,
       adv.SiteCode,
	   (SELECT TOP 1 FacilityID FROM IQC_SiteDetails) FacilityID,
       'IQCare' AS EMR,
       'CHAP Uzima' AS Project,
       adv.VisitDate,
       adv.Regimen AS AdverseEventRegimen,
       adv.AdverseEvent,
       adv.AdverseEventCause,
       adv.Severity,
       adv.ActionTaken AS AdverseEventActionTaken,
       adv.ClinicalOutcome AS AdverseEventClinicalOutcome,
	   adv.VisitDate AS AdverseEventStartDate,
       adv.AdverseEventEndDate,
       adv.Pregnancy AS AdverseEventIsPregnant
FROM adv
     INNER JOIN tmp_PatientMaster p ON adv.PatientPK = p.PatientPK"|dwhstage|0|PatientAdverseEventExtract|8|a6221988-0e85-11e8-ba89-0ed5f89f718b

3253E133-E110-4D8E-B669-3832B244F6E0|All Patients|NDWH|A6221859-0E85-11E8-BA89-0ED5F89F718B|"SELECT
        e.patient_id AS PatientPK,
        pi.identifier AS PatientID,
        la.`value_reference` AS FacilityID,
        la.`value_reference` AS SiteCode,
        'OpenMRS' AS EMR,
        'UCSF Clinical Kisumu' AS Project,
        l.name AS FacilityName,
        p.gender AS Gender,
        DATE(p.birthdate) AS DOB,
        MIN(IF(e.encounter_type IN (1,3,21,26),DATE(e.encounter_datetime),NULL)) AS RegistrationDate,
        MIN(IF(e.encounter_type IN (1,3,21,26),DATE(e.encounter_datetime),NULL)) AS RegistrationAtCCC,
        NULL AS RegistrationATPMTCT,
        NULL AS RegistrationAtTBClinic,
        MID(MIN(CONCAT(e.encounter_datetime,IF(o.concept_id = 1353,cn.name,NULL))),20) AS PatientSource,
        MID(MIN(CONCAT(e.encounter_datetime,IF(o.concept_id = 6687,o.value_text,NULL))),20) AS Region,
        MID(MIN(CONCAT(e.encounter_datetime,IF(o.concept_id = 6367,o.value_text,NULL))),20) AS District,
        MID(MIN(CONCAT(e.encounter_datetime,IF(o.concept_id = 6688,o.value_text,NULL))),20) AS Village,
        MID(MAX(CONCAT(e.encounter_datetime,IF(o.concept_id = 1615,cn.name,NULL))),20) AS ContactRelation,
        MAX(DATE(e.encounter_datetime)) AS LastVisit,
        MID(MAX(CONCAT(e.encounter_datetime,IF(o.concept_id = 1054,cn.name,NULL))),20) AS MaritalStatus,
        MID(MAX(CONCAT(e.encounter_datetime,IF(o.concept_id = 1368,cn.name,NULL))),20) AS EducationLevel,
        COALESCE(MAX(IF(o.concept_id=6740,DATE(o.value_datetime),NULL)), DATE(MIN(e.encounter_datetime))) AS DateConfirmedHIVPositive,
        MID(MIN(CONCAT(e.encounter_datetime,IF(o.concept_id = 1461,cn.name,NULL))),20) AS  PreviousARTExposure,
        COALESCE(COALESCE(MAX(IF(o.concept_id IN (6746,6739),DATE(o.value_datetime),NULL)),
            MAX(IF(o.concept_id IN (1255) AND o.value_coded=1256,DATE(o.obs_datetime),NULL))),
            COALESCE(MID(MIN(CONCAT(e.encounter_datetime,IF(o.concept_id IN(1592,6506) AND o.value_coded IN(1407,6197) ,DATE(o.obs_datetime),NULL))),20),
            MID(MIN(CONCAT(e.encounter_datetime,IF(o.concept_id=1571 ,DATE(o.obs_datetime),NULL))),20))
            ) AS PreviousARTStartDate,
        IF(lt.LastTCADate > CURDATE(),'Active','Inactive') AS StatusAtCCC,
        NULL AS StatusAtPMTCT,
        NULL AS StatusAtTBClinic,
        NULL AS SatelliteName,
        MID(MAX(CONCAT(e.encounter_datetime,IF(o.concept_id = 5629,cn.name,NULL))),20) AS Inschool,
        MID(MAX(CONCAT(e.encounter_datetime,IF(o.concept_id = 7771,cn.name,NULL))),20) AS KeyPopulationType,
        MID(MAX(CONCAT(e.encounter_datetime,IF(o.concept_id = 1174,cn.name,NULL))),20) AS Orphan,
        MID(MAX(CONCAT(e.encounter_datetime,IF(o.concept_id = 7967,cn.name,NULL))),20) AS PatientResidentCounty,
        MID(MAX(CONCAT(e.encounter_datetime,IF(o.concept_id = 6500,cn.name,NULL))),20) AS PatientResidentLocation,
        MID(MAX(CONCAT(e.encounter_datetime,IF(o.concept_id = 8001,cn.name,NULL))),20) AS PatientResidentSubCounty,
        MID(MAX(CONCAT(e.encounter_datetime,IF(o.concept_id = 6501,cn.name,NULL))),20) AS PatientResidentSubLocation,
        MID(MIN(CONCAT(e.encounter_datetime,IF(o.concept_id = 6688,o.value_text,NULL))),20) AS PatientResidentVillage,
        MID(MIN(CONCAT(e.encounter_datetime,IF(o.concept_id = 7968,o.value_text,NULL))),20) AS PatientResidentWard,
        MID(MIN(CONCAT(e.encounter_datetime,IF(o.concept_id = 1353 AND o.value_coded = 1605,'Transfer-In',IF(o.concept_id = 1353 AND o.value_coded != 1605,'New',NULL)))),20) AS PatientType,
        MID(MIN(CONCAT(e.encounter_datetime,IF(o.concept_id = 7766,IF(cn.name = 'Gen Pop','General Population',IF(cn.name = 'Key Pop','Key Population',NULL)),NULL))),20) AS PopulationType,
        MID(MIN(CONCAT(e.encounter_datetime,IF(o.concept_id = 6517,DATE(o.value_datetime),NULL))),20) AS  TransferInDate
    FROM encounter e
    JOIN patient_identifier `pi` ON pi.patient_id = e.patient_id AND pi.identifier_type = 9 AND e.voided = 0 AND pi.voided=0
    JOIN person p ON p.person_id = e.patient_id AND p.voided=0
    INNER JOIN location l ON e.location_id = l.location_id
    LEFT OUTER JOIN location_attribute la ON l.location_id = la.location_id AND la.attribute_type_id = 1
    LEFT OUTER JOIN
    (
    SELECT
            o.person_id,
            MAX(DATE(o.value_datetime)) AS LastTCADate
        FROM obs o
        INNER JOIN encounter e ON o.person_id = e.patient_id
        WHERE o.concept_id IN (1938,5096,7469,7628)
            AND o.voided=0
            AND o.value_datetime IS NOT NULL
        GROUP BY 1
    ) AS lt ON lt.person_id = e.patient_id
    LEFT OUTER JOIN obs o ON o.person_id = e.patient_id AND o.voided=0
        AND o.concept_id IN (1353,6687,6367,6688,1615,1054,1368,6740,1461,6746,6739,1255,1592,6506,1571,5629,7771,1174,7967,6500,8001,6501,6688,7968,7766,6517)
    INNER JOIN concept_name cn ON cn.concept_id = o.value_coded
    GROUP BY e.patient_id"|DWHStage|1|PatientExtract|1|BB254606-38F8-409F-8E36-AB6601139DEA
C7EF8319-50B3-4D1D-9DCD-386E61EA8AFE|ART Patients|NDWH|A6221859-0E85-11E8-BA89-0ED5F89F718B|"SELECT
        p.person_id AS PatientPK,
        MAX(pi.identifier) AS PatientID,
        la.`value_reference` AS FacilityID,
        la.`value_reference` AS SiteCode,
        'OpenMRS' AS EMR,
        'UCSF Clinical Kisumu' AS Project,
        l.name AS FacilityName,
        DATE(p.birthdate) AS DOB,
        DATEDIFF(id.DAteEnrolledInCare,p.birthdate) DIV 365.25 AS AgeEnrollment,
        DATEDIFF(id.Date_Started_ART,p.birthdate) DIV 365.25 AS AgeARTStart,
        DATEDIFF(lv.LastEncounter,p.birthdate) DIV 365.25 AS AgeLastVisit,
        id.FirstEncounter AS RegistrationDate,
        MID(MIN(CONCAT(e.encounter_datetime,IF(o.concept_id = 1353,cn.name,NULL))),20) AS PatientSource,
        p.gender AS Gender,
        id.Date_Started_ART AS StartARTDate,
        MID(MIN(CONCAT(e.encounter_datetime,IF(o.concept_id = 6739,DATE(o.value_datetime),NULL))),20) AS  PreviousARTStartDate,
        MID(MIN(CONCAT(e.encounter_datetime,IF(o.concept_id = 1461,cn.name,NULL))),20) AS  PreviousARTRegimen,
        MID(MIN(CONCAT(e.encounter_datetime,IF(o.concept_id = 1571,DATE(o.obs_datetime),NULL))),20) AS  StartARTAtThisFacility,
        IF(1st_Line_ART_Regimen IS NOT NULL, 1st_Line_ART_Regimen,
            IF(1st_Line_ART_Substitution IS NOT NULL,1st_Line_ART_Substitution,
                IF(2nd_Line_ART_Regimen IS NOT NULL,2nd_Line_ART_Regimen,
                    IF(2nd_Line_ART_Substitution IS NOT NULL,2nd_Line_ART_Substitution,NULL)
                )
            )
        ) AS StartRegimen,
        IF(1st_Line_ART_Regimen IS NOT NULL, 'First Line',
            IF(1st_Line_ART_Substitution IS NOT NULL,'First Line Substitution',
                IF(2nd_Line_ART_Regimen IS NOT NULL,'Second Line',
                    IF(2nd_Line_ART_Substitution IS NOT NULL,'Second Line Substitution',NULL)
                )
            )
        ) AS StartRegimenLine,
        id.LastARTDate,
        cr.Current_Regimen AS LastRegimen,
        IF(STRCMP(cr.Current_Regimen,1st_Line_ART_Regimen)=0, 'First Line',
            IF(STRCMP(cr.Current_Regimen,1st_Line_ART_Substitution)=0,'First Line Substitution',
                IF(STRCMP(cr.Current_Regimen,2nd_Line_ART_Regimen)=0,'Second Line',
                    IF(STRCMP(cr.Current_Regimen,2nd_Line_ART_Substitution)=0,'Second Line Substitution',NULL)
                )
            )
        ) AS LastRegimenLine,
        DATEDIFF(id.LastTCADate,id.LastARTDate) DIV 365.25 AS Duration,
        id.LastTCADate AS ExpectedReturn,
        'Government' AS Provider,
        lv.LastEncounter AS LastVisit,
        MID(MAX(CONCAT(e.encounter_datetime,IF(e.encounter_type=6 AND o.concept_id=1655,cn.name,NULL))),20) AS ExitReason,
        MID(MAX(CONCAT(e.encounter_datetime,IF(e.encounter_type=6,DATE(e.encounter_datetime),NULL))),20) AS ExitDate
    FROM person p
    INNER JOIN patient_identifier `pi` ON p.person_id = pi.patient_id AND pi.identifier_type=9 AND pi.voided = 0 AND p.voided = 0
    INNER JOIN encounter e ON p.person_id = e.patient_id
        AND e.encounter_type IN (1,2,3,4,6,21,22,26,27,28,40,41,42)
    INNER JOIN
    (
        SELECT
            ide.patient_id,
            MIN(DATE(ide.encounter_datetime)) AS FirstEncounter,
            MIN(IF(ido.concept_id=6742,DATE(ido.value_datetime),NULL)) AS DateEnrolledInCare,
            COALESCE(COALESCE(MAX(IF(ido.concept_id IN (6746,6739),DATE(ido.value_datetime),NULL)),
                MAX(IF(ido.concept_id = 1255 AND ido.value_coded = 1256,DATE(ido.obs_datetime),NULL))),
                COALESCE(MID(MIN(CONCAT(ide.encounter_datetime,IF(ido.concept_id IN(1592,6506) AND ido.value_coded IN(1407,6197) ,DATE(ido.obs_datetime),NULL))),20),
                MID(MIN(CONCAT(ide.encounter_datetime,IF(ido.concept_id=1571 ,DATE(ido.obs_datetime),NULL))),20))
                ) AS  Date_Started_ART,
            MAX(IF(ido.concept_id = 1571, DATE(ido.obs_datetime),NULL)) AS LastARTDate,
            MAX(IF(ido.concept_id IN (1938,5096,7469,7628),DATE(ido.value_datetime),NULL)) AS LastTCADate
        FROM encounter ide
        INNER JOIN obs ido ON ide.patient_id = ido.person_id
            AND ido.voided = 0 AND ide.voided = 0
            AND ido.concept_id IN (6742,6746,6739,1255,1592,6506,1571,1938,5096,7469,7628)
            AND ide.encounter_datetime > '2015-12-31'
        GROUP BY 1
    ) id ON p.person_id = id.patient_id
    LEFT OUTER JOIN
    (
        SELECT
            lve.patient_id,
            MID(MAX(CONCAT(lve.encounter_datetime,IF(lve.encounter_type = 6,'Yes','No'))),20) AS  IsDiscontinued,
            MAX(DATE(lve.encounter_datetime)) AS LastEncounter
        FROM encounter lve
        WHERE lve.voided = 0
        GROUP BY 1
        HAVING IsDiscontinued = 'No'
    ) lv ON p.person_id = lv.patient_id
    INNER JOIN location l ON e.location_id = l.location_id
    LEFT OUTER JOIN location_attribute la ON e.location_id = la.location_id AND la.attribute_type_id = 1
    INNER JOIN
    (
        SELECT
            cre.patient_id,
            cre.encounter_id,
            MID(MAX(CONCAT(cre.encounter_datetime,IF(cro.concept_id = 6747, crn.name, NULL))),20) AS 1st_Line_ART_Regimen,
            MID(MAX(CONCAT(cre.encounter_datetime,IF(cro.concept_id = 6749, crn.name, NULL))),20) AS 1st_Line_ART_Substitution,
            MID(MAX(CONCAT(cre.encounter_datetime,IF(cro.concept_id = 6782, crn.name, NULL))),20) AS 2nd_Line_ART_Regimen,
            MID(MAX(CONCAT(cre.encounter_datetime,IF(cro.concept_id = 6750, crn.name, NULL))),20) AS 2nd_Line_ART_Substitution,
            MID(MAX(CONCAT(cre.encounter_datetime,IF(cro.concept_id = 1571, crn.name, NULL))),20) AS Current_Regimen
        FROM encounter cre
        INNER JOIN obs cro
            ON cre.encounter_id = cro.encounter_id
                AND cro.concept_id IN (6747,6749,6782,6750,1571) AND cro.voided = 0 AND cre.voided = 0
        INNER JOIN concept_name crn
            ON cro.value_coded = crn.concept_id AND crn.voided = 0
        GROUP BY 1
    ) cr ON p.person_id = cr.patient_id
    LEFT OUTER JOIN obs o ON e.patient_id = o.person_id
        AND o.voided=0 AND o.concept_id IN (1353,1571,1655,1461,6739)
    INNER JOIN concept_name cn ON cn.concept_id=o.value_coded
    GROUP BY p.person_id"|DWHStage|0|PatientArtExtract|2|BB254606-38F8-409F-8E36-AB6601139DEA
64C5D42A-C3ED-457A-951A-FDB22F14B6B7|Patient Pharmacy|NDWH|A6221859-0E85-11E8-BA89-0ED5F89F718B|"SELECT
        e.patient_id AS PatientPK,
        MIN(pi.identifier) AS PatientID,
        la.`value_reference` AS FacilityID,
        la.`value_reference` AS SiteCode,
        'OpenMRS' AS EMR,
        'UCSF Clinical Kisumu' AS Project,
    -- 	l.name AS FacilityName,
        v.visit_id AS VisitID,
        cr.Current_Regimen AS Drug,
        'Government' AS Provider,
        MID(MAX(CONCAT(e.encounter_datetime,IF(o.concept_id IN (1571,6138),DATE(o.obs_datetime),NULL))),20) AS DispenseDate,
        DATEDIFF(lt.LastTCADate,MID(MAX(CONCAT(e.encounter_datetime,IF(o.concept_id IN (1571,6138),DATE(o.obs_datetime),NULL))),20)) AS Duration,
        lt.LastTCADate AS ExpectedReturn,
        MID(MAX(CONCAT(encounter_datetime,IF(rsn.concept_id IN (1565, 1566,1251,1404,1497,1498,1564,1592,1409,6304,6305,1496),cnr.name,
            IF(rsn.concept_id = 7147, rsn.value_text,NULL)))),20) AS TreatmentType,
        IF(STRCMP(cr.Current_Regimen,1st_Line_ART_Regimen)=0, 'First Line',
            IF(STRCMP(cr.Current_Regimen,1st_Line_ART_Substitution)=0,'First Line Substitution',
                IF(STRCMP(cr.Current_Regimen,2nd_Line_ART_Regimen)=0,'Second Line',
                    IF(STRCMP(cr.Current_Regimen,2nd_Line_ART_Substitution)=0,'Second Line Substitution',NULL)
                )
            )
        ) AS RegimenLine,
        MID(MAX(CONCAT(e.encounter_datetime,IF(o.concept_id = 1836, IF(o.value_coded = 1065,'Pregnancy',IF(o.value_coded IN(6765,50),'Labor',IF(o.value_coded IN(6847,6848),'Postnatal',NULL ) )), NULL))),20) AS PeriodTaken,
        MID(MAX(CONCAT(e.encounter_datetime,IF(o.concept_id = 1565,IF(o.value_coded = 92,'Dapsone',IF(o.value_coded = 1427,'CTX',NULL)),IF(o.concept_id = 1650 AND o.value_coded = 7789,'INH',NULL)))),20) AS ProphylaxisType
    FROM patient_identifier `pi`
    INNER JOIN visit v ON pi.patient_id = v.patient_id AND pi.identifier_type = 9 AND pi.voided=0
    INNER JOIN encounter e ON v.visit_id  = e.visit_id AND e.voided = 0
    INNER JOIN location l ON e.location_id = l.location_id
    LEFT OUTER JOIN location_attribute la ON l.location_id = la.location_id AND la.attribute_type_id = 1
    INNER JOIN obs o ON e.encounter_id = o.encounter_id AND o.voided=0 AND o.concept_id IN (1571,6138,1565,1650,1836)
    INNER JOIN concept_name cn ON cn.concept_id = o.value_coded
    LEFT OUTER JOIN obs rsn ON rsn.encounter_id = e.encounter_id
        AND rsn.voided=0 AND rsn.concept_id IN (1565,1650,1566,7147,1251,1404,1497,1498,1564,1592,1409,6304,6305,1496)
    INNER JOIN concept_name cnr ON cnr.concept_id = rsn.value_coded
    LEFT OUTER JOIN
    (
        SELECT
            e.patient_id,
            e.encounter_id,
            MID(MAX(CONCAT(e.encounter_datetime,IF(o.concept_id = 6747, cn.name, NULL))),20) AS 1st_Line_ART_Regimen,
            MID(MAX(CONCAT(e.encounter_datetime,IF(o.concept_id = 6749, cn.name, NULL))),20) AS 1st_Line_ART_Substitution,
            MID(MAX(CONCAT(e.encounter_datetime,IF(o.concept_id = 6782, cn.name, NULL))),20) AS 2nd_Line_ART_Regimen,
            MID(MAX(CONCAT(e.encounter_datetime,IF(o.concept_id = 6750, cn.name, NULL))),20) AS 2nd_Line_ART_Substitution,
            MID(MAX(CONCAT(e.encounter_datetime,IF(o.concept_id = 1571, cn.name, NULL))),20) AS Current_Regimen
        FROM encounter e
        INNER JOIN obs o
            ON e.encounter_id = o.encounter_id
                AND o.concept_id IN (6747,6749,6782,6750,1571) AND o.voided = 0 AND e.voided = 0
        INNER JOIN concept_name cn
            ON o.value_coded = cn.concept_id AND cn.voided = 0
        GROUP BY 1
    ) cr ON pi.patient_id = cr.patient_id
    LEFT OUTER JOIN
    (
        SELECT
            o.person_id,
            MAX(DATE(o.value_datetime)) AS LastTCADate
        FROM obs o
        INNER JOIN encounter e ON o.person_id = e.patient_id AND e.encounter_type IN (21,22,42,6)
        WHERE o.concept_id IN (1938,5096,7469,7628)
            AND o.voided=0
            AND o.value_datetime IS NOT NULL
            AND DATE(o.value_datetime) >= '2011-01-01'
        GROUP BY 1
    ) AS lt ON lt.person_id = e.patient_id
    WHERE DATE(v.date_started) >= '2011-01-01'
    GROUP BY e.patient_id"|DWHStage|0|PatientPharmacyExtract|3|BB254606-38F8-409F-8E36-AB6601139DEA
1CD45F9F-BC5D-4F85-B2CD-1581CBF1A01E|Patient Labs|NDWH|A6221859-0E85-11E8-BA89-0ED5F89F718B|"SELECT
        e.patient_id AS PatientPk,
        MIN(pi.identifier) AS PatientID,
        la.`value_reference` AS FacilityID,
        la.`value_reference` AS SiteCode,
        'OpenMRS' AS Emr,
        'UCSF Clinical Kisumu' AS Project,
        l.name AS FacilityName,
        NULL AS SatelliteName,
        v.visit_id AS VisitID,
        MID(MIN(CONCAT(e.encounter_datetime,IF(o.concept_id=1271,DATE(e.encounter_datetime),IF(o.concept_id=7467,DATE(o.value_datetime),NULL)))),20) AS OrderedByDate,
        DATE(ot.obs_datetime) AS ReportedByDate,
        MID(MIN(CONCAT(e.encounter_datetime,IF(o.concept_id=1271,cn.name,IF(o.concept_id=7471,'HIV VIRAL LOAD',NULL)))),20) AS TestName,
        NULL AS EnrollmentTest,
        MID(MAX(CONCAT(e.encounter_datetime,IF(o.concept_id=7471,ot.value_text,CONVERT(ot.value_numeric,CHAR)))),20) AS TestResult,
        MID(MIN(CONCAT(e.encounter_datetime,IF(o.concept_id=8037,cn.name,NULL))),20)  AS Reason
    FROM patient_identifier `pi`
    INNER JOIN visit v ON pi.patient_id = v.patient_id AND pi.identifier_type = 9 AND pi.voided=0 AND v.voided = 0
    INNER JOIN encounter e ON v.visit_id  = e.visit_id AND e.voided = 0
    INNER JOIN location l ON e.location_id = l.location_id
    LEFT OUTER JOIN location_attribute la ON l.location_id = la.location_id AND la.attribute_type_id = 1
    INNER JOIN obs o ON e.encounter_id = o.encounter_id AND o.voided=0 AND o.concept_id IN (1271, 8037, 7467,7471)
    LEFT OUTER JOIN concept_name cn ON cn.concept_id = o.value_coded
    LEFT OUTER JOIN
    (
        SELECT
            ot.person_id,
            ot.encounter_id,
            ot.obs_datetime,
            ot.concept_id,
            ot.value_numeric,
            ot.value_text
        FROM obs ot
        WHERE ot.voided = 0 AND ot.concept_id IN (730,21,5497,856,654,790,7467,7471,8037)
    ) ot ON e.encounter_id = ot.encounter_id
    WHERE DATE(v.date_started) >= '2011-01-01'
    GROUP BY  e.patient_id, e.encounter_id
    HAVING TestName IS NOT NULL AND TestResult IS NOT NULL"|DWHStage|0|PatientLabExtract|4|BB254606-38F8-409F-8E36-AB6601139DEA
362DC8AD-9FF8-4622-994B-53761AF6AAE9|Patient Status|NDWH|A6221859-0E85-11E8-BA89-0ED5F89F718B|"SELECT
        e.patient_id AS PatientPK,
        MIN(IF(pi.identifier_type=9,pi.identifier,NULL)) AS PatientID,
        la.`value_reference` AS FacilityID,
        la.`value_reference` AS SiteCode,
        'OpenMRS' AS EMR,
        'UCSF Clinical Kisumu' AS Project,
        l.name AS FacilityName,
        NULL AS ExitDescription,
        IF(s.ExitDate IS NOT NULL AND (MAX(DATE(e.encounter_datetime)) <= s.ExitDate), s.ExitDate, NULL) AS ExitDate,
        IF(s.ExitDate IS NOT NULL AND (MAX(DATE(e.encounter_datetime)) <= s.ExitDate), s.ExitReason, NULL) AS ExitReason
    FROM encounter e
    INNER JOIN location l ON e.location_id = l.location_id
    LEFT OUTER JOIN location_attribute la ON l.location_id = la.location_id AND la.attribute_type_id = 1
    INNER JOIN patient_identifier `pi` ON e.patient_id = pi.patient_id AND pi.identifier_type IN (3,9)
    LEFT OUTER JOIN
    (
        SELECT
            e.patient_id,
            MAX(IF(e.encounter_type = 6,DATE(e.encounter_datetime),NULL)) AS ExitDate,
            MAX(IF(o.concept_id = 1655,cn.name,NULL)) AS ExitReason
        FROM encounter e
        LEFT OUTER JOIN obs o ON e.patient_id = o.person_id AND o.concept_id = 1655 AND o.voided = 0 AND e.voided = 0
        INNER JOIN concept_name cn ON cn.concept_id = o.value_coded
        WHERE e.encounter_type IN (1,2,3,4,21,22,42,6)
        GROUP BY 1
    ) s ON e.patient_id = s.patient_id
    GROUP BY e.patient_id"|DWHStage|0|PatientStatusExtract|5|BB254606-38F8-409F-8E36-AB6601139DEA
127CA0C5-86D8-46BA-98E1-57F224D99C23|Patient Baselines|NDWH|A6221859-0E85-11E8-BA89-0ED5F89F718B|"SELECT
        e.patient_id AS PatientPk,
        MIN(pi.identifier) AS PatientID,
        la.`value_reference` AS FacilityID,
        la.`value_reference` AS SiteCode,
        'OpenMRS' AS EMR,
        'UCSF Clinical Kisumu' AS Project,
        MIN(IF(o.concept_id=5497 AND (o.obs_datetime BETWEEN DATE_ADD(Date_Started_ART,INTERVAL -90 DAY)
            AND DATE_ADD(Date_Started_ART,INTERVAL 14 DAY)),o.value_numeric,NULL)) AS bCD4,
        MIN(IF(o.concept_id=5497 AND (o.obs_datetime BETWEEN DATE_ADD(Date_Started_ART,INTERVAL -90 DAY)
            AND DATE_ADD(Date_Started_ART,INTERVAL 14 DAY)),DATE(o.obs_datetime),NULL)) AS bCD4Date,
        NULL AS bWAB,
        NULL AS bWABDate,
        MIN(IF(o.concept_id = 6745,cn.name,NULL)) AS bWHO,
        MIN(IF(o.concept_id = 6745,DATE(o.obs_datetime),NULL)) AS bWHODate,
        NULL AS eWAB,
        NULL AS eWABDate,
        MIN(IF(o.concept_id=6314 AND (o.obs_datetime BETWEEN DATE_ADD(DateEnrolledInCare,INTERVAL -120 DAY)
            AND DATE_ADD(DateEnrolledInCare,INTERVAL 120 DAY)),o.value_numeric,NULL)) AS eCD4,
        MIN(IF(o.concept_id=6314 AND (o.obs_datetime BETWEEN DATE_ADD(DateEnrolledInCare,INTERVAL -120 DAY)
            AND DATE_ADD(DateEnrolledInCare,INTERVAL 120 DAY)),DATE(o.obs_datetime),NULL)) AS eCD4Date,
        MIN(IF(o.concept_id = 6769,cn.name,NULL)) AS eWHO,
        MIN(IF(o.concept_id=6769,DATE(o.obs_datetime),NULL))AS eWHODate,
        MAX(IF(o.concept_id = 6794,cn.name,NULL))AS lastWHO,
        MAX(IF(o.concept_id = 6794, DATE(o.obs_datetime), NULL)) AS lastWHODate,
        MID(MAX(CONCAT(e.encounter_datetime,IF(o.concept_id=5497,o.value_numeric,NULL))),20) AS lastCD4,
        MID(MAX(CONCAT(e.encounter_datetime,IF(o.concept_id=5497,DATE(o.obs_datetime),NULL))),20) AS lastCD4Date,
        NULL AS lastWAB,
        NULL AS lastWABDate,
        MAX(IF(o.concept_id=5497 AND (o.obs_datetime BETWEEN DATE_ADD(DATE_ADD(Date_Started_ART,INTERVAL 12 MONTH),INTERVAL -1 MONTH) AND DATE_ADD(DATE_ADD(Date_Started_ART,INTERVAL 12 MONTH),INTERVAL 1 MONTH)),o.value_numeric,NULL)) AS m12CD4,
        MAX(IF(o.concept_id=5497 AND (o.obs_datetime BETWEEN DATE_ADD(DATE_ADD(Date_Started_ART,INTERVAL 12 MONTH),INTERVAL -1 MONTH) AND DATE_ADD(DATE_ADD(Date_Started_ART,INTERVAL 12 MONTH),INTERVAL 1 MONTH)),DATE(o.obs_datetime),NULL)) AS m12CD4Date,
        MAX(IF(o.concept_id=5497 AND (o.obs_datetime BETWEEN DATE_ADD(DATE_ADD(Date_Started_ART,INTERVAL 6 MONTH),INTERVAL -1 MONTH) AND DATE_ADD(DATE_ADD(Date_Started_ART,INTERVAL 6 MONTH),INTERVAL 1 MONTH)),o.value_numeric,NULL)) AS m6CD4,
        MAX(IF(o.concept_id=5497 AND (o.obs_datetime BETWEEN DATE_ADD(DATE_ADD(Date_Started_ART,INTERVAL 6 MONTH),INTERVAL -1 MONTH) AND DATE_ADD(DATE_ADD(Date_Started_ART,INTERVAL 6 MONTH),INTERVAL 1 MONTH)),DATE(o.obs_datetime),NULL)) AS m6CD4Date
    FROM encounter e
    INNER JOIN patient_identifier `pi` ON pi.patient_id = e.patient_id AND pi.identifier_type = 9
    INNER JOIN
    (
        SELECT
            e.patient_id,
            MIN(DATE(e.encounter_datetime)) AS FirstEncounter,
            MIN(IF(o.concept_id=6742,DATE(o.value_datetime),NULL)) AS DateEnrolledInCare,
            COALESCE(COALESCE(MAX(IF(o.concept_id IN (6746,6739),DATE(o.value_datetime),NULL)),
                MAX(IF(o.concept_id = 1255 AND o.value_coded = 1256,DATE(o.obs_datetime),NULL))),
                COALESCE(MID(MIN(CONCAT(e.encounter_datetime,IF(o.concept_id IN(1592,6506) AND o.value_coded IN(1407,6197) ,DATE(o.obs_datetime),NULL))),20),
                MID(MIN(CONCAT(e.encounter_datetime,IF(o.concept_id=1571 ,DATE(o.obs_datetime),NULL))),20))
                ) AS  Date_Started_ART,
            MAX(IF(o.concept_id = 1571, DATE(o.obs_datetime),NULL)) AS LastARTDate,
            MAX(IF(o.concept_id IN (1938,5096,7469,7628),DATE(o.value_datetime),NULL)) AS LastTCADate
        FROM encounter e
        INNER JOIN obs o ON e.patient_id = o.person_id
            AND o.voided = 0 AND e.voided = 0
            AND o.concept_id IN (6742,6746,6739,1255,1592,6506,1571,1938,5096,7469,7628)
        GROUP BY 1
    ) id ON e.patient_id = id.patient_id
    LEFT OUTER JOIN obs o ON o.encounter_id = e.encounter_id AND o.voided=0 AND o.concept_id IN (6314,6769,5497,6745,6794)
    LEFT OUTER JOIN concept_name cn ON cn.concept_id=o.value_coded
    INNER JOIN location l ON l.location_id = e.location_id
    LEFT OUTER JOIN location_attribute la ON l.location_id = la.location_id AND la.attribute_type_id = 1
    GROUP BY e.patient_id"|DWHStage|0|PatientBaselineExtract|6|BB254606-38F8-409F-8E36-AB6601139DEA
90A68C9F-72AD-48C4-B0EB-35AB9DC6F07D|Patient Visits|NDWH|A6221859-0E85-11E8-BA89-0ED5F89F718B|"SELECT
        p.patient_id AS PatientPk,
        MIN(pi.identifier) AS PatientID,
        la.`value_reference` AS FacilityID,
        la.`value_reference` AS SiteCode,
        'OpenMRS' AS EMR,
        'UCSF Clinical Kisumu' AS Project,
        l.name AS FacilityName,
        v.visit_id AS VisitID,
        DATE(v.date_started) AS VisitDate,
        et.name AS Service,
        'Out-Patient' AS VisitType,
        MID(MAX(CONCAT(e.encounter_datetime,IF(o.concept_id = 6794,cn.name,NULL))),20) AS WHOStage,
        NULL AS WABStage,
        MID(MAX(CONCAT(e.encounter_datetime,IF(o.concept_id = 1836,cn.name,NULL))),20) AS Pregnant,
        MID(MAX(CONCAT(e.encounter_datetime,IF(o.concept_id = 1450, DATE(o.value_datetime), NULL))),20) AS LMP,
        MID(MAX(CONCAT(e.encounter_datetime,IF(o.concept_id = 1451,DATE(o.value_datetime),NULL))),20) AS EDD,
        MID(MAX(CONCAT(e.encounter_datetime,IF(o.concept_id = 5090,o.value_numeric,NULL))),20) AS Height,
        MID(MAX(CONCAT(e.encounter_datetime,IF(o.concept_id = 5089,o.value_numeric,NULL))),20) AS Weight,
        CONCAT_WS(""/"",MID(MAX(CONCAT(e.encounter_datetime,IF(o.concept_id = 5085,o.value_numeric,NULL),IF(o.concept_id = 5086,o.value_numeric,NULL))),20)) AS BP,
        MID(MAX(CONCAT(e.encounter_datetime,IF(o.concept_id=6802,cn.name,NULL))),20) AS OI,
        MID(MAX(CONCAT(e.encounter_datetime,IF(o.concept_id=6802,DATE(obs_datetime),NULL))),20) AS OIDate,
        MID(MAX(CONCAT(e.encounter_datetime,IF(o.concept_id = 6760,cn.name,NULL))),20) AS Adherence,
        'ART' AS AdherenceCategory,
        MID(MIN(CONCAT(e.encounter_datetime,IF(o.concept_id = 6748, DATE(o.value_datetime), NULL))),20) AS SubstitutionFirstlineRegimenDate,
        MID(MAX(CONCAT(e.encounter_datetime,IF(o.concept_id = 6771, cn.name, NULL))),20) AS SubstitutionFirstlineRegimenReason,
        MID(MIN(CONCAT(e.encounter_datetime,IF(o.concept_id = 6751, DATE(o.value_datetime), NULL))),20) AS SubstitutionSecondlineRegimenDate,
        MID(MAX(CONCAT(e.encounter_datetime,IF(o.concept_id = 6192, cn.name, NULL))),20) AS SubstitutionSecondlineRegimenReason,
        MID(MIN(CONCAT(e.encounter_datetime,IF(o.concept_id = 6770, DATE(o.value_datetime), NULL))),20) AS SecondlineRegimenChangeDate,
        MID(MAX(CONCAT(e.encounter_datetime,IF(o.concept_id = 6772, cn.name, NULL))),20) AS SecondlineRegimenChangeReason,
        MID(MAX(CONCAT(e.encounter_datetime,IF(o.concept_id IN(374,1591),cn.name,NULL))),20) AS FamilyPlanningMethod,
        MID(MAX(CONCAT(e.encounter_datetime,IF(o.concept_id = 1048,'Disclosure',IF(o.concept_id = 6781,'Condoms',IF(o.concept_id = 1363,'Partner Testing',IF(o.concept_id = 6780,'STI Screen',NULL)))))),20) AS PWP,
        DATEDIFF((MAX(IF(e.encounter_type IN (1,2,21,22),DATE(e.encounter_datetime), NULL))),MAX(IF(o.concept_id = 1450, DATE(o.value_datetime), NULL))) DIV 365.25 AS GestationAge,
        lt.LastTCADate AS NextAppointmentDate,
        MID(MAX(CONCAT(e.encounter_datetime,IF(o.concept_id = 7979,cn.name,NULL))),20) AS DifferentiatedCare,
        MID(MAX(CONCAT(e.encounter_datetime,IF(o.concept_id = 7771,cn.name,NULL))),20) AS KeyPopulationType,
        MID(MAX(CONCAT(e.encounter_datetime,IF(o.concept_id = 7766,IF(cn.name = 'Gen Pop','General Population',IF(cn.name = 'Key Pop','Key Population',NULL)),NULL))),20) AS PopulationType,
        MID(MAX(CONCAT(e.encounter_datetime,IF(o.concept_id = 7978,cn.name,NULL))),20) AS StabilityAssessment
    FROM patient p
    INNER JOIN patient_identifier `pi` ON p.patient_id = pi.patient_id AND pi.identifier_type IS NOT NULL AND pi.identifier_type = 9 AND p.voided = 0	-- and identifier_type is not null
    LEFT OUTER JOIN visit v ON p.patient_id = v.patient_id AND v.voided = 0 AND DATE(v.date_started) > '2016-12-31'
    INNER JOIN encounter e ON p.patient_id = e.patient_id AND e.voided = 0 AND DATE(e.encounter_datetime) > '2016-12-31'
    INNER JOIN location l ON e.location_id = l.location_id
    LEFT OUTER JOIN location_attribute la ON l.location_id = la.location_id AND la.attribute_type_id = 1
    JOIN encounter_type et ON  e.encounter_type = et.encounter_type_id
    LEFT OUTER JOIN obs o ON e.patient_id = o.person_id AND o.voided=0
        AND o.concept_id IN (7978,7766,7771,7979,1916,6794,1836,1450,1451,5090,5089,5085,6802,6760,374,1591,1048,6781,1363,6780,6748,6771,6751,6192,6770,6772)
    LEFT OUTER JOIN concept_name cn ON cn.concept_id = o.value_coded AND cn.concept_name_type = 'FULLY_SPECIFIED'
    LEFT OUTER JOIN
    (
        SELECT
            ol.person_id,
            MAX(DATE(ol.value_datetime)) AS LastTCADate
        FROM obs ol
        WHERE ol.concept_id IN (1938,5096,7469,7628)
            AND ol.voided=0
            AND ol.value_datetime IS NOT NULL
        GROUP BY 1
    ) AS lt ON p.patient_id = lt.person_id
    GROUP BY p.patient_id, v.visit_id, e.encounter_id"|DWHStage|0|PatientVisitExtract|7|BB254606-38F8-409F-8E36-AB6601139DEA
5A7F8B7F-59E4-4364-8AA0-F7A94A4E6483|Patient Adverse Events|NDWH|A6221859-0E85-11E8-BA89-0ED5F89F718B|"SELECT
        p.patient_id AS PatientPk,
        MIN(pi.identifier) AS PatientID,
        la.`value_reference` AS FacilityID,
        la.`value_reference` AS SiteCode,
        'OpenMRS' AS EMR,
        'UCSF Clinical Kisumu' AS Project,
        NULL AS AdverseEvent,
        NULL AS AdverseEventStartDate,
        NULL AS AdverseEventEndDate,
        NULL AS Severity,
        NULL AS VisitDate,
        NULL AS AdverseEventActionTaken,
        NULL AS AdverseEventClinicalOutcome,
        NULL AS AdverseEventIsPregnant,
        NULL AS AdverseEventCause,
        NULL AS AdverseEventRegimen
    FROM patient p
    INNER JOIN patient_identifier `pi` ON p.patient_id = pi.patient_id AND pi.identifier_type IS NOT NULL AND pi.identifier_type = 9
    INNER JOIN visit v ON p.patient_id = v.patient_id AND v.voided = 0
    INNER JOIN location l ON v.location_id = l.location_id
    LEFT OUTER JOIN location_attribute la ON l.location_id = la.location_id AND la.attribute_type_id = 1
    GROUP BY p.patient_id, v.visit_id
    HAVING AdverseEvent IS NOT NULL
    ORDER BY p.patient_id, v.visit_id"|DWHStage|0|PatientAdverseEventExtract|8|BB254606-38F8-409F-8E36-AB6601139DEA
72D51B17-EB57-49F8-88FE-F79FD2299B7B|Hts Clients|HTS|A6221859-0E85-11E8-BA89-0ED5F89F718B|"SELECT
        pt.patient_id AS PatientPK,
        la.`value_reference` AS SiteCode,
        l.name AS FacilityName,
        'OpenMRS' AS EMR,
        'UCSF Clinical Kisumu' AS Project,
        MAX(pi.identifier) AS HtsNumber,
        DATE(p.birthdate) AS DOB,
        IF(p.gender = 'M', 'Male',IF(p.gender = 'F','Female',NULL)) AS Gender,
        MAX(IF(o.concept_id = 1054,cn.name,NULL)) AS MaritalStatus,
        MAX(IF(o.concept_id = 7766,IF(cn.name = 'Gen Pop','General Population',IF(cn.name = 'Key Pop','Key Population',NULL)),NULL)) AS PopulationType,
        MAX(IF(o.concept_id = 7771,cn.name,NULL)) AS KeyPopulationType,
        MAX(IF(o.concept_id = 7923,cn.name,NULL)) AS PatientDisabled,
        pa.county_district AS County,
        pa.address6 AS SubCounty,
        pa.address5 AS Ward
    FROM patient pt
    LEFT OUTER JOIN person_address pa ON pt.patient_id = pa.person_id AND pt.voided = 0 AND pa.voided = 0
    LEFT OUTER JOIN encounter e ON pt.patient_id = e.patient_id AND e.voided = 0
    INNER JOIN patient_identifier `pi` ON pi.patient_id = pt.patient_id AND pi.identifier_type IN (18,1) AND pi.voided=0
    INNER JOIN person p ON p.person_id = pt.patient_id
    INNER JOIN location l ON pi.location_id = l.location_id AND l.location_id IN (2,40,265,238,217,215,237,216,42,261,41,258,233,267,44,228,43)
    INNER JOIN location_attribute la ON l.location_id = la.location_id AND la.attribute_type_id = 1
    LEFT OUTER JOIN obs o ON o.person_id = pt.patient_id AND o.voided=0 AND o.concept_id IN (1054,7766,7771,7923)
    LEFT OUTER JOIN concept_name cn ON cn.concept_id = o.value_coded
    GROUP BY pt.patient_id
    HAVING DOB IS NOT NULL AND Gender IS NOT NULL"|DWHStage|1|HtsClient|1|A6221989-0E85-11E8-BA89-0ED5F89F718B
64748A19-0A4C-4065-BF0E-3E963F0F4133|Hts Test Kits|HTS|A6221859-0E85-11E8-BA89-0ED5F89F718B|"SELECT
        ct.FacilityName,
        ct.SiteCode,
        ct.PatientPK,
        ct.HtsNumber,
        'OpenMRS' AS EMR,
        'UCSF Clinical Kisumu' AS Project,
        e.encounter_id AS EncounterId,
        t.kit_name1 AS TestKitName1,
        t.lot_no1 AS TestKitLotNumber1,
        t.expiry_date1 AS TestKitExpiry1,
        MAX(IF(t.test_1_result IS NOT NULL, t.test_1_result, NULL)) AS TestResult1,
        t.kit_name2 AS TestKitName2,
        t.lot_no2 AS TestKitLotNumber2,
        t.expiry_date2 AS TestKitExpiry2,
        MAX(IF(t.test_2_result IS NOT NULL, t.test_2_result, NULL)) AS TestResult2
    FROM patient pt
    INNER JOIN (
        SELECT
            hc.FacilityName,
            hc.SiteCode,
            hc.PatientPK,
            hc.HtsNumber,
            'OpenMRS' AS EMR,
            'UCSF Clinical Kisumu' AS Project,
            e.encounter_id AS EncounterId,
            DATE(e.encounter_datetime) AS TestDate,
            MAX(IF(o.concept_id=7136,(CASE o.value_coded WHEN 1065 THEN ""Yes"" WHEN 1066 THEN ""No"" ELSE NULL END),NULL)) AS EverTestedForHiv,
            MAX(IF(o.concept_id=7658,(CASE o.value_coded WHEN 7659 THEN 3 WHEN 7660 THEN 12 WHEN 7661 THEN 13 WHEN 1729 THEN NULL END),NULL)) AS MonthsSinceLastTest,
            MAX(IF(o.concept_id=8138,(CASE o.value_coded WHEN 8137 THEN ""Individual"" WHEN 1756 THEN ""Couple"" ELSE NULL END),NULL)) AS ClientTestedAs,
            MAX(IF(o.concept_id=8174,(
               CASE o.value_coded
                   WHEN 1357 THEN ""OPD""
                   WHEN 8170 THEN ""IPD""
                   WHEN 1354 THEN ""VCT""
                   WHEN 8172 THEN ""MCH""
                   WHEN 8175 THEN ""TB Clinic""
                   WHEN 8173 THEN ""PNS""
                   WHEN 7656 THEN ""Family Testing""
                   WHEN 8171 THEN ""VMMC""
                   ELSE NULL
                   END ), NULL))AS EntryPoint,
            MAX(IF(o.concept_id=8145,(
              CASE o.value_coded
                  WHEN 8139 THEN ""HP/PITC""
                  WHEN 8140 THEN ""Non Provider Initiated Testing""
                  WHEN 8141 THEN ""Integrated VCT Center""
                  WHEN 8142 THEN ""Stand Alone VCT Center""
                  WHEN 8143 THEN ""Home Based Testing""
                  WHEN 8144 THEN ""Mobile Outreach HTS""
                  WHEN 7629 THEN ""HTS for Non-Patient[NP]""
              ELSE NULL
              END ),NULL)) AS TestStrategy,
            MAX(IF(t.test_1_result IS NOT NULL, t.test_1_result, NULL)) AS TestResult1,
            MAX(IF(t.test_2_result IS NOT NULL, t.test_2_result, NULL)) AS TestResult2,
            MAX(IF(o.concept_id=8155,(CASE o.value_coded WHEN 703 THEN ""Positive"" WHEN 664 THEN ""Negative"" WHEN 7864 THEN ""Inconclusive"" ELSE NULL END),NULL)) AS FinalTestResult,
            MAX(IF(o.concept_id=7936,(CASE o.value_coded WHEN 1065 THEN ""Yes"" WHEN 1066 THEN ""No"" ELSE NULL END),NULL)) AS PatientGivenResult,
            MAX(IF(o.concept_id=7791,cn.name,NULL)) AS TBScreening,
            MAX(IF(o.concept_id=7937,(CASE o.value_coded WHEN 1065 THEN ""Yes"" WHEN 1066 THEN ""No"" ELSE NULL END),NULL)) AS ClientSelfTested,
            MAX(IF(o.concept_id=6096,(CASE o.value_coded WHEN 1065 THEN ""Yes"" WHEN 1066 THEN ""No"" ELSE NULL END),NULL)) AS CoupleDiscordant,
            IF(e.encounter_type = 46,""Initial"",IF(e.encounter_type = 47,""Repeat"",NULL)) AS TestType,
            MAX(IF(o.concept_id=8168,(CASE o.value_coded WHEN 1065 THEN ""Yes"" WHEN 1066 THEN ""No"" ELSE """" END),NULL)) AS Consent
        FROM patient pt
        INNER JOIN (
            SELECT
                pt.patient_id AS PatientPK,
                la.`value_reference` AS SiteCode,
                l.name AS FacilityName,
                MAX(pi.identifier) AS HtsNumber,
                DATE(p.birthdate) AS DOB,
                IF(p.gender = 'M', 'Male',IF(p.gender = 'F','Female',NULL)) AS Gender
            FROM patient pt
            LEFT OUTER JOIN encounter e ON pt.patient_id = e.patient_id AND e.voided = 0
            INNER JOIN patient_identifier `pi` ON pi.patient_id = pt.patient_id AND pi.identifier_type IN (18,1) AND pi.voided=0
            INNER JOIN person p ON p.person_id = pt.patient_id
            INNER JOIN location l ON pi.location_id = l.location_id AND l.location_id IN (2,40,265,238,217,215,237,216,42,261,41,258,233,267,44,228,43)
            INNER JOIN location_attribute la ON l.location_id = la.location_id AND la.attribute_type_id = 1
            GROUP BY pt.patient_id
            HAVING DOB IS NOT NULL AND Gender IS NOT NULL
        ) hc ON pt.patient_id = hc.PatientPK AND SiteCode = hc.SiteCode
        INNER JOIN visit v ON pt.patient_id = v.patient_id AND v.voided = 0
        LEFT JOIN encounter e ON pt.patient_id = e.patient_id AND e.encounter_type IN (46,47)
        JOIN person p ON p.person_id = pt.patient_id
        INNER JOIN (
             SELECT
                       o.person_id,
                       o.encounter_id,
                       o.obs_group_id,
                       MAX(IF(o.concept_id=1040, (CASE o.value_coded WHEN 703 THEN ""Positive"" WHEN 664 THEN ""Negative"" WHEN 1304 THEN ""Invalid""  ELSE NULL END),NULL)) AS test_1_result ,
                       MAX(IF(o.concept_id=1326, (CASE o.value_coded WHEN 703 THEN ""Positive"" WHEN 664 THEN ""Negative"" WHEN 1175 THEN ""N/A""  ELSE NULL END),NULL)) AS test_2_result
             FROM obs o
             INNER JOIN encounter e ON e.encounter_id = o.encounter_id
             WHERE o.concept_id IN (1040, 1326)
             GROUP BY e.encounter_id, o.obs_group_id
        ) t ON e.encounter_id = t.encounter_id
        LEFT OUTER JOIN obs o ON o.person_id = pt.patient_id AND o.voided=0 AND o.concept_id IN (7136,7658,8138,8174,8145,8155,7936,7937,6096,8168,7791)
        INNER JOIN concept_name cn ON cn.concept_id = o.value_coded
        GROUP BY pt.patient_id, TestType
    ) ct ON pt.patient_id = ct.PatientPK
    INNER JOIN visit v ON pt.patient_id = v.patient_id AND v.voided = 0
    LEFT JOIN encounter e ON pt.patient_id = e.patient_id AND e.encounter_type IN (44,45,46,47,48,49,53)
    INNER JOIN (
         SELECT
                   o.person_id,
                   o.encounter_id,
                   MAX(IF(o.concept_id=1040, (CASE o.value_coded WHEN 703 THEN ""Positive"" WHEN 664 THEN ""Negative"" WHEN 1304 THEN ""Invalid""  ELSE NULL END),NULL)) AS test_1_result ,
                   MAX(IF(o.concept_id=1326, (CASE o.value_coded WHEN 703 THEN ""Positive"" WHEN 664 THEN ""Negative"" WHEN 1175 THEN ""N/A""  ELSE NULL END),NULL)) AS test_2_result,
                   MAX(IF(o.concept_id=8148,(CASE o.value_coded WHEN 8146 THEN ""Determine"" WHEN 8147 THEN ""First Response"" ELSE NULL END),NULL)) AS kit_name1 ,
                   MAX(IF(o.concept_id=8192,(CASE o.value_coded WHEN 8190 THEN ""Determine"" WHEN 8191 THEN ""First Response"" ELSE NULL END),NULL)) AS kit_name2 ,
                   MAX(IF(o.concept_id=8153,o.value_text,NULL)) AS lot_no1,
                   MAX(IF(o.concept_id=8193,o.value_text,NULL)) AS lot_no2,
                   MAX(IF(o.concept_id=8150,DATE(o.value_datetime),NULL)) AS expiry_date1,
                   MAX(IF(o.concept_id=8154,DATE(o.value_datetime),NULL)) AS expiry_date2
         FROM obs o
         INNER JOIN encounter e ON e.encounter_id = o.encounter_id
         WHERE o.concept_id IN (1040,1326,8148,8192,8153,8193,8150,8154)
         GROUP BY e.encounter_id	-- , o.obs_group_id
    ) t ON ct.EncounterId = t.encounter_id
    GROUP BY pt.patient_id
    HAVING TestKitName1 IS NOT NULL OR TestKitName2 IS NOT NULL"|DWHStage|0|HtsTestKits|2|A6221989-0E85-11E8-BA89-0ED5F89F718B
4CF5649A-E085-4661-A982-A53B6F320F0B|Hts Client Linkage|HTS|A6221859-0E85-11E8-BA89-0ED5F89F718B|"SELECT
        hc.PatientPK,
        hc.SiteCode,
        hc.FacilityName,
        'OpenMRS' AS EMR,
        'UCSF Clinical Kisumu' AS Project,
        hc.HtsNumber,
        MAX(IF(o.concept_id=8156,DATE(o.date_created),NULL)) AS DatePrefferedToBeEnrolled,
        MAX(IF(o.concept_id=8156,o.value_text,NULL)) AS FacilityReferredTo,
        MAX(IF(o.concept_id=8157,o.value_text,NULL)) AS HandedOverTo,
        NULL AS HandedOverToCadre,
        MAX(IF(o.concept_id=8156,o.value_text,NULL)) AS EnrolledFacilityName,
        MAX(IF(o.concept_id=8156,DATE(o.date_created),NULL)) AS ReferralDate,
        MAX(IF(o.concept_id=6742,DATE(o.value_datetime),NULL)) AS DateEnrolled,
        MAX(IF(o.concept_id=6455,o.value_text,NULL)) AS ReportedCCCNumber,
        NULL AS ReportedStartARTDate
    FROM patient pt
    INNER JOIN (
        SELECT
            pt.patient_id AS PatientPK,
            la.`value_reference` AS SiteCode,
            l.name AS FacilityName,
            MAX(pi.identifier) AS HtsNumber,
            DATE(p.birthdate) AS DOB,
            IF(p.gender = 'M', 'Male',IF(p.gender = 'F','Female',NULL)) AS Gender
        FROM patient pt
        LEFT OUTER JOIN encounter e ON pt.patient_id = e.patient_id AND e.voided = 0
        INNER JOIN patient_identifier `pi` ON pi.patient_id = pt.patient_id AND pi.identifier_type IN (18,1) AND pi.voided=0
        INNER JOIN person p ON p.person_id = pt.patient_id
        INNER JOIN location l ON pi.location_id = l.location_id AND l.location_id IN (2,40,265,238,217,215,237,216,42,261,41,258,233,267,44,228,43)
        INNER JOIN location_attribute la ON l.location_id = la.location_id AND la.attribute_type_id = 1
        GROUP BY pt.patient_id
        HAVING DOB IS NOT NULL AND Gender IS NOT NULL
    ) hc ON pt.patient_id = hc.PatientPK
    LEFT JOIN encounter e ON pt.patient_id = e.patient_id AND e.encounter_type IN (44,45,46,47,48,49,53)
    LEFT OUTER JOIN obs o ON o.person_id = pt.patient_id AND o.voided=0 AND o.concept_id IN (8157,8156,6742,6455)
    GROUP BY pt.patient_id
    HAVING DatePrefferedToBeEnrolled IS NOT NULL"|DWHStage|0|HtsClientLinkage|3|A6221989-0E85-11E8-BA89-0ED5F89F718B
D3AB4970-0E03-443F-A3B5-F453692DBECE|Hts Client Tracing|HTS|A6221859-0E85-11E8-BA89-0ED5F89F718B|"SELECT
        hc.FacilityName,
        hc.SiteCode,
        hc.PatientPK,
        hc.HtsNumber,
        'OpenMRS' AS EMR,
        'UCSF Clinical Kisumu' AS Project,
        MAX(IF(o.concept_id=7563,(CASE o.value_coded WHEN 6230 THEN 'Phone' WHEN 6227 THEN 'Physical' ELSE NULL END),NULL)) AS TracingType,
        MAX(IF(o.concept_id=7563,(CASE o.value_coded WHEN 6230 THEN DATE(obs_datetime) WHEN 6227 THEN DATE(obs_datetime) ELSE NULL END),NULL)) AS TracingDate,
        MAX(IF(o.concept_id=7824,(CASE o.value_coded WHEN 1065 THEN ""Contacted and linked"" WHEN 1066 THEN ""Contacted but not linked"" ELSE NULL END),NULL)) AS TracingOutcome
    FROM patient pt
    INNER JOIN (
        SELECT
            pt.patient_id AS PatientPK,
            la.`value_reference` AS SiteCode,
            l.name AS FacilityName,
            MAX(pi.identifier) AS HtsNumber,
            DATE(p.birthdate) AS DOB,
            IF(p.gender = 'M', 'Male',IF(p.gender = 'F','Female',NULL)) AS Gender
        FROM patient pt
        LEFT OUTER JOIN encounter e ON pt.patient_id = e.patient_id AND e.voided = 0
        INNER JOIN patient_identifier `pi` ON pi.patient_id = pt.patient_id AND pi.identifier_type IN (18,1) AND pi.voided=0
        INNER JOIN person p ON p.person_id = pt.patient_id
        INNER JOIN location l ON pi.location_id = l.location_id AND l.location_id IN (2,40,265,238,217,215,237,216,42,261,41,258,233,267,44,228,43)
        INNER JOIN location_attribute la ON l.location_id = la.location_id AND la.attribute_type_id = 1
        GROUP BY pt.patient_id
        HAVING DOB IS NOT NULL AND Gender IS NOT NULL
    ) hc ON pt.patient_id = hc.PatientPK
    LEFT JOIN encounter e ON pt.patient_id = e.patient_id AND e.encounter_type IN (44,45,46,47,48,49,53)
    LEFT OUTER JOIN obs o ON o.person_id = e.patient_id AND o.concept_id IN (7563,7824)
    GROUP BY pt.patient_id
    HAVING TracingType IS NOT NULL"|DWHStage|0|HtsClientTracing|4|A6221989-0E85-11E8-BA89-0ED5F89F718B
6620D2F7-B365-4C5B-83D6-C95DAFC5DD47|Hts Partner Notification Services|HTS|A6221859-0E85-11E8-BA89-0ED5F89F718B|"SELECT
        hc.FacilityName,
        hc.SiteCode,
        hc.PatientPK,
        hc.HtsNumber,
        'OpenMRS' AS EMR,
        'UCSF Clinical Kisumu' AS Project,
        NULL AS PartnerPatientPk,
        NULL AS PartnerPersonID,
        NULL AS Age,
        NULL AS Sex,
        NULL AS RelationsipToIndexClient,
        NULL AS ScreenedForIpv,
        NULL AS IpvScreeningOutcome,
        NULL AS CurrentlyLivingWithIndexClient,
        NULL AS KnowledgeOfHivStatus,
        NULL AS PnsApproach,
        NULL AS PnsConsent,
        NULL AS LinkedToCare,
        NULL AS LinkDateLinkedToCare,
        NULL AS CccNumber,
        NULL AS FacilityLinkedTo,
        NULL AS Dob,
        NULL AS DateElicited,
        NULL AS MaritalStatus
    FROM patient pt
    INNER JOIN (
        SELECT
            pt.patient_id AS PatientPK,
            la.`value_reference` AS SiteCode,
            l.name AS FacilityName,
            MAX(pi.identifier) AS HtsNumber,
            DATE(p.birthdate) AS DOB,
            IF(p.gender = 'M', 'Male',IF(p.gender = 'F','Female',NULL)) AS Gender
        FROM patient pt
        LEFT OUTER JOIN encounter e ON pt.patient_id = e.patient_id AND e.voided = 0
        INNER JOIN patient_identifier `pi` ON pi.patient_id = pt.patient_id AND pi.identifier_type IN (18,1) AND pi.voided=0
        INNER JOIN person p ON p.person_id = pt.patient_id
        INNER JOIN location l ON pi.location_id = l.location_id AND l.location_id IN (2,40,265,238,217,215,237,216,42,261,41,258,233,267,44,228,43)
        INNER JOIN location_attribute la ON l.location_id = la.location_id AND la.attribute_type_id = 1
        GROUP BY pt.patient_id
        HAVING DOB IS NOT NULL AND Gender IS NOT NULL
    ) hc ON pt.patient_id = hc.PatientPK
    GROUP BY pt.patient_id
    HAVING PartnerPatientPk IS NOT NULL"|DWHStage|0|HtsPartnerNotificationServices|5|A6221989-0E85-11E8-BA89-0ED5F89F718B
E454753B-2C01-4C4D-AEE1-06B9E44FF26D|Hts Partner Tracing|HTS|A6221859-0E85-11E8-BA89-0ED5F89F718B|"SELECT
        hc.FacilityName,
        hc.SiteCode,
        hc.PatientPK,
        hc.HtsNumber,
        'OpenMRS' AS EMR,
        'UCSF Clinical Kisumu' AS Project,
        NULL AS TraceType,
        NULL AS PartnerPersonID,
        NULL AS TraceDate,
        NULL AS TraceOutcome,
        NULL AS BookingDate
    FROM patient pt
    INNER JOIN (
        SELECT
            pt.patient_id AS PatientPK,
            la.`value_reference` AS SiteCode,
            l.name AS FacilityName,
            MAX(pi.identifier) AS HtsNumber,
            DATE(p.birthdate) AS DOB,
            IF(p.gender = 'M', 'Male',IF(p.gender = 'F','Female',NULL)) AS Gender
        FROM patient pt
        LEFT OUTER JOIN encounter e ON pt.patient_id = e.patient_id AND e.voided = 0
        INNER JOIN patient_identifier `pi` ON pi.patient_id = pt.patient_id AND pi.identifier_type IN (18,1) AND pi.voided=0
        INNER JOIN person p ON p.person_id = pt.patient_id
        INNER JOIN location l ON pi.location_id = l.location_id AND l.location_id IN (2,40,265,238,217,215,237,216,42,261,41,258,233,267,44,228,43)
        INNER JOIN location_attribute la ON l.location_id = la.location_id AND la.attribute_type_id = 1
        GROUP BY pt.patient_id
        HAVING DOB IS NOT NULL AND Gender IS NOT NULL
    ) hc ON pt.patient_id = hc.PatientPK
    GROUP BY pt.patient_id
    HAVING PartnerPersonID IS NOT NULL"|DWHStage|0|HtsPartnerTracing|6|A6221989-0E85-11E8-BA89-0ED5F89F718B
2C71EB3C-B4E3-4CE8-BDAE-6265A312C3C1|Hts Client Tests|HTS|A6221859-0E85-11E8-BA89-0ED5F89F718B|"SELECT
        hc.FacilityName,
        hc.SiteCode,
        hc.PatientPK,
        hc.HtsNumber,
        'OpenMRS' AS EMR,
        'UCSF Clinical Kisumu' AS Project,
        e.encounter_id AS EncounterId,
        DATE(e.encounter_datetime) AS TestDate,
        MAX(IF(o.concept_id=7136,(CASE o.value_coded WHEN 1065 THEN ""Yes"" WHEN 1066 THEN ""No"" ELSE NULL END),NULL)) AS EverTestedForHiv,
        MAX(IF(o.concept_id=7658,(CASE o.value_coded WHEN 7659 THEN 3 WHEN 7660 THEN 12 WHEN 7661 THEN 13 WHEN 1729 THEN NULL END),NULL)) AS MonthsSinceLastTest,
        MAX(IF(o.concept_id=8138,(CASE o.value_coded WHEN 8137 THEN ""Individual"" WHEN 1756 THEN ""Couple"" ELSE NULL END),NULL)) AS ClientTestedAs,
        MAX(IF(o.concept_id=8174,(
           CASE o.value_coded
               WHEN 1357 THEN ""OPD""
               WHEN 8170 THEN ""IPD""
               WHEN 1354 THEN ""VCT""
               WHEN 8172 THEN ""MCH""
               WHEN 8175 THEN ""TB Clinic""
               WHEN 8173 THEN ""PNS""
               WHEN 7656 THEN ""Family Testing""
               WHEN 8171 THEN ""VMMC""
               ELSE NULL
               END ), NULL))AS EntryPoint,
        MAX(IF(o.concept_id=8145,(
          CASE o.value_coded
              WHEN 8139 THEN ""HP/PITC""
              WHEN 8140 THEN ""Non Provider Initiated Testing""
              WHEN 8141 THEN ""Integrated VCT Center""
              WHEN 8142 THEN ""Stand Alone VCT Center""
              WHEN 8143 THEN ""Home Based Testing""
              WHEN 8144 THEN ""Mobile Outreach HTS""
              WHEN 7629 THEN ""HTS for Non-Patient[NP]""
          ELSE NULL
          END ),NULL)) AS TestStrategy,
        MAX(IF(t.test_1_result IS NOT NULL, t.test_1_result, NULL)) AS TestResult1,
        MAX(IF(t.test_2_result IS NOT NULL, t.test_2_result, NULL)) AS TestResult2,
        MAX(IF(o.concept_id=8155,(CASE o.value_coded WHEN 703 THEN ""Positive"" WHEN 664 THEN ""Negative"" WHEN 7864 THEN ""Inconclusive"" ELSE NULL END),NULL)) AS FinalTestResult,
        MAX(IF(o.concept_id=7936,(CASE o.value_coded WHEN 1065 THEN ""Yes"" WHEN 1066 THEN ""No"" ELSE NULL END),NULL)) AS PatientGivenResult,
        MAX(IF(o.concept_id=7791,cn.name,NULL)) AS TBScreening,
        MAX(IF(o.concept_id=7937,(CASE o.value_coded WHEN 1065 THEN ""Yes"" WHEN 1066 THEN ""No"" ELSE NULL END),NULL)) AS ClientSelfTested,
        MAX(IF(o.concept_id=6096,(CASE o.value_coded WHEN 1065 THEN ""Yes"" WHEN 1066 THEN ""No"" ELSE NULL END),NULL)) AS CoupleDiscordant,
        IF(e.encounter_type = 46,""Initial"",IF(e.encounter_type = 47,""Repeat"",NULL)) AS TestType,
        MAX(IF(o.concept_id=8168,(CASE o.value_coded WHEN 1065 THEN ""Yes"" WHEN 1066 THEN ""No"" ELSE """" END),NULL)) AS Consent
    FROM patient pt
    INNER JOIN (
        SELECT
            pt.patient_id AS PatientPK,
            la.`value_reference` AS SiteCode,
            l.name AS FacilityName,
            MAX(pi.identifier) AS HtsNumber,
            DATE(p.birthdate) AS DOB,
            IF(p.gender = 'M', 'Male',IF(p.gender = 'F','Female',NULL)) AS Gender
        FROM patient pt
        LEFT OUTER JOIN encounter e ON pt.patient_id = e.patient_id AND e.voided = 0
        INNER JOIN patient_identifier `pi` ON pi.patient_id = pt.patient_id AND pi.identifier_type IN (18,1) AND pi.voided=0
        INNER JOIN person p ON p.person_id = pt.patient_id
        INNER JOIN location l ON pi.location_id = l.location_id AND l.location_id IN (2,40,265,238,217,215,237,216,42,261,41,258,233,267,44,228,43)
        INNER JOIN location_attribute la ON l.location_id = la.location_id AND la.attribute_type_id = 1
        GROUP BY pt.patient_id
        HAVING DOB IS NOT NULL AND Gender IS NOT NULL
    ) hc ON pt.patient_id = hc.PatientPK AND SiteCode = hc.SiteCode
    INNER JOIN visit v ON pt.patient_id = v.patient_id AND v.voided = 0
    LEFT JOIN encounter e ON pt.patient_id = e.patient_id AND e.encounter_type IN (46,47)
    JOIN person p ON p.person_id = pt.patient_id
    INNER JOIN (
         SELECT
                   o.person_id,
                   o.encounter_id,
                   o.obs_group_id,
                   MAX(IF(o.concept_id=1040, (CASE o.value_coded WHEN 703 THEN ""Positive"" WHEN 664 THEN ""Negative"" WHEN 1304 THEN ""Invalid""  ELSE NULL END),NULL)) AS test_1_result ,
                   MAX(IF(o.concept_id=1326, (CASE o.value_coded WHEN 703 THEN ""Positive"" WHEN 664 THEN ""Negative"" WHEN 1175 THEN ""N/A""  ELSE NULL END),NULL)) AS test_2_result
         FROM obs o
         INNER JOIN encounter e ON e.encounter_id = o.encounter_id
         WHERE o.concept_id IN (1040, 1326)
         GROUP BY e.encounter_id, o.obs_group_id
    ) t ON e.encounter_id = t.encounter_id
    LEFT OUTER JOIN obs o ON o.person_id = pt.patient_id AND o.voided=0 AND o.concept_id IN (7136,7658,8138,8174,8145,8155,7936,7937,6096,8168,7791)
    INNER JOIN concept_name cn ON cn.concept_id = o.value_coded
    GROUP BY pt.patient_id, TestType"|DWHStage|0|HtsClientTests|7|A6221989-0E85-11E8-BA89-0ED5F89F718B
BAB42EA7-E672-4C1B-A1B3-F2160DE40845|Master Patient Index|CBS|A6221859-0E85-11E8-BA89-0ED5F89F718B|"select null"|MPI|1|MasterPatientIndex|1|A6221989-0E85-11E8-BA89-0ED5F89F718B

b629ab26-3055-11ea-978f-2e728ce98131|Migration|MGS|a62216ee-0e85-11e8-ba89-0ed5f89f718b|"SELECT ID as MetricId,Dataset,Metric,MetricValue,Stage,SiteCode,Emr,FacilityName,'KenyaHMIS' as Project,CreateDate FROM DWAPI_Migration_Metrics"|MgsStage|1|MetricMigrationExtract|1|a6221983-0e85-11e8-ba89-0ed5f89f718b
b629ab27-3055-11ea-978f-2e728ce98132|Migration|MGS|a6221856-0e85-11e8-ba89-0ed5f89f718b|"SELECT ID as MetricId,Dataset,Metric,MetricValue,Stage,SiteCode,Emr,FacilityName,'KenyaHMIS' as Project,CreateDate FROM DWAPI_Migration_Metrics"|MgsStage|1|MetricMigrationExtract|1|a6221aa4-0e85-11e8-ba89-0ed5f89f718b

ec3d7e10-bb10-11ea-b3de-0242ac130004|Smart Card|PSMART|a6221860-0e85-11e8-ba89-0ed5f89f718b|"select id,shr,date_created,status,status_date,uuid FROM psmart_store where upper(status) = 'PENDING'"|PSmartStage|1|pSmart|1|a6221aa6-0e85-11e8-ba89-0ed5f89f718b
ec3d7e11-bb10-11ea-b3de-0242ac130004|All Patients|NDWH|a6221860-0e85-11e8-ba89-0ed5f89f718b|"select
CASE WHEN prg.program='TB' THEN prg.status  ELSE null end  AS StatusAtTBClinic,
CASE WHEN prg.program='PMTCT' THEN prg.status  ELSE null end  AS  StatusAtPMTCT,
CASE WHEN prg.program='HIV' THEN prg.status  ELSE null end  AS   StatusATCCC,

'' AS SatelliteName,
0 AS FacilityId,d.unique_patient_no as PatientID,
                                 d.patient_id as PatientPK,
                                 (select value_reference from location_attribute
                                  where location_id in (select property_value
                                                        from global_property
                                                        where property='kenyaemr.defaultLocation') and attribute_type_id=1) as siteCode,
                                 (select name from location
                                  where location_id in (select property_value
                                                        from global_property
                                                        where property='kenyaemr.defaultLocation')) as FacilityName,
                                 case d.gender when 'M' then 'Male' when 'F' then 'Female' end  as Gender,
                                 d.dob as DOB,
                                 CAST(min(hiv.visit_date) as Date) as RegistrationDate,
                                 CAST(coalesce(date_first_enrolled_in_care,min(hiv.visit_date)) as Date) as RegistrationAtCCC,
                                 CAST(min(mch.visit_date)as Date) as RegistrationATPMTCT,
                                 CAST(min(tb.visit_date)as Date) as RegistrationAtTBClinic,
                                 case  max(hiv.entry_point)
                                   when 160542 then 'OPD'
                                   when 160563 then 'Other'
                                   when 160539 then 'VCT'
                                   when 160538 then 'PMTCT'
                                   when 160541 then 'TB'
                                   when 160536 then 'IPD - Adult'
                                   /*else cn.name*/
                                     end as PatientSource,

                                (select state_province from location
                                                           where location_id in (select property_value
                                                                                 from global_property
                                                                                 where property='kenyaemr.defaultLocation')) as Region,
                                 (select county_district from location
                                  where location_id in (select property_value
                                                        from global_property
                                                        where property='kenyaemr.defaultLocation'))as District,
                                 (select address6 from location
                                  where location_id in (select property_value
                                                        from global_property
                                                        where property='kenyaemr.defaultLocation')) as Village,
                                 UPPER(ts.name) as ContactRelation,
                                 CAST(GREATEST(coalesce(max(hiv.visit_date),date('1000-01-01')),coalesce(max(de.visit_date),date('1000-01-01')), coalesce(max(enr.visit_date),date('1000-01-01'))) as Date) as LastVisit,
                                 UPPER(d.marital_status) as MaritalStatus,
                                 UPPER(d.education_level) as EducationLevel,

                                 CAST(min(hiv.date_confirmed_hiv_positive) as Date) as DateConfirmedHIVPositive,
                                 max(hiv.arv_status) as PreviousARTExposure,
                                 NULL as PreviousARTStartDate,


                                 'KenyaEMR' as Emr,
                                 'IRDO' as Project,


                                CASE hiv.patient_type
									WHEN 160563 THEN 'Transfer in'
									WHEN 164144	THEN 'New client'
									WHEN 159833	THEN 'Re-enroll'
                                ELSE hiv.patient_type
                                END AS PatientType,



                                 (select CASE
									WHEN f.key_population_type  IS NOT NULL AND f.key_population_type  !=1175
										THEN 'Key population'
									WHEN f.key_population_type  =1175 THEN 'General Population'
									ELSE pt.name  END  from  kenyaemr_etl.etl_patient_hiv_followup f
									left join concept_name pt on f.population_type = pt.concept_id AND pt.concept_name_type='FULLY_SPECIFIED'
								WHERE f.encounter_id=min(enr.encounter_id)) AS PopulationType,

                                 (select
									case f.key_population_type
									WHEN 105 THEN 'PWID'
									WHEN 160578 THEN 'MSM'
									WHEN 160579  THEN 'FSW'
									WHEN 1175 THEN 'N/A'
									ELSE null END

                                from  kenyaemr_etl.etl_patient_hiv_followup f
								WHERE f.encounter_id=min(enr.encounter_id)) AS KeyPopulationType,
                                case orp.value_coded when 1 THEN 'Yes' when 2 THEN 'No' ELSE null END as  'Orphan',
                                case sch.value_coded when 1 THEN 'Yes' when 2 THEN 'No' ELSE null END as 'InSchool',
								patAd.county_district AS  PatientResidentCounty,
                                patAd.state_province AS PatientResidentSubCounty,
                                patAd.address6 AS PatientResidentLocation,
                                patAd.address5 AS PatientResidentSubLocation,
                                patAd.address4 AS PatientResidentWard,
                                patAd.city_village AS PatientResidentVillage,
                                cast(min(hiv.transfer_in_date) as Date) as TransferInDate

from kenyaemr_etl.etl_hiv_enrollment hiv
inner join  kenyaemr_etl.etl_patient_demographics d on hiv.patient_id=d.patient_id
left outer join kenyaemr_etl.etl_mch_enrollment mch on mch.patient_id=d.patient_id
left outer join kenyaemr_etl.etl_patient_hiv_followup enr on enr.patient_id=d.patient_id
left outer join kenyaemr_etl.etl_tb_enrollment tb on tb.patient_id=d.patient_id
left outer join kenyaemr_etl.etl_drug_event de on de.patient_id = d.patient_id
left join concept_name ts on ts.concept_id=hiv.relationship_of_treatment_supporter and ts.concept_name_type = 'FULLY_SPECIFIED' and ts.locale='en'
left join person_address patAd ON patAd.person_id=d.patient_id and patAd.voided = 0
left join (select distinct person_id, value_coded
	from obs
    where concept_id=5629 and voided=0) sch on  sch.person_id = d.patient_id
left join (select distinct person_id, value_coded
	from obs
    where concept_id=11704 and voided=0) orp on  sch.person_id = d.patient_id
left join
(
	select Patient_Id,   program ,
	if(mid(max(concat(date_enrolled,date_completed)), 20) is null, 'Active', 'Inactive') as status
	from kenyaemr_etl.etl_patient_program
	group by Patient_Id,program
) as prg on prg.patient_id = d.patient_id
where unique_patient_no is not null
group by d.patient_id
order by d.patient_id"|dwhstage|1|PatientExtract|1|a6221aa6-0e85-11e8-ba89-0ed5f89f718b

ec3d7e12-bb10-11ea-b3de-0242ac130004|ART Patients|NDWH|a6221860-0e85-11e8-ba89-0ed5f89f718b|" select '' AS SatelliteName, 0 AS FacilityId, d.DOB,
       d.Gender, '' AS Provider,
       d.unique_patient_no as PatientID,
       d.patient_id as PatientPK,
       timestampdiff(year,d.DOB, hiv.visit_date) as AgeEnrollment,
       timestampdiff(year,d.DOB, reg.art_start_date) as AgeARTStart,
       timestampdiff(year,d.DOB, reg.latest_vis_date) as AgeLastVisit,
       (select value_reference from location_attribute
        where location_id in (select property_value
                              from global_property
                              where property='kenyaemr.defaultLocation') and attribute_type_id=1) as siteCode,
       (select name from location
        where location_id in (select property_value
                              from global_property
                              where property='kenyaemr.defaultLocation')) as FacilityName,
       CAST(coalesce(date_first_enrolled_in_care,min(hiv.visit_date)) as Date) as RegistrationDate,
       case  max(hiv.entry_point)
         when 160542 then 'OPD'
         when 160563 then 'Other'
         when 160539 then 'VCT'
         when 160538 then 'PMTCT'
         when 160541 then 'TB'
         when 160536 then 'IPD - Adult'
         else cn.name
           end as PatientSource,
       reg.art_start_date as StartARTDate,
       hiv.date_started_art_at_transferring_facility as PreviousARTStartDate,
       '' as PreviousARTRegimen,
       reg.art_start_date as StartARTAtThisFacility,
       reg.regimen as StartRegimen,
       reg.regimen_line as StartRegimenLine,
      -- reg.last_art_date as LastARTDate,
	   case
		when reg.latest_vis_date is not null then reg.latest_vis_date else  reg.last_art_date end as LastARTDate,

       reg.last_regimen as LastRegimen,
       reg.last_regimen_line as LastRegimenLine,
       reg.latest_tca as ExpectedReturn,
       reg.latest_vis_date as LastVisit ,
       timestampdiff(month,reg.art_start_date, reg.latest_vis_date) as duration,
       disc.visit_date as ExitDate,
       case
         when disc.discontinuation_reason is not null then dis_rsn.name
         else '' end as ExitReason,
       'KenyaEMR' as Emr,
       'IRDO' as Project,
       CAST(now() as Date) AS DateExtracted
from kenyaemr_etl.etl_hiv_enrollment hiv
       join kenyaemr_etl.etl_patient_demographics d on d.patient_id=hiv.patient_id
       left outer join  kenyaemr_etl.etl_patient_program_discontinuation disc on disc.patient_id=hiv.patient_id
       left outer join (select e.patient_id,
                               if(enr.date_started_art_at_transferring_facility is not null,enr.date_started_art_at_transferring_facility,
                                  e.date_started)as art_start_date, e.date_started, e.gender,e.dob,d.visit_date as dis_date, if(d.visit_date is not null, 1, 0) as TOut,
                               e.regimen, e.regimen_line, e.alternative_regimen, max(fup.next_appointment_date) as latest_tca,
                               last_art_date,last_regimen,last_regimen_line,
                               if(enr.transfer_in_date is not null, 1, 0) as TIn, max(fup.visit_date) as  latest_vis_date
                        from (select e.patient_id,p.dob,p.Gender,min(e.date_started) as date_started,
                                     max(e.date_started) as last_art_date,
                                     mid(min(concat(e.date_started,e.regimen_name)),11) as regimen,
                                     mid(min(concat(e.date_started,e.regimen_line)),11) as regimen_line,
                                     mid(max(concat(e.date_started,e.regimen_name)),11) as last_regimen,
                                     mid(max(concat(e.date_started,e.regimen_line)),11) as last_regimen_line,
                                     max(if(discontinued,1,0))as alternative_regimen
                              from kenyaemr_etl.etl_drug_event e
                                     join kenyaemr_etl.etl_patient_demographics p on p.patient_id=e.patient_id
                                     left join  kenyaemr_etl.etl_pharmacy_extract ph on ph.patient_id = e.patient_id and is_arv=1
                              group by e.patient_id) e
                               left outer join kenyaemr_etl.etl_patient_program_discontinuation d on d.patient_id=e.patient_id
                               left outer join kenyaemr_etl.etl_hiv_enrollment enr on enr.patient_id=e.patient_id
                               left outer join kenyaemr_etl.etl_patient_hiv_followup fup on fup.patient_id=e.patient_id
                        group by e.patient_id)reg on reg.patient_id=hiv.patient_id
       left outer join concept_name dis_rsn on dis_rsn.concept_id=disc.discontinuation_reason  and dis_rsn.concept_name_type='FULLY_SPECIFIED'
                                                 and dis_rsn.locale='en'
       left outer join concept_name cn on cn.concept_id=hiv.entry_point  and cn.concept_name_type='FULLY_SPECIFIED'
                                            and cn.locale='en'
where d.unique_patient_no is not null
group by d.patient_id
having min(hiv.visit_date) is not null and reg.art_start_date is not null"|dwhstage|0|PatientArtExtract|2|a6221aa6-0e85-11e8-ba89-0ed5f89f718b

ec3d7e13-bb10-11ea-b3de-0242ac130004|Patient Baselines|NDWH|a6221860-0e85-11e8-ba89-0ed5f89f718b|"select distinct '' AS SatelliteName, 0 AS FacilityId, d.unique_patient_no as PatientID,
d.patient_id as PatientPK,
(select value_reference from location_attribute
where location_id in (select property_value
from global_property
where property='kenyaemr.defaultLocation') and attribute_type_id=1) as facilityId,
(select value_reference from location_attribute
where location_id in (select property_value
from global_property
where property='kenyaemr.defaultLocation') and attribute_type_id=1) as siteCode,
 mid(max(if(l.visit_date<=p_dates.enrollment_date,concat(l.visit_date,test_result),null)),11) as eCd4,
 CAST(left(max(if(l.visit_date<=p_dates.enrollment_date,concat(l.visit_date,test_result),null)),10) AS DATE) as eCd4Date,
 if(fup.visit_date<=p_dates.enrollment_date,
 case who_stage
 when 1220 then 'WHO I'
 when 1221 then 'WHO II'
 when 1222 then 'WHO III'
 when 1223 then 'WHO IV'
 when 1204 then 'WHO I'
 when 1205 then 'WHO II'
 when 1206 then 'WHO III'
 when 1207 then 'WHO IV'
 end,null) as ewho,
 CAST(if(fup.visit_date<=p_dates.enrollment_date and who_stage is not null and fup.visit_date>'1900-01-01',
fup.visit_date,null) AS DATE) as ewhodate,
'' as bCD4,
NULL as bCD4Date,
'' as bWHO,
NULL as bWHODate,
 mid(max(concat(fup.visit_date,case who_stage
 when 1220 then 'WHO I'
 when 1221 then 'WHO II'
 when 1222 then 'WHO III'
 when 1223 then 'WHO IV'
 when 1204 then 'WHO I'
 when 1205 then 'WHO II'
 when 1206 then 'WHO III'
 when 1207 then 'WHO IV'
 end)),11) as lastwho,
 CAST(left(max(concat(fup.visit_date,case who_stage
 when 1220 then 'WHO I'
 when 1221 then 'WHO II'
 when 1222 then 'WHO III'
 when 1223 then 'WHO IV'
 when 1204 then 'WHO I'
 when 1205 then 'WHO II'
 when 1206 then 'WHO III'
 when 1207 then 'WHO IV'
 end)),10) AS DATE) as lastwhodate,
  mid(max(concat(l.visit_date,l.test_result)),11) as lastcd4,
 CAST(left(max(concat(l.visit_date,l.test_result)),10) AS DATE) as lastcd4date,
 mid(max(if(l.visit_date>p_dates.six_month_date and l.visit_date<p_dates.twelve_month_date ,concat(l.visit_date,test_result),null)),11) as m6Cd4,
 CAST(left(max(if(l.visit_date>=p_dates.six_month_date and l.visit_date<p_dates.twelve_month_date ,concat(l.visit_date,test_result),null)),10) AS DATE) as m6Cd4Date,
 mid(max(if(l.visit_date>=p_dates.twelve_month_date,concat(l.visit_date,test_result),null)),11) as m6Cd4,
 CAST(left(max(if(l.visit_date>p_dates.twelve_month_date,concat(l.visit_date,test_result),null)),10) AS DATE) as m6Cd4Date,
 '' as eWAB, NULL as eWABDate,'' as bWAB, NULL as bWABDAte,
 'KenyaEMR' as Emr,
 'IRDO' as Project,
 '' AS LastWaB,NULL AS LastWABDate,
 '' as m12CD4,
NULL as m12CD4Date,
'' AS m6CD4,
NULL m6CD4Date
from kenyaemr_etl.etl_patient_hiv_followup fup
join kenyaemr_etl.etl_patient_demographics d on d.patient_id=fup.patient_id
join (select e.patient_id,date_add(date_add(min(e.visit_date),interval 3 month), interval 1 day) as enrollment_date,
date_add(date_add(min(e.visit_date), interval 6 month),interval 1 day) as six_month_date,
date_add(date_add(min(e.visit_date), interval 12 month),interval 1 day) as twelve_month_date
from kenyaemr_etl.etl_hiv_enrollment e
group by e.patient_id) p_dates on p_dates.patient_id=fup.patient_id
left outer join kenyaemr_etl.etl_laboratory_extract l on l.patient_id=fup.patient_id and l.lab_test in (5497,730) where d.unique_patient_no is not null
group by fup.patient_id
order by m6cd4date desc"|dwhstage|0|PatientBaselineExtract|3|a6221aa6-0e85-11e8-ba89-0ed5f89f718b
ec3d7e14-bb10-11ea-b3de-0242ac130004|Patient Status|NDWH|a6221860-0e85-11e8-ba89-0ed5f89f718b|"select
'' AS SatelliteName,
0 AS FacilityId,
d.unique_patient_no as PatientID,
d.patient_id as PatientPK,(select value_reference from location_attribute
where location_id in (select property_value from global_property where property='kenyaemr.defaultLocation') and attribute_type_id=1) as siteCode, (select name from location where location_id in (select property_value
from global_property
where property='kenyaemr.defaultLocation')) as FacilityName,
'' as ExitDescription,
/*disc.visit_date as ExitDate,
case
when disc.discontinuation_reason is not null then cn.name
else '' end as ExitReason,*/
 'KenyaEMR' as Emr,
 'IRDO' as Project,
CAST(now() as Date) AS DateExtracted,
max(disc.visit_date) AS ExitDate,
mid(max(concat(disc.visit_date,case when disc.discontinuation_reason is not null then cn.name
else '' end  )),20) as ExitReason
from kenyaemr_etl.etl_patient_program_discontinuation disc
join kenyaemr_etl.etl_patient_demographics d on d.patient_id=disc.patient_id
left outer join concept_name cn on cn.concept_id=disc.discontinuation_reason  and cn.concept_name_type='FULLY_SPECIFIED'
and cn.locale='en'
where d.unique_patient_no is not null
group by PatientID
order by disc.visit_date ASC"|dwhstage|0|PatientStatusExtract|4|a6221aa6-0e85-11e8-ba89-0ed5f89f718b

ec3d7e15-bb10-11ea-b3de-0242ac130004|Patient Labs|NDWH|a6221860-0e85-11e8-ba89-0ed5f89f718b|"select distinct '' AS SatelliteName, 0 AS FacilityId, d.unique_patient_no as patientID, d.patient_id as patientPK, l.encounter_id as visitID,
CAST(l.visit_date AS DATE) as orderedByDate,CAST(l.visit_date AS DATE) as reportedByDate, null as reason, (select value_reference from location_attribute
where location_id in (select property_value
from global_property
where property='kenyaemr.defaultLocation') and attribute_type_id=1) as facilityID,
(select value_reference from location_attribute
where location_id in (select property_value
from global_property
where property='kenyaemr.defaultLocation') and attribute_type_id=1) as siteCode,
(select name from location
where location_id in (select property_value
from global_property
where property='kenyaemr.defaultLocation')) as facilityName,
cn.name as testName,
case
when c.datatype_id=2 then cn2.name
else
 l.test_result
end as TestResult,
NULL as enrollmentTest,
 'KenyaEMR' as Emr,
 'IRDO' as Project
from kenyaemr_etl.etl_laboratory_extract l
join kenyaemr_etl.etl_patient_demographics d on d.patient_id=l.patient_id
join concept_name cn on cn.concept_id=l.lab_test and cn.concept_name_type='FULLY_SPECIFIED'and cn.locale='en'
join concept c on c.concept_id = l.lab_test
left outer join concept_name cn2 on cn2.concept_id=l.test_result and cn2.concept_name_type='FULLY_SPECIFIED'
and cn2.locale='en' where d.unique_patient_no is not null"|dwhstage|0|PatientLabExtract|5|a6221aa6-0e85-11e8-ba89-0ed5f89f718b

ec3d7e16-bb10-11ea-b3de-0242ac130004|Patient Pharmacy|NDWH|a6221860-0e85-11e8-ba89-0ed5f89f718b|"select distinct
'' AS Provider,'' AS SatelliteName, 0 AS FacilityId, d.unique_patient_no as PatientID,
d.patient_id as PatientPK,
(select name from location
where location_id in (select property_value
from global_property
where property='kenyaemr.defaultLocation')) as FacilityName,
(select value_reference from location_attribute
where location_id in (select property_value
from global_property
where property='kenyaemr.defaultLocation') and attribute_type_id=1) as siteCode,
ph.visit_id as VisitID,
-- if(cn2.name is not null, cn2.name,cn.name) as Drug,
case
when is_arv=1 then ph.drugreg
else if(cn2.name is not null, cn2.name,cn.name) END as Drug,
ph.visit_date as DispenseDate,
ph.duration AS duration,
ph.duration AS PeriodTaken,
fup.next_appointment_date as ExpectedReturn,
'KenyaEMR' as Emr,
'IRDO' as Project,
CASE WHEN is_arv=1 THEN 'ARV'
WHEN is_ctx=1 OR is_dapsone= 1 THEN 'Prophylaxis' END AS TreatmentType,
ph.RegimenLine,
CASE WHEN is_ctx=1 THEN 'CTX'
WHEN is_dapsone =1 THEN 'DAPSON' END AS ProphylaxisType,
CAST(now() as Date) AS DateExtracted
from (SELECT * FROM (
select patient_id, visit_id,visit_date,encounter_id,drug,is_arv, is_ctx,is_dapsone,drug_name as drugreg,frequency,
'' as DispenseDate,duration, duration PeriodTaken,
''ExpectedReturn, CASE WHEN is_ctx=1 OR is_dapsone= 1 THEN 'Prophylaxis' END AS TreatmentType,'' as RegimenLine,
CASE WHEN is_ctx=1 THEN 'CTX'
WHEN is_dapsone =1 THEN 'DAPSON' END AS ProphylaxisType from kenyaemr_etl.etl_pharmacy_extract ph
left outer join concept_name cn2 on cn2.concept_id=ph.drug and cn2.concept_name_type='SHORT'
and cn2.locale='en' where is_ctx=1 OR is_dapsone= 1
GROUP BY patient_id, visit_id,visit_date,encounter_id
UNION

SELECT patient_id,''visit_id,visit_date,encounter_id,regimen drug,1 as is_arv, 0 as is_ctx, 0 as is_dapsone, regimen_name as drugreg, '' frequency, date_started as DispenseDate,''duration,''PeriodTaken,
''ExpectedReturn, 'ARV' AS TreatmentType,regimen_line as RegimenLine,NULL as ProphylaxisType FROM kenyaemr_etl.etl_drug_event
GROUP BY patient_id, visit_id,visit_date,encounter_id
)A )ph
join kenyaemr_etl.etl_patient_demographics d on d.patient_id=ph.patient_id
left outer join concept_name cn on cn.concept_id=ph.drug and cn.concept_name_type='FULLY_SPECIFIED'
and cn.locale='en'
left outer join concept_name cn2 on cn2.concept_id=ph.drug and cn2.concept_name_type='SHORT'
and cn.locale='en'
left outer join kenyaemr_etl.etl_patient_hiv_followup fup on fup.encounter_id=ph.encounter_id
and fup.patient_id=ph.patient_id
where unique_patient_no is not null and (is_arv=1 OR is_ctx=1 OR is_dapsone =1 ) and drugreg is not null
order by ph.patient_id,ph.visit_date"|dwhstage|0|PatientPharmacyExtract|6|a6221aa6-0e85-11e8-ba89-0ed5f89f718b

ec3d7e17-bb10-11ea-b3de-0242ac130004|Patient Visit|NDWH|a6221860-0e85-11e8-ba89-0ed5f89f718b|"select distinct
'' AS SatelliteName, 0 AS FacilityId, d.unique_patient_no as PatientID,
d.patient_id as PatientPK,
(select name from location
where location_id in (select property_value
from global_property
where property='kenyaemr.defaultLocation')) as FacilityName,
(select value_reference from location_attribute
where location_id in (select property_value
from global_property
where property='kenyaemr.defaultLocation') and attribute_type_id=1) as siteCode,
fup.visit_id as VisitID,
case when fup.visit_date < '1990-01-01' then null else CAST(fup.visit_date AS DATE) end  AS VisitDate,
'Out Patient' as Service,
fup.visit_scheduled as VisitType,
case fup.who_stage
when 1220 then 'WHO I'
when 1221 then 'WHO II'
when 1222 then 'WHO III'
when 1223 then 'WHO IV'
when 1204 then 'WHO I'
when 1205 then 'WHO II'
when 1206 then 'WHO III'
when 1207 then 'WHO IV'
  else ''
end as WHOStage,
'' as WABStage,
case fup.pregnancy_status
when 1065 then 'Yes'
when 1066 then 'No'
end as Pregnant,
CAST(fup.last_menstrual_period AS DATE) as LMP,
CAST(fup.expected_delivery_date AS DATE) as EDD,
fup.height as Height,
fup.weight as Weight,
concat(fup.systolic_pressure,'/',fup.diastolic_pressure) as BP,
'ART|CTX' as AdherenceCategory,
concat(
IF(fup.arv_adherence=159405, 'Good', IF(fup.arv_adherence=159406, 'Fair', IF(fup.arv_adherence=159407, 'Poor', ''))), IF(fup.arv_adherence in (159405,159406,159407), '|','') ,
IF(fup.ctx_adherence=159405, 'Good', IF(fup.ctx_adherence=159406, 'Fair', IF(fup.ctx_adherence=159407, 'Poor', '')))
) AS Adherence,
'' as OI,
NULL as OIDate,
case fup.family_planning_status
when 695 then 'Currently using FP'
when 160652 then 'Not using FP'
when 1360 then 'Wants FP'
else ''
end as FamilyPlanningMethod,
concat(
case fup.condom_provided
when 1065 then 'Condoms,'
else ''
end,
case fup.pwp_disclosure
when 1065 then 'Disclosure|'
else ''
end,
case fup.pwp_partner_tested
when 1065 then 'Partner Testing|'
else ''
end,
case fup.screened_for_sti
when 1065 then 'Screened for STI'
else ''
end )as PWP,
if(fup.last_menstrual_period is not null, timestampdiff(week,fup.last_menstrual_period,fup.visit_date),'') as GestationAge,
case when fup.next_appointment_date < '1990-01-01' then null else CAST(fup.next_appointment_date AS DATE) end  AS NextAppointmentDate,
'KenyaEMR' as Emr,
'IRDO' as Project,

CAST(fup.substitution_first_line_regimen_date AS DATE)  AS SubstitutionFirstlineRegimenDate,
fup.substitution_first_line_regimen_reason AS SubstitutionFirstlineRegimenReason,
CAST(fup.substitution_second_line_regimen_date AS DATE) AS SubstitutionSecondlineRegimenDate,
fup.substitution_second_line_regimen_reason AS SubstitutionSecondlineRegimenReason,
CAST(fup.second_line_regimen_change_date AS DATE) AS SecondlineRegimenChangeDate,
fup.second_line_regimen_change_reason AS SecondlineRegimenChangeReason,


 CASE fup.stability
 WHEN 1 THEN 'Stable'
 WHEN 2 THEN 'Not Stable' END as StabilityAssessment,

dc.name as DifferentiatedCare,
CASE
               WHEN fup.key_population_type  IS NOT NULL AND fup.key_population_type  !=1175
               THEN 'Key population'
    ELSE pt.name  END as PopulationType,

case fup.key_population_type
WHEN 105 THEN 'PWID'
WHEN 160578 THEN 'MSM'
WHEN 160579  THEN 'FSW'
WHEN 1175 THEN 'N/A'
ELSE fup.key_population_type  END as KeyPopulationType

from kenyaemr_etl.etl_patient_demographics d
join kenyaemr_etl.etl_patient_hiv_followup fup on fup.patient_id=d.patient_id
left join concept_name dc on dc.concept_id =  fup.differentiated_care and dc.concept_name_type='FULLY_SPECIFIED'
left join concept_name pt on fup.population_type = pt.concept_id AND pt.concept_name_type='FULLY_SPECIFIED'
where d.unique_patient_no is not null and fup.visit_date > '1990-01-01'  "|dwhstage|0|PatientVisitExtract|7|a6221aa6-0e85-11e8-ba89-0ed5f89f718b
ec3d7e18-bb10-11ea-b3de-0242ac130004|Patient Adverse Events|NDWH|a6221860-0e85-11e8-ba89-0ed5f89f718b|"SELECT '' AS PatientID,
       '' AS PatientPK,
       '' AS SiteCode,
	   '' AS FacilityID,
       'KenyaEMR' AS EMR,
       'IRDO' AS Project,
       NOW() AS VisitDate,
       '' AS AdverseEventRegimen,
       '' AS AdverseEvent,
       '' AS AdverseEventCause,
       '' AS Severity,
       '' AS AdverseEventActionTaken,
       '' AS AdverseEventClinicalOutcome,
	   NOW() AS AdverseEventStartDate,
       NOW() AS AdverseEventEndDate,
       '' AS AdverseEventIsPregnant"|dwhstage|0|PatientAdverseEventExtract|8|a6221aa6-0e85-11e8-ba89-0ed5f89f718b
ec3d7e20-bb10-11ea-b3de-0242ac130004|Master Patient Index|CBS|a6221860-0e85-11e8-ba89-0ed5f89f718b|"
SELECT DISTINCT
-- -----Demographics
X.Ptn_Pk,
X.PatientPK,
siteCode,
FacilityName,
-- a.patient_clinic_number AS Serial
-- X.Ptn_Pk AS Serial
X.Serial
,FirstName
, MiddleName
,LastName
, FirstName_Normalized
, MiddleName_Normalized
,LastName_Normalized
,sxFirstName
,sxLastName
,sxMiddleName
,dmFirstName
, dmLastName
, dmMiddleName
, PatientPhoneNumber
, PatientAlternatePhoneNumber
,Gender
,DOB
,MaritalStatus
-- -----Patient Address
, PatientSource
, PatientCounty
, PatientSubCounty
, PatientVillage
-- -----Patient-Identifiers
,PatientID
,National_ID
,NHIF_Number
,Birth_Certificate
,CCC_Number
,TB_Number
-- -----Next Of Kin
,ContactName
,ContactRelation
, ContactPhoneNumber
,ContactAddress
, NokNationalId
-- -----Additional Variables
, DateConfirmedHIVPositive
,StartARTDate
,StartARTRegimenCode
, StartARTRegimenDesc,
CONCAT(LEFT(Gender ,1), sxFirstName ,sxLastName ,LTRIM(RTRIM(DATE_FORMAT(DOB, '%Y')))) AS sxPKValue,
CONCAT( CAST(LEFT(Gender ,1) AS CHAR CHARACTER SET utf8),
CAST(CASE
WHEN locate(';',dmFirstName )>0 THEN
SUBSTRING(dmFirstName , locate(';',dmFirstName )+1,LENGTH(dmFirstName ))
ELSE
dmFirstName
END AS CHAR CHARACTER SET utf8),
CAST(CASE
WHEN locate(';',dmLastName )>0 THEN
SUBSTRING(dmLastName , locate(';',dmLastName )+1,LENGTH(dmLastName ))
ELSE
dmLastName
END AS CHAR CHARACTER SET utf8),
CAST(LTRIM(RTRIM(DATE_FORMAT(DOB, '%Y')))AS CHAR CHARACTER SET utf8)

) AS dmPKValue ,

CASE WHEN locate(';',dmLastName )>0
THEN
CONCAT(
CAST(LEFT(Gender ,1) AS CHAR CHARACTER SET utf8)
, CAST(sxFirstName AS CHAR CHARACTER SET utf8)
, CAST(SUBSTRING(dmLastName , locate(';',dmLastName )+1,LENGTH(dmLastName )) AS CHAR CHARACTER SET utf8)
, CAST(LTRIM(RTRIM(DATE_FORMAT(DOB, '%Y')))AS CHAR CHARACTER SET utf8)
)
ELSE
CONCAT(
CAST(LEFT(Gender ,1)AS CHAR CHARACTER SET utf8)
, CAST(sxFirstName AS CHAR CHARACTER SET utf8)
, CAST(dmLastName AS CHAR CHARACTER SET utf8)
, CAST(LTRIM(RTRIM(DATE_FORMAT(DOB, '%Y'))) AS CHAR CHARACTER SET utf8)
)
END AS sxdmPKValue ,
CONCAT(
CAST(LEFT(Gender ,1) AS CHAR CHARACTER SET utf8)
,CAST(sxFirstName AS CHAR CHARACTER SET utf8)
,CAST(sxLastName AS CHAR CHARACTER SET utf8)
,CAST(LTRIM(RTRIM(DATE_FORMAT(DOB, '%Y%m%d')))AS CHAR CHARACTER SET utf8)
) AS sxPKValueDoB ,

CONCAT(

CAST(LEFT(Gender ,1) AS CHAR CHARACTER SET utf8),
CASE
WHEN locate(';',dmFirstName )>0 THEN
CAST(SUBSTRING(dmFirstName , locate(';',dmFirstName )+1,LENGTH(dmFirstName )) AS CHAR CHARACTER SET utf8)
ELSE
CAST(dmFirstName AS CHAR CHARACTER SET utf8)
END ,
CASE
WHEN locate(';',dmLastName )>0 THEN
CAST( SUBSTRING(dmLastName , locate(';',dmLastName )+1,LENGTH(dmLastName )) AS CHAR CHARACTER SET utf8)
ELSE
CAST( dmLastName AS CHAR CHARACTER SET utf8)
END ,

CAST( LTRIM(RTRIM(DATE_FORMAT(DOB, '%Y%m%d'))) AS CHAR CHARACTER SET utf8)
) AS dmPKValueDoB ,

CASE WHEN locate(';',dmLastName )>0 THEN
CONCAT(
CAST( LEFT(Gender ,1) AS CHAR CHARACTER SET utf8)
,CAST( sxFirstName AS CHAR CHARACTER SET utf8)
, CAST( SUBSTRING(dmLastName ,locate(';',dmLastName )+1,LENGTH(dmLastName )) AS CHAR CHARACTER SET utf8)
,CAST( LTRIM(RTRIM(DATE_FORMAT(DOB, '%Y%m%d'))) AS CHAR CHARACTER SET utf8)
)
ELSE
CONCAT(
CAST( LEFT(Gender ,1)AS CHAR CHARACTER SET utf8)
, CAST( sxFirstName AS CHAR CHARACTER SET utf8),
CAST( dmLastName AS CHAR CHARACTER SET utf8),
CAST( LTRIM(RTRIM(DATE_FORMAT(DOB, '%Y%m%d'))) AS CHAR CHARACTER SET utf8)
)
END AS sxdmPKValueDoB
FROM
(
SELECT
-- -----Demographics
a.patient_id as Ptn_Pk,
a.patient_id as PatientPK,
(select value_reference from location_attribute
where location_id in (select property_value
from global_property
where property='kenyaemr.defaultLocation') and attribute_type_id=1) as siteCode,

(select name from location
where location_id in (select property_value
from global_property
where property='kenyaemr.defaultLocation')) as FacilityName,
id.identifier AS Serial
-- a.patient_clinic_number AS Serial

,UPPER(a.given_name ) as FirstName
,UPPER(a.middle_name ) as MiddleName
,UPPER(family_name) as LastName
,UPPER(REPLACE(given_name ,'0','O')) AS FirstName_Normalized
,UPPER(REPLACE(middle_name ,'0','O')) AS MiddleName_Normalized
,UPPER(REPLACE(family_name ,'0','O')) AS LastName_Normalized
,SOUNDEX(UPPER(REPLACE(given_name ,'0','O'))) AS sxFirstName
,SOUNDEX(UPPER(REPLACE(family_name ,'0','O'))) AS sxLastName
,SOUNDEX(UPPER(REPLACE(middle_name ,'0','O'))) AS sxMiddleName
, fn_getPatientNameDoubleMetaphone(UPPER(REPLACE(given_name ,'0','O'))) AS dmFirstName
, fn_getPatientNameDoubleMetaphone(UPPER(REPLACE(family_name ,'0','O'))) AS dmLastName
, fn_getPatientNameDoubleMetaphone(UPPER(REPLACE(middle_name ,'0','O'))) AS dmMiddleName
,a.phone_number AS PatientPhoneNumber
,en.treatment_supporter_telephone AS PatientAlternatePhoneNumber
,a.Gender
,a.DOB
,a.marital_status AS MaritalStatus
-- -----Patient Address
, en.entry_point AS PatientSource
,NULL PatientCounty
,NULL PatientSubCounty
,NULL PatientVillage
-- -----Patient-Identifiers
,patient_clinic_number AS PatientID
,national_id_no AS National_ID
,NULL as NHIF_Number
,NULL as Birth_Certificate
,a.patient_clinic_number AS CCC_Number
,ltrim(rtrim(a.district_reg_no))TB_Number
-- -----Next Of Kin
,LTRIM(RTRIM(next_of_kin)) AS ContactName
,next_of_kin_relationship AS ContactRelation
,treatment_supporter_telephone as ContactPhoneNumber
,treatment_supporter_address as ContactAddress
,NULL AS NokNationalId
-- -----Additional Variables
,date_confirmed_hiv_positive AS DateConfirmedHIVPositive
,X.date_started AS StartARTDate
,X.regimen_name AS StartARTRegimenCode
,X.regimen_line StartARTRegimenDesc

FROM kenyaemr_datatools.patient_demographics a
INNER JOIN patient_identifier id ON a.patient_id = id.patient_id AND id.identifier_type = (SELECT patient_identifier_type_id FROM openmrs.patient_identifier_type
where name ='OpenMRS ID')
left join (
SELECT  c.patient_id,
c.encounter_id, treatment_supporter_telephone, entry_point , treatment_supporter_address, date_confirmed_hiv_positive
from kenyaemr_datatools.hiv_enrollment  c
left JOIN
    (
        SELECT patient_id, MAX(encounter_id) max_encounter_id
        FROM kenyaemr_datatools.hiv_enrollment
        GROUP BY patient_id
    ) b ON c.patient_id = b.patient_id AND
            c.encounter_id = b.max_encounter_id

  order by patient_id,date_created asc


 ) en
on a.Patient_Id=en.patient_id
LEFT JOIN
(
SELECT patient_id, MIN(date_started) AS date_started ,MIN(regimen_name) AS regimen_name, MIN(regimen_line) AS regimen_line
FROM kenyaemr_datatools.drug_event GROUP BY patient_id
) X ON X.patient_id = a.Patient_id
) X
INNER JOIN
(
SELECT
a.patient_id as Ptn_Pk,
id.identifier AS Serial
FROM kenyaemr_datatools.patient_demographics a
INNER JOIN patient_identifier id ON a.patient_id = id.patient_id AND id.identifier_type = (SELECT patient_identifier_type_id FROM openmrs.patient_identifier_type
where name ='OpenMRS ID')

)Y
ON
Y.Ptn_Pk = X.Ptn_Pk AND Y.Serial= X.Serial
"|MPI|1|MasterPatientIndex|1|a6221aa6-0e85-11e8-ba89-0ed5f89f718b
ec3d7e30-bb10-11ea-b3de-0242ac130004|Hts Clients|HTS|a6221860-0e85-11e8-ba89-0ed5f89f718b|"SELECT  distinct d.patient_id as PatientPK,
	SC.value_reference AS SiteCode,
	SN.name as FacilityName,
	'KenyaEMR' as Emr,
	'IRDO' AS Project,
	id.identifier AS HtsNumber,
	d.DOB,
	case when d.Gender='M' then 'Male' else 'Female' end as Gender,
	d.marital_status as MaritalStatus,
	t.population_type as PopulationType,
	t.key_population_type as KeyPopulationType,
	t.disability_type as PatientDisabled,
	A.county_district as County,
	A.state_province as SubCounty,
	A.address4 as Ward
FROM
kenyaemr_etl.etl_patient_demographics  d
INNER JOIN
kenyaemr_etl.etl_hts_test t ON d.patient_id=t.patient_id
LEFT JOIN
 location_attribute SC ON SC.location_id = t.encounter_location AND SC.attribute_type_id=1
LEFT JOIN
  location SN ON SN.location_id =t.encounter_location
LEFT JOIN person_address A ON A.person_id=d.patient_id
LEFT JOIN patient_identifier id ON id.patient_id = t.patient_id AND id.identifier_type = (select patient_identifier_type_id
from patient_identifier_type
where name='OpenMRS ID')
group by d.patient_id"|DWHStage|1|HtsClient|1|a6221aa6-0e85-11e8-ba89-0ed5f89f718b
ec3d7e31-bb10-11ea-b3de-0242ac130004|Hts Client Tests|HTS|a6221860-0e85-11e8-ba89-0ed5f89f718b|"SELECT
	t.patient_id as PatientPK,
	SC.value_reference AS SiteCode,
	 SN.name as FacilityName,
	'KenyaEMR' as Emr,
	'IRDO' AS Project,
    id.identifier AS HtsNumber,
	t.encounter_id as EncounterId,
	t.visit_date as TestDate,
	t.ever_tested_for_hiv as EverTestedForHiv,
	t.months_since_last_test as MonthsSinceLastTest,
	t.client_tested_as as ClientTestedAs,
	t.hts_entry_point as EntryPoint,
	t.test_strategy as TestStrategy,
	t.test_1_result as TestResult1,
	t.test_2_result as TestResult2,
	t.final_test_result as FinalTestResult,
	t.patient_given_result as PatientGivenResult,
	t.tb_screening as TbScreening,
	t.patient_had_hiv_self_test as ClientSelfTested,
	t.couple_discordant as CoupleDiscordant,
	CASE t.test_type
		WHEN 1 THEN 'Initial'
        WHEN 2 THEN 'Repeat'
	END AS TestType,
	t.patient_consented as Consent
FROM
	kenyaemr_etl.etl_hts_test t
inner join
	kenyaemr_etl.etl_patient_demographics demographics on t.patient_id=demographics.patient_id
LEFT JOIN
	 location_attribute SC ON SC.location_id = t.encounter_location AND SC.attribute_type_id=1
LEFT JOIN
  location SN ON SN.location_id =t.encounter_location
LEFT JOIN patient_identifier id ON id.patient_id = t.patient_id AND id.identifier_type = (select patient_identifier_type_id
from patient_identifier_type
where name='OpenMRS ID')"|DWHStage|1|HtsClientTests|2|a6221aa6-0e85-11e8-ba89-0ed5f89f718b
ec3d7e32-bb10-11ea-b3de-0242ac130004|Hts Client Linkage|HTS|a6221860-0e85-11e8-ba89-0ed5f89f718b|"select distinct a.patient_id as PatientPK,
SC.value_reference AS SiteCode,
SN.name as FacilityName,
'KenyaEMR' as Emr,
'IRDO' AS Project,
id.identifier AS HtsNumber,
ref.date_to_enrol as DatePrefferedToBeEnrolled,
ref.facility_referred_to as FacilityReferredTo,
a.provider_handed_to as HandedOverTo,
NULL HandedOverToCadre,
a.facility_linked_to as EnrolledFacilityName,
ref.visit_date as ReferralDate,
a.enrollment_date as DateEnrolled,
a.ccc_number as ReportedCCCNumber,
a.art_start_date as ReportedStartARTDate
from (SELECT Distinct patient_id, encounter_id,ccc_number,enrollment_date,
art_start_date,provider_handed_to,facility_linked_to,encounter_location FROM
(SELECT DISTINCT htsrl.patient_id, encounter_id,ccc_number,enrollment_date,
art_start_date,provider_handed_to,facility_linked_to,encounter_location
FROM kenyaemr_etl.etl_hts_referral_and_linkage htsrl
UNION ALL
SELECT DISTINCT t.patient_id,t.encounter_id,unique_patient_no ccc_number,e.visit_date DateEnrolled,
ar.art_start_date,provider_handed_to,facility_linked_to,t.encounter_location
FROM kenyaemr_etl.etl_hts_test t
INNER JOIN kenyaemr_etl.etl_patient_demographics pt ON pt.patient_id=t.patient_id AND pt.voided=0
INNER JOIN kenyaemr_etl.etl_hiv_enrollment e ON e.patient_id=t.patient_id AND e.voided=0
LEFT JOIN kenyaemr_etl.etl_hts_referral_and_linkage l ON l.patient_id=t.patient_id
LEFT JOIN (SELECT patient_id,min(date_started) as art_start_date FROM kenyaemr_etl.etl_drug_event
group by patient_id)ar on ar.patient_id=t.patient_id
WHERE t.test_type = 1 AND t.final_test_result='Positive' AND t.voided=0 AND l.patient_id IS NULL)a
) a
left join kenyaemr_etl.etl_hts_referral ref on a.patient_id=ref.patient_id
LEFT JOIN location_attribute SC ON (SC.location_id = a.encounter_location or SC.location_id=ref.encounter_location ) AND SC.attribute_type_id=1
LEFT JOIN location SN ON (SN.location_id =a.encounter_location or SN.location_id =ref.encounter_location )
LEFT JOIN patient_identifier id ON (id.patient_id = a.patient_id or id.patient_id = ref.patient_id ) AND id.identifier_type = (select patient_identifier_type_id
from patient_identifier_type
where name='OpenMRS ID')
LEFT JOIN kenyaemr_etl.etl_hiv_enrollment EN ON EN.patient_id =a.patient_id
where a.patient_id in (select patient_id from kenyaemr_etl.etl_hts_test)"|DWHStage|1|HtsClientLinkage|3|a6221aa6-0e85-11e8-ba89-0ed5f89f718b
ec3d7e33-bb10-11ea-b3de-0242ac130004|Hts Test Kits|HTS|a6221860-0e85-11e8-ba89-0ed5f89f718b|"SELECT
    t.patient_id AS PatientPK,
	SC.value_reference AS SiteCode,
	SN.name as FacilityName,
	'KenyaEMR' as Emr,
	'IRDO' AS Project,
    id.identifier AS HtsNumber,
	t.encounter_id AS EncounterId,
	t.test_1_kit_name AS TestKitName1,
	t.test_1_kit_lot_no AS TestKitLotNumber1,
	t.test_1_kit_expiry as TestKitExpiry1,
	t.test_1_result as TestResult1,
	t.test_2_kit_name as TestKitName2,
	t.test_2_kit_lot_no as TestKitLotNumber2,
	t.test_2_kit_expiry as TestKitExpiry2,
	t.test_2_result as TestResult2

FROM
	kenyaemr_etl.etl_hts_test t
inner join
	kenyaemr_etl.etl_patient_demographics demographics on t.patient_id=demographics.patient_id
LEFT JOIN
	 location_attribute SC ON SC.location_id = t.encounter_location AND SC.attribute_type_id=1
LEFT JOIN
  location SN ON SN.location_id =t.encounter_location
LEFT JOIN patient_identifier id ON id.patient_id = t.patient_id AND id.identifier_type = (select patient_identifier_type_id
from patient_identifier_type
where name='OpenMRS ID')"|DWHStage|1|HtsTestKits|4|a6221aa6-0e85-11e8-ba89-0ed5f89f718b
ec3d7e34-bb10-11ea-b3de-0242ac130004|Hts Client Tracing|HTS|a6221860-0e85-11e8-ba89-0ed5f89f718b|"SELECT
	ht.patient_id as PatientPK,
	SC.value_reference AS SiteCode,
	htsrl.tracing_type as TracingType,
	htsrl.visit_date as TracingDate,
	SN.name as FacilityName,
	'KenyaEMR' as Emr,
	'IRDO' AS Project,
	id.identifier AS HtsNumber,
	htsrl.tracing_status as TracingOutcome
FROM
	kenyaemr_etl.etl_hts_test ht
INNER JOIN
	kenyaemr_etl.etl_hts_test t ON ht.patient_id=t.patient_id
LEFT  JOIN
	kenyaemr_etl.etl_hts_referral_and_linkage htsrl  ON ht.patient_id=htsrl.patient_id
LEFT JOIN
  location SN ON SN.location_id =htsrl.encounter_location
LEFT JOIN
	 location_attribute SC ON SC.location_id = htsrl.encounter_location AND SC.attribute_type_id=1
LEFT JOIN
 patient_identifier id ON id.patient_id = htsrl.patient_id AND id.identifier_type = (select patient_identifier_type_id
from patient_identifier_type
where name='OpenMRS ID')
 WHERE SC.value_reference IS NOT NULL"|DWHStage|1|HtsClientTracing|5|a6221aa6-0e85-11e8-ba89-0ed5f89f718b
ec3d7e35-bb10-11ea-b3de-0242ac130004|Hts Partner Tracing|HTS|a6221860-0e85-11e8-ba89-0ed5f89f718b|"select distinct
t.patient_id as PatientPK,
id.identifier as HtsNumber,
client_id as PartnerPersonId,
contact_type as TraceType,
encounter_date as TraceDate,
SN.name as FacilityName,
'KenyaEMR' as Emr,
'IRDO' AS Project,
SC.value_reference AS SiteCode,
status as TraceOutcome,
tc.appointment_date as BookingDate
from
	kenyaemr_hiv_testing_patient_contact pc
inner join
	kenyaemr_etl.etl_hts_test t on pc.patient_related_to=t.patient_id
inner join
	kenyaemr_hiv_testing_client_trace tc on pc.id=tc.client_id
LEFT JOIN
	patient_identifier id ON id.patient_id = t.patient_id AND id.identifier_type = (select patient_identifier_type_id
	from patient_identifier_type where name='OpenMRS ID')
LEFT JOIN
	 location_attribute SC ON SC.location_id = t.encounter_location AND SC.attribute_type_id=1
LEFT JOIN
	location SN ON SN.location_id =t.encounter_location;" |DWHStage|1|HtsPartnerTracing|6|a6221aa6-0e85-11e8-ba89-0ed5f89f718b
ec3d7e36-bb10-11ea-b3de-0242ac130004|Hts Partner Notification Services|HTS|a6221860-0e85-11e8-ba89-0ed5f89f718b|"SELECT
DISTINCT
               t.patient_id AS PatientPK,
               SC.value_reference AS SiteCode,
               SN.name as FacilityName,
               'KenyaEMR' as Emr,
               'IRDO' AS Project,
               id.identifier AS HtsNumber,
               ohpc.patient_id AS PartnerPatientPk,
               ohpc.id AS PartnerPersonId,
    YEAR(ohpc.date_created)-YEAR(ohpc.birth_date)  AS Age,
               ohpc.sex,
               CASE ohpc.relationship_type
                                              WHEN 970          THEN  'parent (Mother)'
                                              WHEN 971           THEN  'parent(Father)'
                                              WHEN 972          THEN  'sibling'
                                              WHEN 1528        THEN  'Child'
                                              WHEN 5617          THEN  'spouse'
            WHEN 163565  THEN  'partner'
                                              WHEN 162221  THEN  'cowife'
               END     AS RelationsipToIndexClient,

    /*Screened for IPV? CASE?*/
               CASE WHEN ohpc.ipv_outcome IS NOT NUll THEN 'Yes' ELSE 'No' END AS  ScreenedForIpv,

               ohpc.ipv_outcome AS IpvScreeningOutcome,
               CASE ohpc.living_with_patient
                               WHEN 1065 THEN 'Yes'
                               WHEN 1066 THEN 'No'
               END AS CurrentlyLivingWithIndexClient,
    /*knowledgeof HIV Status*/
    ohpc.baseline_hiv_status as KnowledgeOfHivStatus,

pnsApprocah.name AS  PnsApproach,
ohpc.consented_contact_listing as  PnsConsent,
case when ctrace.status is null then 'N' else 'Y' end as LinkedToCare,
ctrace.encounter_date as  LinkDateLinkedToCare,
ctrace.unique_patient_no as CccNumber,
ctrace.facility_linked_to as FacilityLinkedTo,
ohpc.birth_date as DoB,
ohpc.date_created as DateElicited ,
marital.name as  MaritalStatus


  FROM
               kenyaemr_etl.etl_hts_test t
INNER JOIN
        kenyaemr_hiv_testing_patient_contact ohpc ON ohpc.patient_related_to=t.patient_id
LEFT JOIN
                location_attribute SC ON SC.location_id = t.encounter_location AND SC.attribute_type_id=1
LEFT JOIN
  location SN ON SN.location_id =t.encounter_location
  LEFT JOIN
               patient_identifier id ON id.patient_id = t.patient_id AND id.identifier_type = (select patient_identifier_type_id
from patient_identifier_type
where name='OpenMRS ID')
left JOIN patient openmrs ON  openmrs.patient_id = id.patient_id
left JOIN kenyaemr_hiv_testing_client_trace ctrace ON  ctrace.client_id = ohpc.id and ctrace.status='Contacted and Linked'
left join concept_name marital ON marital.concept_id = ohpc.marital_status and marital.locale='en' and marital.concept_name_type = 'FULLY_SPECIFIED'
left join concept_name pnsApprocah ON pnsApprocah.concept_id = ohpc.pns_approach and pnsApprocah.locale='en' and pnsApprocah.concept_name_type = 'FULLY_SPECIFIED'
 "|DWHStage|1|HtsPartnerNotificationServices|7|a6221aa6-0e85-11e8-ba89-0ed5f89f718b
ec3d7e40-bb10-11ea-b3de-0242ac130004|Migration|MGS|a6221860-0e85-11e8-ba89-0ed5f89f718b|"SELECT ID as MetricId,Dataset,Metric,MetricValue,Stage,SiteCode,Emr,FacilityName,'KenyaHMIS' as Project,CreateDate FROM DWAPI_Migration_Metrics"|MgsStage|1|MetricMigrationExtract|1|a6221aa6-0e85-11e8-ba89-0ed5f89f718b

ec3d7e41-bb10-11ea-b3de-0242ac130004|Indicators|MTS|a6221856-0e85-11e8-ba89-0ed5f89f718b|"select INDICATOR,CONVERT(INDICATORVALUE USING utf8) as 'INDICATORVALUE',INDICATORDATE, SiteCode from (
(
      select 'TX_CURR'                                                                   AS 'INDICATOR',
             count(distinct t.patient_id)                                                as 'INDICATORVALUE',
             date_format(last_day(date_sub(current_date(), interval 1 MONTH)), '%Y%b%d') as 'INDICATORDATE',
             def.siteCode SiteCode
      from(
          select fup.visit_date,fup.patient_id, max(e.visit_date) as enroll_date,
                 greatest(max(e.visit_date), ifnull(max(date(e.transfer_in_date)),'0000-00-00')) as latest_enrolment_date,
                 greatest(max(fup.visit_date), ifnull(max(d.visit_date),'0000-00-00')) as latest_vis_date,
                 greatest(mid(max(concat(fup.visit_date,fup.next_appointment_date)),11), ifnull(max(d.visit_date),'0000-00-00')) as latest_tca,
                 d.patient_id as disc_patient,
                 d.effective_disc_date as effective_disc_date,
                 max(d.visit_date) as date_discontinued,
                 de.patient_id as started_on_drugs
          from dwapi_etl.etl_patient_hiv_followup fup
                 join dwapi_etl.etl_patient_demographics p on p.patient_id=fup.patient_id
                 join dwapi_etl.etl_hiv_enrollment e on fup.patient_id=e.patient_id
                 left outer join dwapi_etl.etl_drug_event de on e.patient_id = de.patient_id and de.program='HIV' and date(date_started) <= date(date(last_day(date_sub(current_date(),interval 1 MONTH))))
                 left outer JOIN
                   (select patient_id, coalesce(date(effective_discontinuation_date),visit_date) visit_date,max(date(effective_discontinuation_date)) as effective_disc_date from dwapi_etl.etl_patient_program_discontinuation
                    where date(visit_date) <= date(date(last_day(date_sub(current_date(),interval 1 MONTH))))
                      and program_name='HIV' and patient_id
                    group by patient_id
                   ) d on d.patient_id = fup.patient_id
          where fup.visit_date <= date(date(last_day(date_sub(current_date(),interval 1 MONTH))))
          group by patient_id
          having (started_on_drugs is not null and started_on_drugs <> '')
             and
                 (
                     ((timestampdiff(DAY,date(latest_tca),date(date(last_day(date_sub(current_date(),interval 1 MONTH))))) <= 30 or timestampdiff(DAY,date(latest_tca),date(curdate())) <= 30) and
                      ((date(d.effective_disc_date) > date(date(last_day(date_sub(current_date(),interval 1 MONTH)))) or date(enroll_date) > date(d.effective_disc_date)) or d.effective_disc_date is null))
                       and
                     (date(latest_vis_date) >= date(date_discontinued) or date(latest_tca) >= date(date_discontinued) or disc_patient is null)
                     )
          )t
            join kenyaemr_etl.etl_default_facility_info def
)
UNION
(
  select 'TX_NEW' as INDICATOR,count(net.patient_id) as INDICATORVALUE,date_format(last_day(date_sub(current_date(),interval 1 MONTH)),'%Y%b%d') as 'INDICATORDATE',
  def.siteCode SiteCode
  from (
           select e.patient_id,e.date_started,
                  d.visit_date as dis_date,
                  if(d.visit_date is not null, 1, 0) as TOut,
                  e.regimen, e.regimen_line, e.alternative_regimen,
                  mid(max(concat(fup.visit_date,fup.next_appointment_date)),11) as latest_tca,
                  max(if(enr.date_started_art_at_transferring_facility is not null and enr.facility_transferred_from is not null, 1, 0)) as TI_on_art,
                  max(if(enr.transfer_in_date is not null, 1, 0)) as TIn,
                  max(fup.visit_date) as latest_vis_date
           from (select e.patient_id, min(e.date_started) as date_started,
                        mid(min(concat(e.date_started,e.regimen_name)),11) as regimen,
                        mid(min(concat(e.date_started,e.regimen_line)),11) as regimen_line,
                        max(if(discontinued,1,0))as alternative_regimen
                 from kenyaemr_etl.etl_drug_event e
                          join kenyaemr_etl.etl_patient_demographics p on p.patient_id=e.patient_id
                 where e.program = 'HIV'
                 group by e.patient_id) e
                    left outer join kenyaemr_etl.etl_patient_program_discontinuation d on d.patient_id=e.patient_id
                    left outer join kenyaemr_etl.etl_hiv_enrollment enr on enr.patient_id=e.patient_id
                    left outer join kenyaemr_etl.etl_patient_hiv_followup fup on fup.patient_id=e.patient_id
           where date(e.date_started) between DATE_ADD(DATE_SUB(current_date(),INTERVAL DAYOFMONTH(current_date())-1 DAY),INTERVAL -1 MONTH) and date(last_day(date_sub(current_date(),interval 1 MONTH)))
           group by e.patient_id
           having TI_on_art=0
       )net
         join kenyaemr_etl.etl_default_facility_info def
)
UNION
(
  select 'HTS_TESTED'                                                                as 'INDICATOR',
         count(distinct t.patient_id)                                                AS INDICATOR_VALUE,
         date_format(last_day(date_sub(current_date(), interval 1 MONTH)), '%Y%b%d') as 'INDICATOR_DATE',
         def.siteCode SiteCode
  from dwapi_etl.etl_hts_test t
           inner join dwapi_etl.etl_patient_demographics d on d.patient_id = t.patient_id
             join kenyaemr_etl.etl_default_facility_info def
  where test_type = 1
    and t.voided = 0
    and t.visit_date between DATE_ADD(DATE_SUB(current_date(), INTERVAL DAYOFMONTH(current_date()) - 1 DAY), INTERVAL -1
                                      MONTH)
      and date(last_day(date_sub(current_date(), interval 1 MONTH)))
)
UNION
(
      select 'HTS_TESTED_POS'                                                               AS 'INDICATOR',
             count(distinct t.patient_id)                                                as 'INDICATOR_VALUE',
             date_format(last_day(date_sub(current_date(), interval 1 MONTH)), '%Y%b%d') as 'INDICATOR_DATE',
             def.siteCode SiteCode
      from dwapi_etl.etl_hts_test t
               inner join dwapi_etl.etl_patient_demographics d on d.patient_id = t.patient_id
                 join kenyaemr_etl.etl_default_facility_info def
      where t.voided = 0
        and date(t.visit_date) between DATE_ADD(DATE_SUB(current_date(), INTERVAL DAYOFMONTH(current_date()) - 1 DAY),
                                                INTERVAL -1
                                                MONTH) and date(last_day(date_sub(current_date(), interval 1 MONTH)))
        and t.test_type = 1
        and t.patient_given_result = 'Yes'
        and t.final_test_result = 'Positive'
)
UNION
(
  select 'HTS_LINKED'                                                                AS 'INDICATOR',
         count(distinct t.patient_id)                                                as 'INDICATOR_VALUE',
         date_format(last_day(date_sub(current_date(), interval 1 MONTH)), '%Y%b%d') as 'INDICATOR_DATE',
         def.siteCode SiteCode
  from dwapi_etl.etl_hts_referral_and_linkage r
           inner join dwapi_etl.etl_hts_test t on r.patient_id = t.patient_id and t.final_test_result = 'Positive'
             join kenyaemr_etl.etl_default_facility_info def
  where (r.ccc_number != '' or r.ccc_number IS NOT NULL)
    and (r.facility_linked_to != '' or r.facility_linked_to IS NOT NULL)
    and t.visit_date between DATE_ADD(DATE_SUB(current_date(), INTERVAL DAYOFMONTH(current_date()) - 1 DAY), INTERVAL -1
                                      MONTH) and date(last_day(date_sub(current_date(), interval 1 MONTH)))
)
UNION
(
  select  'RETENTION_ON_ART_12_MONTHS' as 'INDICATOR',count(net.patient_id) AS INDICATOR_VALUE,date_format(last_day(date_sub(current_date(),interval 1 MONTH)),'%Y%b%d') as 'INDICATOR_DATE',
  def.siteCode SiteCode
  from (select e.patient_id,
               e.date_started,
               d.visit_date                                                                      as dis_date,
               if(d.visit_date is not null and d.discontinuation_reason = 159492, 1, 0)          as TOut,
               d.date_died,
               mid(max(concat(fup.visit_date, fup.next_appointment_date)), 11)                   as latest_tca,
               if(enr.transfer_in_date is not null, 1, 0)                                        as TIn,
               max(fup.visit_date)                                                               as latest_vis_date,
               DATE_SUB(date(last_day(date_sub(current_date(), interval 1 MONTH))), INTERVAL
                        day(date(last_day(date_sub(current_date(), interval 1 MONTH)))) - 1
                        DAY)                                                                     as first_day_of_prev_month,
               date(last_day(date_sub(current_date(), interval 1 MONTH)))                        as last_day_of_prev_month,
               DATE_ADD(DATE_SUB(date(last_day(date_sub(current_date(), interval 1 MONTH))), INTERVAL
                                 day(date(last_day(date_sub(current_date(), interval 1 MONTH)))) - 1 DAY), INTERVAL -12
                        MONTH)                                                                   as cohort_start_date,
               date(last_day(DATE_ADD(DATE_SUB(date(last_day(date_sub(current_date(), interval 1 MONTH))), INTERVAL
                                               day(date(last_day(date_sub(current_date(), interval 1 MONTH)))) - 1 DAY),
                                      INTERVAL -12 MONTH)))                                      as cohort_end_date
        from (select e.patient_id, p.dob, p.Gender, min(e.date_started) as date_started
              from dwapi_etl.etl_drug_event e
                       join dwapi_etl.etl_patient_demographics p on p.patient_id = e.patient_id
              where e.program = 'HIV'
              group by e.patient_id) e
                 left outer join dwapi_etl.etl_patient_program_discontinuation d on d.patient_id = e.patient_id and
                                                                                    d.program_uuid =
                                                                                    '2bdada65-4c72-4a48-8730-859890e25cee'
                 left outer join dwapi_etl.etl_hiv_enrollment enr on enr.patient_id = e.patient_id
                 left outer join dwapi_etl.etl_patient_hiv_followup fup on fup.patient_id = e.patient_id
        where date(e.date_started) between DATE_ADD(
                DATE_SUB(date(last_day(date_sub(current_date(), interval 1 MONTH))), INTERVAL
                         day(date(last_day(date_sub(current_date(), interval 1 MONTH)))) - 1 DAY), INTERVAL -12 MONTH) and
                  date(last_day(DATE_ADD(DATE_SUB(date(last_day(date_sub(current_date(), interval 1 MONTH))), INTERVAL
                                                  day(date(last_day(date_sub(current_date(), interval 1 MONTH)))) - 1
                                                  DAY), INTERVAL -12 MONTH)))
        group by e.patient_id
        having (dis_date > date(last_day(date_sub(current_date(), interval 1 MONTH))) or dis_date is null or TOut = 0)
           and (
                (date(latest_tca) > date(last_day(date_sub(current_date(), interval 1 MONTH))) and
                 (date(latest_tca) > date(dis_date) or dis_date is null)) or
                (((date(latest_tca) between DATE_ADD(
                        DATE_SUB(current_date(), INTERVAL DAYOFMONTH(current_date()) - 1 DAY), INTERVAL -1
                        MONTH) and date(last_day(date_sub(current_date(), interval 1 MONTH)))) and
                  (date(latest_tca) >= date(latest_vis_date)))) or
                (((date(latest_tca) between DATE_ADD(
                        DATE_SUB(current_date(), INTERVAL DAYOFMONTH(current_date()) - 1 DAY), INTERVAL -1
                        MONTH) and date(last_day(date_sub(current_date(), interval 1 MONTH)))) and
                  (date(latest_vis_date) >= date(latest_tca)) or date(latest_tca) > curdate())) and
                (date(latest_tca) > date(dis_date) or dis_date is null)
            )) net
              join kenyaemr_etl.etl_default_facility_info def
)
UNION
(
  select  'RETENTION_ON_ART_VL_1000_12_MONTHS' as 'INDICATOR',count(net.patient_id) AS INDICATOR_VALUE,date_format(last_day(date_sub(current_date(),interval 1 MONTH)),'%Y%b%d') as 'INDICATOR_DATE',
  def.siteCode SiteCode
  from (select e.patient_id,
               e.date_started,
               d.visit_date                                                                      as dis_date,
               if(d.visit_date is not null and d.discontinuation_reason = 159492, 1, 0)          as TOut,
               d.date_died,
               mid(max(concat(fup.visit_date, fup.next_appointment_date)), 11)                   as latest_tca,
               if(enr.transfer_in_date is not null, 1, 0)                                        as TIn,
               max(fup.visit_date)                                                               as latest_vis_date,
               DATE_SUB(date(last_day(date_sub(current_date(), interval 1 MONTH))), INTERVAL
                        day(date(last_day(date_sub(current_date(), interval 1 MONTH)))) - 1
                        DAY)                                                                     as first_day_of_prev_month,
               DATE_ADD(DATE_SUB(date(last_day(date_sub(current_date(), interval 1 MONTH))), INTERVAL
                                 day(date(last_day(date_sub(current_date(), interval 1 MONTH)))) - 1 DAY), INTERVAL -12
                        MONTH)                                                                   as cohort_start_date,
               date(last_day(DATE_ADD(DATE_SUB(date(last_day(date_sub(current_date(), interval 1 MONTH))), INTERVAL
                                               day(date(last_day(date_sub(current_date(), interval 1 MONTH)))) - 1 DAY),
                                      INTERVAL -12 MONTH)))                                      as cohort_end_date
        from (select e.patient_id, p.dob, p.Gender, min(e.date_started) as date_started
              from dwapi_etl.etl_drug_event e
                       join dwapi_etl.etl_patient_demographics p on p.patient_id = e.patient_id
              where e.program = 'HIV'
              group by e.patient_id) e
                 left outer join dwapi_etl.etl_patient_program_discontinuation d on d.patient_id = e.patient_id and
                                                                                    d.program_uuid =
                                                                                    '2bdada65-4c72-4a48-8730-859890e25cee'
                 left outer join dwapi_etl.etl_hiv_enrollment enr on enr.patient_id = e.patient_id
                 left outer join dwapi_etl.etl_patient_hiv_followup fup on fup.patient_id = e.patient_id
                 inner join(select patient_id,
                                   max(visit_date)                                                                      as vl_date,
                                   if(mid(max(concat(visit_date, lab_test)), 11) = 856,
                                      mid(max(concat(visit_date, test_result)), 11), if(
                                                      mid(max(concat(visit_date, lab_test)), 11) = 1305 and
                                                      mid(max(concat(visit_date, test_result)), 11) = 1302, 'LDL',
                                                      ''))                                                              as vl_result,
                                   mid(max(concat(visit_date, urgency)), 11)                                            as urgency,
                                   DATE_ADD(DATE_SUB(date(last_day(date_sub(current_date(), interval 1 MONTH))), INTERVAL
                                                     day(date(last_day(date_sub(current_date(), interval 1 MONTH)))) - 1
                                                     DAY), INTERVAL -12 MONTH),
                                   date(date(last_day(date_sub(current_date(), interval 1 MONTH))))
                            from dwapi_etl.etl_laboratory_extract
                            where lab_test in (1305, 856)
                              and visit_date between DATE_ADD(
                                    DATE_SUB(date(last_day(date_sub(current_date(), interval 1 MONTH))), INTERVAL
                                             day(date(last_day(date_sub(current_date(), interval 1 MONTH)))) - 1 DAY),
                                    INTERVAL -12 MONTH)
                                and date(date(last_day(date_sub(current_date(), interval 1 MONTH))))
                            group by patient_id
                            having mid(max(concat(visit_date, test_result)), 11) is not null
                                or mid(max(concat(visit_date, test_result)), 11) <> '') vl on e.patient_id = vl.patient_id
        where date(e.date_started) between DATE_ADD(
                DATE_SUB(date(last_day(date_sub(current_date(), interval 1 MONTH))), INTERVAL
                         day(date(last_day(date_sub(current_date(), interval 1 MONTH)))) - 1 DAY), INTERVAL -12 MONTH) and
            date(last_day(DATE_ADD(DATE_SUB(date(last_day(date_sub(current_date(), interval 1 MONTH))), INTERVAL
                                            day(date(last_day(date_sub(current_date(), interval 1 MONTH)))) - 1 DAY),
                                   INTERVAL -12 MONTH)))
          and (vl.vl_result < 1000 or vl.vl_result = 'LDL')
        group by e.patient_id
        having (dis_date > date(last_day(date_sub(current_date(), interval 1 MONTH))) or dis_date is null or TOut = 0)
           and (
                (date(latest_tca) > date(last_day(date_sub(current_date(), interval 1 MONTH))) and
                 (date(latest_tca) > date(dis_date) or dis_date is null)) or
                (((date(latest_tca) between DATE_ADD(
                        DATE_SUB(current_date(), INTERVAL DAYOFMONTH(current_date()) - 1 DAY), INTERVAL -1
                        MONTH) and date(last_day(date_sub(current_date(), interval 1 MONTH)))) and
                  (date(latest_tca) >= date(latest_vis_date)))) or
                (((date(latest_tca) between DATE_ADD(
                        DATE_SUB(current_date(), INTERVAL DAYOFMONTH(current_date()) - 1 DAY), INTERVAL -1
                        MONTH) and date(last_day(date_sub(current_date(), interval 1 MONTH)))) and
                  (date(latest_vis_date) >= date(latest_tca)) or date(latest_tca) > curdate())) and
                (date(latest_tca) > date(dis_date) or dis_date is null)
            )) net
              join kenyaemr_etl.etl_default_facility_info def

)
UNION
(
select 'MMD' AS 'INDICATOR', -99 as 'INDICATORVALUE',date_format(current_date(),'%Y%b%d') as 'INDICATORDATE', def.siteCode SiteCode
  from kenyaemr_etl.etl_default_facility_info def
)
UNION
(
      select 'HTS_INDEX'                                                                 AS 'INDICATOR',
             count(distinct a.patient_id)                                                as 'INDICATOR_VALUE',
             date_format(last_day(date_sub(current_date(), interval 1 MONTH)), '%Y%b%d') as 'INDICATOR_DATE',
             def.siteCode SiteCode
      from (select hts.patient_id,
                   hts.final_test_result,
                   hts.visit_date,
                   hts.test_type,
                   pc.patient_id as contact,
                   r.person_a,
                   r.person_b
            from (select hts.patient_id, hts.final_test_result, hts.visit_date, hts.test_type
                  from dwapi_etl.etl_hts_test hts
                  where hts.test_strategy = 161557
                    and hts.patient_given_result = 'Yes'
                    and hts.voided = 0
                    and hts.visit_date
                      between DATE_SUB(date(last_day(date_sub(current_date(), interval 1 MONTH))), INTERVAL
                                       day(date(last_day(date_sub(current_date(), interval 1 MONTH)))) - 1 DAY)
                      and date(last_day(date_sub(current_date(), interval 1 MONTH)))
                  group by hts.patient_id) hts
                     left JOIN
                 (select patient_id, id
                  from dwapi_etl.etl_patient_contact c
                  where (c.relationship_type in (971, 972, 1528, 162221, 163565, 970, 5617))
                    and c.patient_id is not NULL
                    and c.voided = 0
                  group by c.patient_id) pc on hts.patient_id = pc.patient_id
                     left join (select r.person_a, r.person_b
                                from openmrs.relationship r
                                         inner join openmrs.relationship_type t
                                                    on r.relationship = t.relationship_type_id and t.uuid in
                                                                                                   ('8d91a01c-c2cc-11de-8d13-0010c6dffd0f',
                                                                                                    '8d91a210-c2cc-11de-8d13-0010c6dffd0f',
                                                                                                    'd6895098-5d8d-11e3-94ee-b35a4132a5e3',
                                                                                                    '007b765f-6725-4ae9-afee-9966302bace4',
                                                                                                    '2ac0d501-eadc-4624-b982-563c70035d46'
                                                                                                       )) r
                               on hts.patient_id = r.person_a or hts.patient_id = r.person_b
            where r.person_a is not null
               or pc.patient_id
               or r.person_b is not null is not null) a
                 join kenyaemr_etl.etl_default_facility_info def
)
UNION
(
      select 'TX_PVLS'                                                                   AS 'INDICATOR',
             count(distinct a.patient_id)                                                as 'INDICATOR_VALUE',
             date_format(last_day(date_sub(current_date(), interval 1 MONTH)), '%Y%b%d') as 'INDICATOR_DATE',
             def.siteCode SiteCode
                     from(select t.patient_id,vl.vl_date,vl.vl_result,vl.urgency from (
                                    select fup.visit_date,fup.patient_id, max(e.visit_date) as enroll_date,
                                           greatest(max(e.visit_date), ifnull(max(date(e.transfer_in_date)),'0000-00-00')) as latest_enrolment_date,
                                           greatest(max(fup.visit_date), ifnull(max(d.visit_date),'0000-00-00')) as latest_vis_date,
                                           greatest(mid(max(concat(fup.visit_date,fup.next_appointment_date)),11), ifnull(max(d.visit_date),'0000-00-00')) as latest_tca,
                                           d.patient_id as disc_patient,
                                           d.effective_disc_date as effective_disc_date,
                                           max(d.visit_date) as date_discontinued,
                                           de.patient_id as started_on_drugs,
                                           de.date_started
                                    from dwapi_etl.etl_patient_hiv_followup fup
                                           join dwapi_etl.etl_patient_demographics p on p.patient_id=fup.patient_id
                                           join dwapi_etl.etl_hiv_enrollment e on fup.patient_id=e.patient_id
                                           left outer join dwapi_etl.etl_drug_event de on e.patient_id = de.patient_id and de.program='HIV' and date(date_started) <= date(last_day(date_sub(current_date(), interval 1 MONTH)))
                                           left outer JOIN
                                             (select patient_id, coalesce(date(effective_discontinuation_date),visit_date) visit_date,max(date(effective_discontinuation_date)) as effective_disc_date from dwapi_etl.etl_patient_program_discontinuation
                                              where date(visit_date) <= date(last_day(date_sub(current_date(), interval 1 MONTH))) and program_name='HIV'
                                              group by patient_id
                                             ) d on d.patient_id = fup.patient_id
                                    where fup.visit_date <= date(last_day(date_sub(current_date(), interval 1 MONTH)))
                                    group by patient_id
                                    having (started_on_drugs is not null and started_on_drugs <> '') and (
                                        (
                                            ((timestampdiff(DAY,date(latest_tca),date(last_day(date_sub(current_date(), interval 1 MONTH)))) <= 30 or timestampdiff(DAY,date(latest_tca),date(curdate())) <= 30) and ((date(d.effective_disc_date) > date(last_day(date_sub(current_date(), interval 1 MONTH))) or date(enroll_date) > date(d.effective_disc_date)) or d.effective_disc_date is null))
                                              and (date(latest_vis_date) >= date(date_discontinued) or date(latest_tca) >= date(date_discontinued) or disc_patient is null)
                                            )
                                        ) order by date_started desc
                                    ) t
                                      inner join (
                                                 select
                                                        b.patient_id,
                                                        max(b.visit_date) as vl_date,
                                                        date_sub(date(last_day(date_sub(current_date(), interval 1 MONTH))) , interval 12 MONTH),
                                                        mid(max(concat(b.visit_date,b.lab_test)),11) as lab_test,
                                                        if(mid(max(concat(b.visit_date,b.lab_test)),11) = 856, mid(max(concat(b.visit_date,b.test_result)),11), if(mid(max(concat(b.visit_date,b.lab_test)),11)=1305 and mid(max(concat(visit_date,test_result)),11) = 1302, 'LDL','')) as vl_result,
                                                        mid(max(concat(b.visit_date,b.urgency)),11) as urgency
                                                 from (select x.patient_id as patient_id,x.visit_date as visit_date,x.lab_test as lab_test, x.test_result as test_result,urgency as urgency
                                                       from dwapi_etl.etl_laboratory_extract x where x.lab_test in (1305,856)
                                                       group by x.patient_id,x.visit_date order by visit_date desc)b
                                                 group by patient_id
                                                 having max(visit_date) between
                                                            date_sub(date(last_day(date_sub(current_date(), interval 1 MONTH))), interval 12
                                                                     MONTH) and date(last_day(date_sub(current_date(), interval 1 MONTH)))
                                                 )vl
                                        on t.patient_id = vl.patient_id  where (vl_result < 1000 or vl_result='LDL'))a
                                          join kenyaemr_etl.etl_default_facility_info def
)
UNION
(
      select 'HTS_INDEX_POS'                                                             AS 'INDICATOR',
             count(distinct a.patient_id)                                                as 'INDICATOR_VALUE',
             date_format(last_day(date_sub(current_date(), interval 1 MONTH)), '%Y%b%d') as 'INDICATOR_DATE',
             def.siteCode SiteCode
      from (select hts.patient_id,
                   hts.final_test_result,
                   hts.visit_date,
                   hts.test_type,
                   pc.patient_id as contact,
                   r.person_a,
                   r.person_b
            from (select hts.patient_id, hts.final_test_result, hts.visit_date, hts.test_type
                  from dwapi_etl.etl_hts_test hts
                  where hts.test_strategy = 161557
                    and hts.final_test_result = 'Positive'
                    and hts.patient_given_result = 'Yes'
                    and hts.patient_given_result = 'Yes'
                    and hts.voided = 0
                    and hts.visit_date
                      between DATE_SUB(date(last_day(date_sub(current_date(), interval 1 MONTH))), INTERVAL
                                       day(date(last_day(date_sub(current_date(), interval 1 MONTH)))) - 1 DAY)
                      and date(last_day(date_sub(current_date(), interval 1 MONTH)))
                  group by hts.patient_id) hts
                     left JOIN
                 (select patient_id, id
                  from dwapi_etl.etl_patient_contact c
                  where (c.relationship_type in (971, 972, 1528, 162221, 163565, 970, 5617))
                    and c.patient_id is not NULL
                    and c.voided = 0
                  group by c.patient_id) pc on hts.patient_id = pc.patient_id
                     left join (select r.person_a, r.person_b
                                from openmrs.relationship r
                                         inner join openmrs.relationship_type t
                                                    on r.relationship = t.relationship_type_id and t.uuid in
                                                                                                   ('8d91a01c-c2cc-11de-8d13-0010c6dffd0f',
                                                                                                    '8d91a210-c2cc-11de-8d13-0010c6dffd0f',
                                                                                                    'd6895098-5d8d-11e3-94ee-b35a4132a5e3',
                                                                                                    '007b765f-6725-4ae9-afee-9966302bace4',
                                                                                                    '2ac0d501-eadc-4624-b982-563c70035d46'
                                                                                                       )) r
                               on hts.patient_id = r.person_a or hts.patient_id = r.person_b
            where r.person_a is not null
               or pc.patient_id
               or r.person_b is not null is not null) a
                 join kenyaemr_etl.etl_default_facility_info def
)
UNION
(
        select 'TX_RTT' AS 'INDICATOR', -99 as 'INDICATORVALUE',date_format(current_date(),'%Y%b%d') as 'INDICATORDATE',def.siteCode SiteCode
            from kenyaemr_etl.etl_default_facility_info def
)
UNION
(
    select 'TX_ML' AS 'INDICATOR', -99 as 'INDICATORVALUE',date_format(current_date(),'%Y%b%d') as 'INDICATORDATE', def.siteCode SiteCode
    from kenyaemr_etl.etl_default_facility_info def
)
UNION
(
        select 'LAST_ENCOUNTER_CREATE_DATE' AS 'INDICATOR', max(e.date_created) as 'INDICATORVALUE',date_format(current_date(),'%Y%b%d') as 'INDICATORDATE',
          def.siteCode SiteCode
        from openmrs.encounter e
            join kenyaemr_etl.etl_default_facility_info def
)
UNION
(
        select 'MFL_CODE' as 'INDICATOR',CONCAT(li.value_reference,' | ',l.name)   as 'INDICATORVALUE', date_format(min(pi.date_created),'%Y%b%d') as 'INDICATORDATE',
          def.siteCode SiteCode
        from openmrs.patient_identifier pi inner join openmrs.location_attribute li on pi.location_id = li.location_id left join location l on pi.location_id=l.location_id
          join kenyaemr_etl.etl_default_facility_info def
          where pi.voided=0
        group by li.value_reference
)
UNION
(
        select 'SITECODE' as 'INDICATOR', li.value_reference   as 'INDICATORVALUE', date_format(min(pi.date_created),'%Y%b%d') as 'INDICATORDATE',
          def.siteCode SiteCode
        from openmrs.patient_identifier pi inner join openmrs.location_attribute li on pi.location_id = li.location_id left join location l on pi.location_id=l.location_id
          join kenyaemr_etl.etl_default_facility_info def
          where pi.voided=0
        group by li.value_reference
)
UNION
(
        select 'SITENAME' as 'INDICATOR', l.name   as 'INDICATORVALUE', date_format(min(pi.date_created),'%Y%b%d') as 'INDICATORDATE',
          def.siteCode SiteCode
        from openmrs.patient_identifier pi inner join openmrs.location_attribute li on pi.location_id = li.location_id left join location l on pi.location_id=l.location_id
          join kenyaemr_etl.etl_default_facility_info def
          where pi.voided=0
        group by li.value_reference
)
UNION
(
  SELECT 'EMR_ETL_Refresh' as 'INDICATORNAME',
         stop_time                        as 'INDICATORVALUE',
         DATE_FORMAT(stop_time, '%Y%b%d') as 'INDICATORMONTH',
         def.siteCode SiteCode
  FROM kenyaemr_etl.etl_script_status s
  join kenyaemr_etl.etl_default_facility_info def
  where s.error is null
    and script_name = 'population_of_dwapi_tables'
  order by INDICATORVALUE desc
  limit 1
)
UNION(
        select 'DB_STATE' as INDICATOR,
        if(c.current_visits > floor(c.avg_visits/2), 'DATA_ALIGNED', 'MISALIGNED') as INDICATORVALUE,
        date_format(last_day(date_sub(current_date(), interval 1 MONTH)), '%Y%b%d') as INDICATORDATE,
        def.siteCode SiteCode
        from (select a.current_visits, b.avg_visits, b.followup_enc_since_April, b.months_since_april
        from (select count(hv.encounter_id) as current_visits
        from kenyaemr_etl.etl_patient_hiv_followup hv
        where hv.visit_date between DATE_SUB(date(last_day(date_sub(current_date(), interval 1 MONTH))), INTERVAL
        day(date(last_day(date_sub(current_date(), interval 1 MONTH)))) - 1 DAY) and date(date(last_day(date_sub(current_date(),interval 1 MONTH)))) ) a
        join
        (select count(hv.encounter_id) as followup_enc_since_April,
        timestampdiff(MONTH, '2022-04-01', DATE_SUB(date(last_day(date_sub(current_date(), interval 1 MONTH))), INTERVAL
        day(date(last_day(date_sub(current_date(), interval 1 MONTH)))) - 1 DAY) )  months_since_april,
        floor(count(hv.encounter_id) /
        (timestampdiff(MONTH, '2022-04-01', DATE_SUB(date(last_day(date_sub(current_date(), interval 1 MONTH))), INTERVAL
        day(date(last_day(date_sub(current_date(), interval 1 MONTH)))) - 1 DAY) ) +
        1)) as avg_visits,
        last_day(date_sub(CURRENT_DATE, interval 1 MONTH))
        from kenyaemr_etl.etl_patient_hiv_followup hv
        where hv.visit_date between '2022-04-01' and
        DATE_SUB(date(last_day(date_sub(current_date(), interval 1 MONTH))), INTERVAL
        day(date(last_day(date_sub(current_date(), interval 1 MONTH)))) - 1 DAY) ) b) c
                            join kenyaemr_etl.etl_default_facility_info def

        )
)x"|Indicator|1|IndicatorExtract|1|a6221aa4-0e85-11e8-ba89-0ed5f89f718b


2bbeec20-7754-11eb-9439-0242ac130002|Allergies Chronic Illness|NDWH|a6221856-0e85-11e8-ba89-0ed5f89f718b|"select ci.patient_id   as PatientPK,
                                            ci.uuid   as RecordUUID,
                                            s.siteCode                                                as SiteCode,
                                            de.unique_patient_no                                      as PatientID,
                                            0                                                         AS FacilityId,
                                            'KenyaEMR'                                                as Emr,
                                            'Kenya HMIS II'                                           as Project,
                                            s.FacilityName                                            as FacilityName,
                                            ci.visit_date                                             as VisitDate,
                                            ci.visit_id                                               as VisitID,
                                            group_concat(case ci.chronic_illness
                                                             when 149019 then 'Alzheimers Disease and other Dementias'
                                                             when 148432 then 'Arthritis'
                                                             when 153754 then 'Asthma'
                                                             when 159351 then 'Cancer'
                                                             when 119270 then 'Cardiovascular diseases'
                                                             when 120637 then 'Chronic Hepatitis'
                                                             when 145438 then 'Chronic Kidney Disease'
                                                             when 1295 then 'Chronic Obstructive Pulmonary Disease(COPD)'
                                                             when 120576 then 'Chronic Renal Failure'
                                                             when 119692 then 'Cystic Fibrosis'
                                                             when 120291 then 'Deafness and Hearing impairment'
                                                             when 119481 then 'Diabetes'
                                                             when 118631 then 'Endometriosis'
                                                             when 117855 then 'Epilepsy'
                                                             when 117789 then 'Glaucoma'
                                                             when 139071 then 'Heart Disease'
                                                             when 115728 then 'Hyperlipidaemia'
                                                             when 117399 then 'Hypertension'
                                                             when 117321 then 'Hypothyroidism'
                                                             when 151342 then 'Mental illness'
                                                             when 133687 then 'Multiple Sclerosis'
                                                             when 115115 then 'Obesity'
                                                             when 114662 then 'Osteoporosis'
                                                             when 117703 then 'Sickle Cell Anaemia'
                                                             when 118976 then 'Thyroid disease'
                                                             when 141623 then 'Dyslipidemia'
                                                             end SEPARATOR
                                                         '|')                                         as ChronicIllness,
                                            group_concat(CASE ci.is_chronic_illness_controlled 
                                                 when 1065 then 'Yes'
                                                 when 1066 then 'No'  
                                                 else 'N/A'
                                                 end SEPARATOR '|' )			                    as Controlled,
                                         group_concat(case ci.chronic_illness_onset_date 
                                                 when ci.chronic_illness_onset_date then ci.chronic_illness_onset_date
                                                 else 'N/A' end SEPARATOR '|')                      as ChronicOnsetDate,
                                            (case coalesce(v.has_known_allergies, p.known_allergies)
                                                 when 1 then 'Yes'
                                                 when 2
                                                     then 'No' end)                                   as knownAllergies,
                                            group_concat(case ci.allergy_causative_agent
                                                             when 162543 then 'Beef'
                                                             when 72609 then 'Caffeine'
                                                             when 162544 then 'Chocolate'
                                                             when 162545 then 'Dairy Food'
                                                             when 162171 then 'Eggs'
                                                             when 162546 then 'Fish'
                                                             when 162547 then 'Milk Protein'
                                                             when 162172 then 'Peanuts'
                                                             when 162175 then 'Shellfish'
                                                             when 162176 then 'Soy'
                                                             when 162548 then 'Strawberries'
                                                             when 162177 then 'Wheat'
                                                             when 162542 then 'Adhesive Tape'
                                                             when 162536 then 'Bee Stings'
                                                             when 162537 then 'Dust'
                                                             when 162538 then 'Latex'
                                                             when 162539 then 'Mold'
                                                             when 162540 then 'Pollen'
                                                             when 162541 then 'Ragweed'
                                                             when 5622 then 'Other'
                                                             end SEPARATOR
                                                         '|')                                         as AllergyCausativeAgent,
                                            group_concat(case ci.allergy_reaction
                                                             when 1067 then 'Unknown'
                                                             when 121629 then 'Anaemia'
                                                             when 148888 then 'Anaphylaxis'
                                                             when 148787 then 'Angioedema'
                                                             when 120148 then 'Arrhythmia'
                                                             when 108 then 'Bronchospasm'
                                                             when 143264 then 'Cough'
                                                             when 142412 then 'Diarrhea'
                                                             when 118773 then 'Dystonia'
                                                             when 140238 then 'Fever'
                                                             when 140039 then 'Flushing'
                                                             when 139581 then 'GI upset'
                                                             when 139084 then 'Headache'
                                                             when 159098 then 'Hepatotoxicity'
                                                             when 111061 then 'Hives'
                                                             when 117399 then 'Hypertension'
                                                             when 879 then 'Itching'
                                                             when 121677 then 'Mental status change'
                                                             when 159347 then 'Musculoskeletal pain'
                                                             when 121 then 'Myalgia'
                                                             when 512 then 'Rash'
                                                             when 5622 then 'Other'
                                                             end SEPARATOR
                                                         '|')                                         as AllergicReaction,
                                            group_concat(case ci.allergy_severity
                                                             when 160754 then 'Mild'
                                                             when 160755 then 'Moderate'
                                                             when 160756 then 'Severe'
                                                             when 160758 then 'Fatal'
                                                             when 1067 then 'Unknown'
                                                             end SEPARATOR
                                                         '|')                                         as AllergySeverity,
                                            group_concat(ci.allergy_onset_date SEPARATOR '|')         as AllergyOnsetDate,
                                            ''                                                        as Skin,
                                            ''                                                        as Eyes,
                                            ''                                                        as ENT,
                                            ''                                                        as Chest,
                                            ''                                                        as CVS,
                                            ''                                                        as Abdomen,
                                            ''                                                        as CNS,
                                            ''                                                        AS Genitourinary,
                                            ci.date_created                                           as Date_Created,
                                            max(ci.date_last_modified)                                    as Date_Last_Modified,
                         ci.voided as Voided
                  from dwapi_etl.etl_allergy_chronic_illness ci
                           left join (select e.patient_id, max(e.visit_date) as latest_enrolment_date,uuid
                                      from dwapi_etl.etl_hiv_enrollment e
                                      group by e.patient_id) e on ci.patient_id = e.patient_id
                           left join (select pe.patient_id, max(pe.visit_date) as prep_latest_enrolment_date,uuid
                                      from dwapi_etl.etl_prep_enrolment pe
                                      group by pe.patient_id) pe on ci.patient_id = pe.patient_id
                           left join dwapi_etl.etl_patient_hiv_followup v on ci.encounter_id = v.encounter_id
                           left join dwapi_etl.etl_prep_followup p on ci.encounter_id = p.encounter_id
                           left join (select d.patient_id as                                                           hiv_disc_patient,
                                             coalesce(max(date(d.effective_discontinuation_date)), date(d.visit_date)) hiv_outcome_date
                                      from dwapi_etl.etl_patient_program_discontinuation d
                                      where program_name = 'HIV'
                                      group by d.patient_id) d on d.hiv_disc_patient = ci.patient_id
                           left join (select d.patient_id as         PrEP_disc_patient,
                                             max(date(d.visit_date)) PrEP_Outcome_date
                                      from dwapi_etl.etl_prep_discontinuation d
                                      group by d.patient_id) pd on pd.PrEP_disc_patient = ci.patient_id
                           inner join dwapi_etl.etl_patient_demographics de on ci.patient_id = de.patient_id
                           join kenyaemr_etl.etl_default_facility_info s
                  where (d.hiv_disc_patient is null
                      or d.hiv_outcome_date < e.latest_enrolment_date)
                     or (pd.PrEP_disc_patient is null or pd.PrEP_Outcome_date < pe.prep_latest_enrolment_date)
                  group by ci.patient_id, ci.visit_date"|dwhstage|0|AllergiesChronicIllnessExtract|11|a6221aa4-0e85-11e8-ba89-0ed5f89f718b
2bbeec21-7754-11eb-9439-0242ac130002|IPT|NDWH|a6221856-0e85-11e8-ba89-0ed5f89f718b|"select v.patient_id                                                               as PatientPK,
                            v.uuid   as RecordUUID,
                            site.siteCode                                                              as SiteCode,
                            de.unique_patient_no                                                       as PatientID,
                            0                                                                          AS FacilityId,
                            'KenyaEMR'                                                                 as Emr,
                            'Kenya HMIS II'                                                            as Project,
                            site.FacilityName                                                          as FacilityName,
                            coalesce(v.visit_date, s.visit_date)                                       as VisitDate,
                            coalesce(v.visit_id, s.visit_id)                                           as VisitID,
                            case v.on_anti_tb_drugs when 1065 then 'Yes' when 1066 then 'No' end       as OnTBDrugs,
                            coalesce(case v.on_ipt when 1065 then 'Yes' when 1066 then 'No' end, if(i.isStarted is not null and	
                            coalesce(v.visit_date, s.visit_date) between i.TPT_Initiation_date and d.Outcome_date,	
                            'Yes',	
                            'No'))                                                                    as OnIPT,
                            i.TPT_Initiation_date                                                      as TPTInitiationDate,
                                coalesce(case v.ever_on_ipt when 1065 then 'Yes' when 1066 then 'No' end, if(i.isStarted is not null and	
                            coalesce(v.visit_date, s.visit_date) >=	
                            i.TPT_Initiation_date,	
                            'Yes', 'No'))                                                                as EverOnIPT,
                            (case s.cough when 159799 then 'Yes' when 1066 then 'No' end)              as Cough,
                            (case s.fever when 1494 then 'Yes' when 1066 then 'No' end)                as Fever,
                            (case s.weight_loss_poor_gain when 832 then 'Yes' when 1066 then 'No' end) as NoticeableWeightLoss,
                            (case s.night_sweats when 133027 then 'Yes' when 1066 then 'No' end)       as NightSweats,
                            (case s.lethargy when 116334 then 'Yes' when 1066 then 'No' end)           as Lethargy,
                            concat_ws('|', case v.spatum_smear_ordered when 307 then 'Sputum smear' end,
                                      case v.chest_xray_ordered when 12 then 'Chest Xray' end,
                                      case v.genexpert_ordered when 162202 then 'GeneXpert' end)         as ICFActionTaken,
                            concat_ws('|', case v.spatum_smear_result
                                               when 703 then 'Positive'
                                               when 664 then 'Negative' end, case v.chest_xray_result
                                                                                 when 1115 then 'Normal'
                                                                                 when 152526 then 'Abnormal' end,
                                      case v.genexpert_result
                                          when 162203 then 'Mycobacterium Tuberculosis detected with Rifampicin resistance'
                                          when 664 then 'Negative'
                                          when 162204 then 'Mycobacterium Tuberculosis detected without Rifampicin resistance'
                                          when 164104 then 'Mycobacterium tuberculosis detected with indeterminate rifampin resistance'
                                          when 163611 then 'Invalid'
                                          when 1138 then 'Indeterminate' end)                          as TestResult,
                            (case v.clinical_tb_diagnosis
                                 when 703 then 'Positive'
                                 when 664 then 'Negative' end)                                         as TBClinicalDiagnosis,
                            (case v.contact_invitation when 1065 then 'Yes' when 1066 then 'No' end)   as ContactsInvited,
                            (case v.evaluated_for_ipt when 1065 then 'Yes' when 1066 then 'No' end)    as EvaluatedForIPT,
                            (case started_anti_TB when 1065 then 'Yes' when 1066 then 'No' end)        as StartAntiTBs,
                            v.tb_rx_date                                                               as TBRxStartDate,
                            (case v.tb_status
                                 when 1660 then 'No Signs'
                                 when 142177 then 'Presumed TB'
                                 when 1662 then 'TB Confirmed'
                                 when 160737 then 'TB Screening not done' end)                         as TBScreening,
                            s.IPTClientWorkUp                                                          as IPTClientWorkUp,
                            if(i.isStarted is not null and i.TPT_Initiation_date =	
                            coalesce(v.visit_date, s.visit_date),	
                            'Yes', 'No')                                                                as StartIPT,
                            if(ifnull(i.IndicationForIPT, ''), '', i.IndicationForIPT)                 as IndicationForIPT,                                                                                             
                            d.IPT_disc_reason                                                          as IPTDiscontinuation,
                            d.Outcome_date                                                             as DateOfDiscontinuation,
                            v.date_created                                                             as Date_Created,
                            v.date_last_modified                                                       as Date_Last_Modified,
                            v.voided                                            as Voided
from dwapi_etl.etl_patient_hiv_followup v
inner join dwapi_etl.etl_patient_demographics de on v.patient_id = de.patient_id
inner join (select a.patient_id
 from (select e.patient_id, max(e.visit_date) as latest_enrolment_date
       from dwapi_etl.etl_hiv_enrollment e
       group by e.patient_id) a
          left join (select d.patient_id as              disc_patient,
                            coalesce(max(date(d.effective_discontinuation_date)),
                                     date(d.visit_date)) Outcome_date
                     from dwapi_etl.etl_patient_program_discontinuation d
                     where program_name = 'HIV'
                     group by d.patient_id) d on a.patient_id = d.disc_patient
 where d.disc_patient is null
    or d.Outcome_date < a.latest_enrolment_date
 group by a.patient_id) e on v.patient_id = e.patient_id
left join (select s.patient_id                                                            as patient_id,
       s.visit_date                                                            as visit_date,
       s.visit_id                                                              as visit_id,
       s.cough,
       s.fever,
       s.weight_loss_poor_gain,
       s.night_sweats,
       s.lethargy,
       concat_ws('|', (case Ifnull(s.yellow_urine, '')
                           when 162311 then 'Yes'
                           when 1066 then 'No' end), (case ifnull(s.numbness_bs_hands_feet, '')
                                                          when 132652 then 'Yes'
                                                          when 1066 then 'No' end),
                 (case ifnull(s.eyes_yellowness, '')
                      when 5192 then 'Yes'
                      when 1066 then 'No' end), (case ifnull(s.upper_rightQ_abdomen_tenderness, '')
                                                     when 124994 then 'Yes'
                                                     when 1066 then 'No' end)) as IPTClientWorkUp
from dwapi_etl.etl_ipt_screening s) s
on v.patient_id = s.patient_id and v.visit_date = s.visit_date
left join (select i.patient_id                                         as isStarted,
       i.visit_date                                         as TPT_Initiation_date,
       (case i.ipt_indication
            when 138571 then 'PLHIV'
            when 162277 then 'Prison setting'
            when 162278 then 'Household contact'
            when 1555 then 'HCW and other Facility staff'
            when 5619 then 'Other clinical risk group' end) as IndicationForIPT
from dwapi_etl.etl_ipt_initiation i) i on v.patient_id = i.isStarted
left join (select o.patient_id                    as disc_patient,
       max(date(o.visit_date))            Outcome_date,
       case mid(max(concat(o.visit_date, o.outcome)), 11)
           when 1267 then 'Treatment completed'
           when 5240 then 'Lost to followup'
           when 159836 then 'Discontinued'
           when 160034 then 'Died'
           when 159492 then 'Transferred out'
           when 112141 then 'Active TB Disease'
           when 102 then 'Adverse drug reaction'
           when 159598 then 'Poor adherence'
           when 5622 then 'Others' end as IPT_disc_reason
from dwapi_etl.etl_ipt_outcome o
group by o.patient_id) d on d.disc_patient = v.patient_id
join kenyaemr_etl.etl_default_facility_info site
where de.unique_patient_no is not null
group by v.encounter_id"|dwhstage|0|IptExtract|12|a6221aa4-0e85-11e8-ba89-0ed5f89f718b
2bbeec22-7754-11eb-9439-0242ac130002|Depression Screening|NDWH|a6221856-0e85-11e8-ba89-0ed5f89f718b|"select v.patient_id as PatientPK,
                                                                    v.uuid  as RecordUUID,
                                                                    s.siteCode as SiteCode,
                                                                    de.unique_patient_no as PatientID,
                                                                    0 AS FacilityId,
                                                                    'KenyaEMR' as Emr,'Kenya HMIS II' as Project,s.FacilityName as FacilityName,
                                                                    v.visit_id as VisitID,v.visit_date as VisitDate,
                                                                    '' as PHQ9_1,'' as PHQ9_2,'' as PHQ9_3,'' as PHQ9_4,'' as PHQ9_5,'' as PHQ9_6,'' as PHQ9_7,'' as PHQ9_8,'' as PHQ9_9,'' as DepressionAssesmentScore,
                                                                    (case v.PHQ_9_rating when 1115 then 'Depression unlikely' when 157790 then 'Mild depression'
                                                                                                                                                        when 134011 then 'Moderate depression' when 134017 then 'Moderate severe depression' when 126627 then 'Severe depression' end) as PHQ_9_rating,
                                                                    v.date_created as Date_Created, v.date_last_modified as Date_Last_Modified,
                                v.voided                                       as Voided
                         from dwapi_etl.etl_depression_screening v
                                  inner join dwapi_etl.etl_patient_demographics de on v.patient_id = de.patient_id
                                  inner join (select e.patient_id, max(e.visit_date) as latest_enrolment_date
                                              from dwapi_etl.etl_hiv_enrollment e
                                              group by e.patient_id) e on v.patient_id = e.patient_id
                                  left join (select d.patient_id as                                                           disc_patient,
                                                    coalesce(max(date(d.effective_discontinuation_date)), date(d.visit_date)) Outcome_date
                                             from dwapi_etl.etl_patient_program_discontinuation d
                                             where program_name = 'HIV'
                                             group by d.patient_id) d on d.disc_patient = v.patient_id
                                  join kenyaemr_etl.etl_default_facility_info s
                         where d.disc_patient is null
                            or d.Outcome_date < e.latest_enrolment_date"|dwhstage|0|DepressionScreeningExtract|13|a6221aa4-0e85-11e8-ba89-0ed5f89f718b
2bbeec23-7754-11eb-9439-0242ac130002|Contact Listing|NDWH|a6221856-0e85-11e8-ba89-0ed5f89f718b|"select v.patient_id as PatientPK,
                         v.uuid  as RecordUUID,
                         v.patient_id                                            as ContactPatientPK,
                           s.siteCode                                              as SiteCode,
                           de.unique_patient_no                                    as PatientID,
                           'KenyaEMR'                                              as Emr,
                           'Kenya HMIS II'                                         as Project,
                           0                                                       AS FacilityId,
                           s.FacilityName                                          as FacilityName,
                           v.patient_id                                            as PartnerPersonID,
                           timestampdiff(YEAR, date(v.birth_date), current_date()) as ContactAge,
                           v.sex                                                   as ContactSex,
                           (case v.marital_status
                                when 1057 then 'Single'
                                when 5555 then 'Married Monogamous'
                                when 159715 then 'Married Polygamous'
                                when 1058 then 'Divorced'
                                when 1059 then 'Widowed' end)                      as ContactMaritalStatus,
                           (case v.relationship_type
                                when 970 then 'Mother'
                                when 971 then 'Father'
                                when 972 then 'Sibling'
                                when 1528 then 'Child'
                                when 5617 then 'Spouse'
                                when 163565 then 'Partner'
                                when 162221 then 'Co-wife'
                                when 157351 then 'Injectable drug user' end)       as RelationshipWithPatient,
                           if(v.ipv_outcome is not null, 'Yes', 'No')              as ScreenedForIpv,
                           ''                                                      as IpvScreening,
                           v.ipv_outcome                                           as IPVScreeningOutcome,
                           (case v.living_with_patient
                                when 1065 then 'Yes'
                                when 1066 then 'No'
                                else '' end)                                       as CurrentlyLivingWithIndexClient,
                           v.baseline_hiv_status                                   as KnowledgeOfHivStatus,
                           (case v.pns_approach
                                when 162284 then 'Dual referral'
                                when 160551 then 'Passive referral'
                                when 161642 then 'Contract referral'
                                when 163096 then 'Provider referral'
                                else '' end)                                       as PnsApproach,
                           v.date_created                                          as Date_Created,
                           v.date_last_modified                                    as Date_Last_Modified,
                                                v.voided                                                as Voided
                    from dwapi_etl.etl_patient_contact v
                             inner join dwapi_etl.etl_patient_demographics de on v.patient_related_to = de.patient_id
                             inner join (select e.patient_id, max(e.visit_date) as latest_enrolment_date
                                         from dwapi_etl.etl_hiv_enrollment e
                                         group by e.patient_id) e on v.patient_related_to = e.patient_id
                             left join (select d.patient_id as                                                           disc_patient,
                                               coalesce(max(date(d.effective_discontinuation_date)), date(d.visit_date)) Outcome_date
                                        from dwapi_etl.etl_patient_program_discontinuation d
                                        where program_name = 'HIV'
                                        group by d.patient_id) d on d.disc_patient = v.patient_id
                             join kenyaemr_etl.etl_default_facility_info s
                    where d.disc_patient is null
                       or d.Outcome_date < e.latest_enrolment_date"|dwhstage|0|ContactListingExtract|14|a6221aa4-0e85-11e8-ba89-0ed5f89f718b
2bbeec24-7754-11eb-9439-0242ac130002|GBV Screening|NDWH|a6221856-0e85-11e8-ba89-0ed5f89f718b|"select v.patient_id                                                           as PatientPK,
                            v.uuid  as RecordUUID,
                            s.siteCode                                                             as SiteCode,
                            0                                                                      AS FacilityId,
                            de.unique_patient_no                                                   as PatientID,
                            'KenyaEMR'                                                             as Emr,
                            'Kenya HMIS II'                                                        as Project,
                            s.FacilityName                                                         as FacilityName,
                            v.visit_id                                                             as VisitID,
                            v.visit_date                                                           as VisitDate,
                            (case v.ipv when 1065 then 'Yes' when 1066 then 'No' end)              as IPV,
                            (case v.physical_ipv when 158358 then 'Yes' when 1066 then 'No' end)   as PhysicalIPV,
                            (case v.emotional_ipv when 118688 then 'Yes' when 1066 then 'No' end)  as EmotionalIPV,
                            (case v.sexual_ipv when 152370 then 'Yes' when 1066 then 'No' end)     as SexualIPV,
                            (case v.ipv_relationship when 1582 then 'Yes' when 1066 then 'No' end) as IPVRelationship,
                            v.date_created                                                         as Date_Created,
                            v.date_last_modified                                                   as Date_Last_Modified,
             v.voided                                                               as Voided
      from dwapi_etl.etl_gbv_screening v
               inner join dwapi_etl.etl_patient_demographics de on v.patient_id = de.patient_id
               inner join (select e.patient_id, max(e.visit_date) as latest_enrolment_date
                           from dwapi_etl.etl_hiv_enrollment e
                           group by e.patient_id) e on e.patient_id = v.patient_id
               left join (select d.patient_id as                                                           disc_patient,
                                 coalesce(max(date(d.effective_discontinuation_date)), date(d.visit_date)) Outcome_date
                          from dwapi_etl.etl_patient_program_discontinuation d
                          where program_name = 'HIV'
                          group by d.patient_id) d on d.disc_patient = v.patient_id
               join kenyaemr_etl.etl_default_facility_info s
      where d.disc_patient is null
         or d.Outcome_date < e.latest_enrolment_date"|dwhstage|0|GbvScreeningExtract|15|a6221aa4-0e85-11e8-ba89-0ed5f89f718b
2bbeec25-7754-11eb-9439-0242ac130002|Enhanced Adherence Counselling|NDWH|a6221856-0e85-11e8-ba89-0ed5f89f718b|"select v.patient_id as PatientPK,
                                               v.uuid  as RecordUUID,
                                               s.siteCode as SiteCode,
                                               de.unique_patient_no as PatientID,
                                               'KenyaEMR' as Emr,
                                               'Kenya HMIS II' as Project,
                                               0 AS FacilityId,
                                               s.FacilityName as FacilityName,
                                               v.visit_id as VisitID,v.visit_date as VisitDate,v.session_number as SessionNumber,v.first_session_date as DateOfFirstSession,v.pill_count as PillCountAdherence,                                               
                                                v.MMAS4_1_forgets_to_take_meds                as MMAS4_1,
                                                v.MMAS4_2_careless_taking_meds                as MMAS4_2,
                                                v.MMAS4_3_stops_on_reactive_meds              as MMAS4_3,
                                                v.MMAS4_4_stops_meds_on_feeling_good          as MMAS4_4,
                                                v.MMSA8_1_took_meds_yesterday                 as MMSA8_1,
                                                v.MMSA8_2_stops_meds_on_controlled_symptoms   as MMSA8_2,
                                                v.MMSA8_3_struggles_to_comply_tx_plan         as MMSA8_3,
                                                v.MMSA8_4_struggles_remembering_taking_meds   as MMSA8_4,                                               
                                               v.arv_adherence as MMSAScore ,v.has_vl_results as EACRecievedVL, v.vl_results_suppressed as EACVL,v.vl_results_feeling as EACVLConcerns,
                                               v.cause_of_high_vl as EACVLThoughts,v.way_forward as EACWayForward,v.patient_hiv_knowledge as EACCognitiveBarrier,v.patient_drugs_uptake as EACBehaviouralBarrier_1,
                                               v.patient_drugs_reminder_tools as EACBehaviouralBarrier_2,v.patient_drugs_uptake_during_travels as EACBehaviouralBarrier_3,v.patient_drugs_side_effects_response as EACBehaviouralBarrier_4,
                                               v.patient_drugs_uptake_most_difficult_times as EACBehaviouralBarrier_5,v.patient_drugs_daily_uptake_feeling as EACEmotionalBarriers_1,v.patient_ambitions as EACEmotionalBarriers_2,
                                               v.patient_has_people_to_talk as EACEconBarrier_1,v.patient_enlisting_social_support as EACEconBarrier_2,v.patient_income_sources as EACEconBarrier_3,v.patient_challenges_reaching_clinic as EACEconBarrier_4,
                                               v.patient_worried_of_accidental_disclosure as EACEconBarrier_5, v.patient_treated_differently as EACEconBarrier_6,v.stigma_hinders_adherence as EACEconBarrier_7,v.patient_tried_faith_healing as EACEconBarrier_8,
                                               v.patient_adherence_improved as EACReviewImprovement,v.patient_doses_missed as EACReviewMissedDoses,v.review_and_barriers_to_adherence as EACReviewStrategy,v.other_referrals as EACReferral,
                                               v.appointments_honoured as EACReferralApp,v.referral_experience as EACReferralExperience,v.home_visit_benefit as EACHomevisit,v.adherence_plan as EACAdherencePlan,v.next_appointment_date as EACFollowupDate,
                                               v.date_created as Date_Created, v.date_last_modified as Date_Last_Modified,	
                                       v.voided                                    as Voided	
                                       from dwapi_etl.etl_enhanced_adherence v	
                                       inner join dwapi_etl.etl_patient_demographics de on v.patient_id = de.patient_id	
                                       inner join (select e.patient_id, max(e.visit_date) as latest_enrolment_date	
                                       from dwapi_etl.etl_hiv_enrollment e	
                                       group by e.patient_id) e on v.patient_id = e.patient_id	
                                       left join (select d.patient_id as                                                           disc_patient,	
                                       coalesce(max(date(d.effective_discontinuation_date)), date(d.visit_date)) Outcome_date	
                                       from dwapi_etl.etl_patient_program_discontinuation d	
                                       where program_name = 'HIV'	
                                       group by d.patient_id) d on d.disc_patient = v.patient_id	
                                       join kenyaemr_etl.etl_default_facility_info s	
                                       where d.disc_patient is null	
                                       or d.Outcome_date < e.latest_enrolment_date"|dwhstage|0|EnhancedAdherenceCounsellingExtract|16|a6221aa4-0e85-11e8-ba89-0ed5f89f718b
2bbeec26-7754-11eb-9439-0242ac130002|Drug and Alcohol Screening|NDWH|a6221856-0e85-11e8-ba89-0ed5f89f718b|"select v.patient_id as PatientPK,
                                           v.uuid  as RecordUUID,
                                           s.siteCode as SiteCode,
                                           de.unique_patient_no as PatientID,
                                           'KenyaEMR' as Emr,'Kenya HMIS II' as Project,
                                           s.FacilityName as FacilityName,
                                           0 AS FacilityId,
                                           v.visit_id as VisitID,v.visit_date as VisitDate,
                                           (case v.alcohol_drinking_frequency when 1090 then 'Never' when 1091 then 'Monthly or less' when 1092 then '2 to 4 times a month' when 1093 then '2 to 3 times a week' when 1094 then '4 or More Times a Week' end) as DrinkingAlcohol,
                                           (case v.smoking_frequency when 1090 then 'Never smoked' when 156358 then 'Former cigarette smoker' when 163197 then 'Current some day smoker' when 163196 then 'Current light tobacco smoker'
                                                                     when 163195 then 'Current heavy tobacco smoker' when 163200 then 'Unknown if ever smoked' end) as Smoking,
                                           (case v.drugs_use_frequency when 1090 then 'Never' when 1091 then 'Monthly or less' when 1092 then '2 to 4 times a month' when 1093 then '2 to 3 times a week' when 1094 then '4 or More Times a Week' end) as DrugUse,
                                           v.date_created as Date_Created, v.date_last_modified as Date_Last_Modified,
                                          v.voided                                            as Voided
                                   from dwapi_etl.etl_alcohol_drug_abuse_screening v
                                            inner join dwapi_etl.etl_patient_demographics de on v.patient_id = de.patient_id
                                            inner join (select e.patient_id, max(e.visit_date) as latest_enrolment_date
                                                        from dwapi_etl.etl_hiv_enrollment e
                                                        group by e.patient_id) e on v.patient_id = e.patient_id
                                            left join (select d.patient_id as                                                           disc_patient,
                                                              coalesce(max(date(d.effective_discontinuation_date)), date(d.visit_date)) Outcome_date
                                                       from dwapi_etl.etl_patient_program_discontinuation d
                                                       where program_name = 'HIV'
                                                       group by d.patient_id) d on d.disc_patient = v.patient_id
                                            join kenyaemr_etl.etl_default_facility_info s
                                   where d.disc_patient is null
                                      or d.Outcome_date < e.latest_enrolment_date"|dwhstage|0|DrugAlcoholScreeningExtract|17|a6221aa4-0e85-11e8-ba89-0ed5f89f718b
2bbeec27-7754-11eb-9439-0242ac130002|OVC|NDWH|a6221856-0e85-11e8-ba89-0ed5f89f718b|"select v.patient_id as PatientPK,
                                        v.uuid  as RecordUUID, 0 AS FacilityId,s.siteCode as SiteCode,de.unique_patient_no as PatientID,'KenyaEMR' as Emr,'Kenya HMIS II' as Project,s.FacilityName as FacilityName,
                                    v.encounter_id as VisitID,v.visit_date as VisitDate,v.visit_date as OVCEnrollmentDate,coalesce(v.relationship_to_client,r.b_is_to_a) as RelationshipToClient,
                                    de.CPIMS_unique_identifier as CPIMSUniqueIdentifier,v.partner_offering_ovc as PartnerOfferingOVCServices,v.client_enrolled_cpims as EnrolledinCPIMS,
                                    concat_ws(',',NULLIF(if(v.ovc_comprehensive_program='Yes','OVC Comprehensive',''),''),
                                              NULLIF(if(v.dreams_program='Yes','DREAMS',''),''),
                                              NULLIF(if(v.ovc_preventive_program='Yes','OVC Preventive',''),'')) as ProgramModel,
                                              d.attrition_reason as OVCExitReason, d.Outcome_date as ExitDate, 
                                              v.date_created as Date_Created, greatest(v.date_last_modified,v.date_last_modified) as Date_Last_Modified,
                                   v.voided                                                                          as Voided
                            from dwapi_etl.etl_ovc_enrolment v
                                     inner join dwapi_etl.etl_patient_demographics de on v.patient_id = de.patient_id
                                     left join (SELECT r.person_b, r.person_a, t.a_is_to_b, t.b_is_to_a
                                                FROM openmrs.relationship r
                                                         inner join openmrs.relationship_type t on r.relationship = t.relationship_type_id
                                                where r.voided = 0) r on v.patient_id = r.person_b
                                     left join (select d.patient_id,
                                                       coalesce(max(date(d.effective_discontinuation_date)), date(d.visit_date)) Outcome_date,
                                                       (case mid(max(concat(date(d.visit_date), d.discontinuation_reason)), 11)
                                                            when 160036 then 'Transfer out to a PEPFAR supported facility'
                                                            when 159492 then 'Transfer out to a non PEPFAR supported facility'
                                                            when 165219 then 'Exit without graduation'
                                                            when 1267 then 'Graduated out of OVC'
                                                            when 160034 then 'Died' end) as                                      attrition_reason
                                                from dwapi_etl.etl_patient_program_discontinuation d
                                                where program_name = 'OVC'
                                                group by d.patient_id) d on d.patient_id = v.patient_id
                                     join kenyaemr_etl.etl_default_facility_info s"|dwhstage|0|OvcExtract|18|a6221aa4-0e85-11e8-ba89-0ed5f89f718b
2bbeec28-7754-11eb-9439-0242ac130002|OTZ|NDWH|a6221856-0e85-11e8-ba89-0ed5f89f718b|"select e.patient_id                                                   as PatientPK,
                                                           e.uuid                                                         as RecordUUID,
                                                           0                                                              AS FacilityId,
                                                           s.siteCode                                                     as SiteCode,
                                                           de.unique_patient_no                                           as PatientID,
                                                           'KenyaEMR'                                                     as Emr,
                                                           'Kenya HMIS II'                                                as Project,
                                                           s.FacilityName                                                 as FacilityName,
                                                           e.visit_id                                                     as VisitID,
                                                           e.visit_date                                                   as VisitDate,
                                                           e.OTZEnrollmentDate,
                                                           e.TransferInStatus,
                                                           e.ModulesPreviouslyCovered,
                                                           e.modules_attended_today                                       as ModulesCompletedToday,
                                                           e.attended_support_group                                       as SupportGroupInvolvement,
                                                           e.remarks                                                      as Remarks,
                                                           d.attrition_reason                                             as TransitionAttritionReason,
                                                           d.Outcome_date                                                 as OutcomeDate,
                                                           e.date_created                                                 as Date_Created,                                                           
                                                            if(greatest(IFNULL(e.date_last_modified, '0000-00-00'), IFNULL(e.activity_date_last_modified, '0000-00-00'),
                                                            IFNULL(d.date_last_modified, '0000-00-00')) = '0000-00-00',
                                                            NULL,
                                                            greatest(IFNULL(e.date_last_modified, '0000-00-00'), IFNULL(e.activity_date_last_modified, '0000-00-00'),
                                                            IFNULL(d.date_last_modified, '0000-00-00'))) as Date_Last_Modified,
                                                           e.voided                                                       as voided
                                                    from dwapi_etl.etl_patient_demographics de
                                                             inner join (select e.patient_id,
                                                                                e.uuid,
                                                                                e.visit_date,
                                                                                a.visit_id,
                                                                                a.attended_support_group,
                                                                                a.remarks,
                                                                                greatest(max(e.visit_date), '0000-00-00')         as OTZEnrollmentDate,
                                                                                mid(max(concat(e.visit_date, e.transfer_in)), 11) as TransferInStatus,
                                                                                concat_ws(',', NULLIF(if(e.orientation = 'Yes', 'OTZ Orientation', null), ''),
                                                                                          NULLIF(if(e.participation = 'Yes', 'OTZ Participation', ''), ''), NULLIF(
                                                                                                  if(e.making_decision_future = 'Yes',
                                                                                                     'OTZ Making decisions for the future', ''), ''),
                                                                                          NULLIF(if(e.transition_to_adult_care = 'Yes', 'OTZ Transition to Adult care', ''),
                                                                                                 ''),
                                                                                          NULLIF(if(e.treatment_literacy = 'Yes', 'OTZ Treatment literacy', ''), ''),
                                                                                          NULLIF(if(e.srh = 'Yes', 'OTZ SRH', ''), ''),
                                                                                          NULLIF(if(e.beyond_third_ninety = 'Yes', 'OTZ Beyond the 3rd 90', null),
                                                                                                 ''))                             as ModulesPreviouslyCovered,
                                                                                concat_ws(',', NULLIF(if(a.orientation = 'Yes', 'OTZ Orientation', null), ''),
                                                                                          NULLIF(if(a.participation = 'Yes', 'OTZ Participation', ''), ''),
                                                                                          NULLIF(if(a.making_decision_future = 'Yes', 'OTZ Making decisions for the future',
                                                                                                    ''), '')
                                                                                    , NULLIF(if(a.transition_to_adult_care = 'Yes', 'OTZ Transition to Adult care', ''),
                                                                                             ''),
                                                                                          NULLIF(if(a.treatment_literacy = 'Yes', 'OTZ Treatment literacy', ''), ''),
                                                                                          NULLIF(if(a.srh = 'Yes', 'OTZ SRH', ''), ''),
                                                                                          NULLIF(if(a.leadership = 'Yes', 'Leadership', ''), ''),
                                                                                          NULLIF(if(a.beyond_third_ninety = 'Yes', 'OTZ Beyond the 3rd 90', null),
                                                                                                 ''))                             as modules_attended_today,
                                                                                e.voided                                          as voided,
                                                                                e.date_created                                    as date_created,
                                                                                e.date_last_modified                              as date_last_modified,
                                                                                a.date_last_modified                              as activity_date_last_modified
                                                                         from dwapi_etl.etl_otz_enrollment e
                                                                                  left join dwapi_etl.etl_otz_activity a on e.patient_id = a.patient_id
                                                                         group by e.patient_id) e on de.patient_id = e.patient_id
                                                             left join (select d.patient_id,
                                                                               coalesce(max(date(d.effective_discontinuation_date)), date(d.visit_date)) Outcome_date,
                                                                               (case mid(max(concat(date(d.visit_date), d.discontinuation_reason)), 11)
                                                                                    when 5240 then 'LTFU'
                                                                                    when 159492 then 'Transfer Out'
                                                                                    when 160034 then 'Died'
                                                                                    when 159836 then 'Opt out of OTZ'
                                                                                    when 165363 then 'Transition to Adult Care' end) as                  attrition_reason,
                                                                               d.date_created,
                                                                               d.date_last_modified
                                                                        from dwapi_etl.etl_patient_program_discontinuation d
                                                                        where program_name = 'OTZ'
                                                                        group by d.patient_id) d on d.patient_id = e.patient_id
                                                             join kenyaemr_etl.etl_default_facility_info s"|dwhstage|0|OtzExtract|19|a6221aa4-0e85-11e8-ba89-0ed5f89f718b

7c2e4a14-8728-11eb-8dcd-0242ac130003|All Patients|NDWH|a6221861-0e85-11e8-ba89-0ed5f89f718b|"select * from NDWH_Patients_Extract"|dwhstage|1|PatientExtract|1|a6221aa7-0E85-11E8-BA89-0ED5F89F718B
7c2e4c44-8728-11eb-8dcd-0242ac130003|ART Patients|NDWH|a6221861-0e85-11e8-ba89-0ed5f89f718b|"select * from NDWH_Patients_ART_EXTRACT"|dwhstage|0|PatientArtExtract|2|a6221aa7-0E85-11E8-BA89-0ED5F89F718B
7c2e4d34-8728-11eb-8dcd-0242ac130003|Patient Baselines|NDWH|a6221861-0e85-11e8-ba89-0ed5f89f718b|"select * from NDWH_Patients_Baseline_Extract"|dwhstage|0|PatientBaselineExtract|3|a6221aa7-0E85-11E8-BA89-0ED5F89F718B
7c2e4dfc-8728-11eb-8dcd-0242ac130003|Patient Status|NDWH|a6221861-0e85-11e8-ba89-0ed5f89f718b|"select * from NDWH_Patients_STATUS_Extract"|dwhstage|0|PatientStatusExtract|4|a6221aa7-0E85-11E8-BA89-0ED5F89F718B
7c2e4eba-8728-11eb-8dcd-0242ac130003|Patient Labs|NDWH|a6221861-0e85-11e8-ba89-0ed5f89f718b|"select * from NDWH_Patients_LABS_EXTRACT"|dwhstage|0|PatientLabExtract|5|a6221aa7-0E85-11E8-BA89-0ED5F89F718B
7c2e4f6e-8728-11eb-8dcd-0242ac130003|Patient Pharmacy|NDWH|a6221861-0e85-11e8-ba89-0ed5f89f718b|"select * from NDWH_Patients_PHARMACY_EXTRACT"|dwhstage|0|PatientPharmacyExtract|6|a6221aa7-0E85-11E8-BA89-0ED5F89F718B
7c2e51ee-8728-11eb-8dcd-0242ac130003|Patient Visits|NDWH|a6221861-0e85-11e8-ba89-0ed5f89f718b|"select * from NDWH_Patients_VISIT_Extract"|dwhstage|0|PatientVisitExtract|7|a6221aa7-0E85-11E8-BA89-0ED5F89F718B
7c2e52c0-8728-11eb-8dcd-0242ac130003|Patient Adverse Events|NDWH|a6221861-0e85-11e8-ba89-0ed5f89f718b|"select * from NDWH_Patients_Adverse_Events"|dwhstage|0|PatientAdverseEventExtract|8|a6221aa7-0E85-11E8-BA89-0ED5F89F718B
7c2e63c0-8728-11eb-8dcd-0242ac130003|Allergies Chronic Illness|NDWH|a6221861-0e85-11e8-ba89-0ed5f89f718b|SELECT * from NDWH_AllergiesChronicIllness|dwhstage|0|AllergiesChronicIllnessExtract|11.0|a6221aa7-0e85-11e8-ba89-0ed5f89f718b
7c2e53c0-8728-11eb-8dcd-0242ac130003|IPT|NDWH|a6221861-0e85-11e8-ba89-0ed5f89f718b|SELECT * from NDWH_TPT|dwhstage|0|IptExtract|12.0|a6221aa7-0e85-11e8-ba89-0ed5f89f718b
7c2e54c0-8728-11eb-8dcd-0242ac130003|Depression Screening|NDWH|a6221861-0e85-11e8-ba89-0ed5f89f718b|SELECT * from NDWH_DepressionScreening|dwhstage|0|DepressionScreeningExtract|13.0|a6221aa7-0e85-11e8-ba89-0ed5f89f718b
7c2e55c0-8728-11eb-8dcd-0242ac130003|Contact Listing|NDWH|a6221861-0e85-11e8-ba89-0ed5f89f718b|SELECT * from NDWH_ContactListing|dwhstage|0|ContactListingExtract|14.0|a6221aa7-0e85-11e8-ba89-0ed5f89f718b
7c2e56c0-8728-11eb-8dcd-0242ac130003|GBV Screening|NDWH|a6221861-0e85-11e8-ba89-0ed5f89f718b|SELECT * from NDWH_GBVScreening|dwhstage|0|GbvScreeningExtract|15.0|a6221aa7-0e85-11e8-ba89-0ed5f89f718b
7c2e57c0-8728-11eb-8dcd-0242ac130003|Enhanced Adherence Counselling|NDWH|a6221861-0e85-11e8-ba89-0ed5f89f718b|SELECT * from NDWH_EnAdhCounselling|dwhstage|0|EnhancedAdherenceCounsellingExtract|16.0|a6221aa7-0e85-11e8-ba89-0ed5f89f718b
7c2e58c0-8728-11eb-8dcd-0242ac130003|Drug and Alcohol Screening|NDWH|a6221861-0e85-11e8-ba89-0ed5f89f718b|SELECT * from NDWH_DrugAlcoholScr|dwhstage|0|DrugAlcoholScreeningExtract|17.0|a6221aa7-0e85-11e8-ba89-0ed5f89f718b
7c2e59c0-8728-11eb-8dcd-0242ac130003|OVC|NDWH|a6221861-0e85-11e8-ba89-0ed5f89f718b|SELECT * from NDWH_OVC|dwhstage|0|OvcExtract|18.0|a6221aa7-0e85-11e8-ba89-0ed5f89f718b
7c2e60c0-8728-11eb-8dcd-0242ac130003|OTZ|NDWH|a6221861-0e85-11e8-ba89-0ed5f89f718b|SELECT * from NDWH_OTZ|dwhstage|0|OtzExtract|19.0|a6221aa7-0e85-11e8-ba89-0ed5f89f718b
7c2e61c0-8728-11eb-8dcd-0242ac130003|Covid|NDWH|a6221861-0e85-11e8-ba89-0ed5f89f718b|SELECT * from NDWH_COVID|dwhstage|0|CovidExtract|20.0|a6221aa7-0e85-11e8-ba89-0ed5f89f718b
7c2e62c0-8728-11eb-8dcd-0242ac130003|Defaulter Tracing|NDWH|a6221861-0e85-11e8-ba89-0ed5f89f718b|SELECT * from NDWH_DefaulterTracing|dwhstage|0|DefaulterTracingExtract|21.0|a6221aa7-0e85-11e8-ba89-0ed5f89f718b
A926B327-D042-4459-963B-523879C47347|Hts Clients|HTS|A6221861-0E85-11E8-BA89-0ED5F89F718B|""|DWHStage|1|HtsClient|1.00|A6221AA7-0E85-11E8-BA89-0ED5F89F718B
0C82AA9F-C58D-4BEA-996B-00EE33286CAD|Hts Test Kits|HTS|A6221861-0E85-11E8-BA89-0ED5F89F718B|""|DWHStage|1|HtsTestKits|4.00|A6221AA7-0E85-11E8-BA89-0ED5F89F718B
EEE41260-E92F-47CB-8AC8-E47281B8A8C4|Hts Client Linkage|HTS|A6221861-0E85-11E8-BA89-0ED5F89F718B|""|DWHStage|1|HtsClientLinkage|3.00|A6221AA7-0E85-11E8-BA89-0ED5F89F718B
A72B9001-7109-4D66-8938-9F41D1779D95|Hts Partner Notification Services|HTS|A6221861-0E85-11E8-BA89-0ED5F89F718B|""|DWHStage|1|HtsPartnerNotificationServices|7.00|A6221AA7-0E85-11E8-BA89-0ED5F89F718B
79527CF5-6DA1-439E-B32C-49F7677E0A0F|Hts Client Tracing|HTS|A6221861-0E85-11E8-BA89-0ED5F89F718B|""|DWHStage|1|HtsClientTracing|5.00|A6221AA7-0E85-11E8-BA89-0ED5F89F718B
838E36EF-812D-4953-88E6-3F1DD5EC4531|Hts Partner Tracing|HTS|A6221861-0E85-11E8-BA89-0ED5F89F718B|""|DWHStage|1|HtsPartnerTracing|6.00|A6221AA7-0E85-11E8-BA89-0ED5F89F718B
88C4C1CF-703F-473B-8A4C-44B94A8DD17C|Hts Client Tests|HTS|A6221861-0E85-11E8-BA89-0ED5F89F718B|""|DWHStage|1|HtsClientTests|2.00|A6221AA7-0E85-11E8-BA89-0ED5F89F718B
3B3894F4-04B0-4141-896D-FA9F206C0DD1|Migration|MGS|A6221861-0E85-11E8-BA89-0ED5F89F718B|""|MgsStage|1|MetricMigrationExtract|1.00|A6221AA7-0E85-11E8-BA89-0ED5F89F718B
4B7B10F2-FF7E-452C-A67D-76A37E16B3EB|Hei|MNCH|A6221861-0E85-11E8-BA89-0ED5F89F718B|""|TempHeiExtract|0|HeiExtract|28.00|A6221AA7-0E85-11E8-BA89-0ED5F89F718B
F14362A9-C5EF-4BAE-91B6-67D4AA808EBC|Mnch Enrolment|MNCH|A6221861-0E85-11E8-BA89-0ED5F89F718B|""|TempMnchEnrolmentExtract|0|MnchEnrolmentExtract|20.00|A6221AA7-0E85-11E8-BA89-0ED5F89F718B
42CFECA5-4ACF-48A1-B72B-AE0B32A09503|Pnc Visit|MNCH|A6221861-0E85-11E8-BA89-0ED5F89F718B|""|TempPncVisitExtract|0|PncVisitExtract|24.00|A6221AA7-0E85-11E8-BA89-0ED5F89F718B
25E0B476-C284-4BBD-81D2-1AB3DF59A094|Mnch Art|MNCH|A6221861-0E85-11E8-BA89-0ED5F89F718B|""|TempMnchArtExtract|0|MnchArtExtract|21.00|A6221AA7-0E85-11E8-BA89-0ED5F89F718B
69474AB7-EACB-4531-8A32-B70F34874688|Mother Baby Pair|MNCH|A6221861-0E85-11E8-BA89-0ED5F89F718B|""|TempMotherBabyPairExtract|0|MotherBabyPairExtract|25.00|A6221AA7-0E85-11E8-BA89-0ED5F89F718B
2775CDFE-A796-41DE-AACC-EDC7EE5A18D9|Anc Visit|MNCH|A6221861-0E85-11E8-BA89-0ED5F89F718B|""|TempAncVisitExtract|0|AncVisitExtract|22.00|A6221AA7-0E85-11E8-BA89-0ED5F89F718B
A91D30FB-40C1-4453-903D-4E687FF5E20D|Mnch Patient|MNCH|A6221861-0E85-11E8-BA89-0ED5F89F718B|""|TempPatientMnchExtract|1|PatientMnchExtract|19.00|A6221AA7-0E85-11E8-BA89-0ED5F89F718B
84AB9AE3-6225-4937-9DBB-0B4B257AE676|Cwc Enrolment|MNCH|A6221861-0E85-11E8-BA89-0ED5F89F718B|""|TempCwcEnrolmentExtract|0|CwcEnrolmentExtract|26.00|A6221AA7-0E85-11E8-BA89-0ED5F89F718B
2D5489D0-2721-4D03-A869-5A10700ABD19|Cwc Visit|MNCH|A6221861-0E85-11E8-BA89-0ED5F89F718B|""|TempCwcVisitExtract|0|CwcVisitExtract|27.00|A6221AA7-0E85-11E8-BA89-0ED5F89F718B
5FF64729-FDA7-4065-A909-E059B8DD5A1A|Mnch Labs|MNCH|A6221861-0E85-11E8-BA89-0ED5F89F718B|""|TempMnchLabExtract|0|MnchLabExtract|29.00|A6221AA7-0E85-11E8-BA89-0ED5F89F718B
830568D9-2C97-46F4-B5FB-3AA83480BFBF|Mat Visit|MNCH|A6221861-0E85-11E8-BA89-0ED5F89F718B|""|TempMatVisitExtract|0|MatVisitExtract|23.00|A6221AA7-0E85-11E8-BA89-0ED5F89F718B
DD2E320D-D68F-4F81-819E-2D6E32836105|Indicators|MTS|A6221861-0E85-11E8-BA89-0ED5F89F718B|""|Indicator|1|IndicatorExtract|1.00|A6221AA7-0E85-11E8-BA89-0ED5F89F718B

82650e9a-9db2-11eb-a8b3-0242ac130003|Mnch Patient|MNCH|a6221856-0e85-11e8-ba89-0ed5f89f718b|"select pkv.pkv as PKV,
                                   d.patient_id                                                    as PatientPK,
                                    d.uuid                                                               RecordUUID,
                                   d.national_unique_patient_identifier                            as NUPI,
                                   i.siteCode                                                      as SiteCode,
                                   d.openmrs_id                                                    as PatientMNCHID,
                                   d.hei_no                                                        as PatientHEIID,
                                   'KenyaEMR'                                                      as Emr,
                                   'Kenya HMIS II'                                                 as Project,
                                   i.FacilityName                                                  as FacilityName,
                                    0 as FacilityId,
                                   (case d.Gender when 'F' then 'Female' when 'M' then 'Male' end) as Gender,
                                   d.DOB                                                           as DOB,
                                   coalesce(c.hei_enrolment_date, m.mch_enrolment_date)            as FirstEnrollmentAtMnch,
                                   coalesce(c.hei_encounter_id, m.mch_encounter_id,r.fup_encounter_id)  as EncounterId,
                                   d.occupation                                                    as Occupation,
                                   d.marital_status                                                as MaritalStatus,
                                   d.education_level                                               as EducationLevel,
                                   a.county                                                        as PatientResidentCounty,
                                   a.sub_county                                                    as PatientResidentSubCounty,
                                   a.ward                                                          as PatientResidentWard,
                                   (case e.in_school when 1 then 'Yes' when 2 then 'No' end)       as Inschool,
                                   d.date_created                                                  as Date_Created,
                                   d.date_last_modified                                            as Date_Last_Modified,
                                  d.voided                                                             as Voided	
         from dwapi_etl.etl_patient_demographics d	
         left join (select m.patient_id,	
         min(date(m.visit_date))                                  as mch_enrolment_date,	
         mid(min(concat(date(m.visit_date), m.encounter_id)), 11) as mch_encounter_id	
         from dwapi_etl.etl_mch_enrollment m	
         group by m.patient_id) m on d.patient_id = m.patient_id	
         left join (select c.patient_id,	
         min(date(c.visit_date))                                  as hei_enrolment_date,	
         mid(min(concat(date(c.visit_date), c.encounter_id)), 11) as hei_encounter_id	
         from dwapi_etl.etl_hei_enrollment c	
         group by c.patient_id) c on d.patient_id = c.patient_id	
         left join (select a.patient_id, a.county, a.sub_county, a.ward from dwapi_etl.etl_person_address a) a	
         on d.patient_id = a.patient_id	
         left join (select r.person_a, mid(min(concat(date(fup.visit_date), fup.encounter_id)), 11) as fup_encounter_id	
         from dwapi_etl.etl_patient_hiv_followup fup	
         inner join openmrs.relationship r on fup.patient_id = r.person_a	
         inner join openmrs.relationship_type t on r.relationship = t.relationship_type_id and	
         t.uuid in	
         ('8d91a210-c2cc-11de-8d13-0010c6dffd0f')	
         group by r.person_a) r on d.patient_id = r.person_a	
         left join (select e.patient_id as patient_id, e.in_school as in_school from dwapi_etl.etl_hiv_enrollment e) e	
         on d.patient_id = e.patient_id	
         inner join (select x.patient_id as patient_id,	
         x.sxFirstName,	
         x.sxLastname,	
         x.sxMiddleName,	
         x.dmFirstName,	
         x.dmLastName,	
         x.dmMiddleName,	
         x.Gender,	
         x.DOB,	
         CASE	
         WHEN locate(';', dmLastName) > 0 THEN CONCAT(	
         CAST(LEFT(Gender, 1) AS CHAR CHARACTER SET utf8),	
         CAST(sxFirstName AS CHAR CHARACTER SET utf8), CAST(	
         SUBSTRING(dmLastName, locate(';', dmLastName) + 1, LENGTH(dmLastName))	
         AS
         CHAR CHARACTER SET utf8),	
         CAST(LTRIM(RTRIM(DATE_FORMAT(DOB, '%Y'))) AS CHAR CHARACTER SET utf8)	
         )	
         ELSE CONCAT(	
         CAST(LEFT(Gender, 1) AS CHAR CHARACTER SET utf8),	
         CAST(sxFirstName AS CHAR CHARACTER SET utf8),	
         CAST(dmLastName AS CHAR CHARACTER SET utf8),	
         CAST(LTRIM(RTRIM(DATE_FORMAT(DOB, '%Y'))) AS CHAR CHARACTER SET utf8)	
         )	
         END      AS PKV	
         from (SELECT patient_id,	
         SOUNDEX(UPPER(REPLACE(given_name, '0', 'O')))                           AS sxFirstName,	
         SOUNDEX(UPPER(REPLACE(family_name, '0', 'O')))                          AS sxLastName,	
         SOUNDEX(UPPER(REPLACE(middle_name, '0', 'O')))                          AS sxMiddleName,	
         fn_getPatientNameDoubleMetaphone(UPPER(REPLACE(given_name, '0', 'O')))  AS dmFirstName,	
         fn_getPatientNameDoubleMetaphone(UPPER(REPLACE(family_name, '0', 'O'))) AS dmLastName,	
         fn_getPatientNameDoubleMetaphone(UPPER(REPLACE(middle_name, '0', 'O'))) AS dmMiddleName,	
         Gender,	
         DOB	
         FROM dwapi_etl.etl_patient_demographics) x) pkv on pkv.patient_id = d.patient_id
         join kenyaemr_etl.etl_default_facility_info i	
         where m.patient_id is not null	
         or c.patient_id is not null	
         or r.person_a is not null	
         group by EncounterId"|TempPatientMnchExtract|1|PatientMnchExtract|19|a6221aa4-0e85-11e8-ba89-0ed5f89f718b
82651214-9db2-11eb-a8b3-0242ac130003|Mnch Enrolment|MNCH|a6221856-0e85-11e8-ba89-0ed5f89f718b|"select distinct d.patient_id            as PatientPK,
                                                       if(m.patient_id is not null, m.muuid, if(c.patient_id is not null, c.cuuid, null))   RecordUUID,
                                                              i.siteCode                                                                   as SiteCode,
                                                              d.openmrs_id                                                                 as PatientMnchID,
                                                           # d.hei_no                                                                     as PatientHEI_ID,
                                                              'KenyaEMR'                                                                   as Emr,
                                                              'Kenya HMIS II'                                                              as Project,
                                                              i.FacilityName                                                               as FacilityName,
                                                              0 as FacilityId,
                                                              (case m.service_type
                                                                 when 1622 then 'ANC'
                                                                 when 164835 then 'Delivery'
                                                                 when 1623 then 'PNC'
                                                                 else '' end)                                                              as ServiceType,
                                                              coalesce(c.hei_enrolment_date, m.mch_enrollment_date)                        as EnrollmentDateAtMnch,
                                                              m.anc_number                                                                 as MnchNumber,
                                                              m.first_anc_visit                                                            as FirstVisitAnc,
                                                              m.parity                                                                     as Parity,
                                                              m.gravida                                                                    as Gravidae,
                                                              m.lmp                                                                        as LMP,
                                                              coalesce(m.edd, date_add(date_add(m.lmp, interval 7 day), interval 9 month)) as EDDFromLMP,
                                                              (case m.hiv_status_before_anc
                                                                 when 664 then 'Negative'
                                                                 when 703 then 'Positive'
                                                                 when 1067 then 'Unknown'
                                                                 else '' end)                                                              as HIVStatusBeforeANC,
                                                              m.test_date                                                                  as HIVTestDate,
                                                              (case m.partner_status
                                                                 when 664 then 'Negative'
                                                                 when 703 then 'Positive'
                                                                 when 1067 then 'Unknown'
                                                                 else '' end)                                                              as PartnerHIVStatus,
                                                              m.partner_test_date                                                          as PartnerHIVTestDate,
                                                              (case m.blood_group
                                                                 when 690 then 'A POSITIVE'
                                                                 when 692 then 'A NEGATIVE'
                                                                 when 694 then 'B POSITIVE'
                                                                 when 696 then 'B NEGATIVE'
                                                                 when 699 then 'O POSITIVE'
                                                                 when 701 then 'O NEGATIVE'
                                                                 when 1230 then 'AB POSITIVE'
                                                                 when 1231 then 'AB NEGATIVE'
                                                                 else '' end)                                                              as BloodGroup,
                                                              coalesce(m.status_in_mnch, c.status_in_cwc)                                  as StatusAtMnch,
                                                               m.date_created                                                               as Date_Created,	
                                                              m.date_last_modified                                                         as Date_Last_Modified,	
                                                             if(m.patient_id is not null, m.mvoided, if(c.patient_id is not null, cvoided, null)) as Voided	
                                                      from dwapi_etl.etl_patient_demographics d	
                                                               left join (select m.patient_id,	
                           m.uuid                  as muuid,	
                           m.service_type          as service_type,	
                           m.visit_date            as mch_enrollment_date,	
                           m.anc_number            as anc_number,	
                           m.first_anc_visit_date  as first_anc_visit,	
                           m.parity                as parity,	
                           m.gravida               as gravida,	
                           m.lmp,	
                           m.edd_ultrasound        as edd,
                                             m.hiv_status            as hiv_status_before_anc,	
                           m.hiv_test_date         as test_date,	
                           m.partner_hiv_status    as partner_status,	
                           m.partner_hiv_test_date as partner_test_date,	
                           m.blood_group           as blood_group,	
                           p.status_in_prg         as status_in_mnch,	
                           m.date_created          as date_created,	
                           m.date_last_modified    as date_last_modified,	
                           m.voided                as mvoided	
                           from dwapi_etl.etl_mch_enrollment m	
                           left join (select p.patient_id                                              as prg_patient,	
                                          p.date_enrolled                                           as date_enrolled,	
                                          if(p.date_completed is null, 'Active', 
                                             (case d.discontinuation_reason	
                                              when 160035 then 'Completed'	
                                              when 159492
                                           then 'Transferred Out'	
                                              when 160034 then 'Died'	
                                              when 5240	
                                                  then 'Lost to Follow up'	
                                              else '' end)) as status_in_prg	
                                               from dwapi_etl.etl_patient_program p	
                                                        left join dwapi_etl.etl_patient_program_discontinuation d	
                                                                  on p.patient_id = d.patient_id and p.date_completed = date(d.visit_date)	
                                               where p.program = 'MCH-Mother Services') p	
                                              on m.patient_id = p.prg_patient and m.visit_date = p.date_enrolled	
                           group by m.patient_id, m.visit_date,date_enrolled, discontinuation_reason,
                           uuid , service_type, visit_date , anc_number, first_anc_visit_date, parity , gravida, lmp, edd_ultrasound , hiv_status,
                           hiv_test_date, partner_hiv_status, partner_hiv_test_date, blood_group, status_in_prg, date_created, date_last_modified,
                               voided) m on d.patient_id = m.patient_id	
                           left join (
                           select c.patient_id,
                                  c.uuid          as cuuid,	
                                  c.visit_date    as hei_enrolment_date,	
                                  p.status_in_prg as status_in_cwc,	
                                  c.voided        as cvoided	
                               from dwapi_etl.etl_hei_enrollment c	
                                left join (select p.patient_id          as prg_patient,	
                                          p.date_enrolled       as date_enrolled,	
                                          d.discontinuation_reason,	
                                          if(p.date_completed is null, 'Active',	
                                             (case d.discontinuation_reason	
                                                  when 1267 then 'Completed'	
                                                  when 159492 then 'Transferred Out'	
                                                  when 160034 then 'Died'	
                                                  when 5240 then 'Lost to Follow up'	
                                                  else '' end)) as status_in_prg	
                                                   from dwapi_etl.etl_patient_program p	
                                left join dwapi_etl.etl_patient_program_discontinuation d	
                                                      on p.patient_id = d.patient_id and p.date_completed = date(d.visit_date)	
                                   where p.program = 'MCH-Child Services') p	
                                  on c.patient_id = p.prg_patient and c.visit_date = p.date_enrolled	
                                   group by c.patient_id, c.visit_date, date_enrolled, prg_patient, discontinuation_reason,
                                    uuid, status_in_prg, voided
                                   ) c on d.patient_id = c.patient_id	
                                                               join kenyaemr_etl.etl_default_facility_info i	
                                                      where m.patient_id is not null	
                                                         or c.patient_id is not null"|TempMnchEnrolmentExtract|0|MnchEnrolmentExtract|20|a6221aa4-0e85-11e8-ba89-0ed5f89f718b
82651386-9db2-11eb-a8b3-0242ac130003|Mnch Art|MNCH|a6221856-0e85-11e8-ba89-0ed5f89f718b|"select d.patient_id                                                                        as PatientPK,
                        de.uuid                                                                               RecordUUID,
                                           i.siteCode                                                                          as SiteCode,
                                           d.openmrs_id                                                                        as PatientMnchID,
                                           d.hei_no                                                                            as PatientHeiID,
                                           '' as Pkv,
                                           d.unique_patient_no                                                                 as PatientID,
                                           'KenyaEMR'                                                                          as Emr,
                                           'Kenya HMIS II'                                                                     as Project,
                                           i.FacilityName                                                                      as FacilityName,
                                           0 as FacilityId,
                                           e.date_first_enrolled_in_care                                                       as RegistrationAtCCC,
                                           least(ifnull(mid(min(concat(e.visit_date, e.date_started_art_at_transferring_facility)), 11),
                                           de.date_started_art + interval rand()*1000 year), de.date_started_art) as StartARTDate,
                                           m.ti_care_facility                                                                    as FacilityReceivingARTCare,
                                           de.start_regimen                                                                    as StartRegimen,
                                           de.start_regimen_line                                                               as StartRegimenLine,
                                           if(p.patient_id is null, 'ACTIVE', p.status_at_ccc)                                 as StatusAtCCC,
                                           de.last_art_date                                                                    as LastARTDate,
                                           de.last_art_date                                                                      as DateStartedCurrentRegimen,
                                           de.last_regimen                                                                     as LastRegimen,
                                           de.last_regimen_line                                                                as LastRegimenLine,
                                           de.Date_Created                                                                       as Date_Created,
                                           de.Date_Last_Modified                                                                 as Date_Last_Modified,
                                          de.voided                                                                             as Voided
                                          from dwapi_etl.etl_patient_demographics d	
                     left join (select m.patient_id,	
                     m.uuid,	
                     min(m.visit_date) as first_mch_enrolment_date,	
                     m.ti_care_facility,	
                     m.ti_curent_regimen,	
                     m.ti_date_started_art,	
                     m.date_last_modified,	
                     m.voided	
                     from dwapi_etl.etl_mch_enrollment m	
                     group by m.patient_id) m on d.patient_id = m.patient_id	
                     left join (select c.patient_id, min(c.visit_date) as first_hei_enrolment_date, c.date_last_modified	
                     from dwapi_etl.etl_hei_enrollment c	
                     group by c.patient_id) c on d.patient_id = c.patient_id	
                     left join (select e.patient_id,	
                     e.uuid,	
                     e.visit_date,	
                     e.date_started_art_at_transferring_facility,	
                     least(min(e.visit_date), mid(min(concat(e.visit_date,	
                     coalesce(e.date_first_enrolled_in_care, date('9999-12-31')))),
                     11)) as date_first_enrolled_in_care,	
                     e.date_last_modified,	
                     e.voided	
                     from dwapi_etl.etl_hiv_enrollment e	
                     group by e.patient_id) e on d.patient_id = e.patient_id	
                     left join (select de.patient_id,	
                     de.uuid as uuid,	
                     min(de.date_started)                                   as date_started_art,	
                     mid(min(concat(de.date_started, de.regimen_name)), 11) as start_regimen,	
                     mid(min(concat(de.date_started, de.regimen_line)), 11) as start_regimen_line,	
                     mid(max(concat(de.date_started, de.regimen_name)), 11) as last_regimen,	
                     max(de.date_started)                                   as last_art_date,	
                     mid(max(concat(de.date_started, de.regimen_line)), 11) as last_regimen_line,	
                     de.date_created                                        as Date_Created,	
                     de.date_last_modified                                  as Date_Last_Modified,	
                     de.voided as Voided
                     from dwapi_etl.etl_drug_event de where de.program = 'HIV'	
                     group by de.patient_id) de on d.patient_id = de.patient_id	
                     left join (select p.patient_id,	
                     max(date(p.visit_date))                                                    as latest_disc,	
                     mid(max(concat(date(p.visit_date), (case p.discontinuation_reason	
                     when 159492 then 'TransferOut'	
                     when 5240 then 'LTFU'	
                     when 160034 then 'Dead'	
                     when 5622 then 'OTHER' end))), 11) as status_at_ccc,	
                     date_last_modified	
                     from dwapi_etl.etl_patient_program_discontinuation p	
                     group by p.patient_id	
                     having mid(max(concat(date(p.visit_date), p.program_name)), 11) = 'HIV') p	
                     on d.patient_id = p.patient_id	
                     join kenyaemr_etl.etl_default_facility_info i	
                     where (m.patient_id is not null	
                     and e.patient_id is not null)	
                     or (m.patient_id is not null and	
                     (m.ti_date_started_art is not null or m.ti_care_facility is not null or m.ti_curent_regimen is not null))	
                     or (c.patient_id is not null and e.patient_id is not null)	
                     group by d.patient_id"|TempMnchArtExtract|0|MnchArtExtract|21|a6221aa4-0e85-11e8-ba89-0ed5f89f718b
82651494-9db2-11eb-a8b3-0242ac130003|Anc Visit|MNCH|a6221856-0e85-11e8-ba89-0ed5f89f718b|"select d.patient_id                                                                             PatientPK,
                                                                   a.uuid        as RecordUUID,
                                                                   i.siteCode                                                                               SiteCode,
                                                                   d.openmrs_id                                                                             PatientMnchID,
                                                                   'KenyaEMR'                                                                               Emr,
                                                                   'Kenya HMIS II'                                                                          Project,
                                                                   i.facilityName                                                                           FacilityName,
                                                                   0 																						FacilityId,
                                                                   a.visit_id                                                                               VisitID,
                                                                   a.visit_date                                                                             VisitDate,
                                                                   e.anc_number                                                                             ANCClinicNumber,
                                                                   a.anc_visit_number                                                                       ANCVisitNo,
                                                                   a.maturity                                                                               GestationWeeks,
                                                                   round(a.height, 2)                                                                                 Height,
                                                                   round(a.weight, 2)                                                                                Weight,
                                                                   round(a.temperature, 1)                                                                           Temp,
                                                                   a.pulse_rate                                                                             PulseRate,
                                                                   a.respiratory_rate                                                                       RespiratoryRate,
                                                                   a.oxygen_saturation                                                                      OxygenSaturation,
                                                                   a.muac                                                                                   MUAC,
                                                                   concat_ws('/', a.systolic_bp, a.diastolic_bp)                                            BP,
                                                                   case a.breast_exam_done when 1065 then 'Yes' when 1066 then 'No' end                     BreastExam,
                                                                   case a.anc_exercises when 1065 then 'Yes' when 1066 then 'No' end                        AntenatalExercises,
                                                                   (case a.fgm_done when 1065 then 'Yes' when 1066 then 'No' end)                           FGM,
                                                                   (case a.fgm_complications
                                                                   when 122949 then 'Scarring'
                                                                   when 136308 then 'Keloids'
                                                                   when 141615 then 'dyspaneuria'
                                                                   when 111633 then 'UTI' end)                                                              FGMComplications,
                                                                   a.hemoglobin                                                                             Haemoglobin,
                                                                   (case a.diabetes_test
                                                                   when 664 then 'No Diabetes'
                                                                   when 703 then 'Has Diabetes'
                                                                   when 160737 then 'Not Done' end)                                                         DiabetesTest,
                                                                   case a.tb_screening
                                                                   when 1660 then 'NO signs'
                                                                   when 142177 then 'TB presumed'
                                                                   when 164128 then 'No signs and started on INH'
                                                                   when 1662 then 'TB Rx'
                                                                   when 160737
                                                                   then 'Not done (ND)' end                                                       TBScreening,
                                                                   case a.cacx_screening
                                                                   when 664 then 'Normal'
                                                                   when 159393 then 'Presumed'
                                                                   when 703 then 'Confirmed'
                                                                   when 1118 then 'Not Done'
                                                                   when 1175
                                                                   then 'N/A' end                                                                 CACxScreen,
                                                                   case a.cacx_screening_method
                                                                   when 885 then 'Pap Smear'
                                                                   when 162816 then 'VIA'
                                                                   when 164977 then 'VILI'
                                                                   when 5622
                                                                                       then 'Other' end                                                               CACxScreenMethod,
                                                                   case a.who_stage
                                                                   when 1204 then 1
                                                                   when 1205 then 2
                                                                   when 1206 then 3
                                                                   when 1207
                                                                                       then 4 end                                                                     WHOStaging,
                                                                   case a.vl_sample_taken when 856 then 'Yes' when 1066 then 'No' end                       VLSampleTaken,
                                                                   if(a.vl_sample_taken = 856, a.visit_date, '')                                            VLDate,
                                                                   coalesce(a.viral_load, a.ldl)                                                            VLResult,
                                                                   case a.syphilis_treated_status
                                                                   when 1065 then 'Yes'
                                                                   when 1066 then 'No'
                                                                   else 'NA' end                                                                          SyphilisTreatment,
                                                                   case e.hiv_status
                                                                   when 703 then 'KP'
                                                                  when 1067 then 'Unknown'
                                                                  when 664
                                                                   then 'Negative' end                                                            HIVStatusBeforeANC,
                                                                   if(a.final_test_result is not null or a.test_1_result is not null or a.test_2_result is not null, 'Yes',
                                                                   'No')                                                                                 HIVTestingDone,
                                                                   'Initial'                                                                                     HIVTestType,
                                                                   a.test_1_kit_lot_no                                                                      HIVTest1,
                                                                   a.test_1_result                                                                          HIVTest1Result,
                                                                   a.test_2_kit_lot_no                                                                      HIVTest2,
                                                                   ''                                                                                       HIVTest2Result,
                                                                   a.final_test_result                                                                      HIVTestFinalResult,
                                                                   case a.syphilis_test_status
                                                                   when 1229 then 'Yes'
                                                                   when 1228 then 'Yes'
                                                                   when 1271 then 'Yes'
                                                                   when 1402 then 'ND'
                                                                   when 1304 then 'Yes'
                                                                   else 'No' end                                                                          SyphilisTestDone,
                                                                   ''                                                                                       SyphilisTestType,
                                                                   case a.syphilis_test_status
                                                                   when 1229 then 'Negative'
                                                                   when 1228 then 'Positive'
                                                                   else 'N/A' end                                                                         SyphilisTestResults,
                                                                   case a.syphilis_treated_status
                                                                   when 1065 then 'Yes'
                                                                   when 1066 then 'No'
                                                                   else 'NA' end                                                                          SyphilisTreated,
                                                                   case a.prophylaxis_given
                                                                   when 105281 then 'Yes'
                                                                   when 74250 then 'Yes'
                                                                   when 1107 then 'No'
                                                                   else 'N/A' end                                                                      MotherProphylaxisGiven,
                                                                   a.date_given_haart                                                                       MotherGivenHAART,
                                                                   a.date_given_haart                                                                  DateMotherStartedHAART,
                                                                   case a.baby_azt_dispensed
                                                                   when 160123 then 'Yes'
                                                                   when 1066 then 'No'
                                                                   when 1175
                                                                   then 'NA' end                                                                  AZTBabyDispense,
                                                                   case a.baby_nvp_dispensed
                                                                   when 80586 then 'Yes'
                                                                   when 1066 then 'No'
                                                                   when 1175
                                                                   then 'NA' end                                                                  NVPBabyDispense,
                                                                   group_concat(case ci.chronic_illness
                                                                   when 149019 then 'Alzheimers Disease and other Dementias'
                                                                   when 148432 then 'Arthritis'
                                                                   when 153754 then 'Asthma'
                                                                   when 159351 then 'Cancer'
                                                                   when 119270 then 'Cardiovascular diseases'
                                                                   when 120637 then 'Chronic Hepatitis'
                                                                   when 145438 then 'Chronic Kidney Disease'
                                                                   when 1295 then 'Chronic Obstructive Pulmonary Disease(COPD)'
                                                                   when 120576 then 'Chronic Renal Failure'
                                                                   when 119692 then 'Cystic Fibrosis'
                                                                   when 120291 then 'Deafness and Hearing impairment'
                                                                   when 119481 then 'Diabetes'
                                                                   when 118631 then 'Endometriosis'
                                                                   when 117855 then 'Epilepsy'
                                                                   when 117789 then 'Glaucoma'
                                                                   when 139071 then 'Heart Disease'
                                                                   when 115728 then 'Hyperlipidaemia'
                                                                   when 117399 then 'Hypertension'
                                                                   when 117321 then 'Hypothyroidism'
                                                                   when 151342 then 'Mental illness'
                                                                   when 133687 then 'Multiple Sclerosis'
                                                                   when 115115 then 'Obesity'
                                                                   when 114662 then 'Osteoporosis'
                                                                   when 117703 then 'Sickle Cell Anaemia'
                                                                   when 118976 then 'Thyroid disease'
                                                                     end SEPARATOR
                                                                   '|')                                                                        ChronicIllness,
                                                                   concat_ws('|', nullif(case a.counselled_on_birth_plans when 159758 then 'Birth plans' end, ''),
                                                                   nullif(case a.counselled_on_danger_signs
                                                                   when 159857 then 'Danger signs' end, ''), nullif(case a.counselled_on_family_planning
                                                                   when 156277 then 'Family planning'
                                                                     end, ''),
                                                                   nullif(case a.counselled_on_hiv when 1914 then 'HIV' end, ''),
                                                                   nullif(case a.counselled_on_supplimental_feeding
                                                                   when 159854
                                                                   then 'Supplimental feeding' end, ''),
                                                                   nullif(case a.counselled_on_breast_care when 159856 then 'Breast care' end, ''),
                                                                   nullif(case a.counselled_on_infant_feeding
                                                                   when 161651 then 'Infant feeding' end, ''), nullif(case a.counselled_on_treated_nets
                                                                   when 1381 then 'ITN'
                                                                   end,
                                                                   ''))               CounselledOn,
                                                                   (case a.hepatitis_b_screening
                                                                   when 703 then 'Positive'
                                                                   when 664 then 'Negative'
                                                                   when 160737 then 'Not Done' end)                                                    HepatitisBScreening,
                                                                   (case a.hepatitis_b_treatment when 1065 then 'Yes' when 1066 then 'No' end)              TreatedHepatitisB,
                                                                   case a.partner_hiv_tested
                                                                   when 1065 then 'Yes'
                                                                   when 1066 then 'No'
                                                                   else 'NA' end                                                                    PartnerHIVTestingANC,
                                                                   case a.partner_hiv_status
                                                                   when 703 then 'HIV Positive'
                                                                   when 664 then 'HIV Negative'
                                                                   when 1067
                                                                   then 'UNKNOWN' end                                                               PartnerHIVStatusANC,
                                                                   (case a.fp_method_postpartum
                                                                   when 5275 then 'IUD'
                                                                   when 159589 then 'Implants'
                                                                   when 1472 then 'BTL' end)                                                        PostParturmFP,
                                                                   a.deworming                                                                              Deworming,
                                                                   case a.intermittent_presumptive_treatment_given
                                                                              when 1065 then 'Yes'
                                                                              when 1066 then 'No'
                                                                              when 1175 then 'Not Applicable' end   as                                      MalariaProphylaxis,
                                                                   a.TTT                                                                                    TetanusDose,
                                                                   a.iron_supplement                                                                        IronSupplementsGiven,
                                                                   a.bed_nets                                                                               ReceivedMosquitoNet,
                                                                   concat_ws('|', nullif(case a.TTT when 'Yes' then 'Tetanus Toxoid' end, ''),
                                                                   nullif(case a.intermittent_presumptive_treatment_given when 1065 then 'Malaria Prophylaxis' end, ''),
                                                                   nullif(case a.iron_supplement when 'Yes' then 'Folate / Iron ' end, ''),
                                                                   nullif(case a.deworming_done_anc when 'Yes' then 'Mebendazole' end, ''), nullif(case a.counselled_on_treated_nets
                                                                      when 1381
                                                                          then 'Long-Lasting Insecticidal Net' end,
                                                                  '')) as PreventiveServices,
                                                                   (case a.intermittent_presumptive_treatment_given	
                                                                       when 1065 then 'Yes'	
                                                                       when 1066 then 'No'	
                                                                       when 1175	
                                                                       then 'Not Applicable' end)                                                          as PresumptiveTreatmentGiven,
                                                                   (case a.intermittent_presumptive_treatment_dose	
                                                                       when 1 then 'First Dose'	
                                                                       when 2 then 'Second Dose'	
                                                                       when 3 then 'Third Dose'	
                                                                       when 4 then 'Fourth Dose'	
                                                                       when 5 then 'Fifth Dose'	
                                                                       when 6 then 'Sixth Dose'	
                                                                       when 7 then 'Seventh Dose'	
                                                                       when 0	
                                                                       then 'No' end)                                                                       as PresumptiveTreatmentDose,
                                                                   (case a.minimum_care_package when 1065 then 'Yes' when 1066 then 'No' end)                  MiminumPackageOfCareReceived,
                                                                   a.minimum_package_of_care_services                                                       as MiminumPackageOfCareServices,
                                                                   if(a.urine_microscopy is not null or a.urinary_albumin is not null or a.glucose_measurement is not null
                                                                   or a.urine_ph is not null or a.urine_gravity is not null or a.urine_nitrite_test is not null
                                                                   or a.urine_dipstick_for_blood is not null or a.urine_leukocyte_esterace_test is not null or
                                                                   a.urinary_ketone is not null
                                                                   or a.urine_bile_pigment_test is not null or a.urine_bile_salt_test is not null or
                                                                   a.urine_colour is not null or a.urine_turbidity is not null, 'Yes',
                                                                   'No')                                                                                 UrinalysisVariables,
                                                                   case a.referred_from
                                                                   when 1537 then 'Another Health Facility'
                                                                   when 163488 then 'Community Unit'
                                                                   when 1175 then 'N/A' END                                                               ReferredFrom,
                                                                   case a.referred_to
                                                                   when 1537 then 'Another Health Facility'
                                                                   when 163488 then 'Community Unit'
                                                                   when 1175 then 'N/A' END                                                            as ReferredTo,
                                                                   ''                                                                                       ReferralReasons,
                                                                   a.next_appointment_date                                                                  NextAppointmentANC,
                                                                   a.clinical_notes                                                                         ClinicalNotes,
                                                                   a.date_created                                                                           Date_Created,
                                                                   GREATEST(COALESCE(a.date_last_modified, e.date_last_modified, ci.date_last_modified),
                                                                                   COALESCE(a.date_last_modified, e.date_last_modified,
                                                                                                                       ci.date_last_modified))                as Date_Last_Modified,	
                                              a.voided                                  as                                 voided	
                                              from dwapi_etl.etl_patient_demographics d	
                                              join dwapi_etl.etl_mch_antenatal_visit a on d.patient_id = a.patient_id	
                                              left join dwapi_etl.etl_allergy_chronic_illness ci on a.visit_id = ci.visit_id	
                                              join dwapi_etl.etl_mch_enrollment e on d.patient_id = e.patient_id	
                                              join kenyaemr_etl.etl_default_facility_info i	
                                              where a.visit_id is not null	
                                              group by a.visit_id"|TempAncVisitExtract|0|AncVisitExtract|22|a6221aa4-0e85-11e8-ba89-0ed5f89f718b
826515fc-9db2-11eb-a8b3-0242ac130003|Mat Visit|MNCH|a6221856-0e85-11e8-ba89-0ed5f89f718b|"select d.patient_id                                                                      PatientPK,
                                                                                          	l.uuid                                                                  RecordUUID,
                                           i.siteCode                                                                        SiteCode,
                                           d.openmrs_id                                                                      PatientMnchID,
                                           'KenyaEMR'                                                                        Emr,
                                           'Kenya HMIS II'                                                                   Project,
                                           i.facilityName                                                                    FacilityName,
                                           0 as FacilityId,
                                           l.visit_id                                                                        VisitID,
                                           l.visit_date                                                                      VisitDate,
                                           l.admission_number                                                                AdmissionNumber,
                                           l.number_of_anc_visits                                                            ANCVisits,
                                           date(l.date_of_last_menstrual_period)                                             LMP,
                                           date(l.estimated_date_of_delivery)                                         EDD,
                                           l.date_of_delivery                                                                DateOfDelivery,
                                           l.duration_of_labor                                                               DurationOfDelivery,
                                           l.duration_of_pregnancy                                                           GestationAtBirth,
                                           case l.mode_of_delivery
                                                   when 1170 then 'Normal delivery'
                                                   when 1171 then 'CS'
                                                   when 1172 then 'Breech'
                                                   when 118159 then 'Assisted vaginal delivery' end                           ModeOfDelivery,
                                           case l.placenta_complete
                                                when 703 then 'Yes'
                                               when 664
                                                   then 'No'
                                               when 1501 then 'Baby born before arrival' end                                 PlacentaComplete,
                                          (case l.uterotonic_given
                                               when 81369 then 'Oxytocin'
                                               when 104590 then 'Carbetocin'
                                               when 1107
                                                   then 'None' end)                                                  UterotonicGiven,
                                          (case l.vaginal_examination
                                               when 132681 then 'Normal'
                                               when 5577 then 'Episiotomy'
                                               when 159264 then 'Vaginal Tear'
                                               when 118935 then 'FGM'
                                               when 139505 then 'Vaginal wart' end)                                  VaginalExamination,
                                          l.blood_loss                                                               BloodLoss,
                                          ''                                                                         BloodLossVisual,
                                           case l.condition_of_mother
                                                   when 160429 then 'Alive'
                                                   when 134612 then 'Dead' end                                                     ConditonAfterDelivery,
                                           (case maternal_death_audited when 1065 then 'Yes' when 1066 then 'No' end)          MaternalDeathAudited,
                                           ''                                                                         MaternalDeath,
                                           coalesce(case l.coded_delivery_complications
                                                   when 118744 then 'Eclampsia'
                                                   when 113195 then 'Ruptured Uterus'
                                                   when 115036 then 'Obstructed Labor'
                                                   when 228 then 'APH'
                                                   when 230 then 'PPH'
                                                   when 130 then 'Puerperal sepsis'
                                                   when 1067 then 'Uknown' end, l.other_delivery_complications)           DeliveryComplications,
                                           (case l.delivery_outcome
                                                       when 159913 then 1
                                                       when 159914 then 2
                                                       when 159915 then 3 end)                                                        NoBabiesDelivered,
                                           ''                                                                             as BabyBirthNumber,
                                           case l.baby_sex when 1534 then 'Male' when 1535 then 'Female' end              as SexBaby,
                                           round(l.birth_weight, 2)                                                               as BirthWeight,
                                           case l.baby_condition
                                                   when 151849 then 'Live birth'
                                                   when 159916 then 'Fresh still birth'
                                                   when 135436 then 'Macerated still birth' end                                 as BirthOutcome,
                                           case l.birth_with_deformity
                                                   when 155871 then 'Yes'
                                                   when 1066 then 'No'
                                                   when 1175 then 'N/A' end                                                     as BirthWithDeformity,
                                           case l.teo_given
                                                   when 1 then 'Yes'
                                                   when 0 then 'No' end                                                    as TetracyclineGiven,
                                           case l.bf_within_one_hour when 1065 then 'Yes' when 1066 then 'No' end         as InitiatedBF,
                                           l.apgar_score_1min                                                             as ApgarScore1,
                                           l.apgar_score_5min                                                             as ApgarScore5,
                                           l.apgar_score_10min                                                            as ApgarScore10,
                                           (case l.kangaroo_mother_care_given
                                                       when 1065 then 'Yes'
                                                       when 1066 then 'No'
                                                       when 1175
                                                           then 'N/A' end)                                                as KangarooCare,
                                                  (case l.chlohexidine_applied_on_code_stump
                                                       when 1065 then 'Yes'
                                                       when 1066
                                                           then 'No' end)                                                 as ChlorhexidineApplied,
                                                  (case l.vitamin_K_given when 1065 then 'Yes' when 1066 then 'No' end)   as VitaminKGiven,
                                           case c.baby_status when 163016 then 'Alive' when 160432 then 'Dead' end        as StatusBabyDischarge,
                                           c.discharge_date                                                               as MotherDischargeDate,
                                           (case l.vdrl_rpr_results
                                                       when 703 then 'Positive'
                                                       when 664 then 'Negative'
                                                       when 1118
                                                           then 'Not Done' end)                                           as SyphilisTestResults,
                                           ''                                                                             as HIVStatusLastANC,                        
                                           if(l.final_test_result is not null, 'Yes', 'No')                        as HIVTestingDone,
                                                 l.test_1_kit_name                                                       as HIVTest1,
                                                 l.test_1_result                                                         as HIV1Results,
                                                 l.test_2_kit_name                                                       as HIVTest2,
                                                         ''                                                              as HIV2Results,
                                                 l.final_test_result                                                     as HIVTestFinalResult,
                                                  (case l.mother_on_haart_during_anc
                                                       when 1065 then 'Yes'
                                                       when 1066 then 'No'
                                                       when 1067 then 'N/A'
                                                       else '' end)                                                          OnARTANC,
                                                  (case l.mother_started_haart_at_maternity
                                                       when 1065 then 'Yes'
                                                       when 1066 then 'No'
                                                       when 1067 then 'N/A' end)                                             OnARTMat,
                                           if(l.baby_nvp_dispensed = 1 or l.baby_azt_dispensed = 1, 'Yes', 'No') as BabyGivenProphylaxis,
                                           case l.prophylaxis_given
                                                   when 105281 then 'Yes'
                                                   when 1107 then 'No'
                                                   else '' end                                                                  as MotherGivenCTX,
                                           case l.partner_hiv_tested when 1065 then 'Yes' when 1066 then 'No' end         as PartnerHIVTestingMAT,
                                           case l.partner_hiv_status
                                                   when 703 then 'HIV Positive'
                                                   when 664 then 'HIV Negative'
                                                   when 1067 then 'Unknown' end                                                 as PartnerHIVStatusMAT,
                                        concat_ws('|', nullif(case l.counseling_on_infant_feeding 
                                           when 1065 then 'Infant feeding' end, ''),
                                                        '')                                                           as CounselledOn,
                                       #  concat_ws('|', nullif(case l.counseling_on_infant_feeding when 1065 then 'Infant feeding' end, ''), ''),
                                            case
                                                      when 1537 then 'Another Health Facility'
                                                      when 163488 then 'Community Unit'
                                                      when 1175
                                                          then 'N/A' END                                                  as ReferredFrom,
                                                  case c.referred_to
                                                      when 1537 then 'Another Health Facility'
                                                      when 163488 then 'Community Unit'
                                                      when 1175
                                                          then 'N/A' END                                                  as ReferredTo,
                                           l.reason_for_referral                                                      ReferralReason,
                                           l.clinical_notes                                                               as ClinicalNotes,
                                           l.date_created                                                                    Date_Created,
                                           GREATEST(COALESCE(l.date_last_modified, e.date_last_modified, c.date_last_modified),
                                                                               COALESCE(l.date_last_modified, e.date_last_modified,
                                               c.date_last_modified))                                       as Date_Last_Modified,
                                                l.voided                                                                as Voided	
                  from dwapi_etl.etl_patient_demographics d	
                  join dwapi_etl.etl_mchs_delivery l on d.patient_id = l.patient_id	
                  left join dwapi_etl.etl_mchs_discharge c on d.patient_id = c.patient_id	
                  join dwapi_etl.etl_mch_enrollment e on d.patient_id = e.patient_id	
                  left join (select v.patient_id, mid(max(concat(v.visit_date, v.anc_visit_number)), 11) as anc_visits	
                  from dwapi_etl.etl_mch_antenatal_visit v	
                  group by v.patient_id) v on d.patient_id = v.patient_id	
                  join kenyaemr_etl.etl_default_facility_info i	
                  where l.visit_id is not null	
                  group by l.visit_id"|TempMatVisitExtract|0|MatVisitExtract|23|a6221aa4-0e85-11e8-ba89-0ed5f89f718b
82651750-9db2-11eb-a8b3-0242ac130003|Pnc Visit|MNCH|a6221856-0e85-11e8-ba89-0ed5f89f718b|"select d.patient_id                                                                       PatientPK,
                                              p.uuid                                                                          RecordUUID,
                                                                       i.siteCode                                                                         SiteCode,
                                                                       d.openmrs_id                                                                       PatientMnchID,
                                                                       'KenyaEMR'                                                                         Emr,
                                                                       'Kenya HMIS II'                                                                    Project,
                                                                       i.facilityName                                                                     FacilityName,
                                                                       0 																																																															as FacilityId,
                                                                       p.visit_id                                                                         VisitID,
                                                                       p.visit_date                                                                       VisitDate,
                                                                       p.pnc_register_no                                                                  PNCRegisterNumber,
                                                                       p.pnc_visit_no                                                                     PNCVisitNo,
                                                                       (case p.visit_timing_mother
                                                                       when 1721 then '0-48 Hours'
                                                                       when 1722 then '3 days - 6 weeks'
                                                                       when 1723 then 'More than 6 weeks' end)                                       VisitTimingMother,
                                                                       (case p.visit_timing_baby
                                                                       when 167012 then '0-48 Hours'
                                                                       when 167013 then '3 days - 6 weeks'
                                                                       when 167015 then 'More than 6 weeks' end)                                     VisitTimingBaby,
                                                                       p.delivery_date                                                                    DeliveryDate,
                                                                       case p.mode_of_delivery
                                                                               when 1170 then 'Normal delivery'
                                                                               when 1171 then 'CS'
                                                                               when 1172 then 'Breech'
                                                                               when 118159 then 'Assisted vaginal delivery' end                                 ModeOfDelivery,												
                                                                       case p.place_of_delivery
                                                                               when 1589 then 'Facility'
                                                                               when 1536 then 'Home'
                                                                               when 1601 then 'Born Before Arrival'
                                                                               when 5622 then 'Other' end                                                       PlaceOfDelivery,
                                                                       p.height                                                                           Height,
                                                                       p.weight                                                                           Weight,
                                                                       p.temperature                                                                      Temp,
                                                                       p.pulse_rate                                                                       PulseRate,
                                                                       p.respiratory_rate                                                                 RespiratoryRate,
                                                                       p.oxygen_saturation                                                                OxygenSaturation,
                                                                       p.muac                                                                             MUAC,
                                                                       concat_ws('/', p.systolic_bp, p.diastolic_bp)                                      BP,
                                                                       if(breast is not null, 'Yes', 'No')                                                BreastExam,
                                                                       case p.general_condition
                                                                               when 1855 then 'Good'
                                                                               when 162133 then 'Fair'
                                                                               when 162132 then 'Poor' end                                                   as GeneralCondition,
                                                                       case p.pallor when 1065 then 'Yes' when 1066 then 'No' end                      as HasPallor,
                                                                       (case p.pallor_severity
                                                                       when 1498 then 'Mild'
                                                                       when 1499 then 'Moderate'
                                                                       when 1500 then 'Severe'
                                                                       else '' end)  																	Pallor,
                                                                       case p.breast
                                                                               when 1115 then 'Normal'
                                                                               when 143242 then 'Cracked nipple'
                                                                               when 127522 then 'Engorged nipple'
                                                                               when 115915 then 'Mastitis' end                                                  Breast,
                                                                       case p.pph when 1065 then 'Present' when 1066 then 'Absent' end                 as PPH,
                                                                       case p.cs_scar
                                                                               when 147241 then 'Bleeding'
                                                                              when 1115 then 'Normal'
                                                                              when 156794 then 'Infected'
                                                                              when 145776 then 'Gapping'
                                                                               when 1175 then 'Not Applicable' end                                           as CSScar,
                                                                       case p.gravid_uterus
                                                                               when 162111 then 'On exam, uterine fundus 12-16 week size'
                                                                               when 162112 then 'On exam, uterine fundus 16-20 week size'
                                                                               when 162113 then 'On exam, uterine fundus 20-24 week size'
                                                                               when 162114 then 'On exam, uterine fundus 24-28 week size'
                                                                               when 162115 then 'On exam, uterine fundus 28-32 week size'
                                                                               when 162116 then 'On exam, uterine fundus 32-34 week size'
                                                                               when 162117 then 'On exam, uterine fundus 34-36 week size'
                                                                               when 162118 then 'On exam, uterine fundus 36-38 week size'
                                                                               when 123427 then 'Uterus Involuted' end                                       as UterusInvolution,
                                                                       case p.episiotomy
                                                                               when 159842 then 'Repaired'
                                                                               when 159843 then 'Healed'
                                                                               when 159841 then 'Gaping'
                                                                               when 113919 then 'Infected'
                                                                               when 1175 then 'Not Applicable' end                                           as Episiotomy,
                                                                       case p.lochia
                                                                               when 159721 then 'Normal'
                                                                               when 159846 then 'Foul smelling'
                                                                               when 159845 then 'Excessive' end                                              as Lochia,
                                                                       case p.fistula_screening
                                                                               when 1107 then 'None'
                                                                               when 49 then 'Vesicovaginal Fistula'
                                                                               when 127847 then 'Rectovaginal fistula'
                                                                               when 1118 then 'Not done' end                                                 as Fistula,
                                                                       ''                                                                                    as  MaternalComplications,
                                                                       (case tb.resulting_tb_status
                                                                           when 1660 then 'No TB Signs'
                                                                           when 142177 then 'Presumed TB'
                                                                           when 1662 then 'TB Confirmed'
                                                                           when 160737 then 'TB Screening Not Done'
                                                                           else '' end)                                                                                 TBScreening,
                                                                       if(p.cacx_screening in (664, 703, 159393), 'Yes', 'No')                         as ClientScreenedCACx,
                                                                       case p.cacx_screening_method
                                                                               when 885 then 'Pap Smear'
                                                                               when 162816 then 'VIA'
                                                                               when 164977 then 'VILI'
                                                                               when 5622 then 'Other' end                                                    as CACxScreenMethod,
                                                                       case p.cacx_screening
                                                                               when 664 then 'Norrmal'
                                                                               when 159393 then 'Presumed'
                                                                               when 703 then 'Confirmed'
                                                                               when 1118 then 'Not done'
                                                                               when 1175 then 'N/A' end                                                      as CACxScreenResults,
                                                                       case e.hiv_status
                                                                               when 703 then 'Positive'
                                                                               when 664 then 'Negative'
                                                                               when 1067 then 'Unknown' end                                                  as PriorHIVStatus,
                                                                       ''                                                                                      as MotherCameForHIVTest,
                                                                       (case p.infant_prophylaxis_timing
                                                                       when 1065 then 'Less than 6 weeks'
                                                                       when 1066 then 'Greater 6 weeks' end)                                         InfactCameForHAART,
                                                                       (case p.mother_haart_given
                                                                       when 1065 then 'Yes'
                                                                       when 1066 then 'No'
                                                                       when 1175 then 'N/A'
                                                                       when 164142 then 'Revisit'
                                                                       else '' end)                                                                  MotherGivenHAART,
                                                                       if(p.final_test_result is not null or p.test_1_result is not null or p.test_2_result is not null, 'Yes',
                                                                                   'No')                                                                           HIVTestingDone,
                                                                       p.test_1_kit_lot_no                                                                HIVTest1,
                                                                       p.test_1_result                                                                    HIVTest1Result,
                                                                       p.test_2_kit_lot_no                                                                HIVTest2,
                                                                       p.test_2_result                                                                    HIVTest2Result,
                                                                       p.final_test_result                                                                HIVTestFinalResult,
                                                                       if(p.baby_nvp_dispensed = 80586 or p.baby_azt_dispensed = 160123, 'Yes', 'No') as InfantProphylaxisGiven,
                                                                       if(p.prophylaxis_given in (105281, 74250), 'Yes', 'No')                         as MotherProphylaxisGiven,
                                                                       (case p.couple_counselled when 1065 then 'Yes' when 1066 then 'No' else '' end)    as CoupleCounselled,
                                                                       case p.partner_hiv_tested
                                                                               when 1065 then 'Yes'
                                                                               when 1066 then 'No'
                                                                               else 'N/A' end                                                                as PartnerHIVTestingPNC,
                                                                       case p.partner_hiv_status
                                                                               when 703 then 'Positive'
                                                                               when 664 then 'Negative'
                                                                               when 1067 then 'Unknown' end                                                  as PartnerHIVResultPNC,
                                                                       case p.family_planning_counseling
                                                                               when 1065 then 'Yes'
                                                                               when 1066 then 'No'
                                                                               else '' end                                                                   as CounselledOnFP,
                                                                       case p.family_planning_method
                                                                               when 160570 then 'Emergency contraceptive pills'
                                                                               when 780 then 'Oral Contraceptives Pills'
                                                                               when 5279 then 'Injectable'
                                                                               when 1359 then 'Implant'
                                                                               when 136163 then 'Lactational Amenorhea Method'
                                                                               when 5275 then 'Intrauterine Device'
                                                                               when 5278 then 'Diaphram/Cervical Cap'
                                                                               when 5277 then 'Fertility Awareness'
                                                                               when 1472 then 'Tubal Ligation/Female sterilization'
                                                                               when 190 then 'Condoms'
                                                                               when 1489 then 'Vasectomy(Partner)'
                                                                               when 162332 then 'Undecided'
                                                                               else '' end                                                                   as ReceivedFP,
                                                                       case p.iron_supplementation when 1065 then 'Yes' when 1066 then 'No' end        as HaematinicsGiven,
                                                                       (case p.delivery_outcome
                                                                                   when 159913 then 'Single'
                                                                                   when 159914 then 'Twins'
                                                                                   when 159915 then 'Triplets' end)                                             as DeliveryOutcome,
                                                                       case p.condition_of_baby
                                                                               when 1855 then 'Good'
                                                                               when 162133 then 'Poor'
                                                                               when 162132 then 'Died' end                                                   as BabyConditon,
                                                                       case p.baby_feeding_method
                                                                               when 5526 then 'Breastfed exclusively'
                                                                               when 1595 then 'Replacement feeding'
                                                                               when 6046 then 'Mixed feeding'
                                                                               when 159418 then 'Not at all sure' end                                        as BabyFeeding,
                                                                       case p.umblical_cord
                                                                           when 162122 then 'Neonatal umbilical stump clean'
                                                                           when 162123 then 'Neonatal umbilical stump not clean'
                                                                           when 162124 then 'Neonatal umbilical stump moist'
                                                                           when 162120 then 'Neonatal umbilical stump dry'
                                                                           when 162125 then 'Neonatal umbilical stump not healed'
                                                                           when 162126 then 'Neonatal umbilical stump healed' end                         as UmbilicalCord,
                                                                       case p.baby_immunization_started
                                                                           when 1065 then 'Yes'
                                                                           when 1066 then 'No'
                                                                           when 1067 then 'Unknown' end                                                   as Immunization,
                                                                       case p.counselled_on_infant_feeding
                                                                               when 1065 then 'Yes'
                                                                               when 1066
                                                                                                               then 'No' end                                                         as InfantFeeding,
                                                                       ps.preventive_services                                                             as PreventiveServices,
                                                                       case p.referred_from
                                                                               when 1537 then 'Another Health Facility'
                                                                               when 163488 then 'Community Unit'
                                                                               when 1175 then 'N/A' end                                                      as ReferredFrom,
                                                                       case p.referred_to
                                                                               when 1537 then 'Another Health Facility'
                                                                               when 163488 then 'Community Unit'
                                                                               when 1175 then 'N/A' end                                                      as ReferredTo,
                                                                       p.appointment_date                                                              as NextAppointmentPNC,
                                                                       p.clinical_notes                                                                as ClinicalNotes,
                                                                       p.date_created                                                                     Date_Created,
                                                                       p.date_last_modified                                                            as Date_Last_Modified,
                                                                        p.voided                                                                        as Voided
                                                               from dwapi_etl.etl_patient_demographics d
                                                                           inner join dwapi_etl.etl_mch_postnatal_visit p on d.patient_id = p.patient_id
                                                                           inner join (select e.patient_id, mid(max(concat(e.visit_date, e.hiv_status)), 11) as hiv_status
                                                                           from dwapi_etl.etl_mch_enrollment e
                                                                           group by e.patient_id) e on d.patient_id = e.patient_id							
                                                                   left join (select tb.patient_id, tb.resulting_tb_status, tb.visit_date
                                                                   from dwapi_etl.etl_tb_screening tb) tb
                                                                   on tb.patient_id = p.patient_id and tb.visit_date = p.visit_date
                                                                   left join (select ps.patient_id,
                                                                   ps.visit_date,
                                                                   group_concat(CONCAT_WS(',',
                                                                   if(DAYNAME(ps.malaria_prophylaxis_1) IS NOT NULL,
                                                                   'Malaria prohylaxis 1st dose', NULL),
                                                                   if(DAYNAME(ps.malaria_prophylaxis_2) IS NOT NULL,
                                                                   'Malaria prohylaxis 2nd dose', NULL),
                                                                   if(DAYNAME(ps.malaria_prophylaxis_3) IS NOT NULL,
                                                                   'Malaria prohylaxis 3rd dose', NULL),
                                                                   if(DAYNAME(ps.tetanus_taxoid_1) IS NOT NULL,
                                                                   'Tetanus Taxoid 1st dose', NULL),
                                                                   if(DAYNAME(ps.tetanus_taxoid_2) IS NOT NULL,
                                                                   'Tetanus Taxoid 2nd dose', NULL),
                                                                   if(DAYNAME(ps.tetanus_taxoid_3) IS NOT NULL,
                                                                   'Tetanus Taxoid 3rd dose', NULL),
                                                                   if(DAYNAME(ps.tetanus_taxoid_4) IS NOT NULL,
                                                                   'Tetanus Taxoid 4th dose', NULL),
                                                                   if(DAYNAME(ps.folate_iron_1) IS NOT NULL, 'Folate Iron 1st dose',
                                                                   NULL),
                                                                   if(DAYNAME(ps.folate_iron_2) IS NOT NULL, 'Folate Iron 2nd dose',
                                                                   NULL),
                                                                   if(DAYNAME(ps.folate_iron_3) IS NOT NULL, 'Folate Iron 3rd dose',
                                                                   NULL),
                                                                   if(DAYNAME(ps.folate_iron_4) IS NOT NULL, 'Folate Iron 4th dose',
                                                                   NULL),
                                                                   if(DAYNAME(ps.folate_1) IS NOT NULL, 'Folate 1st dose', NULL),
                                                                   if(DAYNAME(ps.folate_2) IS NOT NULL, 'Folate 2nd dose', NULL),
                                                                   if(DAYNAME(ps.folate_3) IS NOT NULL, 'Folate 3rd dose', NULL),
                                                                   if(DAYNAME(ps.folate_4) IS NOT NULL, 'Folate 4th dose', NULL),
                                                                   if(DAYNAME(ps.iron_1) IS NOT NULL, 'Iron 1st dose', NULL),
                                                                   if(DAYNAME(ps.iron_2) IS NOT NULL, 'Iron 2nd dose', NULL),
                                                                   if(DAYNAME(ps.iron_3) IS NOT NULL, 'Iron 3rd dose', NULL),
                                                                   if(DAYNAME(ps.iron_4) IS NOT NULL, 'Iron 4th dose', NULL),
                                                                   if(DAYNAME(ps.mebendazole) IS NOT NULL, 'Mebendazole', NULL),
                                                                   if(DAYNAME(ps.long_lasting_insecticidal_net) IS NOT NULL,
                                                                   'Long Lasting Insecticidal Net', NULL))) as preventive_services
                                                                   from dwapi_etl.etl_preventive_services ps
                                                                   group by ps.patient_id, ps.visit_date) ps
                                                                   on p.patient_id = ps.patient_id and p.visit_date = ps.visit_date
                                                               inner join kenyaemr_etl.etl_default_facility_info i
                                                               group by p.visit_id"|TempPncVisitExtract|0|PncVisitExtract|24|a6221aa4-0e85-11e8-ba89-0ed5f89f718b
82651886-9db2-11eb-a8b3-0242ac130003|Mother Baby Pair|MNCH|a6221856-0e85-11e8-ba89-0ed5f89f718b|"select r.child  as BabyPatientPK,
                            r.mother as MotherPatientPK,
                            r.uuid             RecordUUID,
                            r.mother as PatientPK,
                            i.siteCode          as SiteCode,
                            r.hei_id            as BabyPatientMncHeiID,
                            r.child_openmrs_id  as MotherPatientMncHeiID,
                            r.mother_ccc        as PatientIDCCC,
                            'KenyaEMR'          as Emr,
                            'Kenya HMIS II'     as Project,
                            i.FacilityName      as FacilityName,
                            0                   as FacilityId,
                            r.date_created     as Date_Created,
                            r.date_changed     as Date_Last_Modified,
                            convert(r.voided, SIGNED)        as Voided
from dwapi_etl.etl_patient_demographics d
inner join (select r.person_a as mother,
        r.uuid,
         m.mother_ccc,
         r.person_b as child,
         c.child_openmrs_id,
         c.hei_id,
         c.hei_enr_date,
         c.disc_hei,
         c.hei_disc_date,
         r.end_date as rel_end_date,
         r.date_created,
         r.date_changed,
            r.voided,
         m.latest_hiv_enrollment,
         m.disc_patient,
         m.hiv_disc_date
        
from openmrs.relationship r
inner join (select d.patient_id,
d.unique_patient_no                                   as mother_ccc,
d.openmrs_id                                          as mother_openmrs_id,
e.patient_id                                          as hiv_client,
e.latest_hiv_enrollment,
disc.patient_id                                       as disc_patient,
coalesce(disc.effective_disc, disc.latest_disc_visit) as hiv_disc_date	
from dwapi_etl.etl_patient_demographics d	
inner join (select e.patient_id, max(e.visit_date) as latest_hiv_enrollment	
from dwapi_etl.etl_hiv_enrollment e	
group by e.patient_id) e on d.patient_id = e.patient_id	
left join (select disc.patient_id,	
max(date(disc.visit_date)) as latest_disc_visit,	
mid(max(concat(date(disc.visit_date),	
date(disc.effective_discontinuation_date))),	
11)                    as effective_disc	
from dwapi_etl.etl_patient_program_discontinuation disc	
where disc.program_name = 'HIV'	
group by disc.patient_id) disc	
on e.patient_id = disc.patient_id	
where d.gender = 'F') m	
on m.patient_id = r.person_a	
inner join (select c.patient_id,	
c.dob,	
c.openmrs_id            as child_openmrs_id,	
c.hei_no                as hei_id,	
max(date(h.visit_date)) as hei_enr_date,	
disc.patient_id         as disc_hei,	
disc.latest_disc_visit  as hei_disc_date	
from dwapi_etl.etl_patient_demographics c	
inner join dwapi_etl.etl_hei_enrollment h on c.patient_id = h.patient_id	
left join (select disc.patient_id,	
max(date(disc.visit_date)) as latest_disc_visit	
from dwapi_etl.etl_patient_program_discontinuation disc	
where disc.program_name in ('MCH Child', 'MCH Child HEI')	
group by disc.patient_id) disc	
on h.patient_id = disc.patient_id	
group by c.patient_id) c	
on c.patient_id = r.person_b	
inner join openmrs.relationship_type t	
on r.relationship = t.relationship_type_id and	
t.uuid = '8d91a210-c2cc-11de-8d13-0010c6dffd0f'	
where (disc_hei is null or date(hei_enr_date) > date(hei_disc_date))	
and (disc_patient is null or date(latest_hiv_enrollment) > date(hiv_disc_date))	
and (r.end_date is null or date(r.end_date) > date(current_date))/* and r.voided = 0*/) r	
on r.child = d.patient_id	
join kenyaemr_etl.etl_default_facility_info i"|TempMotherBabyPairExtract|0|MotherBabyPairExtract|25|a6221aa4-0e85-11e8-ba89-0ed5f89f718b
826519c6-9db2-11eb-a8b3-0242ac130003|Cwc Enrolment|MNCH|a6221856-0e85-11e8-ba89-0ed5f89f718b|"select d.patient_id              as PatientPK,
                                    e.uuid                    RecordUUID,
                            d.openmrs_id              as PatientMNCH_ID,
                            i.siteCode                as SiteCode,
                            d.cwc_number              as PatientIDCWC,
                            0 																																																															as FacilityId,
                            d.hei_no                  as HEIID,
                            pkv.PKV                   as Pkv,
                            e.initial_reg_at_cwc      as RegistrationAtCWC,
                            e.child_exposed           as MothersPkv,
                            e.initial_reg_at_cwc      as RegistrationAtHEI,
                            'KenyaEMR'                as Emr,
                            'Kenya HMIS II'           as Project,
                            e.visit_id                as VisitID,
                            null      as Gestation,
                            round(e.birth_weight, 2)            as BirthWeight,
                            round(e.birth_length, 2)            as BirthLength,
                            e.birth_order             as BirthOrder,
                            e.birth_type              as BirthType,
                            e.place_of_delivery       as PlaceOfdelivery,
                            e.mode_of_delivery        as ModeOfDelivery,
                            e.has_special_needs       as SpecialNeeds,
                            e.reason_for_special_care as SpecialCare,
                            e.child_exposed           as HEI,
                            e.is_mother_alive         as MotherAlive,
                            e.mother_ccc_no           as MothersCCCNo,
                            e.mother_art_regimen      as ARTRegimenMother,
                            '' 						 as ARTMother,
                            null						 as ARTStartDateMother,
                            null as HEIDate,
                            e.transfer_in             as TransferIn,
                            e.trf_in_date             as TransferInDate,
                            e.facility_trf_from       as TransferredFrom,
                            e.nvp_during_bf           as NVP,
                            e.breast_feeding          as BreastFeeding,
                            e.referred_from           as ReferredFrom,
                                e.voided                  as Voided
    from kenyaemr_etl.etl_patient_demographics d
               inner join (select e.patient_id                                                             as patient_id,
             e.uuid                                                                   as uuid,
                               e.permanent_registration_serial                                          as permanent_reg_serial,
                               min(e.visit_date)                                                        as initial_reg_at_cwc,
                               case e.child_exposed
                                       when 822 then 'Yes'
                                       when 1066 then 'No'
                                       when 1067 then 'Unknown' end                                           as child_exposed,
                               e.visit_id                                                               as visit_id,
                               e.gestation_at_birth                                                     as gestation_at_birth,
                               e.birth_weight                                                           as birth_weight,
                               e.birth_length                                                           as birth_length,
                               e.birth_order                                                            as birth_order,
                               case e.birth_type
                                       when 159913 then 'Single'
                                       when 159914 then 'Twins'
                                       when 159915 then 'Triplets'
                                       when 113450 then 'Quadruplets'
                                       when 113440 then 'Quintuplets' end                                     as birth_type,
                               case e.place_of_delivery
                                       when 1589 then 'Facility'
                                       when 1536 then 'Home'
                                       when 5622 then 'Other' end                                             as place_of_delivery,
                               case e.mode_of_delivery
                                       when 1170 then 'SVD'
                                       when 1171 then 'C-Section' end                                         as mode_of_delivery,
                               case e.need_for_special_care
                                       when 161628 then 'Yes'
                                       when 1066 then 'No' end                                                as has_special_needs,
                               case e.reason_for_special_care
                                       when 116222 then 'Birth weight less than 2.5 kg'
                                       when 162071 then 'Birth less than 2 years after last birth'
                                       when 162072 then 'Fifth or more child'
                                       when 162073 then 'Teenage mother'
                                       when 162074 then 'Brother or sisters undernourished'
                                       when 162075 then 'Multiple births(Twins,triplets)'
                                       when 162076 then 'Child in family dead'
                                       when 1174 then 'Orphan'
                                       when 161599 then 'Child has disability'
                                       when 1859 then 'Parent HIV positive'
                                       when 123174
                                       then 'History/signs of child abuse/neglect' end                as reason_for_special_care,
                               case e.mother_alive when 1 then 'Yes' when 0 then 'No' else '' end       as is_mother_alive,
                               e.parent_ccc_number                                                      as mother_ccc_no,
                                case e.mother_drug_regimen	
                               when 792 then 'D4T/3TC/NVP'	
                               when 160124 then 'AZT/3TC/EFV'	
                               when 160104 then 'D4T/3TC/EFV'	
                               when 1652 then '3TC/NVP/AZT'	
                               when 161361 then 'EDF/3TC/EFV'	
                               when 104565 then 'EFV/FTC/TDF'	
                               when 162201 then '3TC/LPV/TDF/r'	
                               when 817 then 'ABC/3TC/AZT'	
                               when 162199 then 'ABC/NVP/3TC'	
                               when 162200 then '3TC/ABC/LPV/r'	
                               when 162565 then '3TC/NVP/TDF'	
                               when 1652 then '3TC/NVP/AZT'	
                               when 162561 then '3TC/AZT/LPV/r'	
                               when 164511 then 'AZT-3TC-ATV/r'	
                               when 164512 then 'TDF-3TC-ATV/r'	
                               when 162560 then '3TC/D4T/LPV/r'	
                               when 162563 then '3TC/ABC/EFV'	
                               when 162562 then 'ABC/LPV/R/TDF'	
                               when 162559	
                               then 'ABC/DDI/LPV/r' end                                                   as mother_art_regimen,
                               case e.transfer_in when 1065 then 'Yes' when 1066 then 'No' end          as transfer_in,
                               e.transfer_in_date                                                       as trf_in_date,
                               e.facility_transferred_from                                              as facility_trf_from,
                               e.mother_on_NVP_during_breastfeeding                                     as nvp_during_bf,
                               case e.mother_breastfeeding when 1065 then 'Yes' when 1066 then 'No' end as breast_feeding,
                               case e.referral_source
                                       when 160537 then 'Paediatric'
                                       when 160542 then 'OPD'
                                       when 160456 then 'Maternity'
                                       when 162050 then 'CCC'
                                       when 160538 then 'MCH/PMTCT'
                                       when 5622 then 'Other' end                                             as referred_from,
                               md.parent_pid as parent_pid,
                               e.date_created                                                           as Date_Created,	
                               e.date_last_modified                                                     as Date_Last_Modified,
                                e.voided                                                                 as Voided
            from dwapi_etl.etl_hei_enrollment e	
                                  left join (select d.patient_id as parent_pid, d.unique_patient_no as parent_ccc	
                                  from dwapi_etl.etl_patient_demographics d) md	
                                  on e.parent_ccc_number = md.parent_ccc	
                                  group by e.patient_id) e on d.patient_id = e.patient_id	
                                  left join (select x.patient_id as patient_id,	
                                  x.sxFirstName,	
                                  x.sxLastname,	
                                  x.sxMiddleName,	
                                  x.dmFirstName,	
                                  x.dmLastName,	
                                  x.dmMiddleName,	
                                  x.Gender,	
                                  x.DOB,	
                                  CASE	
                                  WHEN locate(';', dmLastName) > 0 THEN CONCAT(	
                                  CAST(LEFT(Gender, 1) AS CHAR CHARACTER SET utf8),	
                                  CAST(sxFirstName AS CHAR CHARACTER SET utf8), CAST(	
                                  SUBSTRING(dmLastName, locate(';', dmLastName) + 1, LENGTH(dmLastName))	
                                  AS	
                                  CHAR CHARACTER SET utf8),	
                                  CAST(LTRIM(RTRIM(DATE_FORMAT(DOB, '%Y'))) AS CHAR CHARACTER SET utf8)	
                                  )	
                                  ELSE CONCAT(	
                                  CAST(LEFT(Gender, 1) AS CHAR CHARACTER SET utf8),	
                                  CAST(sxFirstName AS CHAR CHARACTER SET utf8),	
                                  CAST(dmLastName AS CHAR CHARACTER SET utf8),	
                                  CAST(LTRIM(RTRIM(DATE_FORMAT(DOB, '%Y'))) AS CHAR CHARACTER SET utf8)	
                                  )	
                                  END      AS PKV	
                                  from (SELECT patient_id,	
                                  SOUNDEX(UPPER(REPLACE(given_name, '0', 'O')))                           AS sxFirstName,	
                                  SOUNDEX(UPPER(REPLACE(family_name, '0', 'O')))                          AS sxLastName,	
                                  SOUNDEX(UPPER(REPLACE(middle_name, '0', 'O')))                          AS sxMiddleName,	
                                  fn_getPatientNameDoubleMetaphone(UPPER(REPLACE(given_name, '0', 'O')))  AS dmFirstName,	
                                  fn_getPatientNameDoubleMetaphone(UPPER(REPLACE(family_name, '0', 'O'))) AS dmLastName,	
                                  fn_getPatientNameDoubleMetaphone(UPPER(REPLACE(middle_name, '0', 'O'))) AS dmMiddleName,	
                                  Gender,	
                                  DOB	
                                  FROM dwapi_etl.etl_patient_demographics) x) pkv on pkv.patient_id = e.parent_pid	
                                  join kenyaemr_etl.etl_default_facility_info i"|TempCwcEnrolmentExtract|0|CwcEnrolmentExtract|26|a6221aa4-0e85-11e8-ba89-0ed5f89f718b
82651ade-9db2-11eb-a8b3-0242ac130003|Cwc Visit|MNCH|a6221856-0e85-11e8-ba89-0ed5f89f718b|"select d.patient_id           as PatientPK,
                                                                                          	v.uuid                 RecordUUID,
                                                                                                                    i.siteCode             as SiteCode,
                                                                                                                   'KenyaEMR'             as Emr,
                                                                                                                   'Kenya HMIS II'        as Project,
                                                                                                                   i.FacilityName         as FacilityName,
                                                                                                                   0 						                            as FacilityId,
                                                                                                                   d.openmrs_id           as PatientMnchID,
                                                                                                                   v.visit_date           as VisitDate,
                                                                                                                   v.visit_id             as VisitID,
                                                                                                                   v.revisit_this_year    as RevisitThisYear,
                                                                                                                   v.height               as Height,
                                                                                                                   v.weight               as Weight,
                                                                                                                   v.height_length      as HeightLength,
                                                                                                                   v.temperature          as Temp,
                                                                                                                   v.pulse_rate           as PulseRate,
                                                                                                                   v.respiratory_rate     as RespiratoryRate,
                                                                                                                   v.oxygen_saturation    as OxygenSaturation,
                                                                                                                   v.muac                 as MUAC,
                                                                                                                   	v.ZScoreAbsolute       as ZScoreAbsolute,
                                                                                                                   v.ZScore               as ZScore,
                                                                                                                   v.weight_category      as WeightCategory,
                                                                                                                   v.stunted              as Stunted,
                                                                                                                   v.infant_feeding       as InfantFeeding,
                                                                                                                   v.medication_given     as MedicationGiven,
                                                                                                                   v.tb_assessment        as TBAssessment,
                                                                                                                   v.mnps_supplementation as MNPsSupplementation,
                                                                                                                   ''                     as Immunization,
                                                                                                                   ''                     as ImmunizationGiven,
                                                                                                                   v.danger_signs	      as DangerSigns,
                                                                                                                   v.milestones           as Milestones,
                                                                                                                   v.vitaminA_given       as VitaminA,
                                                                                                                   v.disability           as Disability,
                                                                                                                   v.llin                 as ReceivedMosquitoNet,
                                                                                                                   v.dewormed             as Dewormed,
                                                                                                                   v.referred			          as Refferred,
                                                                                                                   v.referred_from        as ReferredFrom,
                                                                                                                   v.referred_to          as ReferredTo,
                                                                                                                   v.referral_reason      as ReferralReasons,
                                                                                                                   v.follow_up            as FollowUP,
                                                                                                                   v.appointment_date     as NextAppointment,
                                                                                                                   v.dna_pcr              as dnapcr,
                                                                                                                   v.dna_pcr_date         as dnapcrdate,
                                                                                          						v.voided               as Voided	
                                                                                          from dwapi_etl.etl_patient_demographics d	
                                                                                          inner join (select v.patient_id,	
                                                                                          v.uuid                                                                  as uuid,	
                                                                                          v.visit_date,	
                                                                                          v.visit_id,	
                                                                                          (case v.revisit_this_year when 1065 then 'Yes' when 1066 then 'No' end) as revisit_this_year,	
                                                                                          round(t.height, 2)                                                      as height,	
                                                                                          round(t.weight, 2)                                                      as weight,	
                                                                                          (case v.height_length	
                                                                                          when 1115 then 'Normal'	
                                                                                          when 164085 then 'Stunted'	
                                                                                          when 164086 then 'Severe Stunded' end)                             as height_length,	
                                                                                          round(t.temperature, 1)                                                 as temperature,	
                                                                                          t.pulse_rate,	
                                                                                          t.respiratory_rate,	
                                                                                          t.oxygen_saturation,	
                                                                                          (case v.muac	
                                                                                          when 160909 then 'Green'	
                                                                                          when 160910 then 'Yellow'	
                                                                                          when 127778 then 'Red'	
                                                                                          else '' end)                                                       as muac,	
                                                                                          t.z_score_absolute                                                      as ZScoreAbsolute,	
                                                                                          case t.z_score	
                                                                                          when 1115 then 'Normal (Median)'	
                                                                                          when 123814 then 'Mild (-1 SD)'	
                                                                                          when 123815 then 'Moderate (-2 SD)'	
                                                                                          when 164131 then 'Severe (-3 SD and -4 SD)' end                     as ZScore,	
                                                                                          case v.weight_category	
                                                                                          when 123814 then 'Underweight(UW)'	
                                                                                          when 126598 then 'Severely Underweight(SUW)'	
                                                                                          when 114413 then 'Overweight(OW)'	
                                                                                          when 115115 then 'Obese(O)'	
                                                                                          when 1115 then 'Normal(N)' end                                      as weight_category,	
                                                                                          case v.stunted when 164085 then 'Yes' when 1115 then 'No' end           as stunted,	
                                                                                          case v.infant_feeding	
                                                                                          when 5526 then 'Exclusive Breastfeeding(EBF)'	
                                                                                          when 1595 then 'Exclusive Replacement(ERF)'	
                                                                                          when 6046 then 'Mixed Feeding(MF)'	
                                                                                          else 'Not Breastfeeding' end                                        as infant_feeding,	
                                                                                          concat_ws('|', nullif(case v.azt_given when 'Yes' then 'AZT' when 'No' then '' end, ''),	
                                                                                          nullif(case v.nvp_given when 'Yes' then 'NVP' when 'No' then '' end, ''),	
                                                                                          nullif(case v.ctx_given when 'Yes' then 'CTX' when 'No' then '' end, ''),	
                                                                                          nullif(case v.multi_vitamin_given when 'Yes' then 'AZT' when 'No' then '' end,	
                                                                                          ''))                                                   as medication_given,	
                                                                                          case v.tb_assessment_outcome	
                                                                                          when 1660 then 'No TB Signs'	
                                                                                          when 142177 then 'Presumed TB'	
                                                                                          when 1661 then 'TB Confirmed'	
                                                                                          when 1662 then 'TB Rx'	
                                                                                          when 1679 then 'INH'	
                                                                                          when 160737 then 'Not Done'	
                                                                                          else '' end                                                         as tb_assessment,	
                                                                                          case v.danger_signs	
                                                                                          when 159861 then 'Unable to breastfeed'	
                                                                                          when 1983 then 'Unable to drink'	
                                                                                          when 164482 then 'Vomits everything'	
                                                                                          when 138868 then 'Bloody Diarrhea'	
                                                                                          when 460 then 'Has Oedema'	
                                                                                          when 164483 then 'Has convulsions' end                              as danger_signs,	
                                                                                          case v.review_of_systems_developmental	
                                                                                          when 1115 then 'Normal(N)'	
                                                                                          when 6022 then 'Delayed(D)'	
                                                                                          when 6025 then 'Regressed(R)' end                                   as milestones,	
                                                                                          case v.vitaminA_given when 1065 then 'Yes' when 1066 then 'No' end      as vitaminA_given,	
                                                                                          case v.disability when 1065 then 'Yes' when 1066 then 'No' end          as disability,	
                                                                                          (case LLIN when 1065 then 'Yes' when 1066 then 'No' else '' end)        as llin,	
                                                                                          case v.deworming_drug when 79413 then 'Yes' when 70439 then 'Yes' end   as dewormed,	
                                                                                          case v.counselled_on	
                                                                                          when 1914 then 'HIV'	
                                                                                          when 1380 then 'Nutrition Services' end                             as follow_up,	
                                                                                          (case v.referred when 1065 then 'Yes' when 1066 then 'No' end)          as referred,	
                                                                                          case v.referred_from	
                                                                                          when 1537 then 'Another Health Facility'	
                                                                                          when 163488 then 'Community Unit'	
                                                                                          when 1175 then 'N/A' end                                            as referred_from,	
                                                                                          case v.referred_to	
                                                                                          when 1537 then 'Another Health Facility'	
                                                                                          when 163488 then 'Community Unit'	
                                                                                          when 1175 then 'N/A' end                                            as referred_to,	
                                                                                          v.referral_reason                                                       as referral_reason,	
                                                                                          v.next_appointment_date                                                 as appointment_date,	
                                                                                          case v.dna_pcr_result	
                                                                                          when 1138 then 'Indeterminate'	
                                                                                          when 664 then 'Negative'	
                                                                                          when 703 then 'Positive'	
                                                                                          when 1304 then 'Poor sample quality' end                            as dna_pcr,	
                                                                                          v.dna_pcr_sample_date                                                   as dna_pcr_date,	
                                                                                          v.MNPS_Supplementation                                                  as mnps_supplementation,	
                                                                                          i.fully_immunized                                                       as FullyImmunizedChild,	
                                                                                          v.date_created                                                          as Date_Created,	
                                                                                          v.date_last_modified                                                    as Date_Last_Modified,	
                                                                                          v.voided                                                                as Voided	
                                                                                          from dwapi_etl.etl_hei_follow_up_visit v	
                                                                                          left join dwapi_etl.etl_patient_triage t	
                                                                                          on v.visit_date = t.visit_date and v.patient_id = t.patient_id	
                                                                                          left join dwapi_etl.etl_hei_immunization i	
                                                                                          on v.patient_id = i.patient_id and v.visit_date = i.visit_date) v	
                                                                                          on d.patient_id = v.patient_id	
                                                                                          join kenyaemr_etl.etl_default_facility_info i"|TempCwcVisitExtract|0|CwcVisitExtract|27|a6221aa4-0e85-11e8-ba89-0ed5f89f718b
82651c00-9db2-11eb-a8b3-0242ac130003|Hei|MNCH|a6221856-0e85-11e8-ba89-0ed5f89f718b|"select d.patient_id                 as PatientPK,
                                                                                    m.uuid                       RecordUUID,
                                                                                     											i.siteCode                   as SiteCode,
                                                                                     											'KenyaEMR'                   as Emr,
                                                                                     											'Kenya HMIS II'              as Project,
                                                                                     											i.FacilityName               as FacilityName,
                                                                                     											0 																																																															as FacilityId,
                                                                                     											d.openmrs_id                 as PatientMnchID,
                                                                                     											d.hei_no                     as PatientHeiId,
                                                                                     											a.1st_DNA_PCR_date           as DNAPCR1Date,
                                                                                     											b.2nd_DNA_PCR_date           as DNAPCR2Date,
                                                                                     											c.3rd_DNA_PCR_date           as DNAPCR3Date,
                                                                                     											v.confirmatory_pcr_date      as ConfirmatoryPCRDate,
                                                                                     											baseline.baseline_vl_date    as BasellineVLDate,
                                                                                     											ab.final_antibody_date       as FinalyAntibodyDate,
                                                                                     											a.1st_DNA_PCR_result         as DNAPCR1,
                                                                                     											b.2nd_DNA_PCR_result         as DNAPCR2,
                                                                                     											c.3rd_DNA_PCR_result         as DNAPCR3,
                                                                                     											v.dna_confirmatory_results   as ConfirmatoryPCR,
                                                                                     											baseline.baseline_vl_results as BasellineVL,
                                                                                     											ab.final_antibody_result     as FinalyAntibody,
                                                                                     											m.exit_date                  as HEIExitDate,
                                                                                     											m.hiv_status                 as HEIHIVStatus,
                                                                                     											m.exit_reason                as HEIExitCritearia,
                                                                                     											m.Date_Created               as Date_Created,	
                                                                                                                                 m.Date_Last_Modified         as Date_Last_Modified,
                                                                                    											 m.voided                     as Voided
                                                                                     				from dwapi_etl.etl_patient_demographics d
                                                                                     											inner join (select m.patient_id,
                                                                                    											m.uuid                                            as uuid,
                                                                                                                                 m.hiv_status_at_exit as                            hiv_status,
                                                                                                                                 m.exit_date as                                     exit_date,
                                                                                                                                 case m.exit_reason
                                                                                                                                         when 1403 then 'HIV Neg age >18 months'
                                                                                                                                         when 5240 then 'Lost'
                                                                                                                                         when 160432 then 'Dead'
                                                                                                                                         when 159492 then 'Transfer Out'
                                                                                                                                         when 138571 then 'Confirmed HIV Positive' end as exit_reason,
                                                                                                                                 m.date_created as                                  Date_Created,	
                                                                                                                                 m.date_last_modified as                            Date_Last_Modified,	
                                                                                    											m.voided                                          as Voided
                                                                                                     from dwapi_etl.etl_hei_enrollment m)m on d.patient_id = m.patient_id
                                                                                     											left join (select t.patient_id,
                                                                                     																													case t.test_result when 664 then 'Negative' when 703 then 'Positive' end as 1st_DNA_PCR_result,
                                                                                     																													t.visit_date                                                             as 1st_DNA_PCR_date
                                                                                     																						from (select t.*, (@rn := if(@v = patient_id, @rn + 1,
                                                                                     																																																			if(@v := patient_id, 1, 1)
                                                                                     																										)
                                                                                     																										) as rn
                                                                                     																												from dwapi_etl.etl_laboratory_extract t
                                                                                     																																			cross join (select @v := -1, @rn := 0) params
                                                                                     																												where t.lab_test = 1030
                                                                                     																												order by t.patient_id, t.visit_date asc) t
                                                                                     																						where rn = 1)a on d.patient_id = a.patient_id
                                                                                     											left join (select t.patient_id,
                                                                                     																													case t.test_result when 664 then 'Negative' when 703 then 'Positive' end as 2nd_DNA_PCR_result,
                                                                                     																													t.visit_date                                                             as 2nd_DNA_PCR_date
                                                                                     																						from (select t.*, (@rn := if(@v = patient_id, @rn + 1,
                                                                                     																																																			if(@v := patient_id, 1, 1)
                                                                                     																										)
                                                                                     																										) as rn
                                                                                     																												from dwapi_etl.etl_laboratory_extract t
                                                                                     																																			cross join (select @v := -1, @rn := 0) params
                                                                                     																												where t.lab_test = 1030
                                                                                     																												order by t.patient_id, t.visit_date asc) t
                                                                                     																						where rn = 2)b on d.patient_id = b.patient_id
                                                                                     											left join (select t.patient_id,
                                                                                     																													case t.test_result when 664 then 'Negative' when 703 then 'Positive' end as 3rd_DNA_PCR_result,
                                                                                     																													t.visit_date                                                             as 3rd_DNA_PCR_date
                                                                                     																						from (select t.*, (@rn := if(@v = patient_id, @rn + 1,
                                                                                     																																																			if(@v := patient_id, 1, 1)
                                                                                     																										)
                                                                                     																										) as rn
                                                                                     																												from dwapi_etl.etl_laboratory_extract t
                                                                                     																																			cross join (select @v := -1, @rn := 0) params
                                                                                     																												where t.lab_test = 1030
                                                                                     																												order by t.patient_id, t.visit_date asc) t
                                                                                     																						where rn = 3)c on d.patient_id = c.patient_id
                                                                                     											left join (select ab.patient_id,
                                                                                     																													case ab.final_antibody_result
                                                                                     																															when 664 then 'Negative'
                                                                                     																															when 703 then 'Positive' end as final_antibody_result,
                                                                                     																													ab.final_antibody_sample_date  as final_antibody_date
                                                                                     																						from dwapi_etl.etl_hei_follow_up_visit ab
                                                                                     																						group by ab.patient_id)ab on d.patient_id = ab.patient_id
                                                                                     											left join (select v.patient_id,
                                                                                     																													v.dna_pcr_sample_date as          confirmatory_pcr_date,
                                                                                     																													case v.dna_pcr_result
                                                                                     																															when 664 then 'Negative'
                                                                                     																															when 703 then 'Positive' end as dna_confirmatory_results
                                                                                     																						from dwapi_etl.etl_hei_follow_up_visit v
                                                                                     																						where v.dna_pcr_contextual_status = 162082
                                                                                     																						group by v.patient_id)v on d.patient_id = v.patient_id
                                                                                     											left join (select x.patient_id,
                                                                                     																													if(mid(min(concat(x.visit_date, x.lab_test)), 11) = 856,
                                                                                     																																mid(min(concat(x.visit_date, x.test_result)), 11), if(
                                                                                     																																																																																					mid(min(concat(x.visit_date, x.lab_test)), 11) = 1305 and
                                                                                     																																																																																					mid(min(concat(x.visit_date, x.test_result)), 11) = 1302,
                                                                                     																																																																																					'LDL', '')) as baseline_vl_results,
                                                                                     																													min(x.visit_date)                                                   as baseline_vl_date
                                                                                     																						from dwapi_etl.etl_laboratory_extract x
                                                                                     																						where x.lab_test in (1305, 856)
                                                                                     																						group by x.patient_id) baseline on d.patient_id = baseline.patient_id
                                                                                     											join kenyaemr_etl.etl_default_facility_info i where d.hei_no is not null"|TempHeiExtract|0|HeiExtract|28|a6221aa4-0e85-11e8-ba89-0ed5f89f718b
82651cfa-9db2-11eb-a8b3-0242ac130003|Mnch Labs|MNCH|a6221856-0e85-11e8-ba89-0ed5f89f718b|"select d.patient_id    as PatientPK,
                            l.uuid               RecordUUID,
                                                            i.siteCode      as SiteCode,
                                                            d.openmrs_id    as PatientMNCH_ID,
                                                            0             as FacilityID,
                                                            'KenyaEMR'      as Emr,
                                                            'Kenya HMIS II' as Project,
                                                            i.FacilityName  as FacilityName,
                                                            ''              as SatelliteName,
                                                            l.visit_id      as VisitID,
                                                            l.sample_date   as OrderedByDate,
                                                            l.results_date  as ReportedByDate,
                                                            l.lab_test      as TestName,
                                                            l.test_result   as TestResult,
                                                            l.order_reason  as LabReason,
                                                            l.date_created       as Date_Created,	
                                                            l.date_last_modified as Date_Last_Modified,	
                                                            l.voided             as Voided	
                                        from dwapi_etl.etl_patient_demographics d	
                                    inner join (select e.patient_id from dwapi_etl.etl_hiv_enrollment e) e on d.patient_id = e.patient_id	
                                    inner join (select m.patient_id from dwapi_etl.etl_mch_enrollment m) m on d.patient_id = m.patient_id	
                                    inner join (select l.patient_id,	
                                    l.uuid,	
                                    l.visit_id,	
                                    l.date_test_requested             as sample_date,	
                                    l.date_test_result_received       as results_date,	
                                    case l.lab_test	
                                    when 5497 then 'CD4 Count'	
                                    when 730 then 'CD4 PERCENT '	
                                    when 654 then 'ALT'	
                                    when 790 then 'Serum creatinine (umol/L)'	
                                    when 856 then 'HIV VIRAL LOAD'	
                                    when 1305 then 'HIV VIRAL LOAD'	
                                    when 21 then 'Hemoglobin (HGB)'	
                                    else '' end                   as lab_test,	
                                    case l.order_reason	
                                    when 843 then 'Regimen failure'	
                                    when 1259 then 'CHANGE REGIMEN'	
                                    when 1434 then 'PREGNANCY'	
                                    when 159882 then 'breastfeeding'	
                                    when 160566 then 'Immunologic failure'	
                                    when 160569 then 'Virologic failure'	
                                    when 161236 then 'Routine'	
                                    when 162080 then 'Baseline'	
                                    when 162081 then 'Repeat'	
                                    when 163523 then 'Clinical failure'	
                                    else '' end                   as order_reason,	
                                    if(l.lab_test = 299, (case l.test_result	
                                    when 1228 then 'REACTIVE'	
                                    when 1229 then 'NON-REACTIVE'	
                                    when 1304 then 'POOR SAMPLE QUALITY' end),	
                                    if(l.lab_test = 1030, (case l.test_result	
                                    when 1138 then 'INDETERMINATE'	
                                    when 664 then 'NEGATIVE'	
                                    when 703 then 'POSITIVE'	
                                    when 1304 then 'POOR SAMPLE QUALITY' end),	
                                    if(l.lab_test = 302, (case l.test_result	
                                    when 1115 then 'Normal'	
                                    when 1116 then 'Abnormal'	
                                    when 1067 then 'Unknown' end),	
                                    if(l.lab_test = 32, (case l.test_result	
                                    when 664 then 'NEGATIVE'	
                                    when 703 then 'POSITIVE'	
                                    when 1138 then 'INDETERMINATE' end),	
                                    if(l.lab_test = 1305, (case l.test_result	
                                    when 1306 then 'BEYOND DETECTABLE LIMIT'	
                                    when 1301 then 'DETECTED'	
                                    when 1302 then 'LDL'	
                                    when 1304 then 'POOR SAMPLE QUALITY' end),	
                                    l.test_result))))) as test_result,	
                                    l.date_created,	
                                    l.date_last_modified,	
                                    l.voided	
                                    from dwapi_etl.etl_laboratory_extract l) l on d.patient_id = l.patient_id	
                                    join kenyaemr_etl.etl_default_facility_info i"|TempMnchLabExtract|0|MnchLabExtract|29|a6221aa4-0e85-11e8-ba89-0ed5f89f718b

162B7F2F-37B7-4DCD-B39E-BA520BB5A9A1|Mnch Immunization|MNCH|a6221856-0e85-11e8-ba89-0ed5f89f718b|"select d.patient_id                                                        as PatientPK,
                                  z.uuid RecordUUID,
                                                                    i.siteCode                                                          as SiteCode,
                                                                    'KenyaEMR'                                                          as Emr,
                                                                    'Kenya HMIS II'                                                     as Project,
                                                                    ''                                                                  as FacilityId,
                                                                    i.FacilityName                                                      as FacilityName,
                                                                    d.openmrs_id                                                        as PatientMnchID,
                                                                    z.BCG                                                               as BCG,
                                                                    z.OPV_birth                                                         as OPVAtBirth,
                                                                    z.OPV_1                                                             as OPV1,
                                                                    z.OPV_2                                                             as OPV2,
                                                                    z.OPV_3                                                             as OPV3,
                                                                    z.IPV                                                               AS IPV,
                                                                    z.DPT_Hep_B_Hib_1                                                   as DPTHepBHIB1,
                                                                    z.DPT_Hep_B_Hib_2                                                   AS DPTHepBHIB2,
                                                                    z.DPT_Hep_B_Hib_3                                                   as DPTHepBHIB3,
                                                                    z.PCV_10_1                                                          as PCV101,
                                                                    z.PCV_10_2                                                          as PCV102,
                                                                    z.PCV_10_3                                                          as PCV103,
                                                                    z.ROTA_1                                                            as ROTA1,
                                                                    z.Measles_rubella_1                                                 as MeaslesReubella1,
                                                                    z.Yellow_fever                                                      as YellowFever,
                                                                    z.Measles_rubella_2                                                 as MeaslesReubella2,
                                                                    z.Measles_6_months                                                  as MeaslesAt6Months,
                                                                    z.ROTA_2                                                            as ROTA2,
                                                                    ''                                                                  as DateOfNextVisit,
                                                                    ''                                                                  as BCGScarChecked,
                                                                    ''                                                                  as DateChecked,
                                                                    ''                                                                  as DateBCGrepeated,
                                                                    z.VitaminA_6_months                                                 as VitaminAAt6Months,
                                                                    z.VitaminA_1_yr                                                     as VitaminAAt1Yr,
                                                                    z.VitaminA_1_and_half_yr                                            as VitaminAAt18Months,
                                                                    z.VitaminA_2_yr                                                     as VitaminAAt2Years,
                                                                    z.VitaminA_2_to_5_yr                                                as VitaminAAt2To5Years,
                                                                    case z.fully_immunized when 1065 then 'Yes' when 1066 then 'No' end as FullyImmunizedChild,
                                                                    z.date_created                                                      as Date_Created,
                                                                    z.date_last_modified                                                as Date_Last_Modified,
                                                                  z.voided as Voided	
                                                        from dwapi_etl.etl_patient_demographics d	
                                                        inner join dwapi_etl.etl_hei_immunization z on d.patient_id = z.patient_id	
                                                        join kenyaemr_etl.etl_default_facility_info i	
                                                        group by d.patient_id"|TempMnchImmunizationExtract|0|MnchImmunizationExtract|30|a6221aa4-0e85-11e8-ba89-0ed5f89f718b


d563f4e4-ae47-11eb-8529-0242ac130003|Allergies Chronic Illness|NDWH|A6221857-0E85-11E8-BA89-0ED5F89F718B|"SELECT PatientPK,SiteCode,PatientID,FacilityID,Emr,Project,FacilityName,VisitID,VisitDate,ChronicIllness,ChronicOnsetDate,knownAllergies,AllergyCausativeAgent,AllergicReaction,AllergySeverity,AllergyOnsetDate,Skin,Eyes,ENT,Chest,CVS,Abdomen,CNS,Genitourinary
				FROM ndwr.ndwr_patient_allergies_chronic_illness"|dwhstage|0|AllergiesChronicIllnessExtract|11|A6221AA5-0E85-11E8-BA89-0ED5F89F718B
d563f58e-ae47-11eb-8529-0242ac130003|IPT|NDWH|A6221857-0E85-11E8-BA89-0ED5F89F718B|"SELECT PatientPK,SiteCode,PatientID,FacilityID,Emr,Project,FacilityName,VisitID,VisitDate,OnTBDrugs,OnIPT,EverOnIPT,Cough,Fever,NoticeableWeightLoss,NightSweats,Lethergy,ICFActionTaken,TestResult,TBClinicalDiagnosis,ContactsInvited,EvaluatedForIPT,StartAntiTBs,
	TBRxStartDate,TBScreening,IPTClientWorkUp,StartIPT,IndicationForIPT
		FROM ndwr.ndwr_patient_ipt_extract"|dwhstage|0|IptExtract|12|A6221AA5-0E85-11E8-BA89-0ED5F89F718B
d563f642-ae47-11eb-8529-0242ac130003|Depression Screening|NDWH|A6221857-0E85-11E8-BA89-0ED5F89F718B|"SELECT PatientPK,SiteCode,PatientID,FacilityID,Emr,Project,VisitID,VisitDate,
    CASE
        WHEN PHQ9_1 = 0 THEN 'Not at all'
        WHEN PHQ9_1 = 1 THEN 'Several days'
        WHEN PHQ9_1 = 2 THEN 'More than half'
        WHEN PHQ9_1 = 3 THEN 'Nearly everyday'
        ELSE NULL
    END AS 'PHQ9-1',
    CASE
        WHEN PHQ9_2 = 0 THEN 'Not at all'
        WHEN PHQ9_2 = 1 THEN 'Several days'
        WHEN PHQ9_2 = 2 THEN 'More than half'
        WHEN PHQ9_3 = 3 THEN 'Nearly everyday'
        ELSE NULL
    END AS 'PHQ9-2',
    CASE
        WHEN PHQ9_3 = 0 THEN 'Not at all'
        WHEN PHQ9_3 = 1 THEN 'Several days'
        WHEN PHQ9_3 = 2 THEN 'More than half'
        WHEN PHQ9_3 = 3 THEN 'Nearly everyday'
        ELSE NULL
    END AS 'PHQ9-3',
    CASE
        WHEN PHQ9_4 = 0 THEN 'Not at all'
        WHEN PHQ9_4 = 1 THEN 'Several days'
        WHEN PHQ9_4 = 2 THEN 'More than half'
        WHEN PHQ9_4 = 3 THEN 'Nearly everyday'
        ELSE NULL
    END AS 'PHQ9-4',
    CASE
        WHEN PHQ9_5 = 0 THEN 'Not at all'
        WHEN PHQ9_5 = 1 THEN 'Several days'
        WHEN PHQ9_5 = 2 THEN 'More than half'
        WHEN PHQ9_5 = 3 THEN 'Nearly everyday'
        ELSE NULL
    END AS 'PHQ9-5',
    CASE
        WHEN PHQ9_6 = 0 THEN 'Not at all'
        WHEN PHQ9_6 = 1 THEN 'Several days'
        WHEN PHQ9_6 = 2 THEN 'More than half'
        WHEN PHQ9_6 = 3 THEN 'Nearly everyday'
        ELSE NULL
    END AS 'PHQ9-6',
    CASE
        WHEN PHQ9_7 = 0 THEN 'Not at all'
        WHEN PHQ9_7 = 1 THEN 'Several days'
        WHEN PHQ9_7 = 2 THEN 'More than half'
        WHEN PHQ9_7 = 3 THEN 'Nearly everyday'
        ELSE NULL
    END AS 'PHQ9-7',
    CASE
        WHEN PHQ9_8 = 0 THEN 'Not at all'
        WHEN PHQ9_8 = 1 THEN 'Several days'
        WHEN PHQ9_8 = 2 THEN 'More than half'
        WHEN PHQ9_8 = 3 THEN 'Nearly everyday'
        ELSE NULL
    END AS 'PHQ9-8',
    CASE
        WHEN PHQ9_9 = 0 THEN 'Not at all'
        WHEN PHQ9_9 = 1 THEN 'Several days'
        WHEN PHQ9_9 = 2 THEN 'More than half'
        WHEN PHQ9_9 = 3 THEN 'Nearly everyday'
        ELSE NULL
    END AS 'PHQ9-9',
    CASE
        WHEN PHQ9Score >= 0 AND PHQ9Score <= 4 THEN 'Depression unlikely'
        WHEN PHQ9Score >= 5 AND PHQ9Score <= 9 THEN 'Mild depression'
        WHEN PHQ9Score >= 10 AND PHQ9Score <= 14 THEN 'Moderate depression'
        WHEN PHQ9Score >= 15 AND PHQ9Score <= 19 THEN 'Moderate severe depression'
        WHEN PHQ9Score >= 20 AND PHQ9Score <= 27 THEN 'Severe depression'
        ELSE NULL
    END AS 'PHQ9Score',
    PHQ9Rating AS 'PHQ9 Rating'
FROM
    ndwr.ndwr_patient_depression_screening;
"|dwhstage|0|DepressionScreeningExtract|13|A6221AA5-0E85-11E8-BA89-0ED5F89F718B
d563f7dc-ae47-11eb-8529-0242ac130003|Contact Listing|NDWH|A6221857-0E85-11E8-BA89-0ED5F89F718B|"SELECT  PatientPK,SiteCode,PatientID,FacilityName,Emr,Project,PartnerPersonID,ContactAge,
    CASE
        WHEN ContactSex = 1 THEN 'Male'
        WHEN ContactSex = 2 THEN 'Female'
        ELSE NULL
    END AS 'ContactSex',
    CASE
        WHEN ContactMaritalStatus = 5555 THEN 'Married monogamous'
        WHEN ContactMaritalStatus = 6290 THEN 'Married polygamous'
        WHEN ContactMaritalStatus = 1058 THEN 'Divorced'
        WHEN ContactMaritalStatus = 1059 THEN 'Widowed'
        WHEN ContactMaritalStatus = 1057 THEN 'Single'
        WHEN ContactMaritalStatus = 1175 THEN 'N/A (Child)'
        ELSE NULL
    END AS 'ContactMaritalStatus',
    CASE
        WHEN RelationshipWithPatient = 970 THEN 'Mother'
        WHEN RelationshipWithPatient = 971 THEN 'Father'
        WHEN RelationshipWithPatient = 972 THEN 'Sibling'
        WHEN RelationshipWithPatient = 1565 THEN 'Child'
        WHEN RelationshipWithPatient = 1669 THEN 'Sexual partner-spouse'
        WHEN RelationshipWithPatient = 1670 THEN 'Sexual partner-other'
        WHEN RelationshipWithPatient = 7246 THEN 'Co-wife'
        WHEN RelationshipWithPatient = 105 THEN 'Injectable drug user'
        ELSE NULL
    END AS 'RelationshipWithPatient',
    CASE
        WHEN ScreenedForIpv = 1 THEN 'Yes'
        WHEN ScreenedForIpv = 0 THEN 'No'
        ELSE NULL
    END AS 'ScreenedForIpv',
    CASE
        WHEN IpvScreening = 9303 THEN 'Sexual'
        WHEN IpvScreening = 1789 THEN 'Physical'
        WHEN IpvScreening = 7020 THEN 'Emotional'
        WHEN IpvScreening = 1107 THEN 'No IPV'
        WHEN IpvScreening = 1175 THEN 'N/A (Child)'
        ELSE NULL
    END AS 'IpvScreening',
    CASE
        WHEN IpvScreeningOutcome = 9303 THEN 'Sexual'
        WHEN IpvScreeningOutcome = 1789 THEN 'Physical'
        WHEN IpvScreeningOutcome = 7020 THEN 'Emotional'
        WHEN IpvScreeningOutcome = 1107 THEN 'No IPV'
        WHEN IpvScreeningOutcome = 1175 THEN 'N/A (Child)'
        ELSE NULL
    END AS 'IpvScreeningOutcome',
    CASE
        WHEN CurrentlyLivingWithIndexClient = 1 THEN 'Yes'
        WHEN CurrentlyLivingWithIndexClient = 0 THEN 'No'
        ELSE NULL
    END AS 'CurrentlyLivingWithIndexClient',
    CASE
        WHEN KnowledgeOfHivStatus = 1 THEN 'Yes'
        WHEN KnowledgeOfHivStatus = 0 THEN 'No'
        ELSE NULL
    END AS 'KnowledgeOfHivStatus',
    CASE
        WHEN PnsApproach = 11734 THEN 'Dual referral'
        WHEN PnsApproach = 11733 THEN 'Provider referral'
        WHEN PnsApproach = 9025 THEN 'Contract referral'
        WHEN PnsApproach = 10648 THEN 'Passive referral'
        ELSE NULL
    END AS 'PnsApproach'
	FROM
    ndwr.ndwr_patient_contact_listing"|dwhstage|0|ContactListingExtract|14|A6221AA5-0E85-11E8-BA89-0ED5F89F718B
d563f890-ae47-11eb-8529-0242ac130003|GBV Screening|NDWH|A6221857-0E85-11E8-BA89-0ED5F89F718B|"SELECT
    PatientPK,
    SiteCode,
    PatientID,
    Emr,
    Project,
    FacilityName,
    PartnerPersonID,
    VisitID,
    VisitDate,
    CASE
      WHEN IPV = 1 THEN 'Yes'
      WHEN IPV = 0 THEN 'NO'
      ELSE NULL
    END AS 'IPV',
    CASE
      WHEN PhysicalIPV = 1 THEN 'Yes'
      WHEN PhysicalIPV = 0 THEN 'NO'
      ELSE NULL
    END AS 'PhysicalIPV',
    CASE
      WHEN EmotionalIPV = 1 THEN 'Yes'
      WHEN EmotionalIPV = 0 THEN 'NO'
      ELSE NULL
    END AS 'EmotionalIPV',
	CASE
      WHEN SexualIPV = 1 THEN 'Yes'
      WHEN SexualIPV = 0 THEN 'NO'
      ELSE NULL
    END AS 'SexualIPV',
    CASE
      WHEN IPVRelationship = 1 THEN 'Yes'
      WHEN IPVRelationship = 0 THEN 'NO'
      ELSE NULL
    END AS 'IPVRelationship',
    DateCreated
	FROM
    ndwr.ndwr_gbv_screening"|dwhstage|0|GbvScreeningExtract|15|A6221AA5-0E85-11E8-BA89-0ED5F89F718B
d563f93a-ae47-11eb-8529-0242ac130003|Enhanced Adherence Counselling|NDWH|A6221857-0E85-11E8-BA89-0ED5F89F718B|" SELECT PatientPK,SiteCode,PatientID,Emr,Project,FacilityName,VisitID,VisitDate,
  SessionNumber,
  FirstSessionDate,
  PillCountAdherence,
  MMAS4_1 as 'MMAS4-1',
  MMAS4_2 as 'MMAS4-2',
  MMAS4_3 as 'MMAS4-3',
  MMAS4_4 as 'MMAS4_4',
  MMSA8_1,
  MMSA4_2,
  MMSA4_3,
  MMSA4_4,
  MMSAScore,
  EACRecievedVL,
  EACVL,
  EACVLConcerns,
  EACVLThoughts,
  EACWayForward,
  EACCognitiveBarrier,
  EACBehaviouralBarrier_1,
  EACBehaviouralBarrier_2,
  EACBehaviouralBarrier_3,
  EACBehaviouralBarrier_4,
  EACBehaviouralBarrier_5,
  EACEmotionalBarriers_1,
  EACEmotionalBarriers_2,
  EACEconBarrier_1,
  EACEconBarrier_2,
  EACEconBarrier_3,
  EACEconBarrier_4,
  EACEconBarrier_5,
  EACEconBarrier_6,
  EACEconBarrier_7,
  EACEconBarrier_8,
  EACReviewImprovement,
  EACReviewMissedDoses,
  EACReviewStrategy,
  EACReferral,
  EACReferralApp,
  EACReferralExperience,
  EACHomevisit,
  EACAdherencePlan,
  EACFollowupDate,
  FROM
  ndwr.ndwr_patient_eac"|dwhstage|0|EnhancedAdherenceCounsellingExtract|16|A6221AA5-0E85-11E8-BA89-0ED5F89F718B
d563faac-ae47-11eb-8529-0242ac130003|Drug and Alcohol Screening|NDWH|A6221857-0E85-11E8-BA89-0ED5F89F718B|"   SELECT PatientPK,
    SiteCode,PatientID,
    Emr,
    Project,
    FacilityName,
    VisitID,
    VisitDate,
    DrinkAlcohol,
    Smoking,
    DrugUse
    FROM
    ndwr.ndwr_drug_alcohol_screening"|dwhstage|0|DrugAlcoholScreeningExtract|17|A6221AA5-0E85-11E8-BA89-0ED5F89F718B
d563fb6a-ae47-11eb-8529-0242ac130003|OVC|NDWH|A6221857-0E85-11E8-BA89-0ED5F89F718B|"SELECT PatientPK,SiteCode,PatientID,
    Emr,
    Project,
    FacilityName,
    VisitID,
    VisitDate,
    OVCEnrollmentDate,
    RelationshiptoClient,
    EnrolledinCPIMS,
    CPIMSUniqueidentifier,
    PartnerOfferingOVCServices,
    OVCExitReason,
    ExitDate
    FROM
    ndwr.ndwr_ovc_patient_visits"|dwhstage|0|OvcExtract|18|A6221AA5-0E85-11E8-BA89-0ED5F89F718B
d563fc28-ae47-11eb-8529-0242ac130003|OTZ|NDWH|A6221857-0E85-11E8-BA89-0ED5F89F718B|"  SELECT PatientPK,SiteCode,PatientID,
    Emr,
    Project,
    FacilityName,
    VisitID,
    VisitDate,
    OTZEnrollmentDate,
    TransferInStatus,
    Modulespreviouslycovered,
    Modulescompletedtoday,
    SupportGroupInvolvement,
    Remarks,
    TransitionattritionReason,
    OutcomeDate
    FROM
    ndwr.ndwr_otz_patient_visits"|dwhstage|0|OtzExtract|19|A6221AA5-0E85-11E8-BA89-0ED5F89F718B
d568fc28-ae47-11eb-8529-0242ac130003|Covid|NDWH|A6221857-0E85-11E8-BA89-0ED5F89F718B|"SELECT
										PatientPK,
										SiteCode,
										PatientID,
										Emr,
										Project,
										FacilityName,
										FacilityId,
										VisitID,
										Covid19AssessmentDate,
										ReceivedCOVID19Vaccine,
										DateGivenFirstDose,
										FirstDoseVaccineAdministered,
										DateGivenSecondDose,
										SecondDoseVaccineAdministered,
										VaccinationStatus,
										VaccineVerification,
										VaccineVerificationSecondDose,
										BoosterGiven,
										BoosterDose,
										BoosterDoseDate,
										Sequence,
										COVID19TestResult,
										BoosterDoseVerified,
										COVID19TestDate,
										PatientStatus,
										AdmissionStatus,
										AdmissionUnit,
										MissedAppointmentDueToCOVID19,
										COVID19PositiveSinceLasVisit,
										COVID19TestDateSinceLastVisit,
										PatientStatusSinceLastVisit,
										AdmissionStatusSinceLastVisit,
										AdmissionStartDate,
										AdmissionEndDate,
										AdmissionUnitSinceLastVisit,
										SupplementalOxygenReceived,
										PatientVentilated,
										EverCOVID19Positive,
										TracingFinalOutcome,
										CauseOfDeath
						FROM
										ndwr.ndwr_covid_extract"|dwhstage|0|CovidExtract|20|A6221AA5-0E85-11E8-BA89-0ED5F89F718B
d569fc28-ae47-11eb-8529-0242ac130003|Defaulter Tracing|NDWH|A6221857-0E85-11E8-BA89-0ED5F89F718B|"SELECT
								PatientPK,
								SiteCode,
								PatientID,
								Emr,
								Project,
								FacilityName,
								FacilityId,
								VisitID,
								VisitDate,
								EncounterId,
								TracingType,
								TracingOutcome,
								AttemptNumber,
								IsFinalTrace,
								TrueStatus,
								CauseOfDeath,
								Comments,
								BookingDate
				FROM
								ndwr.ndwr_defaulter_tracing_extract"|dwhstage|0|DefaulterTracingExtract|21|A6221AA5-0E85-11E8-BA89-0ED5F89F718B
5D94B087-01DC-4C4E-8BA6-1027F974B232|Cancer Screening|NDWH|A6221857-0E85-11E8-BA89-0ED5F89F718B|""|dwhstage|0|CancerScreeningExtract|22|A6221AA5-0E85-11E8-BA89-0ED5F89F718B
7C612ECF-4468-42A0-90FC-DBEB6FD68096|Art Fast Track|NDWH|A6221857-0E85-11E8-BA89-0ED5F89F718B|""|dwhstage|0|ArtFastTrackExtract|23|A6221AA5-0E85-11E8-BA89-0ED5F89F718B
056F9D4A-1A24-4524-95B8-6A0670CEAFDD|IIT Risk Scores|NDWH|A6221857-0E85-11E8-BA89-0ED5F89F718B|""|dwhstage|0|IITRiskScoresExtract|24|A6221AA5-0E85-11E8-BA89-0ED5F89F718B

d5640010-ae47-11eb-8529-0242ac130003|Indicators|MTS|A6221857-0E85-11E8-BA89-0ED5F89F718B||Indicator|1|IndicatorExtract|1|A6221AA5-0E85-11E8-BA89-0ED5F89F718B
A7F13D1F-8E82-4414-BB56-BB40A10F01F3|Hei|MNCH|A6221857-0E85-11E8-BA89-0ED5F89F718B|""|TempHeiExtract|0|HeiExtract|28.00|A6221AA5-0E85-11E8-BA89-0ED5F89F718B
C37BE5B9-C518-477D-BDA6-C7FAD68262D2|Mnch Enrolment|MNCH|A6221857-0E85-11E8-BA89-0ED5F89F718B|""|TempMnchEnrolmentExtract|0|MnchEnrolmentExtract|20.00|A6221AA5-0E85-11E8-BA89-0ED5F89F718B
5621AE05-2A66-49EF-829F-B0A2A071941D|Pnc Visit|MNCH|A6221857-0E85-11E8-BA89-0ED5F89F718B|""|TempPncVisitExtract|0|PncVisitExtract|24.00|A6221AA5-0E85-11E8-BA89-0ED5F89F718B
027D9EE7-C222-4F9C-ACC5-1DD5B183CC28|Mnch Art|MNCH|A6221857-0E85-11E8-BA89-0ED5F89F718B|""|TempMnchArtExtract|0|MnchArtExtract|21.00|A6221AA5-0E85-11E8-BA89-0ED5F89F718B
1EB37D09-F1AC-4F51-ABCF-94019EBA072B|Mother Baby Pair|MNCH|A6221857-0E85-11E8-BA89-0ED5F89F718B|""|TempMotherBabyPairExtract|0|MotherBabyPairExtract|25.00|A6221AA5-0E85-11E8-BA89-0ED5F89F718B
9A427425-B1F3-4CC2-9233-705E00792497|Anc Visit|MNCH|A6221857-0E85-11E8-BA89-0ED5F89F718B|""|TempAncVisitExtract|0|AncVisitExtract|22.00|A6221AA5-0E85-11E8-BA89-0ED5F89F718B
DCAE23B5-8B52-4196-AB29-61C3CDFD6A6B|Mnch Patient|MNCH|A6221857-0E85-11E8-BA89-0ED5F89F718B|""|TempPatientMnchExtract|1|PatientMnchExtract|19.00|A6221AA5-0E85-11E8-BA89-0ED5F89F718B
3EF83C9E-3A73-4ABE-8981-A838F89B4ABC|Cwc Enrolment|MNCH|A6221857-0E85-11E8-BA89-0ED5F89F718B|""|TempCwcEnrolmentExtract|0|CwcEnrolmentExtract|26.00|A6221AA5-0E85-11E8-BA89-0ED5F89F718B
792C41D4-20D4-4844-93E7-3698C9E2FFA4|Cwc Visit|MNCH|A6221857-0E85-11E8-BA89-0ED5F89F718B|""|TempCwcVisitExtract|0|CwcVisitExtract|27.00|A6221AA5-0E85-11E8-BA89-0ED5F89F718B
65BC8BA3-25A4-44D4-B902-1AA2CD4B9AFE|Mnch Labs|MNCH|A6221857-0E85-11E8-BA89-0ED5F89F718B|""|TempMnchLabExtract|0|MnchLabExtract|29.00|A6221AA5-0E85-11E8-BA89-0ED5F89F718B
07A92DAB-E1D0-4550-9B71-5CF7F63A28BD|Mat Visit|MNCH|A6221857-0E85-11E8-BA89-0ED5F89F718B|""|TempMatVisitExtract|0|MatVisitExtract|23.00|A6221AA5-0E85-11E8-BA89-0ED5F89F718B
63837D56-4540-450A-9406-B1B8F4A44588|Mnch Immunization|MNCH|A6221857-0E85-11E8-BA89-0ED5F89F718B|""|TempMnchImmunizationExtract|0|MnchImmunizationExtract|24.00|A6221AA5-0E85-11E8-BA89-0ED5F89F718B
46D92EC7-97F2-41E4-9FF2-44FE92AB13CB|Hts Clients|HTS|A6221857-0E85-11E8-BA89-0ED5F89F718B|""|DWHStage|1|HtsClient|1.00|A6221AA5-0E85-11E8-BA89-0ED5F89F718B
1E0DD61C-4E31-4707-B808-E9FC0649651D|Hts Test Kits|HTS|A6221857-0E85-11E8-BA89-0ED5F89F718B|""|DWHStage|1|HtsTestKits|4.00|A6221AA5-0E85-11E8-BA89-0ED5F89F718B
43F8E14C-5481-43A3-B76E-82FFFA9DFC5B|Hts Client Linkage|HTS|A6221857-0E85-11E8-BA89-0ED5F89F718B|""|DWHStage|1|HtsClientLinkage|3.00|A6221AA5-0E85-11E8-BA89-0ED5F89F718B
3E51A4D6-5DD6-4B8E-97EA-4D1D40F50DC4|Hts Partner Notification Services|HTS|A6221857-0E85-11E8-BA89-0ED5F89F718B|""|DWHStage|1|HtsPartnerNotificationServices|7.00|A6221AA5-0E85-11E8-BA89-0ED5F89F718B
E2EFAE43-2B09-41A6-83B5-A2E5CF5EDDF7|Hts Client Tracing|HTS|A6221857-0E85-11E8-BA89-0ED5F89F718B|""|DWHStage|1|HtsClientTracing|5.00|A6221AA5-0E85-11E8-BA89-0ED5F89F718B
C2294906-D283-4E43-818D-E047047BD6BF|Hts Partner Tracing|HTS|A6221857-0E85-11E8-BA89-0ED5F89F718B|""|DWHStage|1|HtsPartnerTracing|6.00|A6221AA5-0E85-11E8-BA89-0ED5F89F718B
5F402C12-6846-4087-9C9B-7D5CF15B7B2D|Hts Client Tests|HTS|A6221857-0E85-11E8-BA89-0ED5F89F718B|""|DWHStage|1|HtsClientTests|2.00|A6221AA5-0E85-11E8-BA89-0ED5F89F718B
1BFE7DC2-8B21-4C52-843A-956CB65BE526|Hts Eligibility Screening|HTS|A6221857-0E85-11E8-BA89-0ED5F89F718B|""|DWHStage|1|HtsEligibilityExtract|8.00|A6221AA5-0E85-11E8-BA89-0ED5F89F718B
3BF8ACD9-8E99-430A-AE5C-535B46877C7A|Master Patient Index|CBS|A6221857-0E85-11E8-BA89-0ED5F89F718B|""|MPI|1|MasterPatientIndex|1.00|A6221AA5-0E85-11E8-BA89-0ED5F89F718B
5823F29C-D01E-4479-897B-720343FDD876|Migration|MGS|A6221857-0E85-11E8-BA89-0ED5F89F718B|""|MgsStage|1|MetricMigrationExtract|1.00|A6221AA5-0E85-11E8-BA89-0ED5F89F718B

399E96EE-3C82-400D-B5EF-8C320F865B81|Master Patient Index|CBS|a6221858-0e85-11e8-ba89-0ed5f89f718b|""|MPI|1|MasterPatientIndex|1.00|a6221982-0e86-11e8-ba89-0ed5f89f718b
CD478F6B-22FA-4262-AC8A-C8DF680F4381|Hts Clients|HTS|a6221858-0e85-11e8-ba89-0ed5f89f718b|""|DWHStage|1|HtsClient|1.00|a6221982-0e86-11e8-ba89-0ed5f89f718b
2A5E6765-CE9E-4BF8-B64A-089230FBD09F|Hts Test Kits|HTS|a6221858-0e85-11e8-ba89-0ed5f89f718b|""|DWHStage|1|HtsTestKits|4.00|a6221982-0e86-11e8-ba89-0ed5f89f718b
D75B29CB-8745-4DF7-9A39-C33FC95F9F0F|Hts Client Linkage|HTS|a6221858-0e85-11e8-ba89-0ed5f89f718b|""|DWHStage|1|HtsClientLinkage|3.00|a6221982-0e86-11e8-ba89-0ed5f89f718b
A0D0C17E-2315-46AE-AAA9-B33572A3BEA1|Hts Partner Notification Services|HTS|a6221858-0e85-11e8-ba89-0ed5f89f718b|""|DWHStage|1|HtsPartnerNotificationServices|7.00|a6221982-0e86-11e8-ba89-0ed5f89f718b
B0B42B32-D0B6-48D8-B5C8-A5E085DD391A|Hts Client Tracing|HTS|a6221858-0e85-11e8-ba89-0ed5f89f718b|""|DWHStage|1|HtsClientTracing|5.00|a6221982-0e86-11e8-ba89-0ed5f89f718b
C523F23D-3806-4C4D-8A27-75DC813DA0F3|Hts Partner Tracing|HTS|a6221858-0e85-11e8-ba89-0ed5f89f718b|""|DWHStage|1|HtsPartnerTracing|6.00|a6221982-0e86-11e8-ba89-0ed5f89f718b
9CB06077-AFB2-4072-BA6E-76D8E6003CC3|Hts Client Tests|HTS|a6221858-0e85-11e8-ba89-0ed5f89f718b|""|DWHStage|1|HtsClientTests|2.00|a6221982-0e86-11e8-ba89-0ed5f89f718b
CDE7E836-57A7-4F2F-8A5A-F9B66FB2C9A0|Migration|MGS|a6221858-0e85-11e8-ba89-0ed5f89f718b|""|MgsStage|1|MetricMigrationExtract|1.00|a6221982-0e86-11e8-ba89-0ed5f89f718b
16DB7A26-9D2E-4DB9-9E4E-C58B6239E032|Hei|MNCH|a6221858-0e85-11e8-ba89-0ed5f89f718b|""|TempHeiExtract|0|HeiExtract|28.00|a6221982-0e86-11e8-ba89-0ed5f89f718b
7C60F063-6CA1-4560-A34A-A7F3A3E64896|Mnch Enrolment|MNCH|a6221858-0e85-11e8-ba89-0ed5f89f718b|""|TempMnchEnrolmentExtract|0|MnchEnrolmentExtract|20.00|a6221982-0e86-11e8-ba89-0ed5f89f718b
4469549E-BD31-4C99-8FE0-CA9BE614E6EF|Pnc Visit|MNCH|a6221858-0e85-11e8-ba89-0ed5f89f718b|""|TempPncVisitExtract|0|PncVisitExtract|24.00|a6221982-0e86-11e8-ba89-0ed5f89f718b
405B749C-5E73-4D36-8698-BD5334F1AC26|Mnch Art|MNCH|a6221858-0e85-11e8-ba89-0ed5f89f718b|""|TempMnchArtExtract|0|MnchArtExtract|21.00|a6221982-0e86-11e8-ba89-0ed5f89f718b
6F825B4F-4179-42D4-B32D-F473162A266B|Mother Baby Pair|MNCH|a6221858-0e85-11e8-ba89-0ed5f89f718b|""|TempMotherBabyPairExtract|0|MotherBabyPairExtract|25.00|a6221982-0e86-11e8-ba89-0ed5f89f718b
C4076AFF-98BB-4EA7-B4CD-01F845C9C611|Anc Visit|MNCH|a6221858-0e85-11e8-ba89-0ed5f89f718b|""|TempAncVisitExtract|0|AncVisitExtract|22.00|a6221982-0e86-11e8-ba89-0ed5f89f718b
ED45ABA8-F5C2-4EA6-85EC-836CFBA4211E|Mnch Patient|MNCH|a6221858-0e85-11e8-ba89-0ed5f89f718b|""|TempPatientMnchExtract|1|PatientMnchExtract|19.00|a6221982-0e86-11e8-ba89-0ed5f89f718b
F8D4B2D3-9A4D-4B2A-BE45-5B4A3492B0F9|Cwc Enrolment|MNCH|a6221858-0e85-11e8-ba89-0ed5f89f718b|""|TempCwcEnrolmentExtract|0|CwcEnrolmentExtract|26.00|a6221982-0e86-11e8-ba89-0ed5f89f718b
D15D7235-C4C4-4219-8364-C585BA708B81|Cwc Visit|MNCH|a6221858-0e85-11e8-ba89-0ed5f89f718b|""|TempCwcVisitExtract|0|CwcVisitExtract|27.00|a6221982-0e86-11e8-ba89-0ed5f89f718b
1CD97F9F-8659-4444-8DC8-4FBA08B88E0B|Mnch Labs|MNCH|a6221858-0e85-11e8-ba89-0ed5f89f718b|""|TempMnchLabExtract|0|MnchLabExtract|29.00|a6221982-0e86-11e8-ba89-0ed5f89f718b
846DE4FD-A8D9-46F3-9902-01C1657923AD|Mat Visit|MNCH|a6221858-0e85-11e8-ba89-0ed5f89f718b|""|TempMatVisitExtract|0|MatVisitExtract|23.00|a6221982-0e86-11e8-ba89-0ed5f89f718b
497E84D7-5819-47BA-9117-50108935E718|Indicators|MTS|a6221858-0e85-11e8-ba89-0ed5f89f718b|""|Indicator|1|IndicatorExtract|1.00|a6221982-0e86-11e8-ba89-0ed5f89f718b
2328A891-F0CF-436C-A68E-69DFFD0AF7BC|Allergies Chronic Illness|NDWH|a6221858-0e85-11e8-ba89-0ed5f89f718b|""|dwhstage|0|AllergiesChronicIllnessExtract|11.00|a6221982-0e86-11e8-ba89-0ed5f89f718b
9A7686D9-4F29-40B6-B8D1-98B9EE5FDA70|IPT|NDWH|a6221858-0e85-11e8-ba89-0ed5f89f718b|""|dwhstage|0|IptExtract|12.00|a6221982-0e86-11e8-ba89-0ed5f89f718b
3384309B-C4DF-4DFE-A013-21366CB3FDBB|Depression Screening|NDWH|a6221858-0e85-11e8-ba89-0ed5f89f718b|""|dwhstage|0|DepressionScreeningExtract|13.00|a6221982-0e86-11e8-ba89-0ed5f89f718b
D1743670-8125-4904-AE02-0D62093C72B2|Contact Listing|NDWH|a6221858-0e85-11e8-ba89-0ed5f89f718b|""|dwhstage|0|ContactListingExtract|14.00|a6221982-0e86-11e8-ba89-0ed5f89f718b
8A7F44AF-9A28-48F6-966B-0214E6E54000|GBV Screening|NDWH|a6221858-0e85-11e8-ba89-0ed5f89f718b|""|dwhstage|0|GbvScreeningExtract|15.00|a6221982-0e86-11e8-ba89-0ed5f89f718b
84E023EB-4DA9-45DC-B2A0-76DBAB0A6B44|Enhanced Adherence Counselling|NDWH|a6221858-0e85-11e8-ba89-0ed5f89f718b|""|dwhstage|0|EnhancedAdherenceCounsellingExtract|16.00|a6221982-0e86-11e8-ba89-0ed5f89f718b
EB6036E5-DC82-4E00-B639-2922F40B2AF7|Drug and Alcohol Screening|NDWH|a6221858-0e85-11e8-ba89-0ed5f89f718b|""|dwhstage|0|DrugAlcoholScreeningExtract|17.00|a6221982-0e86-11e8-ba89-0ed5f89f718b
77E3567C-35B6-412D-9232-95CE921C0ABE|OVC|NDWH|a6221858-0e85-11e8-ba89-0ed5f89f718b|""|dwhstage|0|OvcExtract|18.00|a6221982-0e86-11e8-ba89-0ed5f89f718b
3F4F860A-6FB3-4B82-B78A-3C435932285C|OTZ|NDWH|a6221858-0e85-11e8-ba89-0ed5f89f718b|""|dwhstage|0|OtzExtract|19.00|a6221982-0e86-11e8-ba89-0ed5f89f718b
583AB3B7-7CE4-4A7B-A99A-89DEBF5AD54C|Patient Adverse Events|NDWH|a6221858-0e85-11e8-ba89-0ed5f89f718b|""|dwhstage|0|PatientAdverseEventExtract|8.00|a6221982-0e86-11e8-ba89-0ed5f89f718b
82F6CED2-234D-40CF-8B5C-7A6E074A8A0B|Patient Status|NDWH|a6221858-0e85-11e8-ba89-0ed5f89f718b|""|dwhstage|0|PatientStatusExtract|4.00|a6221982-0e86-11e8-ba89-0ed5f89f718b
FC60FEB6-6DA6-48FE-ACC0-E9F148AD64F6|ART Patients|NDWH|a6221858-0e85-11e8-ba89-0ed5f89f718b|""|dwhstage|0|PatientArtExtract|2.00|a6221982-0e86-11e8-ba89-0ed5f89f718b
698FC2EA-1333-4D97-9521-E6AA73609BC4|All Patients|NDWH|a6221858-0e85-11e8-ba89-0ed5f89f718b|""|dwhstage|1|PatientExtract|1.00|a6221982-0e86-11e8-ba89-0ed5f89f718b
E3EDC78A-A0DF-4C35-98C6-AA83B6679781|Patient Baselines|NDWH|a6221858-0e85-11e8-ba89-0ed5f89f718b|""|dwhstage|0|PatientBaselineExtract|3.00|a6221982-0e86-11e8-ba89-0ed5f89f718b
C2A18340-03D0-41FD-B2C5-7507D9653BDF|Patient Labs|NDWH|a6221858-0e85-11e8-ba89-0ed5f89f718b|""|dwhstage|0|PatientLabExtract|5.00|a6221982-0e86-11e8-ba89-0ed5f89f718b
9FC67989-2E8D-49FC-82D0-C15BB1789565|Patient Pharmacy|NDWH|a6221858-0e85-11e8-ba89-0ed5f89f718b|""|dwhstage|0|PatientPharmacyExtract|6.00|a6221982-0e86-11e8-ba89-0ed5f89f718b
A4498816-5690-43CB-A15E-DA02DB82262D|Patient Visit|NDWH|a6221858-0e85-11e8-ba89-0ed5f89f718b|""|dwhstage|0|PatientVisitExtract|7.00|a6221982-0e86-11e8-ba89-0ed5f89f718b
CF1F7642-C5B2-456D-975A-8BC83F86F8E5|Smart Card|PSMART|a6221858-0e85-11e8-ba89-0ed5f89f718b|""|PSmartStage|1|pSmart|1.00|a6221982-0e86-11e8-ba89-0ed5f89f718b


2bbeec30-7754-11eb-9439-0242ac130002|Covid|NDWH|a6221856-0e85-11e8-ba89-0ed5f89f718b|"select d.patient_id                                                                  PatientPK,
                            a.uuid   as RecordUUID,
                          i.siteCode                                                                    SiteCode,
                          d.unique_patient_no                                                           PatientID,
                          'KenyaEMR'                                                                    Emr,
                          'Kenya HMIS II'                                                               Project,
                          i.facilityName                                                                FacilityName,
                          0 as                                                                          FacilityId,
                          a.visit_id                                                                    VisitID,
                          a.visit_date                                                                  Covid19AssessmentDate,
                          if(a.final_vaccination_status in (166192, 5585), 'Yes', 'No')               as ReceivedCOVID19Vaccine,
                          a.first_dose_date                                                          as DateGivenFirstDose,
                          (case a.first_vaccine_type
                               when 166156 then 'Astrazeneca'
                               when 166355 then 'Johnson and Johnson'
                               when 166154 then 'Moderna'
                               when 166155 then 'Pfizer'
                               when 166157 then 'Sputnik'
                               when 166379 then 'Sinopharm'
                               when 1067 then 'Unknown'
                               when 5622
                                   then 'Other' end)                                               as FirstDoseVaccineAdministered,
                          a.second_dose_date                                                         as DateGivenSecondDose,
                          (case a.second_vaccine_type
                               when 166156 then 'Astrazeneca'
                               when 166355 then 'Johnson and Johnson'
                               when 166154 then 'Moderna'
                               when 166155 then 'Pfizer'
                               when 166157 then 'Sputnik'
                               when 166379 then 'Sinopharm'
                               when 1067 then 'Unknown'
                               when 5622
                                   then 'Other' end)                                               as SecondDoseVaccineAdministered,
                          (case a.final_vaccination_status
                               when 166192 then 'Partially Vaccinated'
                               when 5585 then 'Fully Vaccinated'
                               else 'Not Vaccinated' end)                                              as VaccinationStatus,
                          (case a.first_vaccination_verified when 164134 then 'Yes' else 'No' end)   as VaccineVerification,
                          (case a.second_vaccination_verified when 164134 then 'Yes' else 'No' end)  as VaccineVerificationSecondDose,
                          (case a.ever_received_booster
                               when 1065 then 'Yes'
                               when 1066 then 'No' end)                                                as BoosterGiven,
                          (case a.booster_vaccine_taken
                               when 166156 then 'Astrazeneca'
                               when 166355 then 'Johnson and Johnson'
                               when 166154 then 'Moderna'
                               when 166155 then 'Pfizer'
                               when 166157 then 'Sputnik'
                               when 166379 then 'Sinopharm'
                               when 1067 then 'Unknown'
                               when 5622 then 'Other(Specify)' end)                                  as BoosterDose,
                          a.date_taken_booster_vaccine                                               as BoosterDoseDate,
                          a.booster_sequence                                                         as Sequence,
                          (case a.ever_tested_covid_19_positive
                               when 703 then 'Yes'
                               when 664 then 'No'
                               when 1067 then 'Unknown' end)                                         as EverCOVID19Positive,
                          (case a.ever_tested_covid_19_positive
                               when 703 then 'Yes'
                               when 664 then 'No'
                               when 1067 then 'Unknown' end)                                         as COVID19TestResult,
                          (case booster_dose_verified when 164134 then 'Yes' end)                    as BoosterDoseVerified,
                          a.date_tested_positive                                                     as COVID19TestDate,
                          (case a.symptomatic
                               when 1068 then 'Symptomatic'
                               when 165912 then 'Asymptomatic' END)                                            as PatientStatus,
                          (case a.hospital_admission
                               when 1065 then 'Yes'
                               when 1066 then 'No' end)                                              as AdmissionStatus,
                          a.admission_unit                                                           as AdmissionUnit,
                          ''                                                                         as MissedAppointmentDueToCOVID19,
                          ''                                                                         as COVID19PositiveSinceLasVisit,
                          ''                                                                         as COVID19TestDateSinceLastVisit,
                          ''                                                                         as PatientStatusSinceLastVisit,
                          ''                                                                         as AdmissionStatusSinceLastVisit,
                          ''                                                                         as AdmissionStartDate,
                          ''                                                                         as AdmissionEndDate,
                          ''                                                                         as AdmissionUnitSinceLastVisit,
                          (case a.on_oxygen_supplement when 1065 then 'Yes' when 1066 then 'No' end) as SupplementalOxygenReceived,
                          (case a.on_ventillator when 1065 then 'Yes' when 1066 then 'No' end)       as PatientVentilated,
                          a.date_created                                                             as Date_Created,
                          a.date_last_modified                                                       as Date_Last_Modified,
                          '' as TracingFinalOutcome,
                          '' as CauseOfDeath,
                         a.voided                                                                   as Voided
                  from dwapi_etl.etl_patient_demographics d
                           join dwapi_etl.etl_covid19_assessment a on d.patient_id = a.patient_id
                           join kenyaemr_etl.etl_default_facility_info i
                  group by a.visit_id"|dwhstage|0|CovidExtract|20|a6221aa4-0e85-11e8-ba89-0ed5f89f718b
2bbeec31-7754-11eb-9439-0242ac130002|Defaulter Tracing|NDWH|a6221856-0e85-11e8-ba89-0ed5f89f718b|"select d.patient_id                                                              PatientPK,
                         f.uuid   as RecordUUID,
                         i.siteCode                                                                SiteCode,
                       d.unique_patient_no                                                       PatientID,
                       'KenyaEMR'                                                                Emr,
                       'Kenya HMIS II'                                                           Project,
                       i.facilityName                                                            FacilityName,
                       0 as                                                                          FacilityId,
                       f.visit_id                                                                VisitID,
                       f.visit_date                                                              VisitDate,
                       f.encounter_id                                                         as EncounterId,
                       (case f.tracing_type
                                           when 1650 then 'Client Called'
                                           when 164965 then 'Physical Tracing'
                                           when 161642 then 'Treatment supporter' end)                         as TracingType,
                       (case f.tracing_outcome
                                           when 1267 then 'Contact'
                                           when 1118 then 'No contact' end)                                    as TracingOutcome,
                       f.attempt_number                                                       as AttemptNumber,
                       (case f.is_final_trace when 1267 then 'Yes' when 163339 then 'No' end) as IsFinalTrace,
                       (case f.tracing_outcome
                                           when 165610 then 'COVID19 Positive'
                                           when 160432 then 'Dead'
                                           when 1693 then 'Receiving ART from another clinic/Transferred'
                                           when 160037 then 'Still in care at CCC'
                                           when 5240 then 'Lost to follow up'
                                           when 164435 then 'Stopped treatment' end)                           as TrueStatus,
                    (case f.reason_for_missed_appointment
                        when 165609 then 'Client has covid-19 infection'
                        when 165610 then 'COVID-19 restrictions'
                        when 164407 then 'Client refilled drugs from another facility'
                        when 159367 then 'Client has enough drugs'
                        when
                            162619 then 'Client travelled'
                        when 126240 then 'Client could not get an off from work/school'
                        when 160583
                            then 'Client is sharing drugs with partner'
                        when 162192 then 'Client forgot clinic dates'
                        when 164349
                            then 'Client stopped medications'
                        when 1654 then 'Client sick at home/admitted'
                        when 5622 then 'Other' end)                                       as ReasonForMissedAppointment,
                    case
                        when fup.next_appointment_date < '1990-01-01' then null
                        else CAST(fup.next_appointment_date AS DATE) end                     AS DatePromisedToCome,
                    f.missed_appointment_date                                               as DateOfMissedAppointment,  
                       (case f.cause_of_death
                                           when 165609 then 'Infection due to COVID-19'
                                           when 162574 then 'Death related to HIV infection'
                                           when 116030 then 'Cancer'
                                           when 164500 then 'TB'
                                           when 151522 then 'Other infectious and parasitic diseases'
                                           when 133481 then 'Natural cause'
                                           when 1603 then 'Unnatural Cause'
                                           when 5622 then 'Unknown cause' end)                                 as CauseOfDeath,                                                 
                       f.comments                                                             as Comments,
                       date(f.booking_date)                                                   as BookingDate,
                       f.date_created                                                         as Date_Created,
                       f.date_last_modified                                                   as Date_Last_Modified,
f.voided                                                               as Voided
from dwapi_etl.etl_patient_demographics d
join dwapi_etl.etl_ccc_defaulter_tracing f on d.patient_id = f.patient_id
join dwapi_etl.etl_patient_hiv_followup fup on fup.patient_id = d.patient_id
join kenyaemr_etl.etl_default_facility_info i
group by f.visit_id"|dwhstage|0|DefaulterTracingExtract|21|a6221aa4-0e85-11e8-ba89-0ed5f89f718b

3425F2F6-B9D8-48F1-97F6-8E6E092B0C97|Cancer Screening|NDWH|a6221856-0e85-11e8-ba89-0ed5f89f718b|"select d.patient_id                                                                                              PatientPK,
                                        s.uuid                                        as RecordUUID,
                                         i.siteCode                                       SiteCode,
                                         d.unique_patient_no                              PatientID,
                                         0                                             as FacilityId,
                                         'KenyaEMR'                                       Emr,
                                         'Kenya HMIS III'                                 Project,
                                         i.facilityName                                   FacilityName,
                                         '' as TreatmentRetinoblastoma,
                                         '' as RetinoblastomaGene,
                                         '' as ReferalOrdered,                                         
                                         '' as IfTissueDiagnosis,
                                         '' as DateTissueDiagnosis,
                                         '' as ReasonNotDone,
                                         '' as Referred,
                                         '' as ReasonForReferral,
                                         s.visit_id                                       VisitId,
                                         s.visit_date                                     VisitDate,
                                         s.visit_type                                  as VisitType,
                                         s.smoke_cigarattes                            as SmokesCigarette,
                                         s.number_of_years_smoked                      as NumberYearsSmoked,
                                         s.number_of_cigarette_per_day                 as NumberCigarettesPerDay,
                                         s.other_forms_tobacco                         as OtherFormTobacco,
                                         s.take_alcohol                                as TakesAlcohol,
                                         s.hiv_status                                  as HIVStatus,
                                         s.family_history                              as FamilyHistoryOfCa,
                                         s.previous_treatment                          as PreviousCaTreatment,
                                         s.signs_symptoms                              as SymptomsCa,
                                         if(s.cervical_cancer = 'Yes', 'Cervical', if(s.colorectal_cancer = 'Yes', 'Colorectal',
                             if(s.retinoblastoma_cancer = 'Yes', 'RetinoBlastoma',
                                if(s.oral_cancer = 'Yes', 'Oral',
                                   if(s.prostate_cancer = 'Yes', 'Prostate',
                                      if(s.breast_cancer = 'Yes', 'Breast', NULL)))))) as CancerType,
                                         s.fecal_occult_screening_results              as FecalOccultBloodTest,
                                         s.fecal_occult_screening_treatment            as TreatmentOccultBlood,
                                         s.colonoscopy_method_results                  as Colonoscopy,
                                         s.colonoscopy_method_treatment                as TreatmentColonoscopy,
                                         s.retinoblastoma_eua_screening_results        as EUA,
                                         s.retinoblastoma_eua_treatment                as TreatmentEUA,
                                         s.digital_rectal_prostate_examination         as DRE,
                                         s.digital_rectal_prostate_treatment           as TreatmentDRE,
                                         s.prostatic_specific_antigen_results          as PSA,
                                         s.prostatic_specific_antigen_treatment        as TreatmentPSA,
                                         s.oral_cancer_visual_exam_results             as visualExamination,
                                         s.oral_cancer_visual_exam_treatment           as TreatmentVE,
                                         s.oral_cancer_cytology_results                as Cytology,
                                         s.oral_cancer_cytology_treatment              as TreatmentCytology,
                                         s.oral_cancer_imaging_results                 as Imaging,
                                         s.oral_cancer_imaging_treatment               as TreatmentImaging,
                                         s.oral_cancer_biopsy_results                  as Biopsy,
                                         s.oral_cancer_biopsy_treatment                as TreatmentBiopsy,                                         
                                         null                                          as ScreeningMethod,
                                         null                                          as TreatmentToday,
                                         s.screening_type                              as ScreeningType,
                                         s.hpv_screening_result                        as HPVScreeningResult,
                                         s.hpv_treatment_method                        as TreatmentHPV,
                                         s.via_vili_screening_result                   as VIAVILIScreeningResult,
                                         s.via_vili_treatment_method                   as VIAVILITreatment,
                                         ''                                            as VIAScreeningResult,
                                         ''                                            as VIATreatmentOptions,
                                         s.colposcopy_screening_result                 as Colposcopy,
                                         s.colposcopy_treatment_method                 as TreatmentColposcopy,
                                         s.pap_smear_screening_result                  as PAPSmearScreeningResult,
                                         s.pap_smear_treatment_method                  as TreatmentPapSmear,
                                         s.clinical_breast_examination_screening_result    as CBE,
                                         s.clinical_breast_examination_treatment_method    as TreatmentCBE,
                                         s.ultrasound_screening_result                 as Ultrasound,
                                         s.ultrasound_treatment_method                 as TreatmentUltraSound,
                                         s.post_treatment_complication_cause           as PostTreatmentComplicationCause,
                                         s.post_treatment_complication_other           as OtherPostTreatmentComplication,
                                         null                                          as ScreeningResult,
                                         s.referred_out                                as ReferredOut,
                                         s.referral_reason                             as ReferralReason,
                                         date(s.followup_date)                         as NextAppointmentDate,
                                         s.date_created                                as Date_Created,
                                         s.date_last_modified                          as Date_Last_Modified,
                                         s.voided                                      as Voided
                                  from dwapi_etl.etl_patient_demographics d
                                           join dwapi_etl.etl_cervical_cancer_screening s on d.patient_id = s.patient_id
                                           join kenyaemr_etl.etl_default_facility_info i
                                  group by s.visit_id"|dwhstage|0|CancerScreeningExtract|22|a6221aa4-0e85-11e8-ba89-0ed5f89f718b
235A64F3-9EA9-4CCC-8C28-AD7EB8209F9C|IIT Risk Scores|NDWH|a6221856-0e85-11e8-ba89-0ed5f89f718b|"SELECT r.patient_id         as PatientPK,
                                                 d.unique_patient_no                    PatientID,
                                                i.siteCode           as SiteCode,
                                                i.FacilityName       as FacilityName,
                                                0                    as FacilityId,
                                                'KenyaEMR'           as Emr,
                                                'Kenya HMIS III'     as Project,
                                                r.source_system_uuid as SourceSysUUID,
                                                r.risk_score         as RiskScore,
                                                r.risk_factors       as RiskFactors,
                                                r.description        as RiskDescription,
                                                r.evaluation_date    as RiskEvaluationDate,
                                                r.date_created       as Date_Created,
                                                r.date_changed       as Date_Last_Modified,	
                                                convert(r.voided, SIGNED)              as Voided	
                                FROM openmrs.kenyaemr_ml_patient_risk_score r	
                                         inner join dwapi_etl.etl_patient_demographics d on d.patient_id = r.patient_id	
                                         join kenyaemr_etl.etl_default_facility_info i"|dwhstage|0|IITRiskScoresExtract|23|a6221aa4-0e85-11e8-ba89-0ed5f89f718b

A47EFA09-28D9-46EC-B2E6-C6244DBDA240|Art Fast Track|NDWH|a6221856-0e85-11e8-ba89-0ed5f89f718b|"select a.patient_id                                                                           as PatientPK,
                          s.siteCode                                                                             as SiteCode,
                          de.unique_patient_no                                                                   as PatientID,
                          a.uuid                                                                                 as RecordUUID,
                          'KenyaEMR'                                                                             as Emr,
                          'Kenya HMIS III'                                                                       as Project,
                          s.FacilityName                                                                         as FacilityName,
                          0                                                                                      as FacilityId,
                          case a.art_refill_model
                              when 1744 then 'Fast Track'
                              when 1555 then 'Community ART Distribution - HCW Led'
                              when 5618 then 'Community ART Distribution - Peer Led'
                              when 1537 then 'Facility ART Distribution Group' end                               as ARTRefillModel,
                          a.visit_date                                                                           as VisitDate,
                          case a.ctx_dispensed when 162229 then 'Yes' end                                        as CTXDispensed,
                          case a.dapsone_dispensed when 74250 then 'Yes' end                                     as DapsoneDispensed,
                          case a.condoms_distributed
                              when 1065 then 'Yes'
                              when 1066 then 'No' end                                                            as CondomsDistributed,
                          case a.oral_contraceptives_dispensed when 780 then 'Yes' end                           as OralContraceptivesDispensed,
                          a.doses_missed                                                                         as MissedDoses,
                          case a.fatigue when 162626 then 'Yes' when 1066 then 'No' end                          as Fatigue,
                          case a.cough when 143264 then 'Yes' when 1066 then 'No' end                            as Cough,
                          case a.fever when 140238 then 'Yes' when 1066 then 'No' end                            as Fever,
                          case a.rash when 512 then 'Yes' when 1066 then 'No' end                                as Rash,
                          case a.nausea_vomiting when 5978 then 'Yes' when 1066 then 'No' end                    as NauseaOrVomiting,
                          case a.genital_sore_discharge
                              when 135462 then 'Yes'
                              when 1066 then 'No'
                              else null end                                                                      as GenitalSoreOrDischarge,
                          case a.diarrhea when 142412 then 'Yes' when 1066 then 'No' end                         as Diarrhea,
                          a.other_specific_symptoms                                                              as OtherSymptoms,
                          case a.pregnant when 1065 then 'Yes' when 1066 then 'No' when 1067 then 'Not sure' end as PregnancyStatus,
                          case a.family_planning_status
                              when 965 then 'On Family Planning'
                              when 160652 then 'Not using Family Planning'
                              when 1360 then 'Wants Family Planning'
                              end                                                                                as FPStatus,
                          a.family_planning_method                                                               as FPMethod,
                          a.reason_not_on_family_planning                                                        as ReasonNotOnFP,
                          a.referred_to_clinic                                                                   as ReferredToClinic,
                          a.return_visit_date                                                                    as ReturnVisitDate,
                          a.date_created as Date_Created,
                          a.date_last_modified as Date_Last_Modified,
                          a.voided as Voided
                   from dwapi_etl.etl_art_fast_track a
                            inner join dwapi_etl.etl_hiv_enrollment e on a.patient_id = e.patient_id
                            inner join dwapi_etl.etl_patient_demographics de on a.patient_id = de.patient_id
                            join kenyaemr_etl.etl_default_facility_info s"|dwhstage|0|ArtFastTrackExtract|24|a6221aa4-0e85-11e8-ba89-0ed5f89f718b

75E1A1A7-A840-4743-9F21-91F863A43737|Relationships|NDWH|a6221856-0e85-11e8-ba89-0ed5f89f718b|"SELECT r.person_a PatientPK,
                 r.uuid                                                                     as RecordUUID,
                 convert(r.voided  , SIGNED)  												as Voided,
                 i.siteCode                                                                    SiteCode,
                 d.unique_patient_no                                                           PatientID,
                 'KenyaEMR'                                                                    Emr,
                 'Kenya HMIS III'                                                               Project,
                 i.facilityName                                                                FacilityName,
                 0                                                                                      as FacilityId,
                  t.a_is_to_b as patient_relation_to_other,
                 r.person_b as person_pk_related_to_patient,
                 t.b_is_to_a                                          as RelationshipToPatient,
                 r.start_date                                         as EndDate,
                 r.end_date                                           as StartDate,
                 r.date_created                                       as Date_Created,
                 r.date_changed                                       as Date_Last_Modified
              FROM relationship r 
              INNER JOIN relationship_type t ON r.relationship = t.relationship_type_id
              join dwapi_etl.etl_patient_demographics d ON r.person_a = d.patient_id
              join kenyaemr_etl.etl_default_facility_info i"|dwhstage|0|RelationshipsExtract|25|a6221aa4-0e85-11e8-ba89-0ed5f89f718b


82651dea-9db2-11eb-a8b3-0242ac130003|Patient Prep|PREP|a6221856-0e85-11e8-ba89-0ed5f89f718b|"select d.patient_id 
                                                 as PatientPK,
                                        e.uuid                                                            RecordUUID,
                                          i.siteCode                                                    as SiteCode,
                                          i.facilityName                                                as FacilityName,
                                          d.unique_prep_number                                          as PrepNumber,
                                          d.national_unique_patient_identifier                          as NUPI,                                          
                                          d.openmrs_id                                                  as HtsNumber,
                                          'KenyaEMR'                                                    as Emr,
                                          'HMIS'                                                        as Project,
                                          e.visit_date                                                 as PrepEnrollmentDate,
                                          e.prep_type                                                   as TypeOfPrEP,
                                          case d.gender when 'M' then 'Male' when 'F' then 'Female' end as Sex,
                                          d.dob                                                         as DateOfBirth,
                                          d.birth_place                                                 as CountyOfBirth,
                                          pa.county                                                     as County,
                                          pa.sub_county                                                 as SubCounty,
                                          pa.location                                                   as Location,
                                          pa.land_mark                                                  as LandMark,
                                          pa.ward                                                       as Ward,
                                          e.patient_type                                                as ClientType,
                                          e.transfer_in_entry_point                                     as ReferralPoint,
                                          d.marital_status                                              as MaritalStatus,
                                          case e.in_school when 1 then 'Yes' when 2 then 'No' end as Inschool,
                                          (case e.population_type
                                          when 164928 then 'General Population'
                                          when 6096 then 'Discordant Couple'
                                          when 164929 then 'Key Population'
                                           end)                                           as PopulationType,
                                          case e.kp_type when 162277 then 'People in prison and other closed settings' when 165100 then 'Transgender' 
                                          when 105 then 'PWID' when 160578 then 'MSM' when 165084 then 'MSW' when 160579 then 'FSW' end as KeyPopulationType,
                                          e.referred_from                                               as Refferedfrom,
                                          if(e.transfer_in_date is not null, 'Yes', 'No')               as TransferIn,
                                          date(e.transfer_in_date)                                      as TransferInDate,
                                          e.transfer_from                                               as TransferFromFacility,
                                          e.date_started_prep_trf_facility                              as DatefirstinitiatedinPrepCare,
                                          e.date_started_prep_trf_facility                              as DateStartedPrEPattransferringfacility,
                                          e.previously_on_prep                                          as ClientPreviouslyonPrep,
                                          e.regimen                                                     as PrevPrepReg,
                                          e.prep_last_date                                              as DateLastUsedPrev,
                                          e.date_created 												as Date_Created,
                                          e.date_last_modified 											as Date_Last_Modified,
                                            e.voided                                                          as Voided
                                          from dwapi_etl.etl_prep_enrolment e
                                          left join dwapi_etl.etl_person_address pa on e.patient_id = pa.patient_id
                                          inner join dwapi_etl.etl_patient_demographics d on e.patient_id = d.patient_id
                                          inner join dwapi_etl.etl_prep_behaviour_risk_assessment r on e.patient_id = r.patient_id
                                          join kenyaemr_etl.etl_default_facility_info i"|TempPatientPrepExtract|1|PatientPrepExtract|30|a6221aa4-0e85-11e8-ba89-0ed5f89f718b

82651f02-9db2-11eb-a8b3-0242ac130003|Prep Behaviour Risk|PREP|a6221856-0e85-11e8-ba89-0ed5f89f718b|"select d.patient_id                                                                 as PatientPK,
                            h.uuid                                                                       RecordUUID,
                                        i.siteCode                                                                   as SiteCode,
                                        d.unique_prep_number                                                         as PrepNumber,
                                        d.openmrs_id                                                                 as HtsNumber,
                                        'KenyaEMR'                                                                   as Emr,
                                        'HMIS'                                                                       as Project,
                                        h.visit_date                                                                 as VisitDate,
                                        h.visit_id                                                                   as VisitId,
                                        h.sexual_partner_hiv_status                                                  as SexPartnerHIVStatus,
                                        h.sexual_partner_on_art                                                      as IsHIVPositivePartnerCurrentonART,
                                        (case h.high_risk_partner when 'High risk partner' then 'Yes' else 'No' end) as IsPartnerHighRisk,
                                        h.risk                                                                       as PartnerARTRisk,
                                        concat_ws(',', case sex_with_multiple_partners when 'Yes' then 'Has Sex with more than one partner' end,
                                                                                case ipv_gbv when 'Yes' then 'Ongoing IPVor/and GBV' end,
                                                                                case transactional_sex when 'Yes' then 'Transactional sex' end,
                                                                                case recent_sti_infected when 'Yes' then 'Recent STI in the last 6 months' end,
                                                                                case recurrent_pep_use when 'Yes' then 'Recurrent use of PEP' end,
                                                                                case recurrent_sex_under_influence
                                                                                                when 'Yes' then 'Recurrent sex under influence of alcohol/recreational drugs'
                                                                                                end,
                                                                                case inconsistent_no_condom_use when 'Yes' then 'Inconsistent or no condom use' end,
                                                                                case sharing_drug_needles
                                                                                                when 'Yes' then 'IDU with shared needles and/or syringes'
                                                                                                end, other_reason_specify)                                     as ClientAssessments,
                                        h.assessment_outcome                                                         as ClientRisk,
                                        h.willing_to_take_prep                                                       as ClientWillingToTakePrEP,
                                        h.reason_not_willing                                                         as PrEPDeclineReason,
                                        h.risk_edu_offered                                                           as RiskReductionEducationOffered,
                                        h.referral_for_prevention_services                                           as ReferralToOtherPrevServices,
                                        date(h.time_partner_hiv_positive_known)                                      as FirstEstablishPartnerStatus,
                                        h.partner_enrolled_ccc                                                       as PartnerEnrolledToCCC,
                                        h.partner_ccc_number                                                         as HIVPartnerCCCNumber,
                                        h.partner_art_start_date                                                     as HIVPartnerARTStartDate,
                                        h.HIV_serodiscordant_duration_months                                         as MonthsKnownHIVSeroDiscordant,
                                        h.recent_unprotected_sex_with_positive_partner                               as SexWithoutCondom,
                                        h.children_with_hiv_positive_partner                                         as NumberofchildrenWithPartner,
                                        h.date_created 																as Date_Created,
                                        h.date_last_modified 														as Date_Last_Modified,
                                        h.voided                                                                     as Voided
                            from dwapi_etl.etl_prep_behaviour_risk_assessment h
                                                inner join dwapi_etl.etl_prep_enrolment e on h.patient_id = e.patient_id
                                                inner join dwapi_etl.etl_patient_demographics d on e.patient_id = d.patient_id
                                                join kenyaemr_etl.etl_default_facility_info i"|TempPrepBehaviourRiskExtract|0|PrepBehaviourRiskExtract|31|a6221aa4-0e85-11e8-ba89-0ed5f89f718b
8265201a-9db2-11eb-a8b3-0242ac130003|Prep Visit|PREP|a6221856-0e85-11e8-ba89-0ed5f89f718b|"select d.patient_id                                              as PatientPK,
                               f.uuid                                                    as RecordUUID,
                               i.siteCode                                                as SiteCode,
                               d.unique_prep_number                                      as PrepNumber,
                               d.openmrs_id                                              as HtsNumber,
                               f.encounter_id                                            as EncounterId,
                               'KenyaEMR'                                                as Emr,
                               'HMIS'                                                    as Project,
                               f.visit_date                                              as VisitDate,
                               f.visit_id                                                as VisitID,
                               concat_ws('/', t.systolic_pressure, t.diastolic_pressure) as BloodPressure,
                               t.temperature                                             as Temperature,
                               t.weight                                                  as Weight,
                               t.height                                                  as Height,
                               f.sti_screened                                            as STIScreening,
                               concat_ws(',', f.genital_ulcer_disease,
                               f.vaginal_discharge,
                               f.cervical_discharge,
                               f.pid,
                               f.urethral_discharge,
                               f.anal_discharge,
                               f.other_sti_symptoms)                           as STISymptoms,
                               f.sti_treated                                             as STITreated,
                               f.vmmc_status                                             as Circumcised,
                               f.vmmc_referred                                           as VMMCReferral,
                               f.lmp                                                     as LMP,
                               f.menopausal_status                                       as MenopausalStatus,
                               f.pregnant                                                as PregnantAtThisVisit,
                               f.edd                                                     as EDD,
                               f.wanted_pregnancy                                        as PlanningToGetPregnant,
                               f.planned_pregnancy                                       as PregnancyPlanned,
                               f.ended_pregnancy                                         as PregnancyEnded,
                               f.outcome_date                                            as PregnancyEndDate,
                               f.pregnancy_outcome                                       as PregnancyOutcome,
                               f.defects                                                 as BirthDefects,
                               f.breastfeeding                                           as BreastFeeding,
                               f.fp_status                                               as FamilyPlanningStatus,
                               f.fp_method                                               as FPMethods,
                               f.adherence_counselled                                    as AdherenceDone,
                               f.adherence_outcome                                       as AdherenceOutcome,
                               f.prep_contraindications                                  as ContraindicationsPrep,
                               f.treatment_plan                                          as PrepTreatmentPlan,
                               f.prescribed_PrEP                                         as PrepPrescribed,
                               f.regimen_prescribed                                      as RegimenPrescribed,
                               f.months_prescribed_regimen                               as MonthsPrescribed,
                               f.condoms_issued                                          as CondomsIssued,
                               f.appointment_given                                       as Tobegivennextappointment,
                               f.reason_no_appointment                                   as Reasonfornotgivingnextappointment,
                               f.appointment_date                                        as NextAppointment,
                               f.clinical_notes                                          as ClinicalNotes,
                               '' as AdherenceReasons,
                               '' as BMI,
                               '' as HepatitisBPositiveResult,
                               '' as HepatitisCPositiveResult,
                               '' as SymptomsAcuteHIV,
                               case f.hepatitisB_vaccinated when 1065 then 'Yes' when 1066 then 'No' end as VaccinationForHepBStarted,
                               case f.hepatitisB_treated when 1065 then 'Yes' when 1066 then 'No' when 1788 then 'Referred' end as TreatedForHepB,
                               case f.hepatitisC_vaccinated when 1065 then 'Yes' when 1066 then 'No'  end as VaccinationForHepCStarted,
                               case f.hepatitisC_treated when 1065 then 'Yes' when 1066 then 'No' when 1788 then 'Referred' end as TreatedForHepC,
                               f.date_created 								as Date_Created,
                               f.date_last_modified 			            as Date_Last_Modified,
                                f.voided                                    as Voided
                               	from dwapi_etl.etl_prep_followup f	
                               left join dwapi_etl.etl_patient_triage t on f.patient_id = t.patient_id and f.visit_date = t.visit_date	
                               inner join dwapi_etl.etl_prep_enrolment e on f.patient_id = e.patient_id	
                               inner join dwapi_etl.etl_patient_demographics d on e.patient_id = d.patient_id	
                               join kenyaemr_etl.etl_default_facility_info i"|TempPrepVisitExtract|0|PrepVisitExtract|32|a6221aa4-0e85-11e8-ba89-0ed5f89f718b
8265213c-9db2-11eb-a8b3-0242ac130003|Prep Labs|PREP|a6221856-0e85-11e8-ba89-0ed5f89f718b|"select distinct '' AS SatelliteName, 0 AS FacilityId,
                            l.uuid                                                                           as RecordUUID,
                                        d.unique_prep_number as PrepNumber, d.patient_id as PatientPK,
                                         d.openmrs_id as HtsNumber,l.encounter_id as VisitID,
                                            CAST(l.visit_date AS DATE) as OrderedByDate,CAST(l.visit_date AS DATE) as TestResultDate,
                                            i.siteCode as SiteCode,
                                            i.facilityName as FacilityName,
                                            cn.name as TestName,
                                            l.date_test_requested as SampleDate,
                                            (case l.order_reason when 843 then 'Confirmation of treatment failure (repeat VL)'
                                                when 1434 then 'Pregnancy' when 162080 then 'Baseline VL (for infants diagnosed through EID)'
                                                when 1259 then 'Single Drug Substitution' when 159882 then 'Breastfeeding'
                                                when 163523 then 'Clinical failure' when 161236 then 'Routine'
                                                when 160032 then 'Confirmation of persistent low level Viremia (PLLV)' end) as Reason,
                                            case
                                            when c.datatype_id=2 then cn2.name
                                            else
                                                    l.test_result
                                            end as TestResult,
                                            NULL as EnrollmentTest,'' as SampleType,
                                            'KenyaEMR' as Emr,
                                            'Kenya HMIS II' as Project,
                                            l.date_created as Date_Created,
                                            GREATEST(COALESCE(l.date_last_modified, d.date_last_modified), COALESCE(d.date_last_modified, l.date_last_modified)) as Date_Last_Modified,
                                            l.voided                                                                         as Voided
                          from dwapi_etl.etl_laboratory_extract l
                          join dwapi_etl.etl_patient_demographics d on d.patient_id=l.patient_id
                          join concept_name cn on cn.concept_id=l.lab_test and cn.concept_name_type='FULLY_SPECIFIED'and cn.locale='en'
                          join concept c on c.concept_id = l.lab_test
                          join kenyaemr_etl.etl_default_facility_info i
                          join (select p.patient_id from dwapi_etl.etl_prep_enrolment p)p on l.patient_id = p.patient_id
                          left outer join concept_name cn2 on cn2.concept_id=l.test_result and cn2.concept_name_type='FULLY_SPECIFIED'
                          and cn2.locale='en' where p.patient_id is not null"|TempPrepLabExtract|0|PrepLabExtract|33|a6221aa4-0e85-11e8-ba89-0ed5f89f718b
82652272-9db2-11eb-a8b3-0242ac130003|Prep Pharmacy|PREP|a6221856-0e85-11e8-ba89-0ed5f89f718b|"select d.patient_id                as PatientPK,
                                            f.uuid                      RecordUUID,
                                            i.siteCode                  as SiteCode,
                                            d.unique_prep_number        as PrepNumber,
                                            d.openmrs_id                as HtsNumber,
                                            0                           as FacilityID,
                                            'KenyaEMR'                  as Emr,
                                            'HMIS'                      as Project,
                                            f.visit_id                  as VisitID,
                                            f.regimen_prescribed        as RegimenPrescribed,
                                            f.visit_date                as DispenseDate,
                                            f.months_prescribed_regimen as Duration,
                                            f.date_created              as Date_Created,
                                            f.date_last_modified        as Date_Last_Modified,
                                            f.voided                    as Voided
                          from dwapi_etl.etl_prep_followup f
                                                    join dwapi_etl.etl_patient_demographics d on d.patient_id = f.patient_id
                                                    join kenyaemr_etl.etl_default_facility_info i
                          where f.prescribed_PrEP = 'Yes'"|TempPrepPharmacyExtract|0|PrepPharmacyExtract|34|a6221aa4-0e85-11e8-ba89-0ed5f89f718b
82652358-9db2-11eb-a8b3-0242ac130003|Prep Adverse Events|PREP|a6221856-0e85-11e8-ba89-0ed5f89f718b|"select a.patient_id                                                 as PatientPK,
                            a.uuid                                                       RecordUUID,
                                    s.siteCode                                                   as SiteCode,
                                    de.unique_prep_number                                         as PrepNumber,
                                    0                                                            AS FacilityId,
                                    'KenyaEMR'                                                   as Emr,
                                    'Kenya HMIS II'                                              as Project,
                                    s.FacilityName                                               as FacilityName,
                                    a.visit_date                                                 as VisitDate,
                                    group_concat(case a.cause
                                                when 70056 then 'Abicavir'
                                                when 162298 then 'ACE inhibitors'
                                                when 70878 then 'Allopurinol'
                                                when 155060 then 'Aminoglycosides'
                                                when 162299 then 'ARBs (angiotensin II receptor blockers)'
                                                when 103727 then 'Aspirin'
                                                when 71647 then 'Atazanavir'
                                                when 72822 then 'Carbamazepine'
                                                when 162301 then 'Cephalosporins'
                                                when 73300 then 'Chloroquine'
                                                when 73667 then 'Codeine'
                                                when 74807 then 'Didanosine'
                                                when 75523 then 'Efavirenz'
                                                when 162302 then 'Erythromycins'
                                                when
                                                                75948 then 'Ethambutol'
                                                when 77164 then 'Griseofulvin'
                                                when 162305 then 'Heparins'
                                                when 77675 then 'Hydralazine'
                                                when 78280 then 'Isoniazid'
                                                when 794 then 'Lopinavir/ritonavir'
                                                when 80106 then 'Morphine'
                                                when 80586 then 'Nevirapine'
                                                when 80696 then 'Nitrofurans'
                                                when 162306 then 'Non-steroidal anti-inflammatory drugs'
                                                when 81723 then 'Penicillamine'
                                                when 81724 then 'Penicillin'
                                                when 81959 then 'Phenolphthaleins'
                                                when 82023 then 'Phenytoin'
                                                when
                                                                82559 then 'Procainamide'
                                                when 82900 then 'Pyrazinamide'
                                                when 83018 then 'Quinidine'
                                                when 767 then 'Rifampin'
                                                when 162307 then 'Statins'
                                                when 84309 then 'Stavudine'
                                                when 162170 then 'Sulfonamides'
                                                when 84795 then 'Tenofovir'
                                                when 84893 then 'Tetracycline'
                                                when 86663 then 'Zidovudine'
                                                when 5622 then 'Other' end SEPARATOR '|')   as AdverseEventCause,
                        group_concat(case a.adverse_event
                                                when 1067 then 'Unknown'
                                                when 121629 then 'Anaemia'
                                                when 148888 then 'Anaphylaxis'
                                                when 148787 then 'Angioedema'
                                                when 120148 then 'Arrhythmia'
                                                when 108 then 'Bronchospasm'
                                                when 143264 then 'Cough'
                                                when 142412 then 'Diarrhea'
                                                when 118773 then 'Dystonia'
                                                when 140238 then 'Fever'
                                                when 140039 then 'Flushing'
                                                when 139581 then 'GI upset'
                                                when 139084 then 'Headache'
                                                when 159098 then 'Hepatotoxicity'
                                                when 111061 then 'Hives'
                                                when 117399 then 'Hypertension'
                                                when 879 then 'Itching'
                                                when 121677 then 'Mental status change'
                                                when 159347 then 'Musculoskeletal pain'
                                                when 121 then 'Myalgia'
                                                when 512 then 'Rash'
                                                when 5622 then 'Other' end SEPARATOR '|')   as AdverseEvent,
                                    group_concat(case a.severity
                                                when 1498 then 'Mild'
                                                when 1499 then 'Moderate'
                                                when 1500 then 'Severe'
                                                when 162819 then 'Fatal'
                                                when 1067 then 'Unknown' end SEPARATOR '|') as Severity,
                                    group_concat(a.start_date SEPARATOR '|')                     as AdverseEventStartDate,
                                    ''                                                           as AdverseEventEndDate,
                                    group_concat(case a.action_taken
                                                when 1257 then 'CONTINUE REGIMEN'
                                                when 1259 then 'SWITCHED REGIMEN'
                                                when 981 then 'CHANGED DOSE'
                                                when 1258 then 'SUBSTITUTED DRUG'
                                                when 1107 then 'NONE'
                                                when 1260 then 'STOP'
                                                when 5622 then 'Other' end SEPARATOR '|')   as AdverseEventActionTaken,
                                    ''                                                           as AdverseEventClinicalOutcome,
                                    ''                                                           as AdverseEventIsPregnant,
                                    ''                                                           as AdverseEventRegimen,
                                    a.date_created                                               as Date_Created,
                                    a.date_last_modified                                         as Date_Last_Modified,
                                        a.voided                                                     as Voided
                        from dwapi_etl.etl_adverse_events a
                                            left join (select pe.patient_id, max(pe.visit_date) as prep_latest_enrolment_date
                                                                                        from dwapi_etl.etl_prep_enrolment pe
                                                                                        group by pe.patient_id) pe on a.patient_id = pe.patient_id
                                            left join dwapi_etl.etl_prep_followup p on a.encounter_id = p.encounter_id
                                            left join (select d.patient_id as         PrEP_disc_patient,
                                                                                                                    max(date(d.visit_date)) PrEP_Outcome_date
                                                                                        from dwapi_etl.etl_prep_discontinuation d
                                                                                        group by d.patient_id) pd on pd.PrEP_disc_patient = a.patient_id
                                            inner join dwapi_etl.etl_patient_demographics de on a.patient_id = de.patient_id
                                            join kenyaemr_etl.etl_default_facility_info s
                        where a.form in ('prep-initial','prep-consultation')
                        and (pd.PrEP_disc_patient is null or pd.PrEP_Outcome_date < pe.prep_latest_enrolment_date)
                        group by a.patient_id,a.visit_date"|TempPrepAdverseEventExtract|0|PrepAdverseEventExtract|35|a6221aa4-0e85-11e8-ba89-0ed5f89f718b
82652470-9db2-11eb-a8b3-0242ac130003|Prep Care Termination|PREP|a6221856-0e85-11e8-ba89-0ed5f89f718b|"select d.patient_id as PatientPK,
                              f.uuid                              RecordUUID,
                                        i.siteCode as SiteCode,
                                        d.unique_prep_number as PrepNumber,
                                        d.openmrs_id as HtsNumber,
                                        'KenyaEMR' as Emr, 'HMIS' as Project,
                                                                            f.visit_date as ExitDate,
                                                                            f.discontinue_reason as ExitReason,
                                                                            CAST(f.last_prep_dose_date AS DATE) as DateOfLastPrepDose,
                                                                                        f.date_created as DateCreated,
                                                                                        f.date_last_modified as DateModified,
                                                                                            f.voided                            as Voided
                                                            from dwapi_etl.etl_prep_discontinuation f
                                                                join dwapi_etl.etl_patient_demographics d on d.patient_id = f.patient_id
                                join kenyaemr_etl.etl_default_facility_info i"|TempPrepCareTerminationExtract|0|PrepCareTerminationExtract|35|a6221aa4-0e85-11e8-ba89-0ed5f89f718b
FC9AA929-73D8-4CA7-83EA-7882D6C18D16|Prep Monthly Refill|PREP|a6221856-0e85-11e8-ba89-0ed5f89f718b|"select d.patient_id    as PatientPK,
                           r.uuid                           as RecordUUID,
                           i.siteCode                       as SiteCode,
                           d.unique_prep_number             as PrepNumber,
                           'KenyaEMR'                       as Emr,
                           'Kenya HMIS III'                 as Project,
                           r.visit_date                     as VisitDate,
                           ''   as SexPartnerHIVStatus,
                           ''   as SymptomsAcuteHIV,
                           ''   as ContraIndicationForPrEP,
                           ''   as CondomsIssued,
                           ''   as ReasonForFailureToGiveAppointment,
                           ''   as DateOfLastPrepDose, 
                           r.assessed_for_behavior_risk     as BehaviorRiskAssessment,
                           r.risk_for_hiv_positive_partner  as RiskForHIVPositivePartner,
                           r.client_assessment              as ClientAssessment,
                           r.adherence_assessment           as AdherenceAssessment,
                           r.poor_adherence_reasons         as PoorAdherenceReasons,
                           r.other_poor_adherence_reasons   as OtherPoorAdherenceReason,
                           r.adherence_counselling_done     as AdherenceCounsellingDone,
                           r.prep_status                    as PrepStatus,
                           r.switching_option               as SwitchingOption,
                           r.switching_date                 as SwitchingdDate,
                           r.prep_type                      as PrepType,
                           r.prescribed_prep_today          as PrescribedPrepToday,
                           r.prescribed_regimen             as RegimenPrescribed,
                           r.prescribed_regimen_months      as NumberOfMonths,
                           r.number_of_condoms_issued       as NumberOfCondomsIssued,
                           r.prep_discontinue_reasons       as DiscontinueReason,
                           r.prep_discontinue_other_reasons as OtherDiscontinueReason,
                           r.appointment_given              as ClientGivenNextAppointment,
                           r.next_appointment               as AppointmentDate,
                           r.remarks                        as Remarks,
                           r.voided                         as Voided,
                           r.date_created                   as Date_Created,
                           r.date_last_modified             as Date_Last_Modified
                    from dwapi_etl.etl_prep_monthly_refill r
                             inner join dwapi_etl.etl_prep_enrolment e on r.patient_id = e.patient_id
                             inner join dwapi_etl.etl_patient_demographics d on e.patient_id = d.patient_id
                             join kenyaemr_etl.etl_default_facility_info i"|TempPrepMonthlyRefillExtract|0|PrepMonthlyRefillExtract|36|a6221aa4-0e85-11e8-ba89-0ed5f89f718b

2F8A4A81-FEFB-49BF-AB07-C9F529F6EA13|Client Registry Service|CRS|A6221856-0E85-11E8-BA89-0ED5F89F718B|"SELECT dm.patient_id  AS PatientPK,
														dm.unique_patient_no                                              AS CCCNumber,
														dm.national_id_no                                                 AS NationalId,
														dm.passport_no                                                    AS Passport,
														dm.huduma_no                                                      AS HudumaNumber,
														dm.birth_certificate_no                                           AS BirthCertificateNumber,
														dm.alien_no                                                       AS AlienIdNo,
														dm.driving_license_no                                             AS DrivingLicenseNumber,
														dm.patient_clinic_number                                          AS PatientClinicNumber,
														dm.given_name                                                     AS FirstName,
														dm.middle_name                                                    AS MiddleName,
														dm.family_name                                                    AS LastName,
														dm.DOB                                                            AS DateOfBirth,
														(case dm.Gender when 'F' then 'Female' when 'M' then 'Male' else '' end) AS Sex,
														(case dm.marital_status when 'Never married' then 'Single'
																																						when 'Married' then 'Married-monogamous'
																																						
																																						when 'Polygamous' then 'Married-polygamous'
																																						
																																							when 'Living with partner' then 'Cohabiting' else dm.marital_status end) AS MaritalStatus,
														dm.occupation                                                     AS Occupation,
														dm.education_level                                                AS HighestLevelOfEducation,
														dm.phone_number                                                   AS PhoneNumber,
														''                                                                AS AlternativePhoneNumber,
														''                                                                AS SpousePhoneNumber,
														dm.next_of_kin                                                    AS NameOfNextOfKin,
														dm.next_of_kin_relationship                                       AS NextOfKinRelationship,
														dm.next_of_kin_phone                                              AS NextOfKinTelNo,
														pa.county                                                         AS County,
														pa.sub_county                                                     AS SubCounty,
														pa.ward                                                           AS Ward,
														pa.location                                                       AS Location,
														pa.village                                                        AS Village,
														pa.land_mark                                                      AS Landmark,
														(select FacilityName from kenyaemr_etl.etl_default_facility_info) as FacilityName,
														(select siteCode from kenyaemr_etl.etl_default_facility_info)     as MFLCode,
														(select siteCode from kenyaemr_etl.etl_default_facility_info)     as SiteCode,
														0                                                                 as FacilityId,
														'KHMIS'                                                           as Project,
														'KenyaEMR'                                                        as Emr,
														hiv.date_confirmed_hiv_positive                                   as DateOfHIVdiagnosis,
														if(hiv.date_started_art_at_transferring_facility is not null, hiv.date_started_art_at_transferring_facility,
																	reg.date_started)                                              as DateOfInitiation,
														reg.last_regimen                                                  as LastRegimen,
														reg.last_regimen_line                                             as LastRegimenLine,
														disc.ExitReason                                                   AS TreatmentOutcome,
														reg.latest_vis_date                                               AS DateOfLastEncounter,
														lab.lastViralLoadDate                                             AS DateOfLastViralLoad,
														lab.lastViralLoadResult                                           AS LastViralLoadResult,
														reg.latest_tca                                                    AS NextAppointmentDate,
														if(cc.patient_id IS NOT NULL, 'YES', 'NO')                        as CurrentOnART
							from kenyaemr_etl.etl_hiv_enrollment hiv
																join kenyaemr_etl.etl_patient_demographics dm on dm.patient_id = hiv.patient_id
																left join kenyaemr_etl.etl_person_address pa on pa.patient_id = hiv.patient_id
																left join (select d.patient_id,
																																		coalesce(max(date(d.effective_discontinuation_date)),
																																											max(date(d.visit_date))) as ExitDate,
																																		(case mid(max(concat(d.visit_date, d.discontinuation_reason)), 11)
																																							when 159492 then 'Transfer Out'
																																							when 160034 then 'Died'
																																							when 5240 then 'LTFU'
																																							when 819 then 'Stopped Treatment'
																																							else '' end)                 as ExitReason,
																																		max(d.date_last_modified)         as date_last_modified
																											from kenyaemr_etl.etl_patient_program_discontinuation d
																											where d.program_name = 'HIV'
																											group by d.patient_id) disc on disc.patient_id = dm.patient_id
																left join (select lb.patient_id,
																																		mid(max(concat(visit_date, lb.date_test_requested)), 11) as lastViralLoadDate,
																																		if(mid(max(concat(visit_date, lab_test)), 11) = 856,
																																					mid(max(concat(visit_date, test_result)), 11), if(
																																																					mid(max(concat(visit_date, lab_test)), 11) = 1305 and
																																																					mid(max(concat(visit_date, test_result)), 11) = 1302,
																																																					'LDL', ''))                           as lastViralLoadResult
																											from kenyaemr_etl.etl_laboratory_extract lb
																											where lb.lab_test in (1305, 856)
																											group by lb.patient_id) lab on lab.patient_id = dm.patient_id
																left join (select e.patient_id,
																																		e.regimen,
																																		e.regimen_line,
																																		e.alternative_regimen,
																																		max(fup.next_appointment_date) as latest_tca,
																																		last_art_date,
																																		last_regimen,
																																		last_regimen_line,
																																		max(fup.visit_date)            as latest_vis_date,
																																		e.date_started
																											from (select e.patient_id,
																																								min(e.date_started)                                  as date_started,
																																								max(e.date_started)                                  as last_art_date,
																																								mid(min(concat(e.date_started, e.regimen_name)), 11) as regimen,
																																								mid(min(concat(e.date_started, e.regimen_line)), 11) as regimen_line,
																																								mid(max(concat(e.date_started, e.regimen_name)), 11) as last_regimen,
																																								mid(max(concat(e.date_started, e.regimen_line)), 11) as last_regimen_line,
																																								max(if(discontinued, 1, 0))                          as alternative_regimen
																																	from kenyaemr_etl.etl_drug_event e
																																	group by e.patient_id) e
																																				left outer join kenyaemr_etl.etl_patient_hiv_followup fup on fup.patient_id = e.patient_id
																											group by e.patient_id) reg on reg.patient_id = hiv.patient_id
																left join (select ca.patient_id
																											from kenyaemr_etl.etl_current_in_care ca
																											where ca.started_on_drugs is not null
							) cc on cc.patient_id = dm.patient_id
							group by hiv.patient_id"|CRS|1|ClientRegistryExtract|1.00|a6221aa4-0e85-11e8-ba89-0ed5f89f718b
3F6C522C-BA8C-46FA-8151-CDBA393C392D|Client Registry Service|CRS|A6221857-0E85-11E8-BA89-0ED5F89F718B|""|CRS|1|ClientRegistryExtract|1.00|a6221aa4-0e85-11e8-ba89-0ed5f89f718b
8B29B02B-B508-42EF-8FBE-48E1DB23DD6D|Client Registry Service|CRS|A6221858-0E85-11E8-BA89-0ED5F89F718B|""|CRS|1|ClientRegistryExtract|1.00|a6221aa4-0e85-11e8-ba89-0ed5f89f718b
e5e097ed-ec17-4b51-bd0c-b047a09b8b1f|Client Registry Service|CRS|a6221861-0e85-11e8-ba89-0ed5f89f718b|"select * from NDWH_Patients_UPI"|CRS|1|ClientRegistryExtract|1.00|A6221AA7-0E85-11E8-BA89-0ED5F89F718B
